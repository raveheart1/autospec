plan:
  branch: "033-history-command"
  created: "2025-12-17"
  spec_path: "specs/033-history-command/spec.yaml"

summary: |
  This plan implements a command execution history feature for autospec. The solution
  introduces a new `internal/history` package to manage history storage and retrieval,
  a new `autospec history` CLI command for user interaction, and hooks into the existing
  lifecycle wrapper to automatically log command executions.

  Key technical decisions: (1) Store history in ~/.autospec/state/history.yaml using
  YAML format consistent with other artifacts, (2) Use atomic file writes with temp-file-
  and-rename pattern for data safety, (3) Hook logging into the lifecycle wrapper at
  command completion, and (4) Make history logging failures non-fatal with stderr warnings.

technical_context:
  language: "Go"
  framework: "None"
  primary_dependencies:
    - name: "cobra"
      version: "v1.8.0"
      purpose: "CLI framework for command definition"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing and marshaling for history file"
    - name: "koanf"
      version: "v2.0.1"
      purpose: "Configuration management for max_history_entries setting"
    - name: "fatih/color"
      version: "v1.16.0"
      purpose: "Colored terminal output for history display"
  storage: "File-based YAML at ~/.autospec/state/history.yaml"
  testing:
    framework: "go test with testify/assert"
    approach: "Unit tests with map-based table-driven pattern; integration tests for CLI"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "History logging adds <50ms overhead per command execution"
  constraints:
    - "History file location fixed at ~/.autospec/state/history.yaml"
    - "Cannot modify existing command signatures"
    - "Logging failures must not cause command failures"
    - "Functions must be <40 lines"
    - "All errors must be wrapped with context"
  scale_scope: "Single-user local storage; max 500-10000 entries per configuration"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Plan includes test files created before implementation in Phase 1"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "History is a utility feature, not a workflow phase transition"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Plan targets <50ms logging overhead, with non-blocking design"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Atomic file writes prevent corruption; idempotent read operations"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Invalid --limit uses exit code 3; history command follows standard codes"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "History stored as YAML, parseable by standard libraries"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "make fmt and make lint will be run during implementation"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Plan requires <40 line functions, error wrapping, table-driven tests"
    - name: "Cross-Platform Compatibility (PRIN-008)"
      status: "PASS"
      notes: "Using os package for path handling; no platform-specific code"
    - name: "Explicit Dependencies (PRIN-009)"
      status: "PASS"
      notes: "No new external dependencies required; uses existing yaml.v3 and koanf"
    - name: "Documentation Standards (PRIN-010)"
      status: "PASS"
      notes: "Plan includes reference.md update for new command documentation"

research_findings:
  decisions:
    - topic: "History file location"
      decision: "Store in ~/.autospec/state/history.yaml"
      rationale: "Consistent with existing state storage (retry.json); state directory already exists; spec requires fixed location at ~/.autospec/"
      alternatives_considered:
        - "Separate ~/.autospec/history.yaml - rejected for consistency with state pattern"
        - "Per-project history - rejected per spec requirement"
    - topic: "Concurrency safety mechanism"
      decision: "Atomic file writes with temp file + rename pattern"
      rationale: "Already proven pattern in retry.go; no external dependencies; cross-platform compatible; simpler than file locking"
      alternatives_considered:
        - "syscall.Flock - not cross-platform (Windows incompatible)"
        - "External locking library - adds dependency"
        - "Database (SQLite) - overkill for this use case"
    - topic: "History logging integration point"
      decision: "Hook into lifecycle wrapper after command completion"
      rationale: "Lifecycle wrapper already captures command name, duration, and success; centralized location; non-invasive to existing commands"
      alternatives_considered:
        - "Modify each command individually - too invasive, violates DRY"
        - "Separate post-command hook - more complex, less reliable"
    - topic: "Entry pruning strategy"
      decision: "Remove oldest entries when max exceeded, at write time"
      rationale: "Simple FIFO approach; consistent behavior; spec requirement"
      alternatives_considered:
        - "Background cleanup job - overly complex"
        - "Lazy pruning on read - delays write cost to read time"
    - topic: "Duration format"
      decision: "Use Go's time.Duration.String() format (e.g., '2m15.123s')"
      rationale: "Human-readable; standard Go format; parseable back to duration"
      alternatives_considered:
        - "Milliseconds integer - less readable"
        - "Custom format - unnecessary when Go format is good"

data_model:
  entities:
    - name: "HistoryEntry"
      description: "A single record of a command execution"
      fields:
        - name: "timestamp"
          type: "time.Time"
          description: "When the command started executing"
          constraints: "RFC3339 format in YAML; required"
        - name: "command"
          type: "string"
          description: "Name of the autospec command (e.g., 'specify', 'run')"
          constraints: "Required; non-empty"
        - name: "spec"
          type: "string"
          description: "Name or path of the spec being worked on"
          constraints: "May be empty for commands without a spec context"
        - name: "exit_code"
          type: "int"
          description: "Exit code of the command (0=success)"
          constraints: "0-5 per standardized exit codes"
        - name: "duration"
          type: "string"
          description: "Execution duration in Go duration format"
          constraints: "Required; parseable by time.ParseDuration"
      relationships: []
    - name: "HistoryFile"
      description: "The YAML file containing all history entries"
      fields:
        - name: "entries"
          type: "[]HistoryEntry"
          description: "Ordered list of command executions"
          constraints: "Newest entries appended at end; pruned to max_history_entries"
      relationships:
        - target: "HistoryEntry"
          type: "one-to-many"
          description: "Contains multiple history entries"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/reference.md"
      description: "Update with autospec history command documentation"
  source_code:
    - path: "internal/history/history.go"
      description: "Core history package with entry types and file operations"
    - path: "internal/history/writer.go"
      description: "HistoryWriter for thread-safe logging with file operations"
    - path: "internal/cli/history.go"
      description: "Cobra command for autospec history with flag handling"
    - path: "internal/config/config.go"
      description: "Add MaxHistoryEntries field (modify existing)"
    - path: "internal/config/defaults.go"
      description: "Add max_history_entries default value (modify existing)"
    - path: "internal/lifecycle/lifecycle.go"
      description: "Add history logging hook after command completion (modify existing)"
  tests:
    - path: "internal/history/history_test.go"
      description: "Unit tests for history package with table-driven tests"
    - path: "internal/history/writer_test.go"
      description: "Unit tests for HistoryWriter with concurrent access tests"
    - path: "internal/cli/history_test.go"
      description: "Unit tests for history CLI command"

implementation_phases:
  - phase: 1
    name: "Core History Package"
    goal: "Create the internal/history package with data structures and file operations"
    deliverables:
      - "HistoryEntry struct with YAML tags"
      - "HistoryFile struct with entries slice"
      - "LoadHistory() function to read from file"
      - "SaveHistory() function with atomic write"
      - "Unit tests for all functions (test-first)"
  - phase: 2
    name: "HistoryWriter and Configuration"
    goal: "Create thread-safe writer and integrate with configuration system"
    dependencies:
      - "Phase 1"
    deliverables:
      - "HistoryWriter struct with LogEntry() method"
      - "Entry pruning logic when max exceeded"
      - "MaxHistoryEntries config field and default"
      - "Unit tests for writer and pruning"
  - phase: 3
    name: "CLI Command"
    goal: "Create the autospec history command with all flags"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "historyCmd Cobra command"
      - "--spec flag with filtering logic"
      - "--limit flag with entry limiting"
      - "--clear flag with confirmation"
      - "Formatted output display"
      - "Unit tests for CLI command"
  - phase: 4
    name: "Lifecycle Integration"
    goal: "Hook history logging into lifecycle wrapper for automatic logging"
    dependencies:
      - "Phase 2"
    deliverables:
      - "HistoryLogger interface or function type"
      - "Integration in lifecycle.Run() and lifecycle.RunWithContext()"
      - "Spec name resolution from context"
      - "Error handling that doesn't fail commands"
      - "Integration tests"
  - phase: 5
    name: "Documentation and Quality Gates"
    goal: "Update documentation and pass all quality gates"
    dependencies:
      - "Phase 3"
      - "Phase 4"
    deliverables:
      - "docs/reference.md updated with history command"
      - "make test passes"
      - "make fmt produces no changes"
      - "make lint passes"
      - "make build succeeds"

risks:
  - risk: "File corruption during concurrent writes"
    likelihood: "low"
    impact: "medium"
    mitigation: "Atomic write pattern with temp file + rename; corrupt file detection and backup"
  - risk: "Performance overhead exceeds 50ms budget"
    likelihood: "low"
    impact: "low"
    mitigation: "Profile early; use goroutine for async write if needed"
  - risk: "Spec name resolution fails in edge cases"
    likelihood: "medium"
    impact: "low"
    mitigation: "Graceful fallback to empty spec; log warning"
  - risk: "Windows path handling issues"
    likelihood: "low"
    impact: "medium"
    mitigation: "Use filepath package consistently; test on Windows in CI"

open_questions:
  - question: "Should history logging be asynchronous to minimize overhead?"
    context: "Spec requires <50ms overhead; synchronous write may approach this limit"
    proposed_resolution: "Start synchronous; profile; add async option only if needed"
  - question: "Should --clear require confirmation?"
    context: "Spec says no confirmation required; could add --force flag for future"
    proposed_resolution: "Implement per spec (no confirmation); defer confirmation to future enhancement"
  - question: "How to handle interrupted commands (Ctrl+C)?"
    context: "Spec mentions logging with special exit code; need to determine integration point"
    proposed_resolution: "Use context cancellation in lifecycle wrapper; log with exit code 130 (standard SIGINT)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-17T01:27:22Z"
  artifact_type: "plan"
