plan:
  branch: "084-verification-config"
  created: "2026-01-06"
  spec_path: "specs/084-verification-config/spec.yaml"

summary: |
  This plan implements a verification configuration block that enables tiered validation
  depth control through the existing koanf-based configuration system. The design follows
  established patterns from notifications, cclean, and worktree config blocks, adding a
  new VerificationConfig struct with level presets (basic/enhanced/full), individual
  feature toggles, and configurable thresholds. The resolution order (explicit toggle >
  level preset > default) provides flexibility while maintaining backwards compatibility
  by defaulting to 'basic' level for existing configurations.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "koanf"
      version: "v2"
      purpose: "Hierarchical configuration management with env/file/defaults priority"
    - name: "gopkg.in/yaml.v3"
      version: "v3"
      purpose: "YAML parsing and serialization for config files"
    - name: "github.com/spf13/cobra"
      version: "v1.8"
      purpose: "CLI command framework"
  storage: "YAML config files (~/.config/autospec/config.yml, .autospec/config.yml)"
  testing:
    framework: "testing (stdlib)"
    approach: "Map-based table-driven tests with t.Parallel(), validation unit tests, integration tests for config loading"
  target_platform: "Linux, macOS (Intel/Apple Silicon)"
  project_type: "cli"
  performance_goals: "Config loading <100ms, validation functions <10ms"
  constraints:
    - "Must integrate with existing koanf-based configuration system"
    - "Must follow existing config patterns (schema.go, defaults.go, config.go)"
    - "Config loading performance contract: <100ms total"
    - "Cannot break existing config files (backwards compatibility required)"
    - "Functions must be <40 lines per Go coding standards"
    - "All errors must be wrapped with context"
  scale_scope: "Single-user CLI tool configuration"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Plan includes comprehensive test coverage for validation, enum parsing, threshold ranges, and config loading"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "VerificationConfig validation follows established ValidateConfigValues pattern"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Validation functions target <10ms, config loading <100ms per existing contracts"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "N/A"
      notes: "Configuration feature doesn't introduce new exit codes"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "Config uses YAML format with standard koanf/yaml.v3 parsing"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "Implementation will pass go fmt, go vet as enforced by CI"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, map-based table tests, interfaces pattern"

research_findings:
  decisions:
    - topic: "Verification level enum representation"
      decision: "Use string type with const definitions (like WorktreeStatus, OutputType)"
      rationale: "Consistent with existing patterns in worktree.go and notify.go, enables easy YAML serialization"
      alternatives_considered:
        - "Custom int-based enum with String() method"
        - "Interface-based type system"
    - topic: "Feature toggle resolution order"
      decision: "Resolution: explicit toggle > level preset > default (false)"
      rationale: "Allows granular control while providing sensible level-based defaults"
      alternatives_considered:
        - "Level-only with no overrides"
        - "Toggle-only with no presets"
    - topic: "Threshold validation approach"
      decision: "Inline validation in ValidateConfigValues with range checks"
      rationale: "Consistent with existing MaxRetries validation pattern"
      alternatives_considered:
        - "Separate ValidateVerificationConfig function"
        - "Schema-based validation with ConfigKeySchema"
    - topic: "Config struct location"
      decision: "New internal/verification/config.go file with VerificationConfig struct"
      rationale: "Follows pattern of notify/notify.go with NotificationConfig, keeps verification logic isolated"
      alternatives_considered:
        - "Inline struct in internal/config/config.go"
        - "Separate internal/config/verification.go file"
    - topic: "Environment variable naming"
      decision: "AUTOSPEC_VERIFICATION_* prefix with underscore-to-dot transform"
      rationale: "Consistent with existing AUTOSPEC_NOTIFICATIONS_*, AUTOSPEC_CCLEAN_* patterns"
      alternatives_considered:
        - "AUTOSPEC_VERIFY_* shorter prefix"
        - "Flat env vars without nested structure"

data_model:
  entities:
    - name: "VerificationLevel"
      description: "Enumeration of preset verification tiers that enable feature sets"
      fields:
        - name: "value"
          type: "string"
          description: "Level identifier"
          constraints: "One of: basic, enhanced, full"
      relationships: []
    - name: "VerificationConfig"
      description: "Configuration structure holding verification level, feature toggles, and thresholds"
      fields:
        - name: "Level"
          type: "VerificationLevel"
          description: "Selected verification tier"
          constraints: "Must be valid VerificationLevel enum value"
        - name: "AdversarialReview"
          type: "*bool"
          description: "Toggle for adversarial review feature (nil = use level default)"
          constraints: "Optional boolean pointer for explicit override detection"
        - name: "Contracts"
          type: "*bool"
          description: "Toggle for contracts verification feature"
          constraints: "Optional boolean pointer for explicit override detection"
        - name: "PropertyTests"
          type: "*bool"
          description: "Toggle for property-based tests feature"
          constraints: "Optional boolean pointer for explicit override detection"
        - name: "MetamorphicTests"
          type: "*bool"
          description: "Toggle for metamorphic tests feature"
          constraints: "Optional boolean pointer for explicit override detection"
        - name: "MutationThreshold"
          type: "float64"
          description: "Minimum mutation score threshold"
          constraints: "Range: 0.0-1.0, default: 0.8"
        - name: "CoverageThreshold"
          type: "float64"
          description: "Minimum code coverage threshold"
          constraints: "Range: 0.0-1.0, default: 0.85"
        - name: "ComplexityMax"
          type: "int"
          description: "Maximum cyclomatic complexity allowed"
          constraints: "Positive integer, default: 10"
      relationships:
        - target: "Configuration"
          type: "embedded-in"
          description: "VerificationConfig is a field within the main Configuration struct"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/reference.md"
      description: "CLI reference will be updated with verification config options"
    - path: "AGENTS.md"
      description: "May need update if verification affects agent workflow"
  source_code:
    - path: "internal/verification/config.go"
      description: "VerificationConfig struct, VerificationLevel enum, level preset mappings"
    - path: "internal/verification/config_test.go"
      description: "Unit tests for VerificationConfig validation and level resolution"
    - path: "internal/config/config.go"
      description: "Add Verification field to Configuration struct"
    - path: "internal/config/schema.go"
      description: "Add verification.* entries to KnownKeys map"
    - path: "internal/config/defaults.go"
      description: "Add verification defaults to GetDefaults() and template"
    - path: "internal/config/validate.go"
      description: "Add validateVerificationConfig() function"
  tests:
    - path: "internal/verification/config_test.go"
      description: "Unit tests for VerificationConfig, level resolution, toggle overrides"
    - path: "internal/config/validate_test.go"
      description: "Validation tests for verification config values"
    - path: "internal/config/config_test.go"
      description: "Integration tests for loading verification config from YAML/env"

implementation_phases:
  - phase: 1
    name: "Core Data Structures"
    goal: "Define VerificationLevel enum, VerificationConfig struct, and level preset mappings"
    deliverables:
      - "internal/verification/config.go with VerificationLevel const definitions"
      - "VerificationConfig struct with koanf/yaml tags"
      - "Level preset mappings (basic/enhanced/full feature sets)"
      - "IsEnabled() method for resolved feature toggle checking"
      - "Unit tests for level validation and preset mappings"
  - phase: 2
    name: "Config Integration"
    goal: "Integrate VerificationConfig into the koanf configuration system"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Add Verification field to Configuration struct in config.go"
      - "Add verification.* entries to KnownKeys in schema.go"
      - "Add verification defaults to GetDefaults() in defaults.go"
      - "Update GetDefaultConfigTemplate() with verification block"
      - "Update envTransform() for AUTOSPEC_VERIFICATION_* env vars"
  - phase: 3
    name: "Validation"
    goal: "Implement validation for verification config values"
    dependencies:
      - "Phase 2"
    deliverables:
      - "validateVerificationConfig() function in validate.go"
      - "Level enum validation (basic/enhanced/full)"
      - "Threshold range validation (0.0-1.0 for percentages, positive int for complexity)"
      - "Clear error messages with valid options list"
      - "Validation tests covering all edge cases"
  - phase: 4
    name: "Config Display"
    goal: "Ensure verification settings appear in 'autospec config show' output"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Verification block appears in YAML/JSON config output"
      - "Effective feature toggles displayed (resolved from level + explicit)"
      - "Integration tests for config show output"

open_questions:
  - question: "Should *bool pointers be used for feature toggles to distinguish unset from false?"
    context: "Enables detection of explicit false vs using level default"
    proposed_resolution: "Use *bool pointers with yaml 'omitempty' tag - nil means use level default, explicit false means disabled"
  - question: "Should thresholds also support level-based defaults?"
    context: "Different levels might warrant different default thresholds"
    proposed_resolution: "Start with global defaults, add level-based threshold defaults in a future iteration if needed"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.2"
  created: "2026-01-06T06:35:12Z"
  artifact_type: "plan"
