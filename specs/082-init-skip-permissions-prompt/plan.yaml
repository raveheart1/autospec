plan:
  branch: "082-init-skip-permissions-prompt"
  created: "2026-01-06"
  spec_path: "specs/082-init-skip-permissions-prompt/spec.yaml"

summary: |
  Add a skip_permissions prompt to the 'autospec init' wizard when Claude is selected.
  This prompt appears after sandbox configuration and before the Optional Setup phase,
  explaining the tradeoffs of enabling autonomous mode. The implementation follows the
  existing prompt patterns in init_cmd.go, using promptYesNo for user interaction and
  updating the config file with the user's choice. The feature leverages the existing
  skip_permissions field in the config schema and integrates seamlessly with the current
  init flow.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework"
    - name: "github.com/fatih/color"
      version: "v1.16.0"
      purpose: "Colored terminal output"
  storage: "YAML config files (~/.config/autospec/config.yml or .autospec/config.yml)"
  testing:
    framework: "Go testing package with testify"
    approach: "Map-based table-driven unit tests for prompt logic and config updates"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Prompt display and config write complete in <100ms"
  constraints:
    - "Must integrate with existing init wizard flow without breaking changes"
    - "Prompt only shown when Claude agent is selected"
    - "Must follow existing prompt patterns (printSectionHeader, promptYesNo)"
    - "Default value must remain false when prompt is declined or skipped"
  scale_scope: "Single-user CLI tool"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests will be written for prompt display logic, config update, and integration scenarios"
    - name: "Validation-First Workflow"
      status: "N/A"
      notes: "This feature is a prompt addition, not a workflow phase transition"
    - name: "Performance Standards"
      status: "PASS"
      notes: "Prompt display and config write are trivial operations well under 10ms"
    - name: "Idempotency and Retry Logic"
      status: "PASS"
      notes: "Config update is idempotent - can be re-run safely"
    - name: "Go Coding Standards"
      status: "PASS"
      notes: "Functions under 40 lines, errors wrapped with context, table-driven tests"
    - name: "Command Template Independence"
      status: "N/A"
      notes: "No slash command changes - this is pure Go implementation"

research_findings:
  decisions:
    - topic: "Where to place the skip_permissions prompt in the init flow"
      decision: "After sandbox configuration, before Optional Setup phase"
      rationale: "Sandbox is mentioned in the prompt text as improving safety when skip_permissions is enabled. Placing the prompt after sandbox ensures users have context about sandbox protection before making the skip_permissions decision."
      alternatives_considered:
        - "Before sandbox configuration - rejected because prompt mentions sandbox as safety mitigation"
        - "During Optional Setup phase - rejected because it's agent-specific, not project-general"
        - "After agent selection but before sandbox - rejected for same reason"
    - topic: "Prompt style and confirmation default"
      decision: "Use promptYesNo (defaults to No) with clear explanation"
      rationale: "Consistent with security-sensitive prompts. skip_permissions enables autonomous mode which has security implications, so opt-in (default No) is appropriate."
      alternatives_considered:
        - "promptYesNoDefaultYes - rejected because skip_permissions is security-sensitive"
        - "Multi-choice prompt - rejected as overkill for binary yes/no decision"
    - topic: "How to update config file"
      decision: "Create updateSkipPermissionsInConfig helper similar to updateUseSubscriptionInConfig"
      rationale: "Follows existing patterns for atomic config updates while preserving formatting"
      alternatives_considered:
        - "Full config reload and rewrite - rejected because it loses comments and formatting"
        - "Using config.SetValue API - could work but less control over placement"
    - topic: "Handling existing skip_permissions value"
      decision: "Show current value and allow user to change it"
      rationale: "Matches edge case spec requirement (EC-003: re-running init on configured project)"
      alternatives_considered:
        - "Skip prompt if already configured - rejected as users may want to change the value"

data_model:
  entities:
    - name: "Configuration"
      description: "Autospec configuration struct containing all settings"
      fields:
        - name: "SkipPermissions"
          type: "bool"
          description: "Enables Claude autonomous mode (--dangerously-skip-permissions)"
          constraints: "Default false, stored as skip_permissions in YAML"
      relationships:
        - target: "ClaudeExecutor"
          type: "one-to-one"
          description: "SkipPermissions is passed to ClaudeExecutor which sets ExecOptions.Autonomous"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/reference.md"
      description: "CLI reference documentation (may need update if behavior description changes)"
  source_code:
    - path: "internal/cli/config/init_cmd.go"
      description: "Main implementation file - add prompt function and integrate into flow"
  tests:
    - path: "internal/cli/config/init_test.go"
      description: "Unit tests for the new prompt logic and config updates"

implementation_phases:
  - phase: 1
    name: "Core Prompt Implementation"
    goal: "Implement the skip_permissions prompt function and config update helper"
    deliverables:
      - "promptSkipPermissions function with clear explanation text"
      - "updateSkipPermissionsInConfig helper for atomic config updates"
      - "Unit tests for prompt text content and config update logic"
  - phase: 2
    name: "Init Flow Integration"
    goal: "Integrate the prompt into the init wizard flow for Claude agent"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Integration in configureSelectedAgents or handleSandboxConfiguration"
      - "Claude-only conditional check (containsAgent pattern)"
      - "Integration tests verifying prompt appears only for Claude"
  - phase: 3
    name: "Edge Cases and Polish"
    goal: "Handle edge cases and ensure quality gates pass"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Handle existing skip_permissions value (show current, allow change)"
      - "Handle non-interactive mode gracefully"
      - "Verify all quality gates: make test, make fmt, make lint, make build"

open_questions:
  - question: "Should the prompt show sandbox status to help users decide?"
    context: "The spec mentions that skip_permissions is safer after sandbox is configured. We could detect and display current sandbox status."
    proposed_resolution: "Display sandbox status inline in the prompt text if sandbox was just configured, otherwise mention it generally. Keep it simple."
  - question: "Should we persist the choice to project-level or user-level config?"
    context: "The prompt appears during init which can create either project or user config based on --project flag."
    proposed_resolution: "Persist to the same config file being created (respecting --project flag), consistent with other init settings."

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.8.1"
  created: "2026-01-06T03:48:49Z"
  artifact_type: "plan"
