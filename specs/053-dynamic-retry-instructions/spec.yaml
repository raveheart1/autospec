feature:
    branch: "053-dynamic-retry-instructions"
    created: "2025-12-18"
    status: "Completed"
    completed_at: 2025-12-18T21:01:06Z
    input: "Refactor retry context handling so that the 'Retry Context' instruction section in command templates (.claude/commands/autospec.*.md) is only injected during actual retries, not baked into the base template. Currently the ~50-line retry handling instructions exist on every first run, wasting context tokens. The instructions should be dynamically injected only when the executor is doing a retry (when FormatRetryContext/BuildRetryCommand are invoked)."
user_stories:
    - id: "US-001"
      title: "Context-efficient first-run execution"
      priority: "P1"
      as_a: "developer running autospec commands"
      i_want: "the retry handling instructions to only appear when a retry is actually occurring"
      so_that: "I don't waste context tokens on first-run executions and Claude has a cleaner prompt to work with"
      why_this_priority: "Directly addresses the core problem - wasted tokens on every first run across all commands"
      independent_test: "Run a specify/plan/tasks command for the first time and verify the prompt sent to Claude does not contain 'Retry Context' section or retry handling instructions"
      acceptance_scenarios:
        - given: "A fresh execution with no prior validation failures"
          when: "The user runs autospec specify, plan, or tasks command"
          then: "The command prompt sent to Claude contains no retry-related instructions"
        - given: "A first execution of any workflow stage"
          when: "Examining the rendered command template"
          then: "The '## Retry Context' section and all its subsections are absent"
    - id: "US-002"
      title: "Retry-aware instruction injection"
      priority: "P1"
      as_a: "developer whose previous execution failed validation"
      i_want: "the retry handling instructions to be dynamically injected along with the error context"
      so_that: "Claude receives guidance on how to interpret and fix the validation errors"
      why_this_priority: "Essential for retry functionality to work correctly - Claude needs instructions to understand the retry format"
      independent_test: "Force a validation failure, then verify on retry that the prompt includes both the RETRY X/Y prefix AND the instruction section explaining how to handle it"
      acceptance_scenarios:
        - given: "A previous execution that failed schema validation"
          when: "The executor initiates a retry"
          then: "The command prompt includes the retry handling instructions section"
        - given: "Retry context has been formatted with validation errors"
          when: "The retry command is built and sent to Claude"
          then: "Instructions for parsing RETRY X/Y format, handling errors, and common fixes are present"
    - id: "US-003"
      title: "Consistent retry instruction content"
      priority: "P2"
      as_a: "maintainer of autospec"
      i_want: "the retry instructions to be defined in one place and shared across all commands"
      so_that: "updates to retry handling logic don't require editing multiple files"
      why_this_priority: "DRY principle - currently the same ~50 lines are duplicated in specify.md, plan.md, and tasks.md"
      independent_test: "Check that retry instructions are defined in a single source file and injected into all command templates that need them"
      acceptance_scenarios:
        - given: "The retry instructions need to be updated"
          when: "A developer modifies the retry handling documentation"
          then: "Only one file needs to be changed"
        - given: "Three command templates (specify, plan, tasks) need retry handling"
          when: "Building retry commands for any of them"
          then: "All receive identical retry instruction content from a shared source"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST remove static '## Retry Context' section from .claude/commands/autospec.specify.md, autospec.plan.md, and autospec.tasks.md"
          testable: true
          acceptance_criteria: "The three command template files contain no '## Retry Context' heading or retry handling instructions"
        - id: "FR-002"
          description: "MUST create a shared retry instructions content source (embedded string or separate file) that contains the retry handling instructions"
          testable: true
          acceptance_criteria: "A single source exists containing all retry instruction content: detecting RETRY X/Y format, handling errors, common schema fixes"
        - id: "FR-003"
          description: "MUST modify FormatRetryContext or BuildRetryCommand functions in executor.go to append retry handling instructions to the retry context"
          testable: true
          acceptance_criteria: "When FormatRetryContext is called with validation errors, the output includes both the error data AND the instructions for handling them"
        - id: "FR-004"
          description: "MUST maintain identical retry handling behavior - retries should still work correctly after refactoring"
          testable: true
          acceptance_criteria: "Existing retry tests continue to pass; manual retry scenarios produce correct behavior"
        - id: "FR-005"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "performance"
          description: "First-run command prompts should be smaller by ~50 lines (the retry instructions)"
          measurable_target: "First-run prompt size reduced by approximately 1500-2000 characters compared to current implementation"
        - id: "NFR-002"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-003"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-004"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern with t.Parallel()"
          measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
        - id: "NFR-005"
          category: "maintainability"
          description: "Retry instructions should be defined in one location only (DRY principle)"
          measurable_target: "Single source of truth for retry instruction text; no duplication across command templates"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "First-run prompts are leaner without retry instructions"
          metric: "Character count of rendered command template on first run"
          target: "Reduction of ~1500-2000 characters compared to pre-change templates"
        - id: "SC-002"
          description: "Retry functionality continues working correctly"
          metric: "All existing retry-related tests pass"
          target: "100% of retry tests pass without modification"
        - id: "SC-003"
          description: "Retry instructions exist in a single location"
          metric: "Count of files containing retry instruction text"
          target: "Exactly 1 file contains the retry instructions definition"
key_entities:
    - name: "RetryContext"
      description: "The formatted string containing retry attempt info and validation errors, now also including handling instructions"
      attributes:
        - "Attempt number (X/Y format)"
        - "List of validation errors"
        - "Handling instructions (newly added)"
    - name: "CommandTemplate"
      description: "Markdown files in .claude/commands/ that define slash command prompts"
      attributes:
        - "Base prompt content"
        - "Schema/format definitions"
        - "Execution instructions"
    - name: "RetryInstructions"
      description: "The shared documentation explaining how to parse and handle retry context"
      attributes:
        - "Detection pattern (RETRY X/Y)"
        - "Error parsing guidance"
        - "Common fix reference table"
edge_cases:
    - scenario: "Command has never been retried (first run)"
      expected_behavior: "No retry instructions in the prompt; FormatRetryContext returns empty or is not called"
    - scenario: "Retry with zero validation errors (execution error, not validation)"
      expected_behavior: "Retry context shows RETRY X/Y but minimal instructions since no schema errors to fix"
    - scenario: "Multiple retries in sequence"
      expected_behavior: "Each retry includes fresh instructions; no accumulation of duplicate instruction blocks"
    - scenario: "Custom command template without retry support"
      expected_behavior: "Templates for commands that don't use validation (e.g., constitution) are unaffected"
assumptions:
    - "The retry instruction content is stable and doesn't need frequent per-command customization"
    - "Embedded Go strings are acceptable for storing the retry instructions (vs. external file)"
    - "The FormatRetryContext function is the right place to inject instructions (called only on retry)"
constraints:
    - "Must maintain backward compatibility with existing retry state files"
    - "Cannot change the RETRY X/Y format that may be relied upon by other tooling"
    - "Command templates must remain valid markdown after removing retry section"
out_of_scope:
    - "Adding retry support to commands that don't currently have it"
    - "Changing the retry limit or retry behavior logic"
    - "Modifying the validation error extraction logic"
    - "Internationalization of retry instructions"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-18T20:41:49Z"
    artifact_type: "spec"
