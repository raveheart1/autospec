plan:
  branch: "032-lifecycle-wrapper"
  created: "2025-12-16"
  spec_path: "specs/032-lifecycle-wrapper/spec.yaml"

summary: |
  This implementation creates a lightweight lifecycle wrapper package that eliminates
  notification boilerplate across 11 CLI commands. The core pattern is a simple Run()
  function that wraps command execution with timing and notification dispatch.

  The solution is intentionally minimal: no event bus, no goroutines, no external dependencies.
  Each wrapper function captures start time, executes the provided function, calculates duration,
  and calls the appropriate notification method. Handler panic recovery ensures commands complete
  even if notifications fail. The existing notify.Handler interface is sufficient - no changes needed.

technical_context:
  language: "Go"
  framework: "None"
  primary_dependencies:
    - name: "context"
      version: "stdlib"
      purpose: "Context cancellation support for RunWithContext"
    - name: "time"
      version: "stdlib"
      purpose: "Duration tracking and timing"
  storage: "None"
  testing:
    framework: "go test"
    approach: "Table-driven unit tests with parallel execution; mock handler for notification verification"
  target_platform: "linux, darwin, windows"
  project_type: "cli"
  performance_goals: "Wrapper overhead under 1ms; no allocations beyond function call"
  constraints:
    - "No external dependencies - pure Go standard library"
    - "Synchronous notification dispatch - no goroutines for notification"
    - "Backward compatible - existing notification behavior unchanged"
    - "Functions under 40 lines"
    - "Errors wrapped with context"
  scale_scope: "11 CLI commands, single lifecycle package"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests will be written before implementation; table-driven patterns required per spec NFRs"
    - name: "Validation-First Workflow"
      status: "N/A"
      notes: "This feature does not involve workflow phase transitions"
    - name: "Performance Standards"
      status: "PASS"
      notes: "NFR-001 requires <1ms overhead; will be verified with benchmarks"
    - name: "Idempotency and Retry Logic"
      status: "N/A"
      notes: "Lifecycle wrapper is stateless; idempotency not applicable"
    - name: "Standardized Exit Codes"
      status: "PASS"
      notes: "Wrapper returns original function error; exit codes unchanged"
    - name: "YAML-First Artifacts"
      status: "N/A"
      notes: "No YAML artifacts created by this feature"
    - name: "Code Formatting"
      status: "PASS"
      notes: "FR-009 requires make fmt, make lint to pass"
    - name: "Go Coding Standards"
      status: "PASS"
      notes: "NFR-003 through NFR-006 explicitly require 40-line functions, error wrapping, table tests"
    - name: "Cross-Platform Compatibility"
      status: "PASS"
      notes: "Pure Go implementation; no platform-specific code"
    - name: "Explicit Dependencies"
      status: "PASS"
      notes: "NFR-007 requires zero new dependencies"
    - name: "Documentation Standards"
      status: "PASS"
      notes: "Public API will have godoc comments"

research_findings:
  decisions:
    - topic: "Wrapper function signature design"
      decision: "Use closure-based pattern: Run(handler, name, fn func() error) error"
      rationale: "Matches existing command pattern where RunE returns error; handler first for consistency with Go interface-receiver patterns"
      alternatives_considered:
        - "Method on Handler type - rejected because it couples lifecycle to notify package"
        - "Builder pattern - rejected as over-engineering for simple use case"
        - "Options pattern - rejected; minimal configuration needed"

    - topic: "Handler interface requirement"
      decision: "Accept NotificationHandler interface, not concrete *notify.Handler"
      rationale: "Enables testing with mock handlers; follows accept-interfaces-return-concretes principle (NFR-006)"
      alternatives_considered:
        - "Accept concrete *notify.Handler - rejected; limits testability"
        - "Create new Handler interface in lifecycle package - rejected; duplicates existing interface"

    - topic: "Panic recovery strategy"
      decision: "Recover handler panics in defer; propagate fn panics"
      rationale: "NFR-002 requires handler panics not crash app; fn panics should propagate (edge case spec)"
      alternatives_considered:
        - "Recover all panics - rejected per edge case spec"
        - "No recovery - rejected; violates NFR-002"

    - topic: "Package location"
      decision: "internal/lifecycle - new package alongside existing internal packages"
      rationale: "Clear separation of concerns; avoids circular dependencies with notify and cli packages"
      alternatives_considered:
        - "Add to internal/notify - rejected; mixes concerns"
        - "Add to internal/workflow - rejected; lifecycle is CLI-level, not workflow-level"

data_model:
  entities:
    - name: "NotificationHandler"
      description: "Interface for receiving lifecycle notifications (use existing from internal/notify)"
      fields:
        - name: "OnCommandComplete"
          type: "func(name string, success bool, duration time.Duration)"
          description: "Called when command completes"
          constraints: "Must be nil-safe"
        - name: "OnStageComplete"
          type: "func(name string, success bool)"
          description: "Called when stage completes"
          constraints: "Must be nil-safe"
        - name: "SetStartTime"
          type: "func(t time.Time)"
          description: "Sets command start time for duration tracking"
          constraints: "Optional; handler may ignore"
      relationships: []

    - name: "CommandFunc"
      description: "Function type for command execution"
      fields:
        - name: "signature"
          type: "func() error"
          description: "Function that executes command logic and returns error"
          constraints: "May return nil for success"
      relationships: []

    - name: "ContextFunc"
      description: "Function type for context-aware command execution"
      fields:
        - name: "signature"
          type: "func(ctx context.Context) error"
          description: "Function that executes with context and returns error"
          constraints: "Should respect context cancellation"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "CLAUDE.md"
      description: "Update CLI command notification handler section to reference lifecycle wrapper"
  source_code:
    - path: "internal/lifecycle/lifecycle.go"
      description: "Core lifecycle wrapper functions: Run, RunWithContext, RunStage"
    - path: "internal/lifecycle/handler.go"
      description: "NotificationHandler interface definition for dependency injection"
    - path: "internal/cli/specify.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/plan.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/tasks.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/clarify.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/analyze.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/checklist.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/constitution.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/implement.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/prep.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/run.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/cli/all.go"
      description: "Migrate to lifecycle.Run() - remove notification boilerplate"
    - path: "internal/workflow/executor.go"
      description: "Migrate stage completion to lifecycle.RunStage()"
  tests:
    - path: "internal/lifecycle/lifecycle_test.go"
      description: "Unit tests for Run, RunWithContext, RunStage with mock handler"
    - path: "internal/lifecycle/lifecycle_bench_test.go"
      description: "Benchmark tests verifying <1ms overhead"
    - path: "internal/cli/specify_test.go"
      description: "Update TestAllCommandsHaveNotificationSupport to verify lifecycle usage"

implementation_phases:
  - phase: 1
    name: "Core Lifecycle Package"
    goal: "Create internal/lifecycle package with wrapper functions and tests"
    deliverables:
      - "internal/lifecycle/handler.go - NotificationHandler interface"
      - "internal/lifecycle/lifecycle.go - Run, RunWithContext, RunStage functions"
      - "internal/lifecycle/lifecycle_test.go - comprehensive unit tests"
      - "internal/lifecycle/lifecycle_bench_test.go - performance benchmarks"

  - phase: 2
    name: "CLI Command Migration"
    goal: "Migrate all 11 CLI commands to use lifecycle wrapper"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Migrate specify.go to lifecycle.Run()"
      - "Migrate plan.go to lifecycle.Run()"
      - "Migrate tasks.go to lifecycle.Run()"
      - "Migrate clarify.go to lifecycle.Run()"
      - "Migrate analyze.go to lifecycle.Run()"
      - "Migrate checklist.go to lifecycle.Run()"
      - "Migrate constitution.go to lifecycle.Run()"
      - "Migrate implement.go to lifecycle.Run()"
      - "Migrate prep.go to lifecycle.Run()"
      - "Migrate run.go to lifecycle.Run()"
      - "Migrate all.go to lifecycle.Run()"

  - phase: 3
    name: "Executor Integration"
    goal: "Update executor to use lifecycle.RunStage() for stage completion"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Update executor.go to use lifecycle.RunStage()"
      - "Remove direct OnStageComplete calls from executor"

  - phase: 4
    name: "Regression Test Update and Quality Gates"
    goal: "Update regression test and verify all quality gates pass"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "Update TestAllCommandsHaveNotificationSupport to verify lifecycle usage"
      - "Update CLAUDE.md to document lifecycle wrapper pattern"
      - "Verify make test passes"
      - "Verify make fmt produces no changes"
      - "Verify make lint passes"
      - "Verify make build succeeds"

risks:
  - risk: "Circular import between lifecycle and notify packages"
    likelihood: "low"
    impact: "medium"
    mitigation: "Define NotificationHandler interface in lifecycle package; notify.Handler implements it"

  - risk: "Regression in notification timing accuracy"
    likelihood: "low"
    impact: "low"
    mitigation: "Benchmark tests verify timing overhead; existing notification tests validate behavior"

  - risk: "Handler panic recovery masking real errors"
    likelihood: "low"
    impact: "medium"
    mitigation: "Only recover handler panics (not fn panics); log recovered panics for debugging"

open_questions:
  - question: "Should lifecycle package export the NotificationHandler interface or reuse from notify?"
    context: "Defining interface in lifecycle avoids circular imports but creates duplication"
    proposed_resolution: "Define minimal interface in lifecycle; notify.Handler will satisfy it implicitly"

  - question: "Should RunStage track duration like Run does?"
    context: "Current OnStageComplete takes only (name, success) without duration"
    proposed_resolution: "Keep current signature; OnStageComplete doesn't use duration per existing notify.Handler"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-17T00:34:51Z"
  artifact_type: "plan"
