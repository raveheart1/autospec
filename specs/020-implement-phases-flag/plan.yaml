plan:
  branch: "020-implement-phases-flag"
  created: "2025-12-16"
  spec_path: "specs/020-implement-phases-flag/spec.yaml"

summary: |
  This plan implements a --phases flag for the autospec implement command that executes
  each task phase in a separate Claude session. The key insight is that tasks.yaml already
  contains a phases array with task groupings, so the implementation focuses on orchestration
  changes rather than schema modifications.

  The approach modifies ExecuteImplement() in workflow.go to support three modes: default
  single-session (backward compatible), --phases mode that iterates through phases with fresh
  Claude sessions, and --phase N mode for executing a specific phase. Phase completion is
  tracked using the existing retry state mechanism, and tasks with Blocked status are treated
  as non-actionable when determining phase completion.

technical_context:
  language: "Go 1.25.1"
  framework: "Cobra CLI (v1.10.1)"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI command framework"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for tasks.yaml phase structure"
    - name: "github.com/briandowns/spinner"
      version: "v1.23.0+"
      purpose: "Progress display during phase execution"
  storage: "File system (retry state in ~/.autospec/state/retry.json)"
  testing:
    framework: "Go testing with table-driven tests"
    approach: "Unit tests for phase parsing/validation, integration tests for CLI flags"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Phase parsing from tasks.yaml < 100ms"
  constraints:
    - "Cannot modify tasks.yaml schema - must work with existing phases array"
    - "Must maintain backward compatibility with default implement command"
    - "Phase execution order must match tasks.yaml order"
    - "Cannot run phases in parallel due to task dependencies"
  scale_scope: "Single CLI invocation, tasks.yaml files typically < 100KB"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Plan includes test tasks before implementation in each phase"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "Phase completion validated before transitioning to next phase"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Phase parsing targets < 100ms, existing validation contracts maintained"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Phase state persisted in retry.json, operations idempotent via status checks"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Uses existing exit code conventions (0=success, 3=invalid args)"

research_findings:
  decisions:
    - topic: "Phase iteration strategy"
      decision: "Loop through phases array in tasks.yaml, spawning fresh Claude session per phase"
      rationale: "Matches existing ExecutePhase pattern, provides natural context isolation"
      alternatives_considered:
        - "Modify slash command to handle phase filtering (would require more complex command parsing)"
        - "Use subprocess for each phase (added complexity, harder to debug)"

    - topic: "Phase completion detection"
      decision: "Check task status in tasks.yaml after each phase, Completed and Blocked tasks count as 'done'"
      rationale: "Blocked tasks are intentionally blocked, treating them as actionable would cause infinite loops"
      alternatives_considered:
        - "Only count Completed tasks (would block on intentionally blocked tasks)"
        - "Add new 'Skipped' status (schema change out of scope)"

    - topic: "Phase state tracking"
      decision: "Extend existing retry.json structure with phase-level tracking"
      rationale: "Reuses existing atomic file write pattern, maintains single source of truth"
      alternatives_considered:
        - "Separate phase state file (adds complexity, potential sync issues)"
        - "Track only in memory (loses state on interrupt)"

    - topic: "Flag mutual exclusivity"
      decision: "Use Cobra's MarkFlagsMutuallyExclusive for --phases, --phase, --from-phase"
      rationale: "Built-in Cobra feature, provides clear error messages"
      alternatives_considered:
        - "Manual validation in RunE (more code, less standard)"

data_model:
  entities:
    - name: "PhaseExecutionState"
      description: "Tracks progress through phased implementation"
      fields:
        - name: "spec_name"
          type: "string"
          description: "Spec being implemented"
          constraints: "Not empty"
        - name: "current_phase"
          type: "int"
          description: "Currently executing phase number"
          constraints: ">= 1"
        - name: "total_phases"
          type: "int"
          description: "Total phases in tasks.yaml"
          constraints: ">= 1"
        - name: "completed_phases"
          type: "[]int"
          description: "Phase numbers that are fully complete"
          constraints: "Each value >= 1 and <= total_phases"
        - name: "last_phase_attempt"
          type: "time.Time"
          description: "Timestamp of last phase attempt"
          constraints: "None"
      relationships:
        - target: "RetryStore"
          type: "embedded-in"
          description: "Phase state stored alongside retry state in retry.json"

    - name: "PhaseInfo"
      description: "Information about a single phase from tasks.yaml"
      fields:
        - name: "number"
          type: "int"
          description: "Phase number (1-based)"
          constraints: ">= 1"
        - name: "title"
          type: "string"
          description: "Phase title from tasks.yaml"
          constraints: "Not empty"
        - name: "total_tasks"
          type: "int"
          description: "Total tasks in this phase"
          constraints: ">= 0"
        - name: "completed_tasks"
          type: "int"
          description: "Tasks with Completed status"
          constraints: ">= 0"
        - name: "blocked_tasks"
          type: "int"
          description: "Tasks with Blocked status"
          constraints: ">= 0"
        - name: "actionable_tasks"
          type: "int"
          description: "Tasks with Pending or InProgress status"
          constraints: ">= 0"
      relationships:
        - target: "TasksYAML"
          type: "parsed-from"
          description: "Extracted from phases array in tasks.yaml"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "CLAUDE.md"
      description: "Update CLI command documentation with new phase flags"
  source_code:
    - path: "internal/cli/implement.go"
      description: "Add --phases, --phase, --from-phase flags and validation"
    - path: "internal/workflow/workflow.go"
      description: "Extend ExecuteImplement with phased execution logic"
    - path: "internal/workflow/phase_execution.go"
      description: "New file for phase-specific execution helpers"
    - path: "internal/validation/tasks_yaml.go"
      description: "Add GetPhaseInfo() and IsPhaseComplete() functions"
    - path: "internal/retry/retry.go"
      description: "Add PhaseState struct and phase tracking methods"
    - path: ".claude/commands/autospec.implement.md"
      description: "Update slash command to accept optional phase filter parameter"
  tests:
    - path: "internal/cli/implement_test.go"
      description: "CLI flag validation and argument parsing tests"
    - path: "internal/workflow/workflow_test.go"
      description: "Phased execution workflow tests"
    - path: "internal/workflow/phase_execution_test.go"
      description: "Phase-specific helper function tests"
    - path: "internal/validation/tasks_yaml_test.go"
      description: "Phase info extraction and completion check tests"
    - path: "internal/retry/retry_test.go"
      description: "Phase state persistence tests"

implementation_phases:
  - phase: 1
    name: "Foundation - Phase Parsing and Validation"
    goal: "Add functions to parse phase information from tasks.yaml and determine completion status"
    deliverables:
      - "GetPhaseInfo() function returning phase metadata"
      - "IsPhaseComplete() function checking Completed/Blocked status"
      - "GetActionablePhases() function returning phases with work to do"
      - "Unit tests for all phase parsing functions"

  - phase: 2
    name: "State Management - Phase Tracking in Retry State"
    goal: "Extend retry state to track phase-level execution progress"
    dependencies:
      - "Phase 1"
    deliverables:
      - "PhaseState struct for tracking phase execution"
      - "LoadPhaseState/SavePhaseState functions"
      - "Integration with existing retry.json atomic writes"
      - "Unit tests for phase state persistence"

  - phase: 3
    name: "CLI Flags - Add Phase Selection Options"
    goal: "Add --phases, --phase, and --from-phase flags to implement command"
    dependencies:
      - "Phase 1"
    deliverables:
      - "--phases flag for sequential phase execution"
      - "--phase <N> flag for single phase execution"
      - "--from-phase <N> flag for execution from specific phase"
      - "Mutual exclusivity validation"
      - "CLI help text and examples"
      - "Unit tests for flag parsing"

  - phase: 4
    name: "Workflow Orchestration - Phased Execution"
    goal: "Implement the core phased execution loop in workflow orchestrator"
    dependencies:
      - "Phase 1"
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "ExecuteImplementWithPhases() function"
      - "ExecuteImplementSinglePhase() function"
      - "ExecuteImplementFromPhase() function"
      - "Phase completion validation between transitions"
      - "Progress display showing current phase"
      - "Skip already-completed phases message"
      - "Integration tests for phased workflows"

  - phase: 5
    name: "Slash Command - Phase Filter Support"
    goal: "Update /autospec.implement to accept optional phase parameter"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Modified slash command accepting phase number"
      - "Task filtering by phase in slash command"
      - "Documentation updates"

  - phase: 6
    name: "Polish - Documentation and Edge Cases"
    goal: "Update documentation and handle all edge cases"
    dependencies:
      - "Phase 5"
    deliverables:
      - "CLAUDE.md updates with new flags"
      - "Error handling for invalid phase numbers"
      - "Empty phase handling"
      - "Single-phase tasks.yaml handling"
      - "Legacy format (no phases array) handling"
      - "make fmt verification"

risks:
  - risk: "Phase state corruption on interrupt"
    likelihood: "low"
    impact: "medium"
    mitigation: "Use existing atomic write pattern (temp file + rename)"

  - risk: "Backward compatibility regression"
    likelihood: "medium"
    impact: "high"
    mitigation: "Extensive tests for default (no flags) behavior, CI verification"

  - risk: "Incorrect phase completion detection"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Comprehensive tests including edge cases with Blocked tasks"

  - risk: "Progress display interference with Claude output"
    likelihood: "low"
    impact: "low"
    mitigation: "Reuse existing progress display patterns, test in TTY and non-TTY modes"

open_questions:
  - question: "Should --phases be the default in a future version?"
    context: "Single-session execution has known context pollution issues"
    proposed_resolution: "Keep default for backward compatibility, document benefits of --phases for large projects"

  - question: "Should phase-level retry limits be separate from task-level?"
    context: "A phase might fail multiple times due to flaky tasks"
    proposed_resolution: "Out of scope for this feature, use existing task-level retry limits"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T07:26:59Z"
  artifact_type: "plan"
