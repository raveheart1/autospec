plan:
  branch: "104-changelog-yaml"
  created: "2026-01-16"
  spec_path: "specs/104-changelog-yaml/spec.yaml"

summary: |
  This plan implements a YAML-first changelog management system for autospec.
  The core approach is to establish CHANGELOG.yaml as the single source of truth,
  with CHANGELOG.md generated from it. The implementation creates a new
  internal/changelog package with types, parser, renderer, and CLI integration.

  Key technical decisions: use go:embed for embedding changelog in binary,
  leverage existing YAML patterns from internal/yaml package, follow Keep a
  Changelog format for markdown generation, and integrate with existing CLI
  patterns using Cobra commands. The feature adds make targets for sync/check
  workflows and updates slash commands to use the new YAML-first approach.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing and serialization (already in use)"
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework (already in use)"
    - name: "github.com/fatih/color"
      version: "v1.16.0"
      purpose: "Terminal color output (already in use)"
    - name: "embed"
      version: "stdlib"
      purpose: "Embedding CHANGELOG.yaml in binary at build time"
  storage: "File-based (internal/changelog/changelog.yaml)"
  testing:
    framework: "testing + testify"
    approach: "Unit tests with map-based table tests, E2E tests with mock binary"
  target_platform: "Linux, macOS (WSL for Windows)"
  project_type: "cli"
  performance_goals: "YAML parsing <10ms for files up to 1000 entries"
  constraints:
    - "Must maintain backward compatibility with existing CHANGELOG.md consumers"
    - "Embedded changelog increases binary size (acceptable)"
    - "CHANGELOG.yaml must live at internal/changelog/changelog.yaml for go:embed"
    - "CI must run changelog-check to enforce sync"
  scale_scope: "Single project changelog, ~50-100 versions over project lifetime"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "All new packages will have comprehensive tests written before implementation"
    - name: "Idiomatic Go"
      status: "PASS"
      notes: "Follow existing patterns: error wrapping, table tests, <40 line functions"
    - name: "Performance Standards"
      status: "PASS"
      notes: "YAML parsing benchmarked to meet <10ms requirement"
    - name: "Idempotent Operations"
      status: "PASS"
      notes: "make changelog-sync produces identical output on repeated runs"
    - name: "Validation-First Workflow"
      status: "PASS"
      notes: "Schema validation before proceeding with sync/extract operations"
    - name: "Command Template Independence"
      status: "N/A"
      notes: "This feature adds CLI commands, not command templates"
    - name: "Actionable Errors"
      status: "PASS"
      notes: "Parser errors include line numbers and expected format hints"
    - name: "Schema-Driven Artifacts"
      status: "PASS"
      notes: "CHANGELOG.yaml validated against defined schema"

research_findings:
  decisions:
    - topic: "CHANGELOG.yaml location for go:embed"
      decision: "internal/changelog/changelog.yaml"
      rationale: "Direct embedding without build-time copy, follows Go embed patterns"
      alternatives_considered:
        - "Root-level CHANGELOG.yaml (requires build-time copy)"
        - ".autospec/changelog.yaml (non-standard location)"
    - topic: "Version identifier format in YAML"
      decision: "Bare semver without 'v' prefix (e.g., '0.6.0')"
      rationale: "Cleaner data format; CLI normalizes 'v' prefix on input"
      alternatives_considered:
        - "Store with 'v' prefix"
        - "Support both formats in storage"
    - topic: "Terminal output styling"
      decision: "Color-coded categories with icons using fatih/color"
      rationale: "Consistent with existing CLI output patterns, respects NO_COLOR"
      alternatives_considered:
        - "Plain text only"
        - "Custom terminal styling library"
    - topic: "GitHub release extraction approach"
      decision: "Subcommand: autospec changelog extract <version>"
      rationale: "Unified CLI experience, replaces bash script"
      alternatives_considered:
        - "Separate extract-changelog binary"
        - "Direct make target calling Go code"
    - topic: "Remote changelog fetch for ck command"
      decision: "Fetch from GitHub raw URL with graceful fallback"
      rationale: "Shows preview of unreleased changes when update available"
      alternatives_considered:
        - "Skip remote fetch entirely"
        - "Embed unreleased in next version tag"

data_model:
  entities:
    - name: "Changelog"
      description: "Root structure representing the entire changelog"
      fields:
        - name: "Project"
          type: "string"
          description: "Project identifier (e.g., 'autospec')"
          constraints: "Required, non-empty"
        - name: "Versions"
          type: "[]Version"
          description: "Ordered list of versions, newest first"
          constraints: "At most one 'unreleased' entry"
      relationships:
        - target: "Version"
          type: "one-to-many"
          description: "Changelog contains multiple versions"
    - name: "Version"
      description: "Single version entry with release metadata"
      fields:
        - name: "Version"
          type: "string"
          description: "Bare semver (e.g., '0.6.0') or 'unreleased'"
          constraints: "Required, valid semver or 'unreleased'"
        - name: "Date"
          type: "string"
          description: "Release date in YYYY-MM-DD format"
          constraints: "Required for released versions, empty for unreleased"
        - name: "Changes"
          type: "Changes"
          description: "Categorized change entries"
          constraints: "At least one non-empty category"
      relationships:
        - target: "Changes"
          type: "one-to-one"
          description: "Each version has one changes block"
    - name: "Changes"
      description: "Grouped change entries by Keep a Changelog category"
      fields:
        - name: "Added"
          type: "[]string"
          description: "New features"
          constraints: "Optional, each entry non-empty"
        - name: "Changed"
          type: "[]string"
          description: "Changes to existing features"
          constraints: "Optional, each entry non-empty"
        - name: "Fixed"
          type: "[]string"
          description: "Bug fixes"
          constraints: "Optional, each entry non-empty"
        - name: "Removed"
          type: "[]string"
          description: "Removed features"
          constraints: "Optional, each entry non-empty"
        - name: "Deprecated"
          type: "[]string"
          description: "Soon-to-be-removed features"
          constraints: "Optional, each entry non-empty"
        - name: "Security"
          type: "[]string"
          description: "Security-related changes"
          constraints: "Optional, each entry non-empty"
      relationships: []
    - name: "Entry"
      description: "Flattened view of a single changelog entry for querying"
      fields:
        - name: "Text"
          type: "string"
          description: "User-facing description"
          constraints: "Required, non-empty"
        - name: "Category"
          type: "string"
          description: "Change category (added, changed, fixed, etc.)"
          constraints: "Required, one of six valid categories"
        - name: "Version"
          type: "string"
          description: "Containing version identifier"
          constraints: "Required"
      relationships:
        - target: "Version"
          type: "many-to-one"
          description: "Multiple entries belong to one version"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/changelog-yaml.md"
      description: "User documentation for YAML-first changelog workflow"
    - path: ".dev/tasks/104-changelog-yaml.md"
      description: "Manual testing plan for this feature"
  source_code:
    - path: "internal/changelog/"
      description: "Core changelog package with types, parser, renderer"
    - path: "internal/changelog/changelog.yaml"
      description: "YAML source file (embedded in binary)"
    - path: "internal/changelog/embed.go"
      description: "go:embed directive for CHANGELOG.yaml"
    - path: "internal/changelog/types.go"
      description: "Go types for Changelog, Version, Changes, Entry"
    - path: "internal/changelog/parser.go"
      description: "YAML parsing and validation"
    - path: "internal/changelog/render.go"
      description: "Markdown generation following Keep a Changelog"
    - path: "internal/changelog/query.go"
      description: "Query functions for getting entries by version, last N"
    - path: "internal/cli/changelog.go"
      description: "CLI changelog command with subcommands"
    - path: ".claude/commands/changelog.md"
      description: "Updated slash command for YAML-first workflow"
    - path: ".claude/commands/release.md"
      description: "Updated release command for YAML-first workflow"
  tests:
    - path: "internal/changelog/*_test.go"
      description: "Unit tests for changelog package"
    - path: "internal/changelog/parser_bench_test.go"
      description: "Benchmark tests for <10ms parsing requirement"
    - path: "tests/e2e/changelog_test.go"
      description: "E2E tests for changelog CLI commands"

implementation_phases:
  - phase: 1
    name: "Core Data Types and Parser"
    goal: "Establish CHANGELOG.yaml schema and parsing infrastructure"
    deliverables:
      - "internal/changelog/types.go with Changelog, Version, Changes structs"
      - "internal/changelog/parser.go with Load, Validate functions"
      - "internal/changelog/parser_test.go with comprehensive validation tests"
      - "internal/changelog/parser_bench_test.go for <10ms verification"
  - phase: 2
    name: "Markdown Renderer and Migration"
    goal: "Generate CHANGELOG.md from YAML and migrate existing content"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/changelog/render.go with RenderMarkdown function"
      - "internal/changelog/render_test.go with format verification"
      - "internal/changelog/changelog.yaml migrated from existing CHANGELOG.md"
      - "Makefile targets: changelog-sync, changelog-check"
  - phase: 3
    name: "CLI Commands and Embedding"
    goal: "Implement autospec changelog command with subcommands"
    dependencies:
      - "Phase 2"
    deliverables:
      - "internal/changelog/embed.go with go:embed directive"
      - "internal/changelog/query.go for version/entry lookups"
      - "internal/cli/changelog.go with view, extract subcommands"
      - "internal/cli/changelog_test.go with unit tests"
      - "--plain flag for machine-readable output"
      - "--last N flag for entry count"
  - phase: 4
    name: "Update and Check Integration"
    goal: "Display changelog in update/ck commands"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Update internal/cli/util/check.go to show changelog preview"
      - "Update internal/update/ to show changelog after successful update"
      - "Remote changelog fetch with graceful fallback"
  - phase: 5
    name: "Slash Commands and Documentation"
    goal: "Update /changelog and /release commands for YAML-first workflow"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Updated .claude/commands/changelog.md"
      - "Updated .claude/commands/release.md"
      - "CLAUDE.md updated with YAML-first workflow note"
      - "docs/public/changelog-yaml.md user documentation"
  - phase: 6
    name: "E2E Tests and Cleanup"
    goal: "Comprehensive testing and removal of deprecated scripts"
    dependencies:
      - "Phase 5"
    deliverables:
      - "tests/e2e/changelog_test.go with real binary tests"
      - "Remove .release/extract-changelog.sh"
      - "Update .github/workflows/*.yml to use Go extractor"
      - ".dev/tasks/104-changelog-yaml.md manual testing plan"
      - "CHANGELOG.md updated with feature entry"

open_questions:
  - question: "Should changelog-check be added to CI pre-commit?"
    context: "Enforces sync but adds CI step"
    proposed_resolution: "Add to CI but not to local pre-commit to avoid friction"
  - question: "How to handle very old versions with different format?"
    context: "Early versions may have inconsistent entry format"
    proposed_resolution: "Migration normalizes format; preserve content verbatim where possible"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "0.9.0"
  created: "2026-01-16"
  artifact_type: "plan"
