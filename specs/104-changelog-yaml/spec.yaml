feature:
  branch: "104-changelog-yaml"
  created: "2026-01-16"
  status: "Draft"
  input: "create spec for .dev/tasks/changelog-yaml-feature.md comprehensive"

user_stories:
  - id: "US-001"
    title: "Edit changelog in structured YAML format"
    priority: "P1"
    as_a: "developer maintaining autospec"
    i_want: "to edit changelog entries in a structured YAML file"
    so_that: "entries are consistent, validated, and easier to manage than free-form markdown"
    why_this_priority: "Core functionality - YAML becomes the single source of truth for all changelog operations"
    independent_test: "Edit internal/changelog/changelog.yaml, verify it parses correctly and validates against schema"
    acceptance_scenarios:
      - given: "a valid CHANGELOG.yaml file exists at internal/changelog/changelog.yaml"
        when: "I add a new entry under unreleased.changes.added"
        then: "the entry is preserved and can be queried"
      - given: "CHANGELOG.yaml has invalid syntax"
        when: "I attempt to load it"
        then: "I receive a clear error message indicating the issue location"
      - given: "CHANGELOG.yaml has valid syntax but invalid schema"
        when: "I attempt to validate it"
        then: "I receive validation errors specifying which fields are invalid"

  - id: "US-002"
    title: "Auto-generate CHANGELOG.md from YAML"
    priority: "P1"
    as_a: "developer"
    i_want: "CHANGELOG.md to be automatically generated from CHANGELOG.yaml"
    so_that: "the markdown file is always in sync and I never have to manually format it"
    why_this_priority: "Essential for maintaining single source of truth - prevents drift between YAML and MD"
    independent_test: "Run make changelog-sync and verify CHANGELOG.md matches YAML content"
    acceptance_scenarios:
      - given: "CHANGELOG.yaml contains multiple versions with changes"
        when: "I run make changelog-sync"
        then: "CHANGELOG.md is generated with proper Keep a Changelog formatting"
      - given: "CHANGELOG.md exists and matches CHANGELOG.yaml"
        when: "I run make changelog-check"
        then: "the check passes with no errors"
      - given: "CHANGELOG.md is out of sync with CHANGELOG.yaml"
        when: "I run make changelog-check"
        then: "the check fails with a clear diff or message"

  - id: "US-003"
    title: "View changelog via CLI command"
    priority: "P1"
    as_a: "user of autospec"
    i_want: "to view changelog entries using autospec changelog command"
    so_that: "I can see recent changes without opening files or visiting GitHub"
    why_this_priority: "Key user-facing feature that makes the YAML migration worthwhile for end users"
    independent_test: "Run autospec changelog and verify it displays embedded changelog entries"
    acceptance_scenarios:
      - given: "autospec binary has embedded changelog"
        when: "I run autospec changelog"
        then: "I see the 5 most recent entries formatted for terminal"
      - given: "I want to see a specific version"
        when: "I run autospec changelog v0.5.0"
        then: "I see all changes for that version only"
      - given: "I want unreleased changes"
        when: "I run autospec changelog unreleased"
        then: "I see all pending unreleased changes"
      - given: "I want more entries"
        when: "I run autospec changelog --last 10"
        then: "I see the 10 most recent entries across versions"
      - given: "I want machine-readable output"
        when: "I run autospec changelog --plain"
        then: "I see plain text without formatting or colors"

  - id: "US-004"
    title: "See what changed after update"
    priority: "P2"
    as_a: "user who just updated autospec"
    i_want: "to see what's new in the version I just installed"
    so_that: "I understand new features and breaking changes immediately"
    why_this_priority: "Improves user experience but not essential for core YAML functionality"
    independent_test: "Run autospec update (mocked), verify changelog entries display for new version"
    acceptance_scenarios:
      - given: "I have version 0.5.0 installed"
        when: "autospec update successfully installs 0.6.0"
        then: "I see a summary of changes in 0.6.0 after the update confirmation"
      - given: "the update shows changes"
        when: "I want more details"
        then: "the output suggests running autospec changelog <version> for full details"

  - id: "US-005"
    title: "Preview changes when update available"
    priority: "P2"
    as_a: "user checking for updates"
    i_want: "to see highlights of what's new when an update is available"
    so_that: "I can decide whether to update based on the changes"
    why_this_priority: "Enhances update workflow but depends on network access for remote changelog"
    independent_test: "Run autospec ck when update available, verify changelog highlights display"
    acceptance_scenarios:
      - given: "I have version 0.5.0 and 0.6.0 is available"
        when: "I run autospec ck"
        then: "I see update notification with 2-3 highlight entries from 0.6.0"
      - given: "the highlights are truncated"
        when: "more changes exist"
        then: "I see a count like '3 more changes...' and suggestion to view full changelog"

  - id: "US-006"
    title: "Extract release notes for GitHub releases"
    priority: "P1"
    as_a: "release manager"
    i_want: "GitHub releases to automatically use YAML changelog for release descriptions"
    so_that: "release notes are consistent and derived from the authoritative source"
    why_this_priority: "Critical for CI/CD pipeline - replaces fragile bash parsing with structured extraction"
    independent_test: "Run autospec changelog extract v0.6.0, verify it outputs correct markdown for that version"
    acceptance_scenarios:
      - given: "CHANGELOG.yaml contains version 0.6.0 with changes"
        when: "CI runs the release workflow for tag v0.6.0"
        then: "GitHub release description contains all changes from that version"
      - given: "extraction is requested for a non-existent version"
        when: "the extraction tool runs"
        then: "it fails with a clear error message"

  - id: "US-007"
    title: "Draft changelog entries from commits"
    priority: "P2"
    as_a: "developer using /changelog command"
    i_want: "the slash command to add entries to CHANGELOG.yaml and sync to markdown"
    so_that: "I follow the new YAML-first workflow consistently"
    why_this_priority: "Updates existing workflow but not blocking for initial YAML adoption"
    independent_test: "Run /changelog command, verify entries added to YAML and MD synced"
    acceptance_scenarios:
      - given: "I have commits ready to document"
        when: "I run /changelog"
        then: "entries are drafted and added to CHANGELOG.yaml under unreleased"
      - given: "entries are added to YAML"
        when: "/changelog completes"
        then: "make changelog-sync is run to update CHANGELOG.md"

  - id: "US-008"
    title: "Release workflow uses YAML source"
    priority: "P2"
    as_a: "developer using /release command"
    i_want: "the release command to update CHANGELOG.yaml instead of editing markdown directly"
    so_that: "releases follow the YAML-first workflow"
    why_this_priority: "Updates existing workflow - can be done after initial YAML infrastructure"
    independent_test: "Run /release command, verify YAML updated and MD regenerated"
    acceptance_scenarios:
      - given: "CHANGELOG.yaml has unreleased changes"
        when: "I run /release with version 0.6.0"
        then: "unreleased is renamed to 0.6.0 with today's date in YAML"
      - given: "version is moved from unreleased"
        when: "/release completes"
        then: "a new empty unreleased section is added at the top"
      - given: "YAML is updated"
        when: "/release completes"
        then: "make changelog-sync regenerates CHANGELOG.md"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST parse CHANGELOG.yaml from internal/changelog/changelog.yaml with validation against defined schema"
      testable: true
      acceptance_criteria: "Parser loads valid YAML without errors; returns specific errors for invalid schema"

    - id: "FR-002"
      description: "MUST support Keep a Changelog categories: added, changed, fixed, removed, deprecated, security"
      testable: true
      acceptance_criteria: "All six categories can be used in YAML and render correctly to markdown"

    - id: "FR-003"
      description: "MUST treat 'unreleased' as special version identifier without date requirement"
      testable: true
      acceptance_criteria: "unreleased version validates without date; other versions require date"

    - id: "FR-004"
      description: "MUST generate CHANGELOG.md following Keep a Changelog format from YAML source"
      testable: true
      acceptance_criteria: "Generated markdown matches Keep a Changelog specification with proper headers and formatting"

    - id: "FR-005"
      description: "MUST provide make changelog-sync target to regenerate CHANGELOG.md from YAML"
      testable: true
      acceptance_criteria: "Running make changelog-sync updates CHANGELOG.md to match current YAML state"

    - id: "FR-006"
      description: "MUST provide make changelog-check target to validate CHANGELOG.md matches YAML"
      testable: true
      acceptance_criteria: "Check passes when in sync; fails with useful output when out of sync"

    - id: "FR-007"
      description: "MUST implement autospec changelog command with version, --last, and --plain flags"
      testable: true
      acceptance_criteria: "Command displays entries according to flags; handles missing versions gracefully"

    - id: "FR-008"
      description: "MUST embed CHANGELOG.yaml in binary at build time using go:embed"
      testable: true
      acceptance_criteria: "autospec changelog works without network access; shows entries up to build time"

    - id: "FR-009"
      description: "MUST provide autospec changelog extract <version> subcommand for GitHub release workflow"
      testable: true
      acceptance_criteria: "Subcommand extracts specific version's changes as markdown to stdout; returns error for missing versions"

    - id: "FR-010"
      description: "MUST display changelog summary after successful autospec update"
      testable: true
      acceptance_criteria: "Update completion shows new version's highlights with suggestion for full changelog"

    - id: "FR-011"
      description: "MUST show changelog preview in autospec ck when update available"
      testable: true
      acceptance_criteria: "Update check shows 2-3 highlight entries with truncation indicator if more exist"

    - id: "FR-012"
      description: "MUST update /changelog slash command to edit YAML and run sync"
      testable: true
      acceptance_criteria: "Command adds entries to CHANGELOG.yaml and runs make changelog-sync"

    - id: "FR-013"
      description: "MUST update /release slash command to modify YAML, sync, and use Go extractor"
      testable: true
      acceptance_criteria: "Release workflow updates YAML, regenerates MD, validates extraction"

    - id: "FR-014"
      description: "MUST update CLAUDE.md with concise note about YAML-first changelog workflow (edit internal/changelog/changelog.yaml, run make changelog-sync)"
      testable: true
      acceptance_criteria: "CLAUDE.md contains brief instructions for YAML-first changelog workflow without excessive detail"

    - id: "FR-015"
      description: "MUST migrate existing CHANGELOG.md content to CHANGELOG.yaml format"
      testable: true
      acceptance_criteria: "All existing versions and entries preserved in YAML; regenerated MD matches original"

    - id: "FR-016"
      description: "MUST deprecate and remove .release/extract-changelog.sh after migration"
      testable: true
      acceptance_criteria: "Bash script removed; release workflow uses Go extractor"

    - id: "FR-017"
      description: "SHOULD fetch remote changelog in autospec ck for preview of unreleased versions"
      testable: true
      acceptance_criteria: "When network available, ck can show changes from GitHub; graceful fallback when offline"

    - id: "FR-018"
      description: "MUST include at least one E2E test that exercises the real compiled binary with the changelog command"
      testable: true
      acceptance_criteria: "E2E test builds binary, runs autospec changelog subcommands, and verifies expected output"

  non_functional:
    - id: "NFR-001"
      category: "code_quality"
      description: "All functions MUST be under 40 lines"
      measurable_target: "No function exceeds 40 lines; extract helpers as needed"

    - id: "NFR-002"
      category: "code_quality"
      description: "All errors MUST be wrapped with context using fmt.Errorf"
      measurable_target: "No bare return err; all errors include operation context"

    - id: "NFR-003"
      category: "code_quality"
      description: "All tests MUST use map-based table test pattern"
      measurable_target: "Tests use map[string]struct pattern with t.Run"

    - id: "NFR-004"
      category: "code_quality"
      description: "Functions MUST accept interfaces and return concrete types"
      measurable_target: "Interface parameters where appropriate; concrete return types"

    - id: "NFR-005"
      category: "performance"
      description: "CHANGELOG.yaml parsing MUST complete in under 10ms for files up to 1000 entries"
      measurable_target: "Parse time < 10ms for typical changelog size"

    - id: "NFR-006"
      category: "reliability"
      description: "Changelog sync MUST be idempotent"
      measurable_target: "Running sync multiple times produces identical output"

    - id: "NFR-007"
      category: "usability"
      description: "CLI changelog output MUST use color-coded categories with icons (Added=green ✓, Fixed=yellow ⚡, Changed=blue, Removed/Deprecated=red, Security=magenta) and be readable in 80-column terminal"
      measurable_target: "Output uses consistent colors/icons per category; wraps appropriately; --plain flag disables styling"

    - id: "NFR-008"
      category: "code_quality"
      description: "Build MUST pass: make test && make fmt && make lint && make build"
      measurable_target: "All four make targets exit with code 0"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Developers can add changelog entries by editing only CHANGELOG.yaml"
      metric: "Number of files requiring manual edit for changelog update"
      target: "1 file (CHANGELOG.yaml only)"

    - id: "SC-002"
      description: "CHANGELOG.md stays synchronized with CHANGELOG.yaml"
      metric: "CI validation success rate for changelog sync"
      target: "100% of builds pass changelog-check"

    - id: "SC-003"
      description: "Users can view changelog without internet access"
      metric: "autospec changelog command success rate when offline"
      target: "100% success with embedded changelog"

    - id: "SC-004"
      description: "GitHub releases contain accurate version-specific release notes"
      metric: "Release notes match CHANGELOG.yaml content for tagged version"
      target: "100% match between extracted notes and YAML source"

    - id: "SC-005"
      description: "Users are informed of changes after updating autospec"
      metric: "Changelog display rate after successful update"
      target: "100% of successful updates show changelog summary"

    - id: "SC-006"
      description: "Update availability includes change preview"
      metric: "Changelog preview display rate when update available"
      target: "100% of update-available notifications include highlights"

key_entities:
  - name: "Changelog"
    description: "Root structure representing the entire changelog with project name and version list"
    attributes:
      - "project: string - project identifier"
      - "versions: []Version - ordered list of versions (newest first)"

  - name: "Version"
    description: "Single version entry containing release metadata and categorized changes"
    attributes:
      - "version: string - bare semantic version (no 'v' prefix) or 'unreleased'; CLI accepts 'v' prefix and normalizes"
      - "date: string - release date in YYYY-MM-DD format (optional for unreleased)"
      - "changes: Changes - categorized change entries"

  - name: "Changes"
    description: "Grouped change entries by Keep a Changelog category"
    attributes:
      - "added: []string - new features"
      - "changed: []string - changes to existing features"
      - "fixed: []string - bug fixes"
      - "removed: []string - removed features"
      - "deprecated: []string - soon-to-be-removed features"
      - "security: []string - security-related changes"

  - name: "Entry"
    description: "Single changelog entry with metadata for querying"
    attributes:
      - "text: string - user-facing description"
      - "category: string - change category"
      - "version: string - containing version"

edge_cases:
  - scenario: "CHANGELOG.yaml does not exist"
    expected_behavior: "Commands that require it fail with helpful error suggesting to create it or run migration"

  - scenario: "CHANGELOG.yaml is empty or has only project field"
    expected_behavior: "Parser succeeds with empty versions list; sync generates minimal valid markdown"

  - scenario: "Version requested in CLI does not exist"
    expected_behavior: "Command exits with error listing available versions"

  - scenario: "Multiple unreleased sections exist"
    expected_behavior: "Parser fails validation with error specifying only one unreleased allowed"

  - scenario: "Version date is malformed"
    expected_behavior: "Parser fails validation with error specifying expected date format (YYYY-MM-DD)"

  - scenario: "Network unavailable during autospec ck"
    expected_behavior: "Falls back to embedded changelog; shows message about limited preview"

  - scenario: "CHANGELOG.md has been manually edited and differs from YAML"
    expected_behavior: "make changelog-check fails; make changelog-sync overwrites with YAML-derived content"

  - scenario: "Binary built without embedded changelog"
    expected_behavior: "autospec changelog fails with clear error; update/ck work but skip changelog display"

  - scenario: "Release extraction for version not in YAML"
    expected_behavior: "autospec changelog extract exits non-zero with error listing available versions"

  - scenario: "Changelog entry contains markdown formatting"
    expected_behavior: "Formatting preserved in both YAML and generated markdown"

assumptions:
  - "Keep a Changelog format is the desired standard for CHANGELOG.md output"
  - "Semantic versioning is used for version identifiers; bare format in YAML (0.6.0), CLI normalizes 'v' prefix on input"
  - "Versions in CHANGELOG.yaml are ordered newest-first"
  - ".autospec/ directory exists and is the appropriate location for project state"
  - "go:embed directly embeds internal/changelog/changelog.yaml (no build-time copy needed)"
  - "GitHub raw URLs are reliable for fetching remote changelog in ck command"
  - "Users accept that offline changelog in binary only shows changes up to build time"
  - "YAML is preferred over JSON or TOML for human-editable configuration"
  - "Slash command updates can be done incrementally after core infrastructure"

constraints:
  - "Must maintain backward compatibility with existing CHANGELOG.md consumers"
  - "Embedded changelog increases binary size (acceptable for changelog files)"
  - "Remote changelog fetch requires network access (acceptable for ck only)"
  - "CHANGELOG.yaml lives at internal/changelog/changelog.yaml for direct go:embed (no build-time copy needed)"
  - "CI must run changelog-check to enforce sync"
  - "Existing .release/extract-changelog.sh must continue working until Go replacement is validated"

out_of_scope:
  - "Changelog validation rules beyond schema (e.g., entry quality, completeness)"
  - "Automatic changelog generation from git commits (remains manual with /changelog command)"
  - "Changelog translation or localization"
  - "Changelog search or filtering by keyword in CLI"
  - "Changelog notification system (e.g., email, webhooks)"
  - "Breaking change detection or migration guides in changelog"
  - "Changelog history or audit trail beyond git"
  - "Web UI for changelog viewing or editing"
  - "Changelog aggregation from multiple sources or subprojects"
  - "Integration with external changelog services (e.g., Changelogfy, Release Notes)"

clarifications:
  - date: "2026-01-17"
    question: "Where should CHANGELOG.yaml live in the autospec repository for embedding into the binary?"
    answer: "internal/changelog/changelog.yaml - in the changelog package for direct go:embed, syncs to update root CHANGELOG.md"
    applied_to: "FR-001, US-001, constraints"

  - date: "2026-01-17"
    question: "What terminal styling should be used for changelog CLI output categories?"
    answer: "Color-coded categories with icons (Added=green ✓, Fixed=yellow ⚡, Changed=blue, Removed/Deprecated=red, Security=magenta)"
    applied_to: "NFR-007, US-003"

  - date: "2026-01-17"
    question: "How detailed should the CLAUDE.md changelog workflow documentation be?"
    answer: "Concise - just note to edit internal/changelog/changelog.yaml and run make changelog-sync"
    applied_to: "FR-014"

  - date: "2026-01-17"
    question: "Should GitHub release extraction be a separate binary or subcommand?"
    answer: "Subcommand: autospec changelog extract <version> for unified CLI"
    applied_to: "FR-009, US-006"

  - date: "2026-01-17"
    question: "Should version identifiers require the 'v' prefix?"
    answer: "Accept both in CLI (v0.6.0 or 0.6.0), store bare semver in YAML, normalize on input"
    applied_to: "key_entities (Version), FR-007, assumptions"

  - date: "2026-01-17"
    question: "Should E2E tests be added for the changelog command?"
    answer: "Yes, at least one E2E test exercising the real compiled binary with changelog subcommands"
    applied_to: "FR-018 (new requirement)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.9.0"
  created: "2026-01-16T23:56:05Z"
  artifact_type: "spec"
