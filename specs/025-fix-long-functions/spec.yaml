feature:
  branch: "025-fix-long-functions"
  created: "2025-12-16"
  status: "Draft"
  input: "Fix all the long functions listed in .dev/tasks/best-practices-audit.md but only the 'Critical (>100 lines)' and 'Serious (80-100 lines)' ones"

user_stories:
  - id: "US-001"
    title: "Refactor critical long functions in workflow package"
    priority: "P1"
    as_a: "developer maintaining the autospec codebase"
    i_want: "the workflow orchestration functions to be refactored into smaller, focused helper functions"
    so_that: "the code is more readable, testable, and maintainable following Go best practices"
    why_this_priority: "Workflow package contains core orchestration logic with the most severe violations (125, 117, 102, 90, 81 lines). These are critical paths that need immediate attention."
    independent_test: "Each refactored function can be unit tested in isolation. The existing workflow tests should pass after refactoring."
    acceptance_scenarios:
      - given: "the function ExecuteImplementWithTasks in workflow.go has 125 lines"
        when: "refactoring is complete"
        then: "the function is split into helper functions, with no single function exceeding 40 lines"
      - given: "the function ExecutePhase in executor.go has 117 lines"
        when: "refactoring is complete"
        then: "the function is broken into pre-execute, execute, and post-execute helpers, each under 40 lines"
      - given: "the function RunFullWorkflow in workflow.go has 102 lines"
        when: "refactoring is complete"
        then: "the orchestration logic is extracted into focused helper functions"

  - id: "US-002"
    title: "Refactor critical long functions in CLI package"
    priority: "P1"
    as_a: "developer maintaining the autospec codebase"
    i_want: "the oversized CLI command functions to be refactored into smaller helpers"
    so_that: "CLI commands follow the project's 40-line function guideline and are easier to test"
    why_this_priority: "CLI commands runNewFeature (108 lines) and runUninstall (110 lines) exceed 100 lines and violate the best practices significantly."
    independent_test: "Each CLI command can be tested by running the existing CLI tests after refactoring."
    acceptance_scenarios:
      - given: "the function runNewFeature in new_feature.go has 108 lines"
        when: "refactoring is complete"
        then: "the function extracts validation, git operations, and output formatting into separate helpers"
      - given: "the function runUninstall in uninstall.go has 110 lines"
        when: "refactoring is complete"
        then: "the function extracts confirmation prompts, file removal logic, and reporting into separate helpers"

  - id: "US-003"
    title: "Refactor critical long function in config package"
    priority: "P1"
    as_a: "developer maintaining the autospec codebase"
    i_want: "the LoadWithOptions function to be refactored into smaller, focused functions"
    so_that: "configuration loading logic is easier to understand and test"
    why_this_priority: "Configuration loading is used throughout the application and at 105 lines is a critical violation."
    independent_test: "The existing config tests should pass after refactoring."
    acceptance_scenarios:
      - given: "the function LoadWithOptions in config.go has 105 lines"
        when: "refactoring is complete"
        then: "the function is split into helpers for loading defaults, files, and environment variables"

  - id: "US-004"
    title: "Refactor serious long functions in workflow package"
    priority: "P2"
    as_a: "developer maintaining the autospec codebase"
    i_want: "the serious (80-100 line) workflow functions to be refactored"
    so_that: "all workflow functions comply with the 40-line guideline"
    why_this_priority: "These functions (90 and 81 lines) are less critical than >100 line functions but still significantly exceed the guideline."
    independent_test: "Existing workflow tests should pass after refactoring."
    acceptance_scenarios:
      - given: "the function ExecuteImplementFromPhase in workflow.go has 90 lines"
        when: "refactoring is complete"
        then: "the function is split into focused helpers under 40 lines each"
      - given: "the function ExecuteImplementWithPhases in workflow.go has 81 lines"
        when: "refactoring is complete"
        then: "the function extracts phase iteration and execution logic into helpers"

  - id: "US-005"
    title: "Refactor serious long functions in CLI package"
    priority: "P2"
    as_a: "developer maintaining the autospec codebase"
    i_want: "the serious (80-100 line) CLI functions to be refactored"
    so_that: "CLI commands are consistent with project best practices"
    why_this_priority: "These CLI functions (90, 87, 79, 78 lines) are in the serious category but less critical than >100 line violations."
    independent_test: "CLI tests should pass after refactoring."
    acceptance_scenarios:
      - given: "the function runConfigMigrate in config.go has 90 lines"
        when: "refactoring is complete"
        then: "the function extracts migration logic into smaller helpers"
      - given: "the function runUpdateAgentContext in update_agent_context.go has 87 lines"
        when: "refactoring is complete"
        then: "the function extracts agent file updates into separate helpers"
      - given: "the function runInit in init.go has 79 lines"
        when: "refactoring is complete"
        then: "the function extracts initialization steps into helpers"
      - given: "the function executePhases in run.go has 78 lines"
        when: "refactoring is complete"
        then: "the function extracts phase execution logic into helpers"

  - id: "US-006"
    title: "Refactor serious long function in git package"
    priority: "P2"
    as_a: "developer maintaining the autospec codebase"
    i_want: "the GetAllBranches function to be refactored"
    so_that: "git utility functions comply with the 40-line guideline"
    why_this_priority: "GetAllBranches at 80 lines is in the serious category and should be addressed for consistency."
    independent_test: "Git package tests should pass after refactoring."
    acceptance_scenarios:
      - given: "the function GetAllBranches in git.go has 80 lines"
        when: "refactoring is complete"
        then: "the function extracts branch parsing and filtering into separate helpers"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST refactor all 6 Critical (>100 lines) functions to be under 40 lines each"
      testable: true
      acceptance_criteria: "No function in the Critical list exceeds 40 lines after refactoring"
    - id: "FR-002"
      description: "MUST refactor all 7 Serious (80-100 lines) functions to be under 40 lines each"
      testable: true
      acceptance_criteria: "No function in the Serious list exceeds 40 lines after refactoring"
    - id: "FR-003"
      description: "MUST preserve all existing functionality without changing external behavior"
      testable: true
      acceptance_criteria: "All existing tests pass after refactoring (go test ./...)"
    - id: "FR-004"
      description: "MUST extract helper functions with clear, descriptive names following Go naming conventions"
      testable: true
      acceptance_criteria: "Helper function names describe their single responsibility"
    - id: "FR-005"
      description: "SHOULD keep related helpers in the same file as the original function"
      testable: true
      acceptance_criteria: "Helper functions are co-located with calling functions unless a new file improves organization"
  non_functional:
    - id: "NFR-001"
      category: "reliability"
      description: "All existing tests MUST pass after refactoring"
      measurable_target: "100% test pass rate with go test ./..."
    - id: "NFR-002"
      category: "performance"
      description: "Refactoring MUST NOT introduce performance regressions"
      measurable_target: "Benchmark results within 10% of pre-refactor baseline"
    - id: "NFR-003"
      category: "usability"
      description: "Code readability MUST improve as measured by reduced cognitive complexity"
      measurable_target: "Each helper function has a single, clear responsibility"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "All 6 Critical functions are refactored to under 40 lines"
      metric: "Line count per function"
      target: "0 functions over 40 lines in the Critical list"
    - id: "SC-002"
      description: "All 7 Serious functions are refactored to under 40 lines"
      metric: "Line count per function"
      target: "0 functions over 40 lines in the Serious list"
    - id: "SC-003"
      description: "All existing tests continue to pass"
      metric: "Test pass rate"
      target: "100% pass rate with go test ./..."
    - id: "SC-004"
      description: "No new linting errors introduced"
      metric: "Linting output"
      target: "make lint passes with no new errors"

key_entities:
  - name: "Long Function"
    description: "A function that exceeds the 40-line guideline established in go-best-practices.md"
    attributes:
      - "file path"
      - "function name"
      - "current line count"
      - "severity (Critical >100, Serious 80-100)"
  - name: "Helper Function"
    description: "A small, focused function extracted from a larger function to improve readability"
    attributes:
      - "single responsibility"
      - "descriptive name"
      - "under 40 lines"

edge_cases:
  - scenario: "A refactored function still slightly exceeds 40 lines due to necessary error handling"
    expected_behavior: "Accept if the function is significantly improved and under 50 lines with justified error handling"
  - scenario: "Extracting helpers creates excessive function call overhead"
    expected_behavior: "Prioritize readability over micro-optimization; Go inlining handles small functions well"
  - scenario: "Helper functions need to be shared across multiple files"
    expected_behavior: "Create a new internal helper file or use existing utility patterns in the package"

assumptions:
  - "The line counts in best-practices-audit.md are accurate as of the audit date"
  - "Existing tests provide adequate coverage to validate refactoring correctness"
  - "The 40-line guideline is a soft target; slightly exceeding for readability is acceptable"
  - "No changes to public API signatures are needed; this is purely internal refactoring"
  - "Helper functions should be unexported (lowercase) unless they have broader utility"

constraints:
  - "Must not change external API signatures or command-line interface behavior"
  - "Must maintain backward compatibility with existing configuration and state files"
  - "Must work within the existing package structure"
  - "Refactoring must be done incrementally to allow for incremental testing"

out_of_scope:
  - "Functions in the Significant (60-80 lines) category - explicitly excluded per user request"
  - "Adding new features or functionality"
  - "Changing the public API of any package"
  - "Refactoring test files"
  - "Adding t.Parallel() to tests (separate audit item)"
  - "Converting slice-based tests to map-based (separate audit item)"
  - "Error wrapping improvements (separate audit item)"
  - "Adding benchmark tests (separate audit item)"
  - "Adding package documentation (separate audit item)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T09:40:00Z"
  artifact_type: "spec"
