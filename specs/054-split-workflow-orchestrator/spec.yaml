feature:
    branch: "054-split-workflow-orchestrator"
    created: "2025-12-18"
    status: "Completed"
    completed_at: 2025-12-18T21:58:09Z
    input: |
        # Arch 1: Split WorkflowOrchestrator God Object (HIGH PRIORITY)

        **Location:** `internal/workflow/workflow.go` (1,285 LOC, 38 methods)
        **Impact:** HIGH - Core of the application, affects testability and maintainability
        **Effort:** HIGH
        **Dependencies:** Should complete arch-4 (DI interfaces) first for better testability

        ## Problem Statement

        WorkflowOrchestrator violates Single Responsibility Principle by handling:
        - Workflow orchestration (RunCompleteWorkflow, RunFullWorkflow)
        - Stage execution (executeSpecifyPlanTasks, executeImplementStage)
        - Phase management (ExecuteImplementWithPhases, executePhaseLoop)
        - Task management (ExecuteImplementWithTasks, executeTaskLoop)
        - Error handling (handleImplementError, validateTasksCompleteFunc)
        - Output/printing (printFullWorkflowSummary, printPhaseCompletion)

        The struct has 10+ Execute variants creating a combinatorial explosion.

        ## Current Structure

        ```go
        type WorkflowOrchestrator struct {
            Executor         *Executor
            Config           *config.Configuration
            SpecsDir         string
            SkipPreflight    bool
            Debug            bool
            PreflightChecker PreflightChecker
        }
        ```

        ## Target Structure

        ```go
        // 1. Orchestrator - coordination only
        type WorkflowOrchestrator struct {
            stageExecutor StageExecutor
            phaseExecutor PhaseExecutor
            taskExecutor  TaskExecutor
            config        Configuration // interface
        }

        // 2. StageExecutor - specify/plan/tasks stages
        type StageExecutor struct { ... }

        // 3. PhaseExecutor - phase-based implementation
        type PhaseExecutor struct { ... }

        // 4. TaskExecutor - task-level execution
        type TaskExecutor struct { ... }
        ```

        ## Implementation Approach

        1. Extract interfaces for each executor type
        2. Create StageExecutor with specify/plan/tasks methods
        3. Create PhaseExecutor with phase loop and context generation
        4. Create TaskExecutor with task loop
        5. Refactor WorkflowOrchestrator to compose executors
        6. Migrate CLI commands to use new structure
        7. Update tests to use mocked executors

        ## Acceptance Criteria

        - [ ] StageExecutor handles specify, plan, tasks stages
        - [ ] PhaseExecutor handles phase-based implementation
        - [ ] TaskExecutor handles task-level execution
        - [ ] WorkflowOrchestrator delegates to executor types
        - [ ] Each executor <400 LOC
        - [ ] All existing tests pass
        - [ ] Test coverage maintained or improved

        ## Non-Functional Requirements

        - All functions under 40 lines
        - All errors wrapped with context
        - Map-based table tests with t.Parallel()
        - CLI lifecycle wrapper pattern maintained
user_stories:
    - id: "US-001"
      title: "Maintainable Workflow Code"
      priority: "P1"
      as_a: "developer maintaining autospec"
      i_want: "the WorkflowOrchestrator to be split into focused, single-responsibility components"
      so_that: "I can understand, modify, and test workflow logic without navigating a 1,285-line god object"
      why_this_priority: "Core maintainability issue affecting all future development; technical debt compounds without resolution"
      independent_test: "Each extracted executor can be instantiated and tested in isolation without other executors"
      acceptance_scenarios:
        - given: "the refactored codebase"
          when: "I need to modify stage execution logic (specify/plan/tasks)"
          then: "I only need to understand and modify StageExecutor (<400 LOC)"
        - given: "the refactored codebase"
          when: "I need to modify phase-based implementation logic"
          then: "I only need to understand and modify PhaseExecutor (<400 LOC)"
        - given: "the refactored codebase"
          when: "I need to modify task-level execution logic"
          then: "I only need to understand and modify TaskExecutor (<400 LOC)"
    - id: "US-002"
      title: "Testable Workflow Components"
      priority: "P1"
      as_a: "developer writing tests for autospec"
      i_want: "executor components to be injected via interfaces"
      so_that: "I can mock individual components for focused unit testing"
      why_this_priority: "Testability is blocked by concrete dependencies; enables TDD for future changes"
      independent_test: "Create mock implementations of executor interfaces and verify orchestrator accepts them"
      acceptance_scenarios:
        - given: "a WorkflowOrchestrator with mock StageExecutor"
          when: "I run a workflow that calls stage execution"
          then: "the mock StageExecutor is invoked and I can verify call parameters"
        - given: "a WorkflowOrchestrator with mock PhaseExecutor"
          when: "I run phase-based implementation"
          then: "the mock PhaseExecutor is invoked and I can verify phase progression"
        - given: "a WorkflowOrchestrator with mock TaskExecutor"
          when: "I run task-based implementation"
          then: "the mock TaskExecutor is invoked and I can verify task iteration"
    - id: "US-003"
      title: "Backward-Compatible CLI Commands"
      priority: "P1"
      as_a: "user of autospec CLI"
      i_want: "all existing CLI commands to work identically after refactoring"
      so_that: "I experience no disruption in my workflow"
      why_this_priority: "User-facing behavior must not change; breaking changes would violate semver"
      independent_test: "Run full test suite before and after refactoring; all tests must pass"
      acceptance_scenarios:
        - given: "the refactored codebase"
          when: "I run 'autospec run -a \"feature description\"'"
          then: "the workflow executes identically to pre-refactor behavior"
        - given: "the refactored codebase"
          when: "I run 'autospec implement --phases'"
          then: "phase-based implementation executes identically to pre-refactor behavior"
        - given: "the refactored codebase"
          when: "I run 'autospec implement --tasks'"
          then: "task-based implementation executes identically to pre-refactor behavior"
    - id: "US-004"
      title: "Reduced Cognitive Load"
      priority: "P2"
      as_a: "new contributor to autospec"
      i_want: "workflow logic organized into logical, focused files"
      so_that: "I can understand the system architecture without reading 1,285 lines of interleaved logic"
      why_this_priority: "Important for project health but doesn't block current functionality"
      independent_test: "New files are created with clear naming; each file handles one concern"
      acceptance_scenarios:
        - given: "the refactored codebase"
          when: "I look at the workflow package directory"
          then: "I see separate files: orchestrator.go, stage_executor.go, phase_executor.go, task_executor.go"
        - given: "a single executor file"
          when: "I read the file"
          then: "all functions relate to a single responsibility (stage OR phase OR task execution)"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST extract StageExecutor handling specify, plan, and tasks stage execution"
          testable: true
          acceptance_criteria: "StageExecutor type exists with ExecuteSpecify, ExecutePlan, ExecuteTasks methods; WorkflowOrchestrator delegates to it"
        - id: "FR-002"
          description: "MUST extract PhaseExecutor handling phase-based implementation loops"
          testable: true
          acceptance_criteria: "PhaseExecutor type exists with ExecutePhaseLoop, ExecuteSinglePhase methods; handles phase context generation"
        - id: "FR-003"
          description: "MUST extract TaskExecutor handling task-level execution loops"
          testable: true
          acceptance_criteria: "TaskExecutor type exists with ExecuteTaskLoop, ExecuteSingleTask methods; handles task ordering and verification"
        - id: "FR-004"
          description: "MUST define interfaces for each executor type enabling dependency injection"
          testable: true
          acceptance_criteria: "StageExecutorInterface, PhaseExecutorInterface, TaskExecutorInterface defined; WorkflowOrchestrator accepts interfaces in constructor"
        - id: "FR-005"
          description: "MUST refactor WorkflowOrchestrator to coordinate between executor types without containing execution logic"
          testable: true
          acceptance_criteria: "WorkflowOrchestrator contains only coordination logic; delegates all execution to injected executors"
        - id: "FR-006"
          description: "MUST maintain all existing public method signatures for CLI compatibility"
          testable: true
          acceptance_criteria: "All existing public methods on WorkflowOrchestrator continue to exist with identical signatures"
        - id: "FR-007"
          description: "MUST update CLI commands to use new structure without behavior changes"
          testable: true
          acceptance_criteria: "All CLI commands in internal/cli/ work identically; lifecycle wrapper pattern preserved"
        - id: "FR-008"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "maintainability"
          description: "Each executor file MUST be under 400 lines of code"
          measurable_target: "stage_executor.go <400 LOC, phase_executor.go <400 LOC, task_executor.go <400 LOC"
        - id: "NFR-002"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-003"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-004"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern with t.Parallel()"
          measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
        - id: "NFR-005"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
        - id: "NFR-006"
          category: "reliability"
          description: "All existing tests must pass after refactoring"
          measurable_target: "100% of pre-existing tests pass; no test modifications except for updated import paths"
        - id: "NFR-007"
          category: "maintainability"
          description: "Test coverage must not decrease"
          measurable_target: "Code coverage percentage remains equal or higher after refactoring"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Workflow orchestrator code is organized into focused components"
          metric: "Lines of code per file"
          target: "No single file exceeds 400 LOC; original 1,285 LOC distributed across 4+ files"
        - id: "SC-002"
          description: "Developers can test workflow components in isolation"
          metric: "Number of mock-based unit tests possible"
          target: "Each executor type has dedicated unit tests using mock dependencies"
        - id: "SC-003"
          description: "All existing functionality remains intact"
          metric: "Test suite pass rate"
          target: "100% of existing tests pass without modification (except import paths)"
        - id: "SC-004"
          description: "New code follows project quality standards"
          metric: "Lint and format check results"
          target: "make lint and make fmt produce no changes or errors"
key_entities:
    - name: "WorkflowOrchestrator"
      description: "Refactored coordinator that delegates to specialized executors"
      attributes:
        - "Holds references to executor interfaces"
        - "Contains only coordination and delegation logic"
        - "Manages preflight checks"
        - "Provides factory function for default construction"
    - name: "StageExecutor"
      description: "Handles specify, plan, and tasks stage execution"
      attributes:
        - "ExecuteSpecify - runs specification generation"
        - "ExecutePlan - runs plan generation"
        - "ExecuteTasks - runs task breakdown generation"
        - "Manages stage-specific validation and retry"
    - name: "PhaseExecutor"
      description: "Handles phase-based implementation execution"
      attributes:
        - "ExecutePhaseLoop - iterates through phases"
        - "ExecuteSinglePhase - runs one phase"
        - "GeneratePhaseContext - creates phase-specific prompts"
        - "Tracks phase completion status"
    - name: "TaskExecutor"
      description: "Handles task-level implementation execution"
      attributes:
        - "ExecuteTaskLoop - iterates through tasks"
        - "ExecuteSingleTask - runs one task"
        - "GetOrderedTasks - retrieves dependency-ordered tasks"
        - "VerifyTaskCompletion - checks task status after execution"
    - name: "Executor Interfaces"
      description: "Contracts enabling dependency injection and mocking"
      attributes:
        - "StageExecutorInterface"
        - "PhaseExecutorInterface"
        - "TaskExecutorInterface"
edge_cases:
    - scenario: "Executor returns error mid-workflow"
      expected_behavior: "Error propagates to caller with wrapped context; partial state preserved for retry"
    - scenario: "Phase executor encounters incomplete tasks"
      expected_behavior: "Returns clear error indicating which tasks failed; does not mark phase complete"
    - scenario: "Task executor receives fromTask that doesn't exist"
      expected_behavior: "Returns error with available task IDs for user guidance"
    - scenario: "CLI command called during refactoring with partial implementation"
      expected_behavior: "Compilation fails; no runtime errors from partially implemented code"
    - scenario: "Test uses old constructor without interface injection"
      expected_behavior: "Default implementations injected; backward compatibility maintained"
assumptions:
    - "The existing test suite adequately covers current behavior and will catch regressions"
    - "The 38 methods can be logically grouped into three executor types plus orchestration"
    - "Breaking the file into multiple files will not introduce circular import issues"
    - "The internal/workflow package has no external consumers outside internal/cli"
    - "Debug logging can remain in individual executors (not centralized)"
    - "Preflight checking remains in the orchestrator as a cross-cutting concern"
constraints:
    - "Must maintain backward compatibility with all existing CLI commands"
    - "Cannot change public method signatures on WorkflowOrchestrator"
    - "Must use Go interfaces (not generics) for dependency injection"
    - "Must keep all code in the internal/workflow package (no new packages)"
    - "Must complete without modifying internal/cli command implementations beyond import changes"
out_of_scope:
    - "Refactoring the Executor or ClaudeExecutor types"
    - "Changing the retry/validation system"
    - "Modifying the spec detection logic"
    - "Adding new features or capabilities"
    - "Changing the configuration system"
    - "Updating the CLI command structure or flags"
    - "Performance optimization beyond maintaining current behavior"
    - "Dependency injection framework integration"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-18T20:54:47Z"
    artifact_type: "spec"
