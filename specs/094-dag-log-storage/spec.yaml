feature:
  branch: "094-dag-log-storage"
  created: "2026-01-11"
  status: "Draft"
  input: |
    DAG log storage in user cache - Part of DAG Multi-Spec Orchestration. Current storage puts both state and logs in project directory (.autospec/state/dag-runs/). Logs can be 50MB per spec Ã— many specs = hundreds of MB. Users accidentally commit logs to git. Solution: split storage - state stays project-local (versionable), logs move to XDG-compliant user cache (~/.cache/autospec/dag-logs/<project-id>/<dag-id>/<spec-id>.log). Includes project ID generation from git remote URL or path hash, state file references to logs, dag logs command update, and log cleanup integration with dag cleanup command plus standalone dag clean-logs command.

user_stories:
  - id: "US-001"
    title: "DAG logs stored outside project directory"
    priority: "P1"
    as_a: "developer running multi-spec DAG workflows"
    i_want: "logs to be stored in my user cache directory instead of the project directory"
    so_that: "I don't accidentally commit large log files to git and my project stays clean"
    why_this_priority: "Core problem this feature solves - logs polluting project directory and git history"
    independent_test: "Run a DAG workflow and verify logs appear in ~/.cache/autospec/dag-logs/ not in .autospec/state/dag-runs/"
    acceptance_scenarios:
      - given: "a DAG workflow is being executed"
        when: "logs are generated for each spec"
        then: "logs are written to ~/.cache/autospec/dag-logs/<project-id>/<dag-id>/<spec-id>.log"
      - given: "XDG_CACHE_HOME environment variable is set"
        when: "logs are generated"
        then: "logs use $XDG_CACHE_HOME/autospec/dag-logs/ as the base directory"
      - given: "XDG_CACHE_HOME is not set"
        when: "logs are generated"
        then: "logs default to ~/.cache/autospec/dag-logs/"

  - id: "US-002"
    title: "Project identification for log organization"
    priority: "P1"
    as_a: "developer working on multiple projects"
    i_want: "logs to be organized by project in the cache directory"
    so_that: "I can work on multiple projects without logs mixing together"
    why_this_priority: "Essential for multi-project scenarios - without project isolation logs would overwrite each other"
    independent_test: "Run DAG workflows in two different git repositories and verify logs are stored under different project IDs"
    acceptance_scenarios:
      - given: "a project with a git remote URL"
        when: "project ID is generated"
        then: "the ID is derived from the remote URL (e.g., github-com-user-repo)"
      - given: "a local-only repository without a remote"
        when: "project ID is generated"
        then: "the ID is a hash of the absolute path (first 12 characters)"
      - given: "a git remote URL with protocol and special characters"
        when: "project ID is generated"
        then: "the URL is slugified (protocol removed, special chars become hyphens)"

  - id: "US-003"
    title: "View logs via CLI command"
    priority: "P1"
    as_a: "developer debugging a DAG workflow"
    i_want: "to view logs using the dag logs command"
    so_that: "I can access logs without knowing the cache directory structure"
    why_this_priority: "Core usability - users need a way to access logs in the new location"
    independent_test: "Run autospec dag logs workflow.yaml <spec-id> and verify it displays logs from the cache directory"
    acceptance_scenarios:
      - given: "a DAG has been executed with logs"
        when: "I run 'autospec dag logs workflow.yaml <spec-id>'"
        then: "logs are displayed from the cache directory location"
      - given: "state file contains log_base and log_file references"
        when: "dag logs command is executed"
        then: "the correct log file path is resolved and displayed"

  - id: "US-004"
    title: "State file references log locations"
    priority: "P1"
    as_a: "system component"
    i_want: "state files to store log location references"
    so_that: "log files can be found without recalculating paths"
    why_this_priority: "Essential for correct operation - state and logs must remain linked"
    independent_test: "Examine state file after DAG run and verify it contains project_id, log_base, and per-spec log_file fields"
    acceptance_scenarios:
      - given: "a DAG run starts"
        when: "state file is created or updated"
        then: "it includes project_id, dag_id, and log_base fields"
      - given: "a spec completes in a DAG"
        when: "state file is updated"
        then: "the spec entry includes a log_file field with the relative filename"

  - id: "US-005"
    title: "Log cleanup with dag cleanup command"
    priority: "P2"
    as_a: "developer finished with a DAG workflow"
    i_want: "the dag cleanup command to offer log deletion"
    so_that: "I can reclaim disk space from completed workflows"
    why_this_priority: "Important for maintenance but not blocking core functionality"
    independent_test: "Run dag cleanup and verify it prompts about logs and respects --logs/--no-logs/--logs-only flags"
    acceptance_scenarios:
      - given: "a DAG has logs in the cache directory"
        when: "I run 'autospec dag cleanup workflow.yaml'"
        then: "I am prompted whether to delete the logs after worktree cleanup"
      - given: "I want to skip the log deletion prompt"
        when: "I run 'autospec dag cleanup workflow.yaml --logs'"
        then: "logs are deleted without prompting"
      - given: "I want to keep logs"
        when: "I run 'autospec dag cleanup workflow.yaml --no-logs'"
        then: "logs are kept without prompting"
      - given: "I want to delete only logs"
        when: "I run 'autospec dag cleanup workflow.yaml --logs-only'"
        then: "only logs are deleted, worktrees and state are preserved"

  - id: "US-006"
    title: "Standalone log cleanup command"
    priority: "P2"
    as_a: "developer wanting to reclaim disk space"
    i_want: "a dedicated command to clean up logs"
    so_that: "I can manage log storage across all DAGs and projects"
    why_this_priority: "Important for long-term maintenance but not blocking core functionality"
    independent_test: "Run dag clean-logs and verify it lists and removes logs for current project, and with --all flag removes all projects"
    acceptance_scenarios:
      - given: "logs exist for multiple DAGs in the current project"
        when: "I run 'autospec dag clean-logs'"
        then: "logs for all DAGs in current project are listed with sizes and I am prompted to delete"
      - given: "logs exist across multiple projects"
        when: "I run 'autospec dag clean-logs --all'"
        then: "logs for all projects are listed with sizes and I am prompted to delete"

  - id: "US-007"
    title: "Migration of existing logs"
    priority: "P3"
    as_a: "developer with existing DAG runs"
    i_want: "existing logs to be migrated to the new location"
    so_that: "I get the benefits of the new storage without losing history"
    why_this_priority: "Nice-to-have for existing users but new behavior is the priority"
    independent_test: "Create logs in old location, run dag run, verify logs are moved to cache directory and state updated"
    acceptance_scenarios:
      - given: "logs exist in the old project directory location"
        when: "a DAG run is resumed"
        then: "logs are moved to the cache directory and state file is updated"
      - given: "I want to manually migrate logs"
        when: "I run 'autospec dag migrate-logs'"
        then: "all logs in project directory are moved to cache directory"

requirements:
  functional:
    - id: "FR-001"
      description: "The system MUST write DAG logs to the XDG-compliant user cache directory"
      testable: true
      acceptance_criteria: "Logs appear in $XDG_CACHE_HOME/autospec/dag-logs/ or ~/.cache/autospec/dag-logs/"
    - id: "FR-002"
      description: "The system MUST generate a project ID from git remote URL when available"
      testable: true
      acceptance_criteria: "Project ID matches slugified git remote URL (e.g., git@github.com:user/repo.git becomes github-com-user-repo)"
    - id: "FR-003"
      description: "The system MUST generate a project ID from path hash when no git remote exists"
      testable: true
      acceptance_criteria: "Project ID is first 12 characters of path hash for local-only repositories"
    - id: "FR-004"
      description: "The system MUST organize logs as <cache-dir>/autospec/dag-logs/<project-id>/<dag-id>/<spec-id>.log"
      testable: true
      acceptance_criteria: "Log file path follows the specified structure"
    - id: "FR-005"
      description: "The system MUST store log_base and per-spec log_file references in state files"
      testable: true
      acceptance_criteria: "State file contains project_id, log_base, and log_file fields"
    - id: "FR-006"
      description: "The dag logs command MUST resolve and display logs from the cache directory"
      testable: true
      acceptance_criteria: "Running 'autospec dag logs' shows logs from cache location"
    - id: "FR-007"
      description: "The dag cleanup command MUST prompt for log deletion by default"
      testable: true
      acceptance_criteria: "Interactive prompt appears asking about log deletion"
    - id: "FR-008"
      description: "The dag cleanup command MUST support --logs, --no-logs, and --logs-only flags"
      testable: true
      acceptance_criteria: "Each flag behaves as documented without prompting"
    - id: "FR-009"
      description: "The system MUST provide a dag clean-logs command for bulk log cleanup"
      testable: true
      acceptance_criteria: "Command lists logs with sizes and deletes on confirmation"
    - id: "FR-010"
      description: "The dag clean-logs command MUST support --all flag for cross-project cleanup"
      testable: true
      acceptance_criteria: "With --all, logs from all projects are listed and can be deleted"
    - id: "FR-011"
      description: "The system SHOULD migrate existing logs from project directory on resume"
      testable: true
      acceptance_criteria: "Old logs are moved to cache and state updated on next dag run"
    - id: "FR-012"
      description: "The system SHOULD support custom log directory via config or environment variable"
      testable: true
      acceptance_criteria: "AUTOSPEC_DAG_LOG_DIR or dag.log_dir config overrides default location"
    - id: "FR-100"
      description: "All code changes MUST pass make test, make fmt, make lint, and make build"
      testable: true
      acceptance_criteria: "All four commands exit with code 0"

  non_functional:
    - id: "NFR-001"
      category: "code_quality"
      description: "Functions MUST be under 40 lines"
      measurable_target: "No function exceeds 40 lines of code"
    - id: "NFR-002"
      category: "code_quality"
      description: "Errors MUST be wrapped with context using fmt.Errorf with %w"
      measurable_target: "All returned errors include contextual information"
    - id: "NFR-003"
      category: "code_quality"
      description: "Tests MUST use map-based table test pattern"
      measurable_target: "All test files use map[string]struct{} for test cases"
    - id: "NFR-004"
      category: "code_quality"
      description: "Functions SHOULD accept interfaces, return concrete types"
      measurable_target: "Interface parameters used where appropriate"
    - id: "NFR-005"
      category: "performance"
      description: "Project ID generation MUST complete quickly"
      measurable_target: "Project ID generated in under 100ms including git operations"
    - id: "NFR-006"
      category: "reliability"
      description: "Log operations MUST handle missing directories gracefully"
      measurable_target: "Directories created automatically when writing logs"
    - id: "NFR-007"
      category: "usability"
      description: "Log cleanup commands MUST display human-readable sizes"
      measurable_target: "Sizes shown in KB, MB, GB as appropriate"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "DAG logs no longer appear in project directory"
      metric: "Count of log files in .autospec/state/dag-runs/"
      target: "Zero log files after running DAG workflows"
    - id: "SC-002"
      description: "Users can access logs via CLI without knowing cache path"
      metric: "dag logs command success rate"
      target: "100% of log requests successfully resolve to correct file"
    - id: "SC-003"
      description: "Multiple projects have isolated log storage"
      metric: "Log path collision rate across projects"
      target: "Zero collisions - each project has unique directory"
    - id: "SC-004"
      description: "Users can reclaim disk space from old logs"
      metric: "Log cleanup command completion"
      target: "All targeted logs deleted when cleanup requested"

key_entities:
  - name: "Project ID"
    description: "Unique identifier for a project used to organize logs in cache"
    attributes:
      - "Derived from git remote URL (slugified) or path hash"
      - "Used as directory name in cache path"
      - "Stored in state file for reference"
  - name: "Log Base Path"
    description: "The root directory for logs of a specific DAG run"
    attributes:
      - "Combines cache dir, project ID, and DAG ID"
      - "Stored in state file as log_base"
      - "Used to resolve relative log file paths"
  - name: "State File"
    description: "YAML file tracking DAG execution state and log references"
    attributes:
      - "Located in .autospec/state/dag-runs/"
      - "Contains project_id, dag_id, log_base fields"
      - "Per-spec entries include log_file (relative path)"

edge_cases:
  - scenario: "Git remote URL contains special characters or very long paths"
    expected_behavior: "URL is slugified and truncated to reasonable length while maintaining uniqueness"
  - scenario: "XDG_CACHE_HOME points to non-existent directory"
    expected_behavior: "Directory is created with appropriate permissions"
  - scenario: "User lacks write permission to cache directory"
    expected_behavior: "Clear error message indicating permission issue and suggesting fix"
  - scenario: "State file exists but referenced log files are missing"
    expected_behavior: "Log commands indicate logs not found, cleanup skips missing files"
  - scenario: "Project directory moves but state file contains old project_id"
    expected_behavior: "System detects mismatch and regenerates project_id on next run"
  - scenario: "Same repository cloned to multiple locations"
    expected_behavior: "All clones share the same project_id (based on git remote) and logs"
  - scenario: "Cache directory is on different filesystem with limited space"
    expected_behavior: "Standard filesystem errors surfaced, no special handling required"

assumptions:
  - "Git is available for projects that have remotes"
  - "User has write access to their home directory and cache location"
  - "XDG Base Directory Specification is appropriate for non-macOS Unix systems"
  - "12 characters of path hash provides sufficient uniqueness for local-only projects"
  - "Logs are ephemeral and can be regenerated by re-running affected specs"
  - "Users prefer automatic log location over manual configuration in most cases"

constraints:
  - "Must remain compatible with existing state file format (additive changes only)"
  - "Must work on Linux, macOS, and Windows (with appropriate path handling)"
  - "Cannot require additional dependencies for XDG compliance"
  - "Log cleanup must be non-destructive to state files and worktrees unless explicitly requested"

out_of_scope:
  - "Automatic log compression"
  - "Log rotation within a single run"
  - "Remote log storage or cloud sync"
  - "Real-time log streaming to external systems"
  - "Log aggregation across DAGs"
  - "Structured log format changes (JSON, etc.)"
  - "macOS-specific Caches directory handling (uses XDG-style instead)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.8.2"
  created: "2026-01-11T20:59:27Z"
  artifact_type: "spec"
