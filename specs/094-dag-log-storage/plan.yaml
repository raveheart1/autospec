plan:
  branch: "094-dag-log-storage"
  created: "2026-01-11"
  spec_path: "specs/094-dag-log-storage/spec.yaml"

summary: |
  Implement split storage for DAG logs, moving large ephemeral log files from the project
  directory (.autospec/state/dag-runs/) to the XDG-compliant user cache (~/.cache/autospec/dag-logs/).
  This solves the problem of users accidentally committing large logs to git and polluting their
  project with ephemeral data.

  The implementation adds project ID generation (from git remote URL or path hash), updates the
  state file schema to track log locations, modifies the log writing/reading logic to use the
  new cache path, and extends CLI commands for log cleanup with interactive prompts and flags.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for state files"
    - name: "github.com/fatih/color"
      version: "v1.16.0"
      purpose: "Colored terminal output"
  storage: "YAML state files + log files in XDG cache"
  testing:
    framework: "go test"
    approach: "Table-driven unit tests for all new functions, integration tests for CLI commands"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Project ID generation under 100ms including git operations"
  constraints:
    - "State file changes must be additive (backward compatible)"
    - "Cross-platform path handling required"
    - "No additional dependencies for XDG compliance"
  scale_scope: "Individual developer workstations with multiple projects"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "All new functions require table-driven tests before implementation"
    - name: "Validation-First Workflow"
      status: "PASS"
      notes: "State file schema validated on load/save, log paths validated before operations"
    - name: "Performance Standards"
      status: "PASS"
      notes: "Project ID generation has 100ms target per spec NFR-005"
    - name: "Idempotency and Retry Logic"
      status: "PASS"
      notes: "Log directory creation is idempotent, cleanup operations are safe to retry"
    - name: "Go Coding Standards"
      status: "PASS"
      notes: "Functions under 40 lines, errors wrapped with context, table-driven tests"
    - name: "Cross-Platform Compatibility"
      status: "PASS"
      notes: "Uses filepath.Join for paths, XDG fallback works on all platforms"

research_findings:
  decisions:
    - topic: "XDG cache directory location"
      decision: "Use XDG_CACHE_HOME with fallback to ~/.cache on Unix, os.UserCacheDir() for cross-platform"
      rationale: "os.UserCacheDir() provides cross-platform cache paths respecting XDG on Linux"
      alternatives_considered:
        - "Hardcoded ~/.cache path (not cross-platform)"
        - "Custom cache path only (no standard fallback)"

    - topic: "Project ID generation strategy"
      decision: "Use git remote origin URL slugified, fallback to SHA256 hash of absolute path (first 12 chars)"
      rationale: "Git remote provides stable ID across clones; path hash handles local-only repos"
      alternatives_considered:
        - "Always use path hash (loses multi-clone sharing)"
        - "Use git root directory name (not unique enough)"

    - topic: "State file schema extension"
      decision: "Add project_id, log_base fields to DAGRun; add log_file field to SpecState"
      rationale: "Allows existing runs to be loaded while new fields enable cache-based log lookup"
      alternatives_considered:
        - "Separate log metadata file (adds complexity)"
        - "Compute paths from scratch each time (slower, less reliable)"

    - topic: "Log cleanup integration"
      decision: "Extend existing cleanup command with --logs, --no-logs, --logs-only flags; add new clean-logs command"
      rationale: "Builds on existing cleanup workflow while providing standalone option for bulk cleanup"
      alternatives_considered:
        - "Only standalone command (ignores natural cleanup workflow)"
        - "Only integrated prompts (no bulk cleanup option)"

    - topic: "Migration strategy for existing logs"
      decision: "Auto-migrate on resume, optional dag migrate-logs command"
      rationale: "Minimizes disruption while providing explicit migration option"
      alternatives_considered:
        - "Force immediate migration (disruptive)"
        - "Never migrate, old logs orphaned (loses history)"

data_model:
  entities:
    - name: "DAGRun"
      description: "State tracking for a DAG execution run, stored in .autospec/state/dag-runs/"
      fields:
        - name: "run_id"
          type: "string"
          description: "Unique identifier for the run (timestamp + UUID)"
          constraints: "Generated on run start, immutable"
        - name: "project_id"
          type: "string"
          description: "Unique project identifier for log organization (NEW)"
          constraints: "Derived from git remote or path hash"
        - name: "log_base"
          type: "string"
          description: "Base path for log files in cache directory (NEW)"
          constraints: "Computed from cache dir + project_id + dag_id"
        - name: "dag_id"
          type: "string"
          description: "Slug identifier for the DAG"
          constraints: "From dag.ID or slugified dag.Name"
        - name: "specs"
          type: "map[string]SpecState"
          description: "Per-spec execution state"
          constraints: "Keys are spec IDs"
      relationships:
        - target: "SpecState"
          type: "one-to-many"
          description: "Each run contains multiple spec states"

    - name: "SpecState"
      description: "Execution state for a single spec within a DAG run"
      fields:
        - name: "spec_id"
          type: "string"
          description: "Identifier for the spec"
          constraints: "Must be unique within the DAG"
        - name: "log_file"
          type: "string"
          description: "Relative path to log file within log_base (NEW)"
          constraints: "Format: <spec-id>.log"
        - name: "status"
          type: "string"
          description: "Current execution status"
          constraints: "pending|running|completed|failed|blocked"
        - name: "branch"
          type: "string"
          description: "Git branch for this spec's worktree"
          constraints: "Format: dag/<dag-id>/<spec-id>"
        - name: "worktree_path"
          type: "string"
          description: "Absolute path to the worktree"
          constraints: "Created by worktree manager"
      relationships:
        - target: "DAGRun"
          type: "many-to-one"
          description: "Each spec state belongs to one run"

    - name: "DAGExecutionConfig"
      description: "Configuration for DAG execution behavior"
      fields:
        - name: "log_dir"
          type: "string"
          description: "Override for log directory location (NEW)"
          constraints: "Optional; defaults to XDG cache"
        - name: "max_log_size"
          type: "string"
          description: "Maximum size per log file"
          constraints: "Format: 50MB, default: 50MB"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/internal/dag-log-storage.md"
      description: "Internal documentation for log storage architecture (if needed)"
  source_code:
    - path: "internal/dag/projectid.go"
      description: "Project ID generation from git remote or path hash"
    - path: "internal/dag/logpaths.go"
      description: "Cache-based log path computation functions"
    - path: "internal/dag/runstate.go"
      description: "Updates to DAGRun and SpecState structs (add log fields)"
    - path: "internal/dag/output.go"
      description: "Updates to log file creation to use cache paths"
    - path: "internal/dag/config.go"
      description: "Add LogDir to DAGExecutionConfig"
    - path: "internal/dag/migration.go"
      description: "Log migration from project dir to cache"
    - path: "internal/cli/dag/logs.go"
      description: "Update to read logs from cache location"
    - path: "internal/cli/dag/cleanup.go"
      description: "Add log cleanup flags and prompts"
    - path: "internal/cli/dag/cleanlogs.go"
      description: "New standalone log cleanup command"
  tests:
    - path: "internal/dag/projectid_test.go"
      description: "Tests for project ID generation"
    - path: "internal/dag/logpaths_test.go"
      description: "Tests for cache path computation"
    - path: "internal/dag/migration_test.go"
      description: "Tests for log migration"
    - path: "internal/cli/dag/cleanlogs_test.go"
      description: "Tests for clean-logs command"

implementation_phases:
  - phase: 1
    name: "Core Log Path Infrastructure"
    goal: "Implement project ID generation and cache-based log path computation"
    deliverables:
      - "internal/dag/projectid.go with GetProjectID(), slugifyURL() functions"
      - "internal/dag/projectid_test.go with table-driven tests"
      - "internal/dag/logpaths.go with GetLogDir(), GetCacheBase() functions"
      - "internal/dag/logpaths_test.go with table-driven tests"
      - "internal/dag/config.go updated with LogDir field and AUTOSPEC_DAG_LOG_DIR env support"

  - phase: 2
    name: "State File Schema Updates"
    goal: "Extend DAGRun and SpecState with log location fields"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/dag/runstate.go updated with ProjectID, LogBase fields on DAGRun"
      - "internal/dag/runstate.go updated with LogFile field on SpecState"
      - "Backward-compatible YAML marshaling (empty fields allowed)"
      - "Unit tests for state file round-trip with new fields"

  - phase: 3
    name: "Log Writing Integration"
    goal: "Update log file creation to write to cache directory"
    dependencies:
      - "Phase 2"
    deliverables:
      - "internal/dag/output.go updated to use new log paths"
      - "Log directory creation with proper permissions"
      - "State file population with log_base and log_file on run start"
      - "Integration tests for log creation in cache directory"

  - phase: 4
    name: "Log Reading Updates"
    goal: "Update dag logs command to read from cache location"
    dependencies:
      - "Phase 3"
    deliverables:
      - "internal/cli/dag/logs.go updated to resolve paths from state file"
      - "Fallback to legacy path for old runs without log_base"
      - "Clear error messages when logs not found"
      - "Unit tests for path resolution logic"

  - phase: 5
    name: "Log Cleanup Integration"
    goal: "Extend dag cleanup with log deletion options"
    dependencies:
      - "Phase 4"
    deliverables:
      - "internal/cli/dag/cleanup.go with --logs, --no-logs, --logs-only flags"
      - "Interactive prompt for log deletion with size display"
      - "Log size calculation function"
      - "Integration tests for cleanup flags"

  - phase: 6
    name: "Standalone Log Cleanup Command"
    goal: "Implement dag clean-logs command for bulk cleanup"
    dependencies:
      - "Phase 5"
    deliverables:
      - "internal/cli/dag/cleanlogs.go with dag clean-logs command"
      - "Support for --all flag (cross-project cleanup)"
      - "Size summary per DAG and project"
      - "Interactive confirmation with human-readable sizes"
      - "Unit tests for clean-logs command"

  - phase: 7
    name: "Migration Support"
    goal: "Implement automatic and manual log migration from project directory"
    dependencies:
      - "Phase 6"
    deliverables:
      - "internal/dag/migration.go with MigrateLogs() function"
      - "Auto-migration on dag run resume when old logs detected"
      - "Optional dag migrate-logs command"
      - "State file update after migration"
      - "Unit tests for migration logic"

  - phase: 8
    name: "Final Validation"
    goal: "Ensure all quality gates pass"
    dependencies:
      - "Phase 7"
    deliverables:
      - "make test passes with all new tests"
      - "make lint passes"
      - "make fmt produces no changes"
      - "make build succeeds"
      - "Manual testing of full workflow"

open_questions:
  - question: "Should the dag migrate-logs command be implemented in this iteration?"
    context: "Spec mentions it as optional, migration on resume may be sufficient"
    proposed_resolution: "Implement auto-migration on resume; defer explicit command if time-constrained"

  - question: "How should logs be handled when project is cloned to new machine with different XDG_CACHE_HOME?"
    context: "State file contains log_base path which may not exist on new machine"
    proposed_resolution: "Detect missing log_base on load, regenerate from project_id; logs are ephemeral and can be recreated"

  - question: "Should cleanup prompt default to keeping or deleting logs?"
    context: "Spec shows prompt defaults to N (keep logs)"
    proposed_resolution: "Default to keeping logs (N) for safety; users can use --logs to auto-delete"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.8.2"
  created: "2026-01-11T21:00:54Z"
  artifact_type: "plan"
