tasks:
    branch: "094-dag-log-storage"
    created: "2026-01-11"
    spec_path: "specs/094-dag-log-storage/spec.yaml"
    plan_path: "specs/094-dag-log-storage/plan.yaml"
summary:
    total_tasks: 24
    total_phases: 8
    parallel_opportunities: 8
    estimated_complexity: "medium"
phases:
    - number: 1
      title: "Setup"
      purpose: "Create new package files and extend existing structures"
      tasks:
        - id: "T001"
          title: "Create internal/dag/projectid.go with GetProjectID and slugifyURL stubs"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/dag/projectid.go"
          dependencies: []
          acceptance_criteria:
            - "File exists with package declaration"
            - "GetProjectID() stub returns empty string"
            - "slugifyURL(url string) stub returns empty string"
        - id: "T002"
          title: "Create internal/dag/logpaths.go with GetLogDir and GetCacheBase stubs"
          status: "Completed"
          type: "setup"
          parallel: true
          story_id: null
          file_path: "internal/dag/logpaths.go"
          dependencies: []
          acceptance_criteria:
            - "File exists with package declaration"
            - "GetLogDir(projectID, dagID string) stub returns empty string"
            - "GetCacheBase() stub returns empty string"
        - id: "T003"
          title: "Create internal/dag/migration.go with MigrateLogs stub"
          status: "Completed"
          type: "setup"
          parallel: true
          story_id: null
          file_path: "internal/dag/migration.go"
          dependencies: []
          acceptance_criteria:
            - "File exists with package declaration"
            - "MigrateLogs() stub returns nil error"
    - number: 2
      title: "Foundational - Project ID and Cache Path Infrastructure"
      purpose: "Core infrastructure that MUST be complete before user stories can be implemented"
      tasks:
        - id: "T004"
          title: "Implement GetProjectID in internal/dag/projectid.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/projectid.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "Returns slugified git remote URL when origin remote exists"
            - "Returns first 12 chars of SHA256 path hash when no remote"
            - "Handles git command failures gracefully"
            - "Function under 40 lines"
        - id: "T005"
          title: "Implement slugifyURL in internal/dag/projectid.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/projectid.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "Converts git@github.com:user/repo.git to github-com-user-repo"
            - "Converts https://github.com/user/repo to github-com-user-repo"
            - "Removes .git suffix"
            - "Converts special characters to hyphens"
            - "Function under 40 lines"
        - id: "T006"
          title: "Add tests for projectid.go in internal/dag/projectid_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/projectid_test.go"
          dependencies: ["T004", "T005"]
          acceptance_criteria:
            - "Uses map-based table test pattern"
            - "Tests slugifyURL with SSH, HTTPS, and edge case URLs"
            - "Tests GetProjectID with mocked git commands if possible"
            - "All tests pass"
        - id: "T007"
          title: "Implement GetCacheBase in internal/dag/logpaths.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/logpaths.go"
          dependencies: ["T002"]
          acceptance_criteria:
            - "Uses XDG_CACHE_HOME if set"
            - "Falls back to os.UserCacheDir() for cross-platform support"
            - "Returns path with /autospec/dag-logs suffix"
            - "Function under 40 lines"
        - id: "T008"
          title: "Implement GetLogDir in internal/dag/logpaths.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/logpaths.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Joins GetCacheBase with projectID and dagID"
            - "Returns full path to log directory"
            - "Function under 40 lines"
        - id: "T009"
          title: "Add tests for logpaths.go in internal/dag/logpaths_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/logpaths_test.go"
          dependencies: ["T007", "T008"]
          acceptance_criteria:
            - "Uses map-based table test pattern"
            - "Tests GetCacheBase with and without XDG_CACHE_HOME"
            - "Tests GetLogDir with various projectID and dagID inputs"
            - "All tests pass"
    - number: 3
      title: "User Story 1 - DAG logs stored outside project directory"
      purpose: "Logs written to user cache instead of project directory"
      story_reference: "US-001"
      independent_test: "Run a DAG workflow and verify logs appear in ~/.cache/autospec/dag-logs/ not in .autospec/state/dag-runs/"
      tasks:
        - id: "T010"
          title: "Update DAGRun struct with ProjectID and LogBase fields in internal/dag/runstate.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/runstate.go"
          dependencies: ["T006", "T009"]
          acceptance_criteria:
            - "DAGRun has ProjectID string field with yaml tag"
            - "DAGRun has LogBase string field with yaml tag"
            - "Fields are omitempty for backward compatibility"
            - "Existing state files still load correctly"
        - id: "T011"
          title: "Update SpecState struct with LogFile field in internal/dag/runstate.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/dag/runstate.go"
          dependencies: ["T006", "T009"]
          acceptance_criteria:
            - "SpecState has LogFile string field with yaml tag"
            - "Field is omitempty for backward compatibility"
            - "Existing state files still load correctly"
        - id: "T012"
          title: "Update log creation in internal/dag/output.go to use cache paths"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/output.go"
          dependencies: ["T010", "T011"]
          acceptance_criteria:
            - "Logs written to GetLogDir path instead of project directory"
            - "Log directory created with 0755 permissions if missing"
            - "State file updated with LogBase and per-spec LogFile"
            - "ProjectID populated on run start"
    - number: 4
      title: "User Story 2 - Project identification for log organization"
      purpose: "Logs organized by unique project ID in cache directory"
      story_reference: "US-002"
      independent_test: "Run DAG workflows in two different git repositories and verify logs are stored under different project IDs"
      tasks:
        - id: "T013"
          title: "Add config override for log directory in internal/dag/config.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/config.go"
          dependencies: ["T012"]
          acceptance_criteria:
            - "DAGExecutionConfig has LogDir field"
            - "AUTOSPEC_DAG_LOG_DIR environment variable support"
            - "Config file dag.log_dir support"
            - "Override takes precedence over XDG cache"
        - id: "T014"
          title: "Update logpaths.go to respect config override"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/logpaths.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "GetLogDir checks config for LogDir override"
            - "Falls back to XDG cache when no override"
            - "Function under 40 lines"
    - number: 5
      title: "User Story 3 - View logs via CLI command"
      purpose: "Users can access logs using dag logs command without knowing cache path"
      story_reference: "US-003"
      independent_test: "Run autospec dag logs workflow.yaml <spec-id> and verify it displays logs from the cache directory"
      tasks:
        - id: "T015"
          title: "Update dag logs command in internal/cli/dag/logs.go to read from cache"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/cli/dag/logs.go"
          dependencies: ["T014"]
          acceptance_criteria:
            - "Resolves log path from state file log_base + log_file"
            - "Falls back to legacy project directory path for old runs"
            - "Clear error message when logs not found"
            - "Displays logs from correct cache location"
    - number: 6
      title: "User Story 4 - State file references log locations"
      purpose: "State files store log location references for path resolution"
      story_reference: "US-004"
      independent_test: "Examine state file after DAG run and verify it contains project_id, log_base, and per-spec log_file fields"
      tasks:
        - id: "T016"
          title: "Add state file round-trip tests in internal/dag/runstate_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-004"
          file_path: "internal/dag/runstate_test.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "Uses map-based table test pattern"
            - "Tests state file with new log fields serializes correctly"
            - "Tests state file without log fields loads correctly (backward compat)"
            - "All tests pass"
    - number: 7
      title: "User Story 5 - Log cleanup with dag cleanup command"
      purpose: "dag cleanup command offers log deletion with flags and prompts"
      story_reference: "US-005"
      independent_test: "Run dag cleanup and verify it prompts about logs and respects --logs/--no-logs/--logs-only flags"
      tasks:
        - id: "T017"
          title: "Add --logs, --no-logs, --logs-only flags to dag cleanup in internal/cli/dag/cleanup.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/cli/dag/cleanup.go"
          dependencies: ["T016"]
          acceptance_criteria:
            - "--logs flag auto-deletes logs without prompt"
            - "--no-logs flag skips log deletion without prompt"
            - "--logs-only flag deletes only logs, preserves worktrees and state"
            - "Flags are mutually exclusive"
        - id: "T018"
          title: "Add interactive log deletion prompt to dag cleanup"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/cli/dag/cleanup.go"
          dependencies: ["T017"]
          acceptance_criteria:
            - "Prompt shown after worktree cleanup when no log flags specified"
            - "Displays log size in human-readable format (KB, MB, GB)"
            - "Default is N (keep logs)"
            - "Respects terminal non-interactive mode (skips prompt)"
        - id: "T019"
          title: "Add log size calculation helper function"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-005"
          file_path: "internal/dag/logpaths.go"
          dependencies: ["T016"]
          acceptance_criteria:
            - "Function calculates total size of log directory"
            - "Returns human-readable string (e.g., '127MB')"
            - "Handles missing directories gracefully"
            - "Function under 40 lines"
    - number: 8
      title: "User Story 6 - Standalone log cleanup command"
      purpose: "Dedicated command for bulk log cleanup across DAGs and projects"
      story_reference: "US-006"
      independent_test: "Run dag clean-logs and verify it lists and removes logs for current project, and with --all flag removes all projects"
      tasks:
        - id: "T020"
          title: "Create dag clean-logs command in internal/cli/dag/cleanlogs.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-006"
          file_path: "internal/cli/dag/cleanlogs.go"
          dependencies: ["T018", "T019"]
          acceptance_criteria:
            - "Lists all DAGs in current project with sizes"
            - "Shows total size summary"
            - "Interactive confirmation before deletion"
            - "Deletes all logs on confirmation"
        - id: "T021"
          title: "Add --all flag to dag clean-logs for cross-project cleanup"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-006"
          file_path: "internal/cli/dag/cleanlogs.go"
          dependencies: ["T020"]
          acceptance_criteria:
            - "--all flag lists logs from all projects"
            - "Groups logs by project with sizes"
            - "Shows grand total across projects"
            - "Deletes all on confirmation"
        - id: "T022"
          title: "Add tests for clean-logs command in internal/cli/dag/cleanlogs_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-006"
          file_path: "internal/cli/dag/cleanlogs_test.go"
          dependencies: ["T021"]
          acceptance_criteria:
            - "Uses map-based table test pattern"
            - "Tests listing logs for current project"
            - "Tests --all flag behavior"
            - "All tests pass"
    - number: 9
      title: "User Story 7 - Migration of existing logs"
      purpose: "Existing logs migrated to new location automatically or manually"
      story_reference: "US-007"
      independent_test: "Create logs in old location, run dag run, verify logs are moved to cache directory and state updated"
      tasks:
        - id: "T023"
          title: "Implement MigrateLogs in internal/dag/migration.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-007"
          file_path: "internal/dag/migration.go"
          dependencies: ["T022"]
          acceptance_criteria:
            - "Detects logs in old project directory location"
            - "Moves logs to cache directory"
            - "Updates state file with new log_base and log_file"
            - "Handles partial migration (some logs already moved)"
            - "Function under 40 lines (use helpers)"
        - id: "T024"
          title: "Add auto-migration on dag run resume"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-007"
          file_path: "internal/dag/output.go"
          dependencies: ["T023"]
          acceptance_criteria:
            - "On resume, detect if logs exist in old location"
            - "Call MigrateLogs if old logs found"
            - "Continue with normal run after migration"
            - "No error if no old logs exist"
    - number: 10
      title: "Final Validation"
      purpose: "Ensure all quality gates pass and full workflow works"
      tasks:
        - id: "T025"
          title: "Run make test, make fmt, make lint, make build"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: null
          dependencies: ["T024"]
          acceptance_criteria:
            - "make test exits 0 with all tests passing"
            - "make fmt produces no changes"
            - "make lint exits 0 with no issues"
            - "make build succeeds"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-003", "US-004"]
        - story_id: "US-002"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-003"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-004"
          depends_on: ["US-001"]
          blocks: ["US-005"]
        - story_id: "US-005"
          depends_on: ["US-004"]
          blocks: ["US-006"]
        - story_id: "US-006"
          depends_on: ["US-005"]
          blocks: ["US-007"]
        - story_id: "US-007"
          depends_on: ["US-006"]
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2]
        - phase: 2
          blocks: [3, 4, 5, 6]
        - phase: 3
          blocks: [4, 5]
        - phase: 4
          blocks: [5]
        - phase: 5
          blocks: [6]
        - phase: 6
          blocks: [7]
        - phase: 7
          blocks: [8]
        - phase: 8
          blocks: [9]
        - phase: 9
          blocks: [10]
parallel_execution:
    - phase: 1
      parallel_groups:
        - tasks: ["T002", "T003"]
          rationale: "Independent file creation, no dependencies"
    - phase: 2
      parallel_groups:
        - tasks: ["T004", "T005"]
          rationale: "Both implement functions in same file but independent logic"
        - tasks: ["T007"]
          rationale: "Can run in parallel with T004/T005 as it's in different file"
    - phase: 3
      parallel_groups:
        - tasks: ["T010", "T011"]
          rationale: "Both modify runstate.go but different structs"
    - phase: 7
      parallel_groups:
        - tasks: ["T018", "T019"]
          rationale: "Cleanup prompt and size calculation are independent"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3, 4, 5]
        description: "Setup + Foundational + US-001 (cache storage) + US-002 (project ID) + US-003 (view logs)"
        validation: "Run DAG workflow, verify logs in cache, run dag logs command to view"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2]
          deliverable: "Project ID and cache path functions implemented and tested"
        - milestone: "Core Log Storage"
          phases: [1, 2, 3]
          deliverable: "Logs written to cache directory, state tracks locations"
        - milestone: "Log Access"
          phases: [1, 2, 3, 4, 5]
          deliverable: "Full read/write cycle - logs stored in cache and viewable via CLI"
        - milestone: "Cleanup Integration"
          phases: [1, 2, 3, 4, 5, 6, 7, 8]
          deliverable: "All cleanup commands functional with prompts and flags"
        - milestone: "Complete"
          phases: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
          deliverable: "All features including migration and validation"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec v0.8.2"
    created: "2026-01-11T21:03:53Z"
    artifact_type: "tasks"
