plan:
  branch: "076-optional-risk-assessment"
  created: "2026-01-01"
  spec_path: "specs/076-optional-risk-assessment/spec.yaml"

summary: |
  This feature makes risk assessment opt-in rather than the current default behavior.
  The implementation follows the established InjectableInstruction pattern from the
  auto-commit feature, adding a new EnableRiskAssessment config field that defaults
  to false. When enabled, risk assessment instructions are injected into the plan
  command, prompting the AI to include a risks section in the generated plan.yaml.
  The embedded autospec.plan.md template is modified to remove the hardcoded risks
  section, making it conditionally injected instead.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "koanf"
      version: "v2"
      purpose: "Configuration management with hierarchical priority"
    - name: "gopkg.in/yaml.v3"
      version: "v3"
      purpose: "YAML parsing for plan artifact validation"
  storage: "File-based (YAML configuration files)"
  testing:
    framework: "Go testing package"
    approach: "Table-driven unit tests with map[string]struct pattern"
  target_platform: "Cross-platform (Linux, macOS, Windows)"
  project_type: "cli"
  performance_goals: "Validation functions under 10ms; no regression in CLI startup time"
  constraints:
    - "Must follow existing InjectableInstruction pattern"
    - "Must maintain backward compatibility with existing configs"
    - "Embedded templates must remain project-agnostic (PRIN-012)"
    - "All new code must have tests written first"
  scale_scope: "Single CLI tool, local execution"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests will be written before implementation for all new functions"
    - name: "Validation-First Workflow"
      status: "N/A"
      notes: "This feature modifies prompt construction, not workflow phase validation"
    - name: "Performance Standards"
      status: "PASS"
      notes: "New code adds minimal overhead; injection is string concatenation only"
    - name: "Go Coding Standards"
      status: "PASS"
      notes: "Plan specifies map-based tests, error wrapping, <40 line functions"
    - name: "Command Template Independence"
      status: "PASS"
      notes: "Risk instructions are injected at runtime, not embedded in template"

research_findings:
  decisions:
    - topic: "Config field naming"
      decision: "Use enable_risk_assessment following snake_case convention"
      rationale: "Matches existing config field naming (e.g., auto_commit, skip_preflight)"
      alternatives_considered:
        - "risk_assessment_enabled"
        - "include_risks"
    - topic: "Injection location"
      decision: "Inject in buildPlanCommand, not in executor"
      rationale: "Risk assessment is plan-specific; auto-commit is workflow-wide"
      alternatives_considered:
        - "Inject in executor like auto-commit (too broad)"
        - "Create separate plan executor method (unnecessary complexity)"
    - topic: "Template modification approach"
      decision: "Remove risks section from template, inject dynamically"
      rationale: "Keeps template project-agnostic per PRIN-012; injection pattern proven"
      alternatives_considered:
        - "Add conditional in template (violates PRIN-012)"
        - "Two separate templates (maintenance burden)"

data_model:
  entities:
    - name: "Configuration"
      description: "Extended with EnableRiskAssessment field"
      fields:
        - name: "EnableRiskAssessment"
          type: "bool"
          description: "Controls whether risk assessment instructions are injected"
          constraints: "Default: false"
      relationships:
        - target: "StageExecutor"
          type: "one-to-one"
          description: "Config passed to executor for instruction injection decisions"
    - name: "InjectableInstruction"
      description: "Existing struct reused for risk assessment"
      fields:
        - name: "Name"
          type: "string"
          description: "Identifier for the instruction type"
          constraints: "Non-empty, alphanumeric with underscores"
        - name: "DisplayHint"
          type: "string"
          description: "Brief description for verbose display"
          constraints: "Optional, max 80 characters"
        - name: "Content"
          type: "string"
          description: "Full instruction text for agent consumption"
          constraints: "Non-empty"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/risks.md"
      description: "Update with opt-in configuration instructions"
    - path: "docs/reference.md"
      description: "Add enable_risk_assessment config option documentation"
  source_code:
    - path: "internal/config/config.go"
      description: "Add EnableRiskAssessment field to Configuration struct"
    - path: "internal/workflow/risk_assessment.go"
      description: "New file with BuildRiskAssessmentInstructions and InjectRiskAssessment"
    - path: "internal/workflow/stage_executor.go"
      description: "Modify buildPlanCommand to conditionally inject risk instructions"
    - path: "internal/commands/autospec.plan.md"
      description: "Remove hardcoded risks section from template"
  tests:
    - path: "internal/config/config_test.go"
      description: "Tests for EnableRiskAssessment field loading and defaults"
    - path: "internal/workflow/risk_assessment_test.go"
      description: "Tests for BuildRiskAssessmentInstructions and InjectRiskAssessment"
    - path: "internal/workflow/stage_executor_test.go"
      description: "Tests for buildPlanCommand with risk assessment injection"

implementation_phases:
  - phase: 1
    name: "Config and Core Functions"
    goal: "Add config field and create injection functions following existing patterns"
    deliverables:
      - "EnableRiskAssessment field in Configuration struct"
      - "BuildRiskAssessmentInstructions() function"
      - "InjectRiskAssessment() helper function"
      - "Unit tests for all new functions"
  - phase: 2
    name: "Template and Integration"
    goal: "Integrate injection into plan workflow and update template"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Modified buildPlanCommand with conditional injection"
      - "Updated autospec.plan.md template (risks section removed)"
      - "Integration tests for plan generation with/without risk assessment"
  - phase: 3
    name: "Documentation"
    goal: "Update documentation to explain opt-in behavior"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Updated docs/risks.md with configuration instructions"
      - "Updated docs/reference.md with enable_risk_assessment option"

open_questions:
  - question: "Should verbose mode show injection indicator for risk assessment?"
    context: "US-003 mentions [+RiskAssessment] indicator in verbose mode"
    proposed_resolution: "Yes, follow auto-commit pattern with DisplayHint for verbose output"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.7.3"
  created: "2026-01-01T20:34:00Z"
  artifact_type: "plan"
