plan:
  branch: "086-dag-schema-validation"
  created: "2026-01-11"
  spec_path: "specs/086-dag-schema-validation/spec.yaml"

summary: |
  Implement DAG schema validation and visualization for multi-spec workflow orchestration.
  This feature adds a `dag` command group with `validate` and `visualize` subcommands that
  parse YAML configuration files defining spec dependencies across layers. The implementation
  leverages existing patterns from the taskgraph package for cycle detection and ASCII rendering,
  and follows the established CLI structure using Cobra command groups (similar to worktree).

  Key technical decisions include: reusing the DependencyGraph cycle detection algorithm,
  creating a dedicated validation schema for DAG artifacts, and storing DAG files in
  `.autospec/dags/` following XDG-style conventions. ASCII-only visualization ensures
  cross-platform compatibility without external dependencies.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.1"
      purpose: "CLI command structure and argument parsing"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing with line/column tracking for error messages"
    - name: "github.com/stretchr/testify"
      version: "v1.9.0"
      purpose: "Test assertions and require helpers"
  storage: "File-based YAML in .autospec/dags/*.yaml"
  testing:
    framework: "Go testing with testify"
    approach: "Map-based table tests with t.Parallel(), unit tests for parser/validator/visualizer, integration tests for CLI commands"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Validation <10ms for DAGs with up to 50 features"
  constraints:
    - "No execution logic - schema and validation only"
    - "No worktree creation - deferred to Spec 2"
    - "No state persistence - deferred to Spec 2"
    - "ASCII-only visualization - no mermaid or graphical output"
    - "Functions must be under 40 lines"
    - "All errors wrapped with context"
  scale_scope: "DAGs with up to 50 features across multiple layers"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Plan includes tests before implementation in Phase 1"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "Core purpose is DAG validation; errors reported before execution can begin"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Validation <10ms target explicitly stated in NFR-005"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "N/A"
      notes: "Validation is read-only; no state mutation"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Commands will use exit 0 for valid, non-zero for invalid"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "DAG files are YAML format with schema validation"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "Final FR-011 requires make fmt && make lint to pass"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "NFRs require <40 line functions, error wrapping, map-based tests"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "No command templates modified in this feature"

research_findings:
  decisions:
    - topic: "CLI command structure"
      decision: "Create internal/cli/dag/ package with parent command and subcommands"
      rationale: "Follows established pattern from internal/cli/worktree/ which uses same grouped command approach"
      alternatives_considered:
        - "Add commands directly to util/ package"
        - "Create separate binary for DAG operations"
    - topic: "Cycle detection algorithm"
      decision: "Adapt existing DependencyGraph.DetectCycle() from taskgraph package"
      rationale: "Proven DFS-based algorithm already exists; provides cycle path in error message"
      alternatives_considered:
        - "Implement Tarjan's algorithm for strongly connected components"
        - "Use Kahn's algorithm with in-degree tracking"
    - topic: "YAML parsing with line numbers"
      decision: "Use yaml.v3 Node API for error location tracking"
      rationale: "yaml.v3 provides Line and Column fields on nodes for precise error reporting"
      alternatives_considered:
        - "Parse twice - once for errors, once for data"
        - "Use JSON schema validation library"
    - topic: "Visualization approach"
      decision: "Adapt taskgraph/visualize.go ASCII rendering patterns"
      rationale: "Existing implementation is portable, tested, and follows project conventions"
      alternatives_considered:
        - "Use box-drawing Unicode characters"
        - "Generate DOT format for Graphviz"
    - topic: "DAG file location"
      decision: "Store in .autospec/dags/*.yaml"
      rationale: "Follows XDG-style project config directory pattern; keeps DAGs with other autospec artifacts"
      alternatives_considered:
        - "Store alongside specs in specs/dag.yaml"
        - "Store in root as autospec-dag.yaml"

data_model:
  entities:
    - name: "DAGConfig"
      description: "Root configuration structure for a DAG file"
      fields:
        - name: "SchemaVersion"
          type: "string"
          description: "Schema format version (e.g., '1.0')"
          constraints: "Required, semantic version format"
        - name: "DAG"
          type: "DAGMetadata"
          description: "DAG metadata including name"
          constraints: "Required"
        - name: "Layers"
          type: "[]Layer"
          description: "Ordered list of execution layers"
          constraints: "Required, at least one layer"
      relationships:
        - target: "Layer"
          type: "one-to-many"
          description: "DAG contains multiple ordered layers"
    - name: "DAGMetadata"
      description: "Metadata about the DAG"
      fields:
        - name: "Name"
          type: "string"
          description: "Human-readable name for the DAG"
          constraints: "Required, non-empty"
      relationships: []
    - name: "Layer"
      description: "A grouping of features that can be processed together"
      fields:
        - name: "ID"
          type: "string"
          description: "Unique identifier (e.g., 'L0', 'L1')"
          constraints: "Required, unique within DAG"
        - name: "Name"
          type: "string"
          description: "Optional human-readable name"
          constraints: "Optional"
        - name: "DependsOn"
          type: "[]string"
          description: "Layer IDs this layer depends on"
          constraints: "Optional, must reference existing layer IDs"
        - name: "Features"
          type: "[]Feature"
          description: "Features in this layer"
          constraints: "Required, at least one feature"
      relationships:
        - target: "Layer"
          type: "many-to-many"
          description: "Layer can depend on multiple other layers"
        - target: "Feature"
          type: "one-to-many"
          description: "Layer contains multiple features"
    - name: "Feature"
      description: "A reference to a spec folder representing a single feature"
      fields:
        - name: "ID"
          type: "string"
          description: "Spec folder name (must exist in specs/<id>/)"
          constraints: "Required, unique across entire DAG"
        - name: "Description"
          type: "string"
          description: "Human-readable description used by autospec run -spti to create spec if folder doesn't exist"
          constraints: "Required"
        - name: "DependsOn"
          type: "[]string"
          description: "Feature IDs this feature depends on"
          constraints: "Optional, must reference existing feature IDs"
        - name: "Timeout"
          type: "string"
          description: "Override default timeout for this spec (e.g., '30m', '1h')"
          constraints: "Optional, duration format"
      relationships:
        - target: "Feature"
          type: "many-to-many"
          description: "Feature can depend on multiple other features"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/dag-validation.md"
      description: "User documentation for DAG schema and validation commands"
  source_code:
    - path: "internal/dag/"
      description: "DAG parsing, validation, and visualization logic"
    - path: "internal/dag/types.go"
      description: "DAGConfig, Layer, Feature struct definitions"
    - path: "internal/dag/parser.go"
      description: "YAML parsing with line number tracking"
    - path: "internal/dag/validator.go"
      description: "Schema validation, cycle detection, spec reference checking"
    - path: "internal/dag/visualizer.go"
      description: "ASCII diagram generation"
    - path: "internal/cli/dag/"
      description: "CLI command definitions for dag validate and dag visualize"
    - path: "internal/cli/dag/dag.go"
      description: "Parent command group"
    - path: "internal/cli/dag/validate.go"
      description: "validate subcommand implementation"
    - path: "internal/cli/dag/visualize.go"
      description: "visualize subcommand implementation"
  tests:
    - path: "internal/dag/*_test.go"
      description: "Unit tests for parser, validator, visualizer"
    - path: "internal/cli/dag/*_test.go"
      description: "Integration tests for CLI commands"

implementation_phases:
  - phase: 1
    name: "Core Types and Parser"
    goal: "Define data structures and implement YAML parsing with line number tracking"
    deliverables:
      - "internal/dag/types.go - DAGConfig, Layer, Feature structs with YAML tags"
      - "internal/dag/parser.go - ParseDAGFile() function using yaml.v3 Node API"
      - "internal/dag/parser_test.go - Map-based table tests for parser"
  - phase: 2
    name: "Validation Logic"
    goal: "Implement schema validation, cycle detection, and spec reference validation"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/dag/validator.go - ValidateDAG() with all validation rules"
      - "internal/dag/errors.go - Structured validation error types"
      - "internal/dag/validator_test.go - Tests for all validation scenarios"
  - phase: 3
    name: "ASCII Visualization"
    goal: "Generate ASCII diagrams showing layer structure and dependencies"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/dag/visualizer.go - RenderASCII() function"
      - "internal/dag/visualizer_test.go - Tests for visualization output"
  - phase: 4
    name: "CLI Commands"
    goal: "Implement dag validate and dag visualize subcommands"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "internal/cli/dag/dag.go - Parent DagCmd"
      - "internal/cli/dag/validate.go - validateCmd with runValidate()"
      - "internal/cli/dag/visualize.go - visualizeCmd with runVisualize()"
      - "Register dag commands in CLI"
  - phase: 5
    name: "Documentation and Polish"
    goal: "Add user documentation, ensure all quality gates pass"
    dependencies:
      - "Phase 4"
    deliverables:
      - "docs/public/dag-validation.md - User documentation"
      - "All tests passing: make test"
      - "Code formatted: make fmt"
      - "Linting clean: make lint"
      - "Build successful: make build"

open_questions:
  - question: "Should dag validate accept stdin for piped input?"
    context: "Could be useful for CI pipelines that generate DAG configs dynamically"
    proposed_resolution: "Defer to future enhancement; focus on file-based input for Spec 1"
  - question: "Should visualization show spec.yaml status (exists, has plan, etc.)?"
    context: "Would provide more context but increases scope and couples to spec detection logic"
    proposed_resolution: "Keep visualization simple for Spec 1; show only structure and dependencies"

risks:
  - risk: "YAML line number tracking may be complex with yaml.v3 Node API"
    likelihood: "medium"
    impact: "low"
    mitigation: "Fall back to approximate line numbers from raw text parsing if needed"
  - risk: "ASCII visualization may become unwieldy for large DAGs"
    likelihood: "low"
    impact: "medium"
    mitigation: "Add --compact flag option or truncate output with indicator for very large DAGs"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.2"
  created: "2026-01-11T07:32:56Z"
  artifact_type: "plan"
