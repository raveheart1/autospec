feature:
  branch: "086-dag-schema-validation"
  created: "2026-01-11"
  status: "Draft"
  input: "Define YAML schema for multi-spec DAG workflows. Add validation and visualization commands. Part of DAG Multi-Spec Orchestration - a meta-orchestrator that runs multiple autospec run workflows in parallel across worktrees with dependency management."

user_stories:
  - id: "US-001"
    title: "Validate DAG Configuration"
    priority: "P1"
    as_a: "developer managing multiple feature specs"
    i_want: "to validate my DAG configuration file for structural correctness"
    so_that: "I catch errors before attempting to run the orchestrator"
    why_this_priority: "Validation is foundational - without it, users would encounter cryptic errors during execution"
    independent_test: "Create a DAG file, run validation command, verify pass/fail result"
    acceptance_scenarios:
      - given: "a DAG file with valid schema, no cycles, and existing specs"
        when: "I run autospec dag validate <file>"
        then: "the command exits with code 0 and displays 'Valid'"
      - given: "a DAG file with invalid YAML syntax"
        when: "I run autospec dag validate <file>"
        then: "the command exits with non-zero code and displays parsing error with line number"
      - given: "a DAG file with a cycle in dependencies"
        when: "I run autospec dag validate <file>"
        then: "the command exits with non-zero code and displays the cycle path"
      - given: "a DAG file referencing a spec that doesn't exist"
        when: "I run autospec dag validate <file>"
        then: "the command exits with non-zero code and lists the missing spec folder"

  - id: "US-002"
    title: "Visualize DAG Structure"
    priority: "P1"
    as_a: "developer managing multiple feature specs"
    i_want: "to see an ASCII diagram of my DAG structure"
    so_that: "I can understand the dependencies between specs at a glance"
    why_this_priority: "Visualization is critical for understanding complex dependency graphs"
    independent_test: "Create a DAG file, run visualization command, verify ASCII output"
    acceptance_scenarios:
      - given: "a valid DAG file with multiple layers and features"
        when: "I run autospec dag visualize <file>"
        then: "an ASCII diagram is displayed showing layers, features, and dependency arrows"
      - given: "an invalid DAG file"
        when: "I run autospec dag visualize <file>"
        then: "validation errors are shown instead of the diagram"

  - id: "US-003"
    title: "Define DAG Schema"
    priority: "P1"
    as_a: "developer creating DAG configurations"
    i_want: "a well-defined YAML schema for DAG files"
    so_that: "I know exactly what format to use when defining multi-spec workflows"
    why_this_priority: "Schema definition enables all other functionality"
    independent_test: "Create DAG file following schema, verify it parses correctly"
    acceptance_scenarios:
      - given: "the documented schema specification"
        when: "I create a DAG file following the schema"
        then: "the file parses successfully with all required fields"
      - given: "a DAG file missing required fields"
        when: "I run validation"
        then: "clear error messages indicate which fields are missing"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST parse DAG YAML files with schema_version, dag name, and layers sections"
      testable: true
      acceptance_criteria: "Parser correctly extracts all schema fields from valid YAML"
    - id: "FR-002"
      description: "MUST detect cycles in feature dependencies within and across layers"
      testable: true
      acceptance_criteria: "Cycles like A→B→C→A are detected and reported with the full cycle path"
    - id: "FR-003"
      description: "MUST validate that referenced spec folders exist in specs/<id>/"
      testable: true
      acceptance_criteria: "Missing specs are listed with their expected path"
    - id: "FR-004"
      description: "MUST validate layer dependencies (layer depends_on references)"
      testable: true
      acceptance_criteria: "Invalid layer references are detected and reported"
    - id: "FR-005"
      description: "MUST generate ASCII visualization of the DAG structure"
      testable: true
      acceptance_criteria: "Output shows layers, features, and arrows indicating dependencies"
    - id: "FR-006"
      description: "MUST NOT generate mermaid or other non-ASCII visualization formats"
      testable: true
      acceptance_criteria: "Visualization output contains only ASCII characters"
    - id: "FR-007"
      description: "MUST support the dag validate <file> subcommand"
      testable: true
      acceptance_criteria: "Command accepts file path argument and returns exit code"
    - id: "FR-008"
      description: "MUST support the dag visualize <file> subcommand"
      testable: true
      acceptance_criteria: "Command accepts file path argument and produces ASCII output"
    - id: "FR-009"
      description: "MUST report YAML parsing errors with line numbers"
      testable: true
      acceptance_criteria: "Parse errors include the line number where the error occurred"
    - id: "FR-010"
      description: "MUST store DAG files in .autospec/dags/*.yaml location"
      testable: true
      acceptance_criteria: "Parser accepts files from this directory structure"
    - id: "FR-011"
      description: "MUST ensure make test && make fmt && make lint && make build all exit 0"
      testable: true
      acceptance_criteria: "All make targets pass after implementation"

  non_functional:
    - id: "NFR-001"
      category: "code_quality"
      description: "All functions MUST be under 40 lines"
      measurable_target: "Zero functions exceed 40 lines"
    - id: "NFR-002"
      category: "code_quality"
      description: "All errors MUST be wrapped with context using fmt.Errorf with %w"
      measurable_target: "Zero bare error returns in non-trivial functions"
    - id: "NFR-003"
      category: "code_quality"
      description: "Tests MUST use map-based table tests with map[string]struct"
      measurable_target: "All test functions use map-based table tests"
    - id: "NFR-004"
      category: "code_quality"
      description: "Functions MUST accept interfaces and return concrete types where applicable"
      measurable_target: "Interface parameters used for dependencies"
    - id: "NFR-005"
      category: "performance"
      description: "Validation MUST complete in under 10ms for files with up to 50 features"
      measurable_target: "<10ms validation time"
    - id: "NFR-006"
      category: "usability"
      description: "Error messages MUST clearly indicate what's wrong and how to fix it"
      measurable_target: "Error messages include actionable guidance"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can validate DAG files and receive clear pass/fail feedback"
      metric: "Validation command exit codes"
      target: "Exit 0 for valid, non-zero for invalid"
    - id: "SC-002"
      description: "Users can visualize DAG structures as ASCII diagrams"
      metric: "ASCII visualization generation"
      target: "Diagram produced for any valid DAG file"
    - id: "SC-003"
      description: "Cycles are detected and reported before execution"
      metric: "Cycle detection accuracy"
      target: "100% of cycles detected with full path shown"
    - id: "SC-004"
      description: "Missing specs are identified before execution"
      metric: "Spec existence validation"
      target: "100% of missing specs reported with expected path"

key_entities:
  - name: "DAG"
    description: "A directed acyclic graph configuration containing layers and features"
    attributes:
      - "schema_version: version of the DAG schema format"
      - "name: human-readable name for the DAG"
  - name: "Layer"
    description: "A grouping of features that can be processed together"
    attributes:
      - "id: unique identifier for the layer (e.g., L0, L1)"
      - "name: optional human-readable name"
      - "depends_on: list of layer IDs this layer depends on"
      - "features: list of features in this layer"
  - name: "Feature"
    description: "A reference to a spec folder that represents a single feature"
    attributes:
      - "id: spec folder name (must exist in specs/<id>/)"
      - "description: human-readable description (REQUIRED - used by autospec run -spti to create spec if folder doesn't exist)"
      - "depends_on: optional list of feature IDs this feature depends on"
      - "timeout: optional override for default timeout"

edge_cases:
  - scenario: "Empty layers list"
    expected_behavior: "Validation succeeds but warns that DAG has no features to process"
  - scenario: "Feature depends on itself"
    expected_behavior: "Detected as a cycle and reported"
  - scenario: "Layer depends on non-existent layer"
    expected_behavior: "Validation error with list of valid layer IDs"
  - scenario: "Feature in later layer depends on feature in earlier layer (cross-layer)"
    expected_behavior: "Dependency is valid as long as no cycle exists"
  - scenario: "Duplicate feature IDs across layers"
    expected_behavior: "Validation error indicating duplicate feature ID"
  - scenario: "File path argument is a directory"
    expected_behavior: "Error message indicating a file path is required"
  - scenario: "File has YAML extension but is empty"
    expected_behavior: "Validation error indicating required fields are missing"

assumptions:
  - "Spec folders are in the standard specs/<feature-id>/ location"
  - "DAG files use YAML format with .yaml extension"
  - "Feature IDs match their spec folder names exactly"
  - "Layer IDs are unique within a DAG file"
  - "A feature can only appear once in the entire DAG"
  - "Cross-layer dependencies are allowed (feature in L1 can depend on feature in L0)"
  - "ASCII visualization will fit within standard terminal width (80-120 characters)"

constraints:
  - "No execution logic - this spec covers schema and validation only"
  - "No worktree creation - deferred to Spec 2"
  - "No state persistence - deferred to Spec 2"
  - "ASCII-only visualization - no mermaid or graphical output"
  - "Must integrate with existing autospec CLI command structure"

out_of_scope:
  - "Executing DAG workflows (Spec 2)"
  - "Creating git worktrees for parallel execution (Spec 2)"
  - "Persisting execution state (Spec 2)"
  - "Progress tracking and status display (Spec 2)"
  - "Mermaid diagram generation"
  - "Interactive DAG building/editing"
  - "DAG file generation from existing specs"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.2"
  created: "2026-01-11T07:31:58Z"
  artifact_type: "spec"
