feature:
    branch: "091-worktree-copy-setup"
    created: "2026-01-11"
    status: "Completed"
    completed_at: 2026-01-11T19:07:54Z
    input: |
        Enhance worktree creation with directory copying, custom setup scripts, and validation.

        Part of DAG Multi-Spec Orchestration - a meta-orchestrator that runs multiple
        autospec run workflows in parallel across worktrees with dependency management.

        Key deliverables:
        - Directory copying: worktree.copy_dirs config option to copy untracked but essential
          directories before setup script runs. Handle missing dirs gracefully (warn, don't fail).
        - Setup script support: Default autospec built-in setup or custom user script with
          5-minute timeout (configurable via worktree.setup_timeout). Script receives worktree
          path as first argument.
        - Custom script validation: Validate worktree directory exists, differs from source repo,
          and appears in git worktree list. Fail with clear error if validation fails.
        - Rollback on failure: If setup script fails or validation fails, delete worktree
          automatically unless --no-rollback flag used.
        - New flags: --skip-copy, --skip-setup, --no-rollback
user_stories:
    - id: "US-001"
      title: "Skip directory copying during worktree creation"
      priority: "P2"
      as_a: "developer"
      i_want: "to bypass directory copying when creating a worktree"
      so_that: "I can quickly create a worktree without waiting for large directories to copy"
      why_this_priority: "Useful for advanced users but not essential for core functionality"
      independent_test: "Create worktree with --skip-copy flag and verify directories are not copied"
      acceptance_scenarios:
        - given: "A repository with configured copy_dirs"
          when: "I run 'autospec worktree create feature-x --branch feat/x --skip-copy'"
          then: "The worktree is created without copying any directories from copy_dirs"
        - given: "A worktree created with --skip-copy"
          when: "I check the worktree directory"
          then: "The configured directories (.autospec, .claude, etc.) are not present"
    - id: "US-002"
      title: "Skip setup script during worktree creation"
      priority: "P2"
      as_a: "developer"
      i_want: "to bypass the setup script when creating a worktree"
      so_that: "I can manually configure the worktree or debug setup issues"
      why_this_priority: "Useful for debugging and advanced workflows but not core functionality"
      independent_test: "Create worktree with --skip-setup flag and verify setup script is not executed"
      acceptance_scenarios:
        - given: "A repository with a configured setup_script"
          when: "I run 'autospec worktree create feature-x --branch feat/x --skip-setup'"
          then: "The worktree is created without running the setup script"
        - given: "A worktree created with --skip-setup"
          when: "I check the worktree state"
          then: "SetupCompleted is marked as false and a message indicates setup was skipped"
    - id: "US-003"
      title: "Configurable setup script timeout"
      priority: "P1"
      as_a: "developer"
      i_want: "the setup script to have a configurable timeout"
      so_that: "long-running scripts don't hang indefinitely and I can adjust for my project's needs"
      why_this_priority: "Essential for production use to prevent hung processes"
      independent_test: "Configure different timeout values and verify enforcement"
      acceptance_scenarios:
        - given: "A setup script that takes 10 seconds"
          when: "I configure setup_timeout: 5s and run worktree create"
          then: "The script is terminated after 5 seconds and an error is reported"
        - given: "A setup script that takes 10 seconds"
          when: "I configure setup_timeout: 30s and run worktree create"
          then: "The script completes successfully within the timeout"
        - given: "No setup_timeout configured"
          when: "I run worktree create with a setup script"
          then: "The default 5-minute timeout is used"
    - id: "US-004"
      title: "Worktree validation after custom setup"
      priority: "P1"
      as_a: "developer"
      i_want: "worktree creation to validate the result after a custom setup script runs"
      so_that: "I get immediate feedback if the setup script broke the worktree"
      why_this_priority: "Essential for reliable DAG orchestration - invalid worktrees cause failures"
      independent_test: "Run validation checks with various worktree states"
      acceptance_scenarios:
        - given: "A custom setup script that completes"
          when: "The script creates a valid worktree"
          then: "Validation passes and worktree is ready for use"
        - given: "A custom setup script that deletes the worktree directory"
          when: "Validation runs"
          then: "Error message: 'Worktree path does not exist: <path>'"
        - given: "A custom setup script that changes cwd back to source repo"
          when: "Validation runs"
          then: "Error message: 'Worktree cwd same as source repo (script may have cd'd back)'"
        - given: "A worktree path not in git worktree list"
          when: "Validation runs"
          then: "Error message indicates worktree is not registered with git"
    - id: "US-005"
      title: "Automatic rollback on failure"
      priority: "P1"
      as_a: "developer"
      i_want: "the worktree to be automatically deleted if setup or validation fails"
      so_that: "I don't accumulate broken worktrees that need manual cleanup"
      why_this_priority: "Essential for DAG orchestration reliability and automated workflows"
      independent_test: "Trigger setup/validation failures and verify automatic cleanup"
      acceptance_scenarios:
        - given: "A setup script that exits with non-zero status"
          when: "Worktree creation completes"
          then: "The worktree directory is deleted and an error is reported with rollback log"
        - given: "A setup script that times out"
          when: "Worktree creation completes"
          then: "The worktree directory is deleted and a timeout error is reported"
        - given: "Validation fails after setup script"
          when: "Worktree creation completes"
          then: "The worktree directory is deleted and validation errors are reported"
        - given: "A rollback occurs"
          when: "I check the output"
          then: "The message indicates what was deleted for debugging purposes"
    - id: "US-006"
      title: "Prevent automatic rollback"
      priority: "P2"
      as_a: "developer"
      i_want: "to prevent automatic rollback on failure using a flag"
      so_that: "I can inspect the broken worktree state for debugging"
      why_this_priority: "Important for debugging but not essential for normal operation"
      independent_test: "Create worktree with --no-rollback and failing setup, verify worktree persists"
      acceptance_scenarios:
        - given: "A setup script that fails"
          when: "I run 'autospec worktree create feature-x --branch feat/x --no-rollback'"
          then: "The worktree directory is preserved despite the failure"
        - given: "A worktree preserved with --no-rollback"
          when: "I check the output"
          then: "A warning indicates the worktree is in a broken state and may need manual cleanup"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST add --skip-copy flag to 'autospec worktree create' command"
          testable: true
          acceptance_criteria: "Flag appears in --help, bypasses copy_dirs when set"
        - id: "FR-002"
          description: "MUST add --skip-setup flag to 'autospec worktree create' command"
          testable: true
          acceptance_criteria: "Flag appears in --help, bypasses setup_script when set"
        - id: "FR-003"
          description: "MUST add --no-rollback flag to 'autospec worktree create' command"
          testable: true
          acceptance_criteria: "Flag appears in --help, prevents cleanup on failure when set"
        - id: "FR-004"
          description: "MUST add worktree.setup_timeout configuration option"
          testable: true
          acceptance_criteria: "Config accepted in .autospec/config.yml, parsed as duration string (e.g., '5m', '30s')"
        - id: "FR-005"
          description: "MUST enforce setup_timeout by terminating script if exceeded"
          testable: true
          acceptance_criteria: "Script process is killed after timeout, error includes 'timeout' in message"
        - id: "FR-006"
          description: "MUST default setup_timeout to 5 minutes when not configured"
          testable: true
          acceptance_criteria: "Default value applied when config field empty or missing"
        - id: "FR-007"
          description: "MUST validate worktree path exists after custom setup script"
          testable: true
          acceptance_criteria: "os.Stat on worktree path returns no error"
        - id: "FR-008"
          description: "MUST validate worktree path differs from source repository path"
          testable: true
          acceptance_criteria: "Absolute paths compared and must be different"
        - id: "FR-009"
          description: "MUST validate worktree appears in 'git worktree list' output"
          testable: true
          acceptance_criteria: "Worktree path found in git worktree list entries"
        - id: "FR-010"
          description: "MUST run validation only when a custom setup_script is configured"
          testable: true
          acceptance_criteria: "Validation skipped when setup_script is empty"
        - id: "FR-011"
          description: "MUST delete worktree on setup script failure (non-zero exit)"
          testable: true
          acceptance_criteria: "git worktree remove called, directory no longer exists"
        - id: "FR-012"
          description: "MUST delete worktree on setup script timeout"
          testable: true
          acceptance_criteria: "git worktree remove called after timeout detected"
        - id: "FR-013"
          description: "MUST delete worktree on validation failure"
          testable: true
          acceptance_criteria: "git worktree remove called when any validation check fails"
        - id: "FR-014"
          description: "MUST log rollback actions with deleted path for debugging"
          testable: true
          acceptance_criteria: "Output includes 'Rolling back:' or similar with path"
        - id: "FR-015"
          description: "MUST preserve worktree when --no-rollback flag is set despite failure"
          testable: true
          acceptance_criteria: "Worktree directory exists after failed setup/validation"
        - id: "FR-016"
          description: "MUST emit warning when worktree preserved in broken state"
          testable: true
          acceptance_criteria: "Output includes warning about manual cleanup needed"
        - id: "FR-017"
          description: "MUST copy directories before running setup script"
          testable: true
          acceptance_criteria: "Directories present in worktree when setup script starts"
        - id: "FR-018"
          description: "MUST handle missing copy_dirs gracefully with warning, not error"
          testable: true
          acceptance_criteria: "Missing directories logged as warning, creation continues"
        - id: "FR-019"
          description: "Functions MUST be under 40 lines following project coding standards"
          testable: true
          acceptance_criteria: "No function exceeds 40 lines after implementation"
        - id: "FR-020"
          description: "Errors MUST be wrapped with context following project conventions"
          testable: true
          acceptance_criteria: "All returned errors use fmt.Errorf with %w verb"
        - id: "FR-021"
          description: "Tests MUST use map-based table test pattern"
          testable: true
          acceptance_criteria: "Test files use map[string]struct{} for test cases"
        - id: "FR-022"
          description: "MUST pass 'make test && make fmt && make lint && make build' on completion"
          testable: true
          acceptance_criteria: "All commands exit 0"
    non_functional:
        - id: "NFR-001"
          category: "reliability"
          description: "Rollback MUST complete even if partial deletion occurs"
          measurable_target: "Best-effort cleanup with logged errors, never leaves orphan git worktree references"
        - id: "NFR-002"
          category: "usability"
          description: "Error messages MUST include actionable guidance"
          measurable_target: "Each validation error includes suggestion for resolution"
        - id: "NFR-003"
          category: "performance"
          description: "Validation checks MUST complete within 2 seconds"
          measurable_target: "All three validation checks combined under 2 seconds"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Users can skip directory copying during worktree creation"
          metric: "Worktree created without specified directories"
          target: "--skip-copy flag functional with clear output"
        - id: "SC-002"
          description: "Users can skip setup script during worktree creation"
          metric: "Worktree created without running setup script"
          target: "--skip-setup flag functional with clear output"
        - id: "SC-003"
          description: "Setup scripts are terminated if they exceed configured timeout"
          metric: "Long-running scripts killed within 1 second of timeout"
          target: "Timeout enforcement works with default and custom values"
        - id: "SC-004"
          description: "Invalid worktrees are detected and reported with clear errors"
          metric: "All three validation checks implemented and tested"
          target: "100% of validation scenarios in US-004 covered by tests"
        - id: "SC-005"
          description: "Failed worktrees are automatically cleaned up"
          metric: "No orphan worktrees after failures"
          target: "Rollback tested for all failure modes"
        - id: "SC-006"
          description: "Debugging is possible by preserving failed worktrees"
          metric: "--no-rollback flag prevents cleanup"
          target: "Users can inspect failed state when needed"
key_entities:
    - name: "WorktreeConfig"
      description: "Configuration structure for worktree settings"
      attributes:
        - "setup_timeout: duration string (default: '5m')"
        - "existing: base_dir, prefix, setup_script, auto_setup, track_status, copy_dirs"
    - name: "ValidationResult"
      description: "Result of worktree validation after setup"
      attributes:
        - "PathExists: boolean"
        - "PathDiffersFromSource: boolean"
        - "InGitWorktreeList: boolean"
        - "Errors: list of validation error messages"
    - name: "CreateOptions"
      description: "Options for worktree create command"
      attributes:
        - "SkipCopy: boolean"
        - "SkipSetup: boolean"
        - "NoRollback: boolean"
edge_cases:
    - scenario: "Setup script exits 0 but worktree is invalid"
      expected_behavior: "Validation catches the issue, rollback occurs, clear error reported"
    - scenario: "Setup script hangs indefinitely"
      expected_behavior: "Timeout kills process, rollback occurs, timeout error reported"
    - scenario: "Rollback fails (e.g., permission denied)"
      expected_behavior: "Error logged with worktree path for manual cleanup, command exits with error"
    - scenario: "All copy_dirs are missing"
      expected_behavior: "Warnings logged for each, creation continues, no error"
    - scenario: "Both --skip-copy and --skip-setup specified"
      expected_behavior: "Both respected, minimal worktree created (git only)"
    - scenario: "Timeout set to 0 or negative"
      expected_behavior: "Use default 5-minute timeout, log warning about invalid config"
    - scenario: "Setup script writes to stdout during execution"
      expected_behavior: "Output displayed in real-time to user"
    - scenario: "Worktree path exists but is not a git worktree"
      expected_behavior: "Validation fails with clear error about git worktree status"
assumptions:
    - "Existing directory copying implementation (CopyDirs) is correct and reusable"
    - "Existing setup script execution (RunSetupScript) provides a foundation to extend"
    - "Git worktree commands are available and working in the user's environment"
    - "Setup scripts are bash-compatible or platform-native executables"
    - "The source repository has git worktree support (git 2.5+)"
constraints:
    - "Must maintain backward compatibility with existing worktree.create behavior"
    - "Timeout implementation must work across platforms (Linux, macOS, Windows)"
    - "Rollback must use git worktree remove to properly clean up git state"
    - "No glob pattern support for copy_dirs (explicit paths only per original spec)"
    - "No post-setup copying (per original spec)"
out_of_scope:
    - "Glob pattern support for copy_dirs"
    - "Post-setup directory copying"
    - "Parallel directory copying"
    - "Custom validation hooks beyond the three specified checks"
    - "Remote worktree support"
    - "Worktree migration between machines"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.8.2"
    created: "2026-01-11T18:27:40Z"
    artifact_type: "spec"
