tasks:
    branch: "091-worktree-copy-setup"
    created: "2026-01-11"
    spec_path: "specs/091-worktree-copy-setup/spec.yaml"
    plan_path: "specs/091-worktree-copy-setup/plan.yaml"
summary:
    total_tasks: 24
    total_phases: 9
    parallel_opportunities: 8
    estimated_complexity: "medium"
phases:
    - number: 1
      title: "Setup"
      purpose: "Add new types and configuration fields"
      tasks:
        - id: "T001"
          title: "Add SetupTimeout field to WorktreeConfig in internal/worktree/worktree.go"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/worktree/worktree.go"
          dependencies: []
          acceptance_criteria:
            - "SetupTimeout field of type time.Duration added to WorktreeConfig struct"
            - "Field has yaml tag 'setup_timeout'"
            - "Existing WorktreeConfig fields unchanged"
        - id: "T002"
          title: "Add CreateOptions struct in internal/worktree/worktree.go"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/worktree/worktree.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "CreateOptions struct with SkipCopy, SkipSetup, NoRollback bool fields"
            - "Struct is exported for use by CLI and Manager"
            - "Fields have clear documentation comments"
        - id: "T003"
          title: "Add default setup_timeout value in internal/config/defaults.go"
          status: "Completed"
          type: "setup"
          parallel: true
          story_id: null
          file_path: "internal/config/defaults.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "Default SetupTimeout of 5 minutes added to DefaultWorktreeConfig"
            - "Value is time.Duration(5 * time.Minute)"
    - number: 2
      title: "Foundational"
      purpose: "Core validation infrastructure that MUST be complete before user stories"
      tasks:
        - id: "T004"
          title: "Create ValidationResult type in internal/worktree/validate.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/worktree/validate.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "New file internal/worktree/validate.go created"
            - "ValidationResult struct with PathExists, PathDiffersFromSource, InGitWorktreeList bool fields"
            - "Errors field of type []string for validation error messages"
            - "IsValid() method returns true if all checks pass and Errors is empty"
        - id: "T005"
          title: "Implement ValidateWorktree function in internal/worktree/validate.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/worktree/validate.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "ValidateWorktree(worktreePath, sourceRepoPath string) (*ValidationResult, error)"
            - "Checks if worktree path exists using os.Stat"
            - "Checks if worktree path differs from source repo (absolute path comparison)"
            - "Checks if path appears in git worktree list output"
            - "Returns ValidationResult with all checks and any errors"
            - "Function under 40 lines"
        - id: "T006"
          title: "Write tests for ValidateWorktree in internal/worktree/validate_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/worktree/validate_test.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "Map-based table tests for ValidateWorktree"
            - "Test case: valid worktree passes all checks"
            - "Test case: non-existent path fails PathExists check"
            - "Test case: same as source repo fails PathDiffersFromSource check"
            - "Test case: path not in git worktree list fails InGitWorktreeList check"
            - "Test case: error messages are actionable"
    - number: 3
      title: "User Story 1 - Configurable setup script timeout"
      purpose: "Implement timeout enforcement for setup scripts"
      story_reference: "US-003"
      independent_test: "Configure different timeout values and verify enforcement"
      tasks:
        - id: "T007"
          title: "Add SetupResult struct with TimedOut field in internal/worktree/setup.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/worktree/setup.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "SetupResult struct with TimedOut bool field added"
            - "Struct captures whether script exceeded timeout"
        - id: "T008"
          title: "Implement RunSetupScriptWithTimeout in internal/worktree/setup.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/worktree/setup.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "RunSetupScriptWithTimeout(ctx context.Context, scriptPath, worktreePath string, timeout time.Duration) (*SetupResult, error)"
            - "Uses exec.CommandContext with context.WithTimeout for cross-platform timeout"
            - "Returns SetupResult with TimedOut=true if context.DeadlineExceeded"
            - "Logs timeout warning with configured duration"
            - "Script receives worktree path as first argument"
            - "Function under 40 lines"
        - id: "T009"
          title: "Write tests for RunSetupScriptWithTimeout in internal/worktree/setup_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-003"
          file_path: "internal/worktree/setup_test.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "Map-based table tests for RunSetupScriptWithTimeout"
            - "Test case: script completes within timeout returns success"
            - "Test case: script exceeds timeout returns TimedOut=true"
            - "Test case: script receives worktree path as argument"
            - "Test case: default 5-minute timeout used when not configured"
            - "Test case: invalid/zero timeout defaults to 5 minutes with warning"
    - number: 4
      title: "User Story 2 - Worktree validation after custom setup"
      purpose: "Run validation after custom setup scripts complete"
      story_reference: "US-004"
      independent_test: "Run validation checks with various worktree states"
      tasks:
        - id: "T010"
          title: "Integrate validation into Manager after custom setup in internal/worktree/manager.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/worktree/manager.go"
          dependencies: ["T005", "T008"]
          acceptance_criteria:
            - "After custom setup_script runs, call ValidateWorktree"
            - "Validation only runs when setup_script is non-empty (not for default setup)"
            - "If validation fails, return error with all validation errors"
            - "Validation runs before success message"
        - id: "T011"
          title: "Write integration tests for validation in Manager in internal/worktree/manager_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-004"
          file_path: "internal/worktree/manager_test.go"
          dependencies: ["T010"]
          acceptance_criteria:
            - "Map-based table tests for validation integration"
            - "Test case: valid custom script completes successfully"
            - "Test case: custom script that breaks worktree triggers validation failure"
            - "Test case: default setup (no custom script) skips validation"
            - "Test case: validation error messages are clear and actionable"
    - number: 5
      title: "User Story 3 - Automatic rollback on failure"
      purpose: "Implement automatic worktree cleanup on setup or validation failure"
      story_reference: "US-005"
      independent_test: "Trigger setup/validation failures and verify automatic cleanup"
      tasks:
        - id: "T012"
          title: "Implement rollbackWorktree method in internal/worktree/manager.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/worktree/manager.go"
          dependencies: ["T010"]
          acceptance_criteria:
            - "rollbackWorktree(worktreePath string) error method added to Manager"
            - "Uses git worktree remove --force for proper git state cleanup"
            - "Logs rollback action with deleted path"
            - "Handles partial cleanup failures gracefully (log error, continue)"
            - "Function under 40 lines"
        - id: "T013"
          title: "Integrate rollback into create workflow on failure in internal/worktree/manager.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/worktree/manager.go"
          dependencies: ["T012"]
          acceptance_criteria:
            - "Rollback called when setup script returns non-zero exit"
            - "Rollback called when setup script times out"
            - "Rollback called when validation fails"
            - "Rollback logs 'Rolling back:' message with worktree path"
        - id: "T014"
          title: "Write tests for rollback behavior in internal/worktree/manager_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-005"
          file_path: "internal/worktree/manager_test.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "Map-based table tests for rollback"
            - "Test case: rollback on script failure (non-zero exit)"
            - "Test case: rollback on script timeout"
            - "Test case: rollback on validation failure"
            - "Test case: rollback logs include deleted path"
            - "Test case: directory no longer exists after rollback"
    - number: 6
      title: "User Story 4 - Skip directory copying"
      purpose: "Add --skip-copy flag to bypass directory copying"
      story_reference: "US-001"
      independent_test: "Create worktree with --skip-copy flag and verify directories are not copied"
      tasks:
        - id: "T015"
          title: "Add CreateWithOptions method to Manager in internal/worktree/manager.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/worktree/manager.go"
          dependencies: ["T002", "T013"]
          acceptance_criteria:
            - "CreateWithOptions(name string, opts CreateOptions) (*Worktree, error) added"
            - "Update existing Create to call CreateWithOptions with default options"
            - "Skip CopyDirs when opts.SkipCopy is true"
            - "Backward compatible with existing behavior"
        - id: "T016"
          title: "Add --skip-copy flag to worktree create command in internal/cli/worktree/create.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cli/worktree/create.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "--skip-copy flag added with clear description"
            - "Flag passed to CreateOptions when calling Manager"
            - "Help text explains flag bypasses copy_dirs"
        - id: "T017"
          title: "Write tests for --skip-copy flag in internal/cli/worktree/worktree_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cli/worktree/worktree_test.go"
          dependencies: ["T016"]
          acceptance_criteria:
            - "Map-based table tests for --skip-copy"
            - "Test case: directories not copied when flag is set"
            - "Test case: directories copied when flag is not set (default behavior)"
    - number: 7
      title: "User Story 5 - Skip setup script"
      purpose: "Add --skip-setup flag to bypass setup script execution"
      story_reference: "US-002"
      independent_test: "Create worktree with --skip-setup flag and verify setup script is not executed"
      tasks:
        - id: "T018"
          title: "Implement SkipSetup support in CreateWithOptions in internal/worktree/manager.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/worktree/manager.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "Skip setup script execution when opts.SkipSetup is true"
            - "SetupCompleted marked as false when setup is skipped"
            - "Log message indicates setup was skipped"
        - id: "T019"
          title: "Add --skip-setup flag to worktree create command in internal/cli/worktree/create.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/worktree/create.go"
          dependencies: ["T018"]
          acceptance_criteria:
            - "--skip-setup flag added with clear description"
            - "Flag passed to CreateOptions when calling Manager"
            - "Help text explains flag bypasses setup script"
        - id: "T020"
          title: "Write tests for --skip-setup flag in internal/cli/worktree/worktree_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/worktree/worktree_test.go"
          dependencies: ["T019"]
          acceptance_criteria:
            - "Map-based table tests for --skip-setup"
            - "Test case: setup script not executed when flag is set"
            - "Test case: SetupCompleted is false when skipped"
            - "Test case: setup runs when flag is not set (default behavior)"
    - number: 8
      title: "User Story 6 - Prevent automatic rollback"
      purpose: "Add --no-rollback flag to preserve failed worktrees for debugging"
      story_reference: "US-006"
      independent_test: "Create worktree with --no-rollback and failing setup, verify worktree persists"
      tasks:
        - id: "T021"
          title: "Implement NoRollback support in CreateWithOptions in internal/worktree/manager.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-006"
          file_path: "internal/worktree/manager.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "Skip rollback when opts.NoRollback is true"
            - "Log warning when worktree preserved in broken state"
            - "Warning includes path and suggests manual cleanup"
            - "NoRollback prevents cleanup on timeout as well"
        - id: "T022"
          title: "Add --no-rollback flag to worktree create command in internal/cli/worktree/create.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-006"
          file_path: "internal/cli/worktree/create.go"
          dependencies: ["T021"]
          acceptance_criteria:
            - "--no-rollback flag added with clear description"
            - "Flag passed to CreateOptions when calling Manager"
            - "Help text explains flag preserves worktree on failure"
        - id: "T023"
          title: "Write tests for --no-rollback flag in internal/cli/worktree/worktree_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-006"
          file_path: "internal/cli/worktree/worktree_test.go"
          dependencies: ["T022"]
          acceptance_criteria:
            - "Map-based table tests for --no-rollback"
            - "Test case: worktree preserved on setup failure when flag is set"
            - "Test case: warning message shown when preserving broken worktree"
            - "Test case: worktree deleted on failure when flag is not set (default)"
    - number: 9
      title: "Quality Assurance"
      purpose: "Ensure all quality gates pass"
      tasks:
        - id: "T024"
          title: "Run quality checks and fix any issues"
          status: "Completed"
          type: "refactor"
          parallel: false
          story_id: null
          file_path: "."
          dependencies: ["T017", "T020", "T023"]
          acceptance_criteria:
            - "make test exits 0 with all tests passing"
            - "make fmt exits 0 with no formatting changes needed"
            - "make lint exits 0 with no lint errors"
            - "make build exits 0 with successful compilation"
            - "All functions under 40 lines verified"
            - "All errors wrapped with context using fmt.Errorf with %w"
dependencies:
    user_story_order:
        - story_id: "US-003"
          depends_on: []
          blocks: ["US-004"]
        - story_id: "US-004"
          depends_on: ["US-003"]
          blocks: ["US-005"]
        - story_id: "US-005"
          depends_on: ["US-004"]
          blocks: ["US-001", "US-002", "US-006"]
        - story_id: "US-001"
          depends_on: ["US-005"]
          blocks: []
        - story_id: "US-002"
          depends_on: ["US-005"]
          blocks: []
        - story_id: "US-006"
          depends_on: ["US-005"]
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2, 3]
        - phase: 2
          blocks: [4, 5]
        - phase: 3
          blocks: [4]
        - phase: 4
          blocks: [5]
        - phase: 5
          blocks: [6, 7, 8]
        - phase: 6
          blocks: [9]
        - phase: 7
          blocks: [9]
        - phase: 8
          blocks: [9]
parallel_execution:
    - phase: 1
      parallel_groups:
        - tasks: ["T001"]
          rationale: "Must complete first as T002 and T003 depend on it"
        - tasks: ["T002", "T003"]
          rationale: "CreateOptions struct and defaults can be added in parallel after T001"
    - phase: 6
      parallel_groups:
        - tasks: ["T016", "T017"]
          rationale: "CLI flag and tests can be developed together after T015"
    - phase: 7
      parallel_groups:
        - tasks: ["T019", "T020"]
          rationale: "CLI flag and tests can be developed together after T018"
    - phase: 8
      parallel_groups:
        - tasks: ["T022", "T023"]
          rationale: "CLI flag and tests can be developed together after T021"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3, 4, 5]
        description: "Setup + Foundational + Timeout + Validation + Rollback"
        validation: "Custom setup script with timeout is validated and rolls back on failure"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2]
          deliverable: "Types and validation infrastructure in place"
        - milestone: "Timeout Enforcement"
          phases: [1, 2, 3]
          deliverable: "Setup scripts respect configurable timeout"
        - milestone: "Validation and Rollback"
          phases: [1, 2, 3, 4, 5]
          deliverable: "Custom scripts validated with automatic cleanup on failure"
        - milestone: "Full Feature"
          phases: [1, 2, 3, 4, 5, 6, 7, 8, 9]
          deliverable: "All skip flags and quality gates complete"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.8.2"
    created: "2026-01-11T18:31:52Z"
    artifact_type: "tasks"
