plan:
  branch: "091-worktree-copy-setup"
  created: "2026-01-11"
  spec_path: "specs/091-worktree-copy-setup/spec.yaml"

summary: |
  This feature enhances the worktree creation workflow with three major capabilities:
  directory copying with skip option, setup script timeout enforcement with configurable
  duration, and post-setup validation for custom scripts with automatic rollback on failure.

  The implementation extends the existing WorktreeConfig structure with a setup_timeout
  field and adds three new CLI flags (--skip-copy, --skip-setup, --no-rollback) to the
  worktree create command. The Manager.Create method will be refactored to support
  CreateOptions that control these behaviors, with validation logic added after custom
  script execution. Context-based timeout is used for cross-platform script termination.

technical_context:
  language: "Go"
  framework: "Cobra (CLI)"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for config and state"
    - name: "github.com/knadh/koanf/v2"
      version: "v2.1.1"
      purpose: "Hierarchical configuration loading"
  storage: "YAML files for state and configuration"
  testing:
    framework: "Go testing package"
    approach: "Map-based table-driven tests with mocked dependencies"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Validation checks under 2 seconds total"
  constraints:
    - "Timeout must work cross-platform (context.WithTimeout for exec.CommandContext)"
    - "Rollback uses git worktree remove for proper git state cleanup"
    - "Backward compatible with existing worktree.create behavior"
    - "Functions under 40 lines per project conventions"
  scale_scope: "Single repository worktree management, DAG orchestration support"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "PRIN-001: Test-First Development"
      status: "PASS"
      notes: "Tests will be written before implementation for all new functions"
    - name: "PRIN-002: Validation-First Workflow"
      status: "PASS"
      notes: "Worktree validation ensures valid state before proceeding"
    - name: "PRIN-003: Performance Standards"
      status: "PASS"
      notes: "Validation checks designed to complete under 2 seconds"
    - name: "PRIN-004: Idempotency and Retry Logic"
      status: "PASS"
      notes: "Rollback ensures clean state; operations are idempotent"
    - name: "PRIN-005: Standardized Exit Codes"
      status: "PASS"
      notes: "Validation errors return appropriate exit codes"
    - name: "PRIN-006: YAML-First Artifacts"
      status: "PASS"
      notes: "Config uses YAML format with WorktreeConfig struct"
    - name: "PRIN-007: Code Formatting"
      status: "PASS"
      notes: "Will run make fmt and make lint before completion"
    - name: "PRIN-008: Cross-Platform Compatibility"
      status: "PASS"
      notes: "Uses context.WithTimeout for cross-platform timeout support"
    - name: "PRIN-011: Go Coding Standards"
      status: "PASS"
      notes: "Functions under 40 lines, wrapped errors, map-based table tests"

research_findings:
  decisions:
    - topic: "Timeout implementation for script execution"
      decision: "Use exec.CommandContext with context.WithTimeout"
      rationale: "Standard Go approach for cross-platform process timeout; kills process tree on context cancel"
      alternatives_considered:
        - "SIGKILL with timer (Unix-only)"
        - "Process.Kill with manual timer (more complex)"
    - topic: "Validation timing"
      decision: "Run validation only after custom setup_script execution"
      rationale: "Default autospec setup is trusted; custom scripts need validation to catch user errors"
      alternatives_considered:
        - "Always validate (unnecessary overhead for default setup)"
        - "Skip validation entirely (unsafe for DAG orchestration)"
    - topic: "Rollback mechanism"
      decision: "Use git worktree remove --force to clean up on failure"
      rationale: "Properly cleans git worktree state; --force handles partial state"
      alternatives_considered:
        - "os.RemoveAll (doesn't clean git worktree refs)"
        - "Manual cleanup (error-prone)"
    - topic: "CreateOptions pattern vs flag parameters"
      decision: "Add CreateOptions struct passed to Manager.Create"
      rationale: "Clean extension point; avoids modifying Manager interface signature repeatedly"
      alternatives_considered:
        - "Add flags as separate parameters (grows parameter list)"
        - "Use functional options pattern (overkill for simple flags)"

data_model:
  entities:
    - name: "WorktreeConfig"
      description: "Extended configuration for worktree management"
      fields:
        - name: "SetupTimeout"
          type: "time.Duration"
          description: "Maximum time for setup script execution"
          constraints: "Default 5m; parsed from string like '5m', '30s'"
      relationships:
        - target: "Configuration"
          type: "embedded"
          description: "Part of main Configuration struct"

    - name: "CreateOptions"
      description: "Options for worktree create operation"
      fields:
        - name: "SkipCopy"
          type: "bool"
          description: "Skip directory copying"
          constraints: "Default false"
        - name: "SkipSetup"
          type: "bool"
          description: "Skip setup script execution"
          constraints: "Default false"
        - name: "NoRollback"
          type: "bool"
          description: "Preserve worktree on failure for debugging"
          constraints: "Default false"
      relationships:
        - target: "Manager.CreateWithOptions"
          type: "parameter"
          description: "Passed to create method"

    - name: "ValidationResult"
      description: "Result of worktree validation after setup"
      fields:
        - name: "PathExists"
          type: "bool"
          description: "Whether worktree path exists as directory"
          constraints: "Required to be true"
        - name: "PathDiffersFromSource"
          type: "bool"
          description: "Whether worktree path differs from source repo"
          constraints: "Required to be true"
        - name: "InGitWorktreeList"
          type: "bool"
          description: "Whether worktree appears in git worktree list"
          constraints: "Required to be true"
        - name: "Errors"
          type: "[]string"
          description: "List of validation error messages"
          constraints: "Empty on success"
      relationships:
        - target: "Manager.validateWorktree"
          type: "return"
          description: "Returned by validation method"

    - name: "SetupResult"
      description: "Extended result from setup script execution"
      fields:
        - name: "TimedOut"
          type: "bool"
          description: "Whether the script exceeded timeout"
          constraints: "Triggers rollback if true"
      relationships:
        - target: "RunSetupScriptWithTimeout"
          type: "return"
          description: "Returned by timeout-aware setup function"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/worktree.md"
      description: "User documentation for worktree commands (if exists, update)"
  source_code:
    - path: "internal/worktree/worktree.go"
      description: "Add SetupTimeout to WorktreeConfig, add CreateOptions struct"
    - path: "internal/worktree/manager.go"
      description: "Add CreateWithOptions method, validation logic, rollback logic"
    - path: "internal/worktree/setup.go"
      description: "Add RunSetupScriptWithTimeout function using exec.CommandContext"
    - path: "internal/worktree/validate.go"
      description: "New file: ValidateWorktree function and ValidationResult type"
    - path: "internal/cli/worktree/create.go"
      description: "Add --skip-copy, --skip-setup, --no-rollback flags"
    - path: "internal/config/defaults.go"
      description: "Add default setup_timeout value (5m)"
  tests:
    - path: "internal/worktree/manager_test.go"
      description: "Add tests for CreateWithOptions, validation, rollback"
    - path: "internal/worktree/setup_test.go"
      description: "Add tests for timeout enforcement"
    - path: "internal/worktree/validate_test.go"
      description: "New file: tests for validation logic"
    - path: "internal/cli/worktree/worktree_test.go"
      description: "Add tests for new CLI flags"

implementation_phases:
  - phase: 1
    name: "Configuration and Types"
    goal: "Extend configuration schema and add new types"
    deliverables:
      - "Add SetupTimeout field to WorktreeConfig struct"
      - "Add CreateOptions struct with SkipCopy, SkipSetup, NoRollback fields"
      - "Add ValidationResult struct with PathExists, PathDiffersFromSource, InGitWorktreeList, Errors fields"
      - "Update DefaultConfig() to include default SetupTimeout of 5 minutes"
      - "Add config validation for setup_timeout parsing"

  - phase: 2
    name: "Timeout-Aware Setup Script Execution"
    goal: "Implement setup script timeout using context"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Add RunSetupScriptWithTimeout function using exec.CommandContext"
      - "Add TimedOut field to SetupResult struct"
      - "Handle context.DeadlineExceeded to detect timeout"
      - "Log timeout warning with configured duration"
      - "Tests for timeout enforcement (script exceeds, script completes in time)"

  - phase: 3
    name: "Worktree Validation"
    goal: "Implement validation checks for custom setup scripts"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Create internal/worktree/validate.go with ValidateWorktree function"
      - "Implement path existence check (os.Stat)"
      - "Implement path difference check (compare absolute paths)"
      - "Implement git worktree list membership check"
      - "Return ValidationResult with actionable error messages"
      - "Tests for each validation scenario"

  - phase: 4
    name: "Rollback Logic"
    goal: "Implement automatic rollback on setup/validation failure"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Add rollback method using git worktree remove --force"
      - "Log rollback action with deleted path"
      - "Handle partial cleanup failures gracefully"
      - "Tests for rollback on script failure, timeout, validation failure"

  - phase: 5
    name: "Manager.CreateWithOptions"
    goal: "Integrate all features into create workflow"
    dependencies:
      - "Phase 2"
      - "Phase 3"
      - "Phase 4"
    deliverables:
      - "Add CreateWithOptions method to Manager"
      - "Update Create to call CreateWithOptions with default options"
      - "Skip directory copying when SkipCopy is true"
      - "Skip setup script when SkipSetup is true"
      - "Run validation after custom setup script"
      - "Execute rollback on failure unless NoRollback is true"
      - "Log warning when worktree preserved in broken state"
      - "Comprehensive integration tests"

  - phase: 6
    name: "CLI Flag Integration"
    goal: "Add new flags to worktree create command"
    dependencies:
      - "Phase 5"
    deliverables:
      - "Add --skip-copy flag to create command"
      - "Add --skip-setup flag to create command"
      - "Add --no-rollback flag to create command"
      - "Pass CreateOptions to manager based on flags"
      - "Update command help text and examples"
      - "CLI integration tests"

  - phase: 7
    name: "Quality Assurance"
    goal: "Ensure all quality gates pass"
    dependencies:
      - "Phase 6"
    deliverables:
      - "Run make test and fix any failures"
      - "Run make fmt and ensure code is formatted"
      - "Run make lint and fix any lint errors"
      - "Run make build and ensure successful compilation"
      - "Verify all functions under 40 lines"
      - "Verify all errors wrapped with context"

open_questions:
  - question: "Should validation run for default autospec setup or only custom scripts?"
    context: "Spec says 'Run validation only when a custom setup_script is configured' but validation could catch other issues"
    proposed_resolution: "Follow spec - only validate when setup_script is non-empty"
  - question: "Should --no-rollback also prevent rollback on timeout?"
    context: "Timeout is a specific failure mode; user may want to debug hung scripts"
    proposed_resolution: "Yes, --no-rollback should prevent all automatic cleanup including timeout cases"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.2"
  created: "2026-01-11T18:30:04Z"
  artifact_type: "plan"
