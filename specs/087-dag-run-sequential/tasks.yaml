tasks:
    branch: "087-dag-run-sequential"
    created: "2026-01-11"
    spec_path: "specs/087-dag-run-sequential/spec.yaml"
    plan_path: "specs/087-dag-run-sequential/plan.yaml"
summary:
    total_tasks: 28
    total_phases: 7
    parallel_opportunities: 8
    estimated_complexity: "high"
phases:
    - number: 1
      title: "Setup"
      purpose: "Create new package structure for DAG execution"
      tasks:
        - id: "T001"
          title: "Create internal/dag/executor.go skeleton"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/dag/executor.go"
          dependencies: []
          acceptance_criteria:
            - "File exists with package declaration"
            - "Basic Executor struct skeleton defined"
    - number: 2
      title: "Foundational - Configuration and State"
      purpose: "Core infrastructure for DAG configuration and state persistence (FR-005, FR-020)"
      tasks:
        - id: "T002"
          title: "Implement DAGExecutionConfig and WorktreeConfig types in internal/dag/config.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/config.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "DAGExecutionConfig struct with onConflict, maxSpecRetries, maxLogSize fields"
            - "WorktreeConfig struct with baseDir, prefix, setupScript, setupTimeout, copyDirs fields"
            - "LoadDAGConfig() function with env > project > user > defaults hierarchy"
            - "Functions under 40 lines"
        - id: "T003"
          title: "Implement DAGRun and SpecState types in internal/dag/runstate.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/runstate.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "DAGRun struct with run_id, dag_file, status, started_at, completed_at, specs fields"
            - "SpecState struct with spec_id, layer_id, status, worktree_path, timestamps, current_stage, blocked_by, failure_reason, exit_code fields"
            - "NewDAGRun() constructor with timestamp_uuid run ID format"
            - "State directory creation at .autospec/state/dag-runs/"
        - id: "T004"
          title: "Implement atomic SaveState() and LoadState() in internal/dag/runstate.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/runstate.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "SaveState() uses temp file + rename atomic write pattern"
            - "LoadState() handles missing files gracefully"
            - "State persisted to .autospec/state/dag-runs/<run-id>.yaml"
            - "Errors wrapped with context using fmt.Errorf"
        - id: "T005"
          title: "Add unit tests for config.go in internal/dag/config_test.go"
          status: "Completed"
          type: "test"
          parallel: true
          story_id: null
          file_path: "internal/dag/config_test.go"
          dependencies: ["T002"]
          acceptance_criteria:
            - "Map-based table tests for LoadDAGConfig()"
            - "Tests cover env > project > user > defaults hierarchy"
            - "Tests pass with go test"
        - id: "T006"
          title: "Add unit tests for runstate.go in internal/dag/runstate_test.go"
          status: "Completed"
          type: "test"
          parallel: true
          story_id: null
          file_path: "internal/dag/runstate_test.go"
          dependencies: ["T003", "T004"]
          acceptance_criteria:
            - "Map-based table tests for NewDAGRun(), SaveState(), LoadState()"
            - "Tests verify atomic write behavior"
            - "Tests cover state directory creation"
    - number: 3
      title: "Foundational - Locking and Output"
      purpose: "Run locking (FR-018) and prefixed output infrastructure (FR-011, FR-012)"
      tasks:
        - id: "T007"
          title: "Implement RunLock with PID-based stale detection in internal/dag/lock.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/lock.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "RunLock struct with runID, pid, specs, startedAt fields"
            - "AcquireLock() function with overlap detection"
            - "ReleaseLock() function"
            - "IsLockStale() with PID-based detection"
            - "Lock file at .autospec/state/dag-runs/<run-id>.lock"
        - id: "T008"
          title: "Implement PrefixedWriter in internal/dag/output.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/output.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "PrefixedWriter type implementing io.Writer"
            - "Each line prefixed with [spec-id]"
            - "Handles partial writes correctly"
        - id: "T009"
          title: "Implement log file management in internal/dag/output.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/output.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "CreateLogFile() for .autospec/state/dag-runs/<run-id>/logs/<spec-id>.log"
            - "MultiWriter combining terminal and log file output"
            - "Log directory creation logic"
        - id: "T010"
          title: "Add unit tests for lock.go in internal/dag/lock_test.go"
          status: "Completed"
          type: "test"
          parallel: true
          story_id: null
          file_path: "internal/dag/lock_test.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Map-based table tests for lock operations"
            - "Tests cover overlap detection"
            - "Tests cover stale lock detection"
        - id: "T011"
          title: "Add unit tests for output.go in internal/dag/output_test.go"
          status: "InProgress"
          type: "test"
          parallel: true
          story_id: null
          file_path: "internal/dag/output_test.go"
          dependencies: ["T008", "T009"]
          acceptance_criteria:
            - "Map-based table tests for PrefixedWriter"
            - "Tests verify line-by-line prefixing"
            - "Tests cover log file creation"
    - number: 4
      title: "User Story 1 - Execute DAG Workflow Sequentially (US-001)"
      purpose: "Core sequential execution engine respecting layer dependencies"
      story_reference: "US-001"
      independent_test: "Run a DAG file with 3 specs in 2 layers and verify all complete in dependency order"
      tasks:
        - id: "T012"
          title: "Implement Executor struct with dependency injection in internal/dag/executor.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/executor.go"
          dependencies: ["T002", "T003", "T004", "T007", "T008", "T009"]
          acceptance_criteria:
            - "Executor struct with dag, worktreeManager, state, stateDir, logDir, stdout, config fields"
            - "NewExecutor() constructor with dependency injection"
            - "Interface defined for worktree.Manager for testability"
        - id: "T013"
          title: "Implement layer-ordered execution loop in internal/dag/executor.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/executor.go"
          dependencies: ["T012"]
          acceptance_criteria:
            - "Execute() method processes layers in order (L0 before L1)"
            - "Sequential execution within each layer"
            - "State updates after each spec completes"
            - "Functions under 40 lines"
        - id: "T014"
          title: "Implement command execution (autospec run -spti) in worktree in internal/dag/executor.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/executor.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "executeSpec() runs autospec run -spti in worktree directory"
            - "Exit code captured and stored in state"
            - "Output streamed through PrefixedWriter"
            - "Errors wrapped with context"
        - id: "T015"
          title: "Add unit tests for executor.go in internal/dag/executor_test.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/executor_test.go"
          dependencies: ["T012", "T013", "T014"]
          acceptance_criteria:
            - "Map-based table tests with mocked dependencies"
            - "Tests verify layer ordering"
            - "Tests verify state updates"
    - number: 5
      title: "User Story 2 - Isolated Worktrees On-Demand (US-002)"
      purpose: "Create worktrees on-demand with consistent branch naming and handle existing worktrees"
      story_reference: "US-002"
      independent_test: "Run a DAG with 2 specs and verify 2 separate worktrees are created with dag/<run-id>/<spec-id> branch naming"
      tasks:
        - id: "T016"
          title: "Implement on-demand worktree creation with dag/<run-id>/<spec-id> branch naming"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/executor.go"
          dependencies: ["T012"]
          acceptance_criteria:
            - "createWorktree() creates worktree only when spec is about to execute"
            - "Branch naming follows dag/<run-id>/<spec-id> pattern"
            - "Uses existing worktree.Manager.Create()"
            - "Worktree path stored in SpecState"
        - id: "T017"
          title: "Implement existing worktree handling (skip/prompt/force)"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/executor.go"
          dependencies: ["T016"]
          acceptance_criteria:
            - "Skip if worktree exists with completed status"
            - "Prompt if failed/interrupted status (or require --force)"
            - "Never silently overwrite"
            - "Clear error messages for each case"
        - id: "T018"
          title: "Add unit tests for worktree creation in executor_test.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/executor_test.go"
          dependencies: ["T016", "T017"]
          acceptance_criteria:
            - "Tests verify on-demand creation"
            - "Tests verify branch naming pattern"
            - "Tests cover skip/prompt/force scenarios"
    - number: 6
      title: "User Stories 3-8 - State, Output, Locking, CLI (US-003, US-004, US-005, US-006, US-007, US-008)"
      purpose: "State persistence, output handling, locking, and CLI commands"
      tasks:
        - id: "T019"
          title: "Implement failure handling: stop execution, preserve worktree, output instructions"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/executor.go"
          dependencies: ["T014"]
          acceptance_criteria:
            - "On failure: mark spec as failed with failure_reason"
            - "Stop execution entirely (no continue to next spec)"
            - "Preserve worktree for debugging"
            - "Output 'dag resume <run-id>' and 'dag retry <run-id> <spec> --clean' instructions"
        - id: "T020"
          title: "Implement dag run CLI command in internal/cli/dag/run.go"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T014"]
          acceptance_criteria:
            - "dag run <file> command with file argument validation"
            - "--force flag for recreating failed/interrupted worktrees"
            - "Integration with lifecycle wrapper for history/notifications"
            - "Colored output for status display"
            - "Exit 0 for success, 1 for failure, 3 for invalid arguments"
        - id: "T021"
          title: "Implement --dry-run flag for dag run command"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-007"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T020"]
          acceptance_criteria:
            - "--dry-run shows execution order respecting dependencies"
            - "Shows worktrees that would be created"
            - "Shows which specs exist vs would be created"
            - "No actual state changes or worktree creation"
        - id: "T022"
          title: "Implement dag list CLI command in internal/cli/dag/list.go"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-006"
          file_path: "internal/cli/dag/list.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "dag list command shows all runs with run-id, status, timestamp"
            - "Shows running, completed, and failed runs"
            - "Graceful handling when no runs exist"
            - "Colored status output"
        - id: "T023"
          title: "Add command tests for dag run in internal/cli/dag/run_test.go"
          status: "Pending"
          type: "test"
          parallel: true
          story_id: "US-001"
          file_path: "internal/cli/dag/run_test.go"
          dependencies: ["T020", "T021"]
          acceptance_criteria:
            - "Map-based table tests for command execution"
            - "Tests cover --dry-run behavior"
            - "Tests cover --force behavior"
            - "Tests verify exit codes"
        - id: "T024"
          title: "Add command tests for dag list in internal/cli/dag/list_test.go"
          status: "Pending"
          type: "test"
          parallel: true
          story_id: "US-006"
          file_path: "internal/cli/dag/list_test.go"
          dependencies: ["T022"]
          acceptance_criteria:
            - "Map-based table tests"
            - "Tests cover empty state"
            - "Tests cover multiple runs"
    - number: 7
      title: "Polish & Cross-Cutting Concerns"
      purpose: "Integration testing, edge cases, and final validation"
      tasks:
        - id: "T025"
          title: "Add integration tests with real DAG files"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/executor_test.go"
          dependencies: ["T015", "T018", "T023", "T024"]
          acceptance_criteria:
            - "Test with 3 specs in 2 layers"
            - "Verify layer ordering"
            - "Verify state file updates"
            - "Verify log file creation"
        - id: "T026"
          title: "Add edge case handling tests"
          status: "Pending"
          type: "test"
          parallel: true
          story_id: null
          file_path: "internal/dag/executor_test.go"
          dependencies: ["T025"]
          acceptance_criteria:
            - "Empty DAG completes immediately"
            - "Single-layer DAG executes correctly"
            - "All specs failing is handled"
            - "Existing worktrees handled per spec"
        - id: "T027"
          title: "Add lock collision tests"
          status: "Pending"
          type: "test"
          parallel: true
          story_id: null
          file_path: "internal/dag/lock_test.go"
          dependencies: ["T010"]
          acceptance_criteria:
            - "Concurrent runs on overlapping specs fail fast"
            - "Clear error message about lock collision"
            - "Lock released on completion/failure"
        - id: "T028"
          title: "Final validation: make test && make fmt && make lint && make build"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: ""
          dependencies: ["T025", "T026", "T027"]
          acceptance_criteria:
            - "make test passes with all tests green"
            - "make fmt produces no changes"
            - "make lint produces no errors"
            - "make build succeeds"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-002", "US-003", "US-004", "US-005", "US-007", "US-008"]
        - story_id: "US-002"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-003"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-004"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-005"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-006"
          depends_on: []
          blocks: []
        - story_id: "US-007"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-008"
          depends_on: []
          blocks: ["US-001"]
    phase_order:
        - phase: 1
          blocks: [2, 3]
        - phase: 2
          blocks: [4]
        - phase: 3
          blocks: [4]
        - phase: 4
          blocks: [5, 6]
        - phase: 5
          blocks: [6]
        - phase: 6
          blocks: [7]
parallel_execution:
    - phase: 2
      parallel_groups:
        - tasks: ["T002", "T003"]
          rationale: "Independent foundational types in separate files"
        - tasks: ["T005", "T006"]
          rationale: "Independent test files for different components"
    - phase: 3
      parallel_groups:
        - tasks: ["T007", "T008"]
          rationale: "Independent functionality in separate files"
        - tasks: ["T010", "T011"]
          rationale: "Independent test files"
    - phase: 6
      parallel_groups:
        - tasks: ["T020", "T022"]
          rationale: "Independent CLI commands"
        - tasks: ["T023", "T024"]
          rationale: "Independent test files"
    - phase: 7
      parallel_groups:
        - tasks: ["T026", "T027"]
          rationale: "Independent edge case and lock tests"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3, 4]
        description: "Setup + Foundational + Core Execution (US-001)"
        validation: "Run a simple 2-layer DAG and verify specs execute in order with state persistence"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2, 3]
          deliverable: "Config, state, locking, and output infrastructure complete and tested"
        - milestone: "Core Execution"
          phases: [1, 2, 3, 4]
          deliverable: "Sequential DAG execution working with layer dependencies"
        - milestone: "Worktree Isolation"
          phases: [1, 2, 3, 4, 5]
          deliverable: "On-demand worktree creation with proper handling of existing worktrees"
        - milestone: "Full Feature"
          phases: [1, 2, 3, 4, 5, 6, 7]
          deliverable: "Complete dag run and dag list commands with --dry-run, --force, all edge cases handled"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.8.2"
    created: "2026-01-11T08:42:33Z"
    artifact_type: "tasks"
