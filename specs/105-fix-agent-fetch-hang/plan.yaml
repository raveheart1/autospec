plan:
  branch: "105-fix-agent-fetch-hang"
  created: "2026-01-27"
  spec_path: "specs/105-fix-agent-fetch-hang/spec.yaml"

summary: |
  This plan addresses a critical bug where autospec new-feature hangs indefinitely when executed
  by a Claude agent in a sandbox environment without SSH_AUTH_SOCK set. The fix involves three
  key changes: (1) detecting SSH URLs and skipping fetch attempts when no SSH agent is available,
  (2) adding a --no-fetch flag for explicit bypass, and (3) implementing a configurable timeout
  (default 60s) on fetch operations to prevent indefinite hangs even in edge cases.

  The implementation maintains backwards compatibility - users with full network access and SSH
  agent configured will see no change in behavior. The changes are localized to internal/git/git.go
  and internal/cli/new_feature.go as specified in the constraints.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/go-git/go-git/v5"
      version: "v5.x"
      purpose: "Git operations including fetch, branch management"
    - name: "github.com/spf13/cobra"
      version: "v1.x"
      purpose: "CLI command framework"
  storage: "None"
  testing:
    framework: "testing + testify"
    approach: "Unit tests with map-based table tests; integration via temp git repos"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "SSH URL detection <1μs; command completion <5s in sandbox"
  constraints:
    - "No external dependencies added"
    - "Changes limited to internal/git/git.go and internal/cli/new_feature.go"
    - "Must use existing go-git library"
    - "Backwards compatible with existing users"
  scale_scope: "Single repository operations; low concurrency"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Tests will be written before implementation for isSSHURL, SSH agent detection, timeout, and --no-fetch flag"
    - name: "Idiomatic Go (PRIN-002)"
      status: "PASS"
      notes: "Using fmt.Errorf with %w for error wrapping; context for cancellation; map-based table tests"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "isSSHURL targets <1μs; fetch timeout at 60s prevents indefinite hangs"
    - name: "Idempotent Operations (PRIN-004)"
      status: "PASS"
      notes: "Fetch skip/timeout are idempotent; repeated calls produce same behavior"
    - name: "Validation-First Workflow (PRIN-005)"
      status: "N/A"
      notes: "Not applicable to this bug fix"
    - name: "Command Template Independence (PRIN-006)"
      status: "N/A"
      notes: "No command templates modified"
    - name: "Actionable Errors (PRIN-007)"
      status: "PASS"
      notes: "Debug logs explain why SSH remotes are skipped; timeout errors include remote name"
    - name: "Schema-Driven Artifacts (PRIN-008)"
      status: "N/A"
      notes: "No YAML artifacts modified"

research_findings:
  decisions:
    - topic: "SSH URL detection approach"
      decision: "Extend existing isSSHURL function to handle all SSH URL formats"
      rationale: "Function already exists; needs to also detect git+ssh:// scheme"
      alternatives_considered:
        - "Use go-git's transport package for URL parsing"
        - "Regex-based URL matching"
    - topic: "SSH agent availability detection"
      decision: "Check SSH_AUTH_SOCK environment variable presence and non-empty value"
      rationale: "Standard Unix approach; SSH agent sets this variable when running"
      alternatives_considered:
        - "Attempt SSH connection and catch timeout"
        - "Check for ssh-agent process"
    - topic: "Fetch timeout implementation"
      decision: "Use context.WithTimeout wrapping the fetch operation"
      rationale: "Idiomatic Go pattern; go-git supports context for cancellation"
      alternatives_considered:
        - "Goroutine with select and timer"
        - "OS-level process timeout"
    - topic: "Flag naming for skip fetch"
      decision: "Use --no-fetch flag on new-feature command"
      rationale: "Clear, follows common CLI conventions (git --no-verify, etc.)"
      alternatives_considered:
        - "--skip-fetch"
        - "--offline"

data_model:
  entities:
    - name: "FetchOptions"
      description: "Configuration for fetch operations with timeout and skip behavior"
      fields:
        - name: "SkipFetch"
          type: "bool"
          description: "When true, skip all fetch operations"
          constraints: "Default false for backwards compatibility"
        - name: "Timeout"
          type: "time.Duration"
          description: "Maximum time to wait for fetch operations"
          constraints: "Default 60 seconds; 0 means no timeout"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: ".dev/tasks/105-fix-agent-fetch-hang.md"
      description: "Manual testing plan for verifying fix in sandbox environments"
  source_code:
    - path: "internal/git/git.go"
      description: "Git utilities including modified fetch functions with SSH detection and timeout"
    - path: "internal/cli/new_feature.go"
      description: "new-feature command with --no-fetch flag"
  tests:
    - path: "internal/git/git_test.go"
      description: "Unit tests for isSSHURL, isSSHAgentAvailable, fetch timeout"
    - path: "internal/cli/new_feature_test.go"
      description: "Tests for --no-fetch flag behavior"

implementation_phases:
  - phase: 1
    name: "SSH Detection and Skip Logic"
    goal: "Implement SSH URL detection and skip fetch when SSH agent unavailable"
    deliverables:
      - "Add git+ssh:// to isSSHURL function"
      - "Add isSSHAgentAvailable function checking SSH_AUTH_SOCK"
      - "Modify fetchRemote to skip SSH URLs when agent unavailable"
      - "Add debug logging for skipped fetches"
      - "Unit tests for all new functions"
  - phase: 2
    name: "No-Fetch Flag"
    goal: "Add --no-fetch flag to bypass all fetch operations"
    deliverables:
      - "Add --no-fetch flag to new-feature command"
      - "Modify initGitForNewFeature to accept skip parameter"
      - "Unit tests for flag behavior"
    dependencies:
      - "Phase 1"
  - phase: 3
    name: "Fetch Timeout"
    goal: "Implement configurable timeout on fetch operations"
    deliverables:
      - "Add context.WithTimeout to FetchAllRemotes"
      - "Add FetchAllRemotesWithContext function"
      - "Handle timeout errors gracefully with warning"
      - "Unit tests for timeout behavior"
    dependencies:
      - "Phase 1"
  - phase: 4
    name: "Integration and Documentation"
    goal: "Validate end-to-end behavior and document changes"
    deliverables:
      - "Integration test simulating sandbox environment"
      - "Update any relevant documentation"
      - "Manual testing plan in .dev/tasks/"
      - "Changelog entry"
    dependencies:
      - "Phase 2"
      - "Phase 3"

open_questions:
  - question: "Should timeout be user-configurable via config file?"
    context: "Spec lists this as out-of-scope but could be valuable"
    proposed_resolution: "Keep as hardcoded 60s for now; add config option in future enhancement"
  - question: "Should we also modify other commands that call FetchAllRemotes?"
    context: "Spec explicitly lists this as out-of-scope"
    proposed_resolution: "Only modify new-feature; other commands can be addressed separately if needed"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.10.1"
  created: "2026-01-27T00:00:00Z"
  artifact_type: "plan"
