feature:
    branch: "105-fix-agent-fetch-hang"
    created: "2026-01-28"
    status: "Completed"
    completed_at: 2026-01-28T05:19:12Z
    input: "Bug fix: autospec new-feature hangs when run by agent due to SSH fetch without auth. When Claude (running inside autospec as an agent) tries to execute autospec new-feature, the command can hang indefinitely because FetchAllRemotes() attempts SSH connections without SSH_AUTH_SOCK, causing TCP connections to hang waiting for response in sandbox environments."
user_stories:
    - id: "US-001"
      title: "Agent creates feature branches reliably"
      priority: "P1"
      as_a: "Claude agent running autospec workflows"
      i_want: "autospec new-feature to complete without hanging"
      so_that: "I can create feature branches programmatically within workflow automation"
      why_this_priority: "Core functionality is broken - agents cannot create new features, blocking all autospec automation"
      independent_test: "Run autospec new-feature from within a Claude Code sandbox and verify completion"
      acceptance_scenarios:
        - given: "Running in a sandboxed environment without SSH_AUTH_SOCK set"
          when: "I execute autospec new-feature"
          then: "The command completes within 5 seconds without attempting SSH fetch"
        - given: "A git repository with SSH-based remote URLs"
          when: "I execute autospec new-feature without SSH agent available"
          then: "The command skips fetching from SSH remotes and completes successfully"
    - id: "US-002"
      title: "User can bypass fetch operations"
      priority: "P2"
      as_a: "developer using autospec"
      i_want: "an option to skip remote fetch during new-feature creation"
      so_that: "I have explicit control over network operations when needed"
      why_this_priority: "Provides escape hatch for edge cases not covered by auto-detection"
      independent_test: "Run autospec new-feature --no-fetch and verify no network calls are made"
      acceptance_scenarios:
        - given: "A git repository with any remote configuration"
          when: "I execute autospec new-feature --no-fetch"
          then: "The command completes without any fetch attempts to any remote"
        - given: "Normal network access and SSH agent available"
          when: "I execute autospec new-feature without --no-fetch flag"
          then: "The command attempts to fetch as before (backwards compatible)"
    - id: "US-003"
      title: "User receives clear feedback about skipped fetches"
      priority: "P3"
      as_a: "developer troubleshooting git issues"
      i_want: "to see why fetch operations were skipped"
      so_that: "I understand what happened and can take manual action if needed"
      why_this_priority: "Improves debugging and transparency without being essential"
      independent_test: "Run with verbose/debug output and verify skip reasons are logged"
      acceptance_scenarios:
        - given: "SSH_AUTH_SOCK is not set"
          when: "I execute autospec new-feature"
          then: "Debug output indicates SSH remotes were skipped due to missing SSH agent"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST skip fetching from SSH-based remote URLs when SSH_AUTH_SOCK environment variable is not set"
          testable: true
          acceptance_criteria: "Unit test verifies that fetchRemote returns early for SSH URLs when SSH_AUTH_SOCK is empty"
        - id: "FR-002"
          description: "MUST provide a --no-fetch flag on autospec new-feature command"
          testable: true
          acceptance_criteria: "Flag is visible in --help output and accepted by the command"
        - id: "FR-003"
          description: "MUST skip all fetch operations when --no-fetch flag is provided"
          testable: true
          acceptance_criteria: "When --no-fetch is set, FetchAllRemotes is not called"
        - id: "FR-004"
          description: "MUST maintain backwards compatibility - fetch HTTPS remotes when SSH agent is unavailable"
          testable: true
          acceptance_criteria: "HTTPS remotes are still fetched even when SSH_AUTH_SOCK is not set"
        - id: "FR-005"
          description: "MUST log at debug level when skipping SSH remotes"
          testable: true
          acceptance_criteria: "Log output includes remote name and reason for skip"
        - id: "FR-006"
          description: "MUST complete new-feature command within 5 seconds in sandbox environment"
          testable: true
          acceptance_criteria: "Integration test with unset SSH_AUTH_SOCK completes in under 5 seconds"
        - id: "FR-007"
          description: "MUST correctly identify SSH URLs including git@, ssh://, and git+ssh:// schemes"
          testable: true
          acceptance_criteria: "Unit tests verify isSSHURL returns true for all SSH URL formats"
        - id: "FR-008"
          description: "MUST enforce a configurable timeout on all fetch operations with 60 second default"
          testable: true
          acceptance_criteria: "Fetch operations that exceed timeout are cancelled and logged; default is 60 seconds"
        - id: "FR-009"
          description: "All tests MUST pass with make test"
          testable: true
          acceptance_criteria: "make test && make fmt && make lint && make build all exit 0"
    non_functional:
        - id: "NFR-001"
          category: "reliability"
          description: "Command must never hang indefinitely regardless of environment; enforced via fetch timeout"
          measurable_target: "Fetch operations timeout at 60 seconds; overall command completes within reasonable time"
        - id: "NFR-002"
          category: "performance"
          description: "SSH URL detection must be instantaneous"
          measurable_target: "isSSHURL function executes in under 1 microsecond"
        - id: "NFR-003"
          category: "code_quality"
          description: "All functions must be under 40 lines"
          measurable_target: "No function exceeds 40 lines of code"
        - id: "NFR-004"
          category: "code_quality"
          description: "All errors must be wrapped with context"
          measurable_target: "No bare return err statements"
        - id: "NFR-005"
          category: "code_quality"
          description: "Tests must use map-based table test pattern"
          measurable_target: "New tests use map[string]struct{} pattern"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Agents can create feature branches in sandbox environments"
          metric: "Success rate of autospec new-feature in Claude Code sandbox"
          target: "100% success rate (no hangs)"
        - id: "SC-002"
          description: "Command completes quickly in restricted environments"
          metric: "Execution time when SSH_AUTH_SOCK is unset"
          target: "Under 5 seconds"
        - id: "SC-003"
          description: "No regression for users with full network access"
          metric: "Fetch behavior when SSH agent is available"
          target: "HTTPS and SSH remotes fetched as before"
key_entities:
    - name: "Remote"
      description: "A git remote repository with a URL that may use SSH or HTTPS protocol"
      attributes:
        - "name (origin, upstream, etc.)"
        - "URL (SSH or HTTPS format)"
        - "fetchable (whether fetch can be attempted)"
    - name: "SSH Agent"
      description: "System service providing SSH authentication, indicated by SSH_AUTH_SOCK"
      attributes:
        - "available (SSH_AUTH_SOCK is set)"
        - "socket path"
edge_cases:
    - scenario: "Repository has only SSH remotes and no SSH agent"
      expected_behavior: "Skip all fetches, log debug message, create feature successfully"
    - scenario: "Repository has mixed SSH and HTTPS remotes without SSH agent"
      expected_behavior: "Skip SSH remotes, fetch HTTPS remotes, create feature successfully"
    - scenario: "SSH_AUTH_SOCK is set but contains invalid path"
      expected_behavior: "Attempt SSH fetch (may warn), but don't hang indefinitely"
    - scenario: "--no-fetch used with SSH agent available"
      expected_behavior: "Skip all fetches regardless of capabilities"
    - scenario: "Remote URL uses uncommon SSH format (git+ssh://)"
      expected_behavior: "Correctly identified as SSH and skipped when no agent"
    - scenario: "Empty repository with no remotes"
      expected_behavior: "Complete successfully without attempting any fetches"
    - scenario: "Fetch from large repository exceeds timeout"
      expected_behavior: "Fetch cancelled after 60 seconds, warning logged, command continues without fetched data"
assumptions:
    - "The existing FetchAllRemotes and fetchRemote functions in internal/git/git.go are the correct locations to modify"
    - "Timeout can be implemented via context cancellation or goroutine with timer"
    - "Checking SSH_AUTH_SOCK presence is sufficient to determine SSH auth availability"
    - "Debug-level logging is appropriate for skipped fetch messages (not info or warn)"
    - "HTTPS remotes typically work without special authentication in most environments"
constraints:
    - "Must not break existing behavior for users with full network access and SSH agent"
    - "Cannot add external dependencies for this fix"
    - "Must work with current go-git library version"
    - "Changes limited to internal/cli/new_feature.go and internal/git/git.go"
out_of_scope:
    - "Auto-detecting sandbox environments beyond SSH_AUTH_SOCK check"
    - "User-configurable timeout value (future enhancement)"
    - "Supporting SSH agent forwarding or alternative SSH auth methods"
    - "Modifying other commands that may call FetchAllRemotes"
    - "Adding network connectivity checks beyond SSH agent detection"
clarifications:
    - date: "2026-01-27"
      question: "What should the default fetch timeout be?"
      answer: "60 seconds (more lenient for very large repos)"
      applied_to: "FR-008 (new), NFR-001 (updated), edge_cases (new scenario), assumptions (updated)"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.10.1"
    created: "2026-01-28T04:25:02Z"
    artifact_type: "spec"
