feature:
    branch: "066-worktree-setup-generator"
    created: "2025-12-20"
    status: "Completed"
    completed_at: 2025-12-20T02:08:17Z
    input: |
        Worktree Setup Script Generator - A new internal/commands/autospec.worktree-setup.md command
        template that instructs Claude to generate a project-specific setup-worktree.sh script. This
        script handles the tricky aspects of worktree setup: copying necessary .gitignored files
        (like .autospec/, .claude/) while excluding secrets (.env*, credentials, tokens) for safety.
        Instead of copying large directories like node_modules, vendor, or __pycache__, the script
        should run package manager install commands (npm install, go mod download, pip install, etc.).
        The generated script should be intelligent about what to include/exclude based on project
        analysis. A new autospec worktree setup command will run this Claude command to generate
        the script. Users can optionally specify --include-env to copy .env files if they explicitly
        want secrets copied. This integrates with the existing 064-worktree-management worktree command.
user_stories:
    - id: "US-001"
      title: "Generate project-specific setup script via Claude command"
      priority: "P1"
      as_a: "developer setting up worktrees for a new project"
      i_want: "to run a Claude command that analyzes my project and generates a customized setup-worktree.sh script"
      so_that: "the script correctly handles my project's specific needs for copying config files and running install commands"
      why_this_priority: "Core functionality - the Claude command is the main deliverable that generates the smart script"
      independent_test: "Run the command on a Node.js project and verify the generated script includes npm install and copies .autospec/"
      acceptance_scenarios:
        - given: "a Node.js project with package.json and .autospec/ directory"
          when: "I run '/autospec.worktree-setup'"
          then: "a setup-worktree.sh is generated that copies .autospec/ and runs npm install instead of copying node_modules"
        - given: "a Go project with go.mod and .claude/ directory"
          when: "I run '/autospec.worktree-setup'"
          then: "a setup-worktree.sh is generated that copies .autospec/, .claude/ and runs go mod download"
        - given: "a Python project with requirements.txt"
          when: "I run '/autospec.worktree-setup'"
          then: "a setup-worktree.sh is generated that runs pip install -r requirements.txt"
        - given: "a project with .env files"
          when: "I run '/autospec.worktree-setup' without --include-env"
          then: "the generated script does NOT copy .env files and prints a warning about secrets"
    - id: "US-002"
      title: "Intelligently exclude secrets from worktree setup"
      priority: "P1"
      as_a: "developer concerned about security"
      i_want: "the generated script to exclude secrets and credentials by default"
      so_that: "I don't accidentally expose sensitive data in worktrees that might be shared or logged"
      why_this_priority: "Security is non-negotiable - accidentally copying secrets could lead to data breaches"
      independent_test: "Verify generated script excludes .env*, credentials.*, tokens.*, *.pem, *.key files"
      acceptance_scenarios:
        - given: "a project with .env.local and .env.production files"
          when: "the setup script is generated"
          then: "these files are NOT in the copy list by default"
        - given: "a project with credentials.json or secrets.yaml"
          when: "the setup script is generated"
          then: "these files are NOT in the copy list"
        - given: "a project with .ssh/ or *.pem files"
          when: "the setup script is generated"
          then: "these files are NOT in the copy list"
    - id: "US-003"
      title: "Run package manager installs instead of copying dependencies"
      priority: "P1"
      as_a: "developer with large dependency directories"
      i_want: "the script to run install commands rather than copying massive directories like node_modules"
      so_that: "worktree creation is fast and dependencies are properly resolved for the worktree's state"
      why_this_priority: "Copying node_modules is slow, wasteful, and can cause issues with native modules"
      independent_test: "Verify node_modules, vendor, __pycache__ are in exclusion list and appropriate install commands are generated"
      acceptance_scenarios:
        - given: "a project with node_modules/ directory (100MB+)"
          when: "the setup script is generated"
          then: "node_modules is excluded from copying and 'npm install' or 'pnpm install' or 'yarn install' is added to setup"
        - given: "a Go project with vendor/ directory"
          when: "the setup script is generated"
          then: "vendor is excluded and 'go mod vendor' or 'go mod download' is added"
        - given: "a Python project with __pycache__/, .venv/, or venv/"
          when: "the setup script is generated"
          then: "these are excluded and 'pip install -r requirements.txt' or 'poetry install' is added"
    - id: "US-004"
      title: "CLI command to invoke the Claude script generator"
      priority: "P1"
      as_a: "developer using autospec CLI"
      i_want: "to run 'autospec worktree setup' or 'autospec worktree gen-script' to generate the setup script"
      so_that: "I have an easy CLI entry point to create the customized script"
      why_this_priority: "Without CLI integration, users have to manually invoke the Claude command"
      independent_test: "Run 'autospec worktree gen-script' and verify it creates .autospec/scripts/setup-worktree.sh"
      acceptance_scenarios:
        - given: "autospec is installed and I'm in a git repository"
          when: "I run 'autospec worktree gen-script'"
          then: "Claude analyzes the project and generates .autospec/scripts/setup-worktree.sh"
        - given: "the command is run"
          when: "generation completes successfully"
          then: "the script is marked executable (chmod +x)"
        - given: "a setup-worktree.sh already exists"
          when: "I run 'autospec worktree gen-script'"
          then: "I am prompted to confirm overwrite or the file is backed up"
    - id: "US-005"
      title: "Optionally include environment files"
      priority: "P2"
      as_a: "developer who needs env files in worktrees"
      i_want: "to use --include-env flag to explicitly copy .env files"
      so_that: "I can opt-in to copying secrets when I know it's safe (local development, same machine)"
      why_this_priority: "Some users legitimately need .env files copied; this should be explicit opt-in"
      independent_test: "Run with --include-env and verify .env files are included in the copy list"
      acceptance_scenarios:
        - given: "a project with .env file"
          when: "I run 'autospec worktree gen-script --include-env'"
          then: "the generated script includes .env in the copy list"
        - given: "--include-env flag is used"
          when: "the script is generated"
          then: "a warning is printed about security implications of copying secrets"
    - id: "US-006"
      title: "Copy essential autospec files"
      priority: "P1"
      as_a: "developer using autospec with worktrees"
      i_want: "the script to always copy .autospec/ directory"
      so_that: "autospec commands work correctly in the new worktree"
      why_this_priority: "Without .autospec/, autospec is broken in the worktree - this is essential"
      independent_test: "Verify .autospec/ is always in the copy list regardless of other settings"
      acceptance_scenarios:
        - given: "any project with .autospec/ directory"
          when: "the setup script is generated"
          then: ".autospec/ is always included in the copy list"
        - given: "a project with .claude/ directory"
          when: "the setup script is generated"
          then: ".claude/ is included in the copy list (for Claude Code settings)"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST create internal/commands/autospec.worktree-setup.md template following existing command template patterns"
          testable: true
          acceptance_criteria: "File exists at internal/commands/autospec.worktree-setup.md with proper frontmatter and instructions"
        - id: "FR-002"
          description: "MUST analyze project to detect package manager (npm/yarn/pnpm, go mod, pip/poetry/pipenv, cargo, etc.)"
          testable: true
          acceptance_criteria: "Generated script includes correct install command based on detected package manager"
        - id: "FR-003"
          description: "MUST exclude node_modules/, vendor/, __pycache__/, .venv/, venv/, target/, dist/, build/ from copy operations"
          testable: true
          acceptance_criteria: "Generated script never copies these directories; instead runs install commands"
        - id: "FR-004"
          description: "MUST exclude secret files by default: .env*, credentials.*, secrets.*, *.pem, *.key, *.p12, *token*"
          testable: true
          acceptance_criteria: "Generated script excludes secret patterns unless --include-env is specified"
        - id: "FR-005"
          description: "MUST always include .autospec/ directory in copy list"
          testable: true
          acceptance_criteria: ".autospec/ is always copied regardless of other exclusion rules"
        - id: "FR-006"
          description: "SHOULD include .claude/ directory in copy list if it exists"
          testable: true
          acceptance_criteria: ".claude/ is copied when present, silently skipped when absent"
        - id: "FR-007"
          description: "MUST generate executable shell script at .autospec/scripts/setup-worktree.sh"
          testable: true
          acceptance_criteria: "Script is created with 755 permissions and proper shebang"
        - id: "FR-008"
          description: "MUST implement 'autospec worktree gen-script' subcommand to invoke Claude generation"
          testable: true
          acceptance_criteria: "Command is registered, appears in help, and executes Claude with correct template"
        - id: "FR-009"
          description: "SHOULD support --include-env flag to opt-in to copying environment files"
          testable: true
          acceptance_criteria: "Flag is recognized; when set, .env files are included in copy list with warning"
        - id: "FR-010"
          description: "MUST make generated script compatible with existing worktree create command"
          testable: true
          acceptance_criteria: "Script accepts $WORKTREE_PATH, $WORKTREE_NAME, $WORKTREE_BRANCH, $SOURCE_REPO env vars"
        - id: "FR-011"
          description: "SHOULD detect and include project-specific config directories that are gitignored but needed"
          testable: true
          acceptance_criteria: "Common patterns like .vscode/settings.json, .idea/, local.settings.json detected and user prompted"
        - id: "FR-012"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-002"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern with t.Parallel()"
          measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
        - id: "NFR-004"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
        - id: "NFR-005"
          category: "security"
          description: "Default to secure behavior by excluding secrets"
          measurable_target: "No secret files copied without explicit user opt-in via --include-env"
        - id: "NFR-006"
          category: "usability"
          description: "Generated script should be readable and well-commented"
          measurable_target: "Script includes header comments explaining purpose and usage"
        - id: "NFR-007"
          category: "reliability"
          description: "Generated script should be idempotent"
          measurable_target: "Running script multiple times produces same result without errors"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Users can generate a project-specific worktree setup script with a single command"
          metric: "Commands required to create customized setup script"
          target: "1 command: 'autospec worktree gen-script'"
        - id: "SC-002"
          description: "Generated scripts correctly detect and install dependencies instead of copying"
          metric: "Package managers correctly detected"
          target: "100% correct detection for npm, yarn, pnpm, go mod, pip, poetry, cargo"
        - id: "SC-003"
          description: "No secrets are accidentally copied by default"
          metric: "Secret file exclusion rate"
          target: "100% exclusion of .env*, credentials, tokens by default"
        - id: "SC-004"
          description: "Worktrees created with generated script are fully functional for autospec"
          metric: "autospec command success rate in new worktrees"
          target: "100% of autospec commands work in worktrees set up with generated script"
key_entities:
    - name: "SetupScriptGenerator"
      description: "Claude command template that analyzes project and generates setup script"
      attributes:
        - "template_path: internal/commands/autospec.worktree-setup.md"
        - "output_path: .autospec/scripts/setup-worktree.sh"
        - "include_env: boolean flag for opting into secret copying"
    - name: "PackageManagerDetector"
      description: "Logic for detecting which package manager(s) a project uses"
      attributes:
        - "npm: detected via package.json + package-lock.json"
        - "yarn: detected via yarn.lock"
        - "pnpm: detected via pnpm-lock.yaml"
        - "go_mod: detected via go.mod"
        - "pip: detected via requirements.txt"
        - "poetry: detected via pyproject.toml with [tool.poetry]"
        - "cargo: detected via Cargo.toml"
    - name: "ExclusionPatterns"
      description: "Patterns for files/directories to exclude from copying"
      attributes:
        - "dependencies: node_modules, vendor, __pycache__, .venv, target, dist, build"
        - "secrets: .env*, credentials.*, secrets.*, *.pem, *.key, *token*"
        - "generated: *.log, *.tmp, .cache, coverage"
    - name: "InclusionPatterns"
      description: "Patterns for files/directories that must always be copied"
      attributes:
        - "required: .autospec/"
        - "recommended: .claude/, .vscode/settings.json, .editorconfig"
edge_cases:
    - scenario: "Project has multiple package managers (e.g., package.json and go.mod for monorepo)"
      expected_behavior: "Generated script includes install commands for all detected package managers"
    - scenario: "Project has no recognizable package manager"
      expected_behavior: "Generated script includes comment placeholder for manual install command"
    - scenario: ".autospec/ directory doesn't exist yet"
      expected_behavior: "Script generation still succeeds; script will create .autospec/ if needed"
    - scenario: "User runs gen-script in worktree instead of main repo"
      expected_behavior: "Error with message suggesting to run from main repository"
    - scenario: "Generated script already exists with user modifications"
      expected_behavior: "Prompt user to confirm overwrite; offer backup option"
    - scenario: "Project uses unusual directory names for dependencies (e.g., deps/ instead of node_modules)"
      expected_behavior: "Claude should analyze .gitignore and npm/yarn config to detect non-standard paths"
assumptions:
    - "Users have Claude Code or Claude CLI available for running the generation command"
    - "Projects follow standard package manager conventions for lock file locations"
    - ".gitignore accurately reflects which files should not be tracked"
    - "Users understand the security implications when using --include-env"
    - "bash is available on the target system for running the setup script"
    - "The existing worktree command (064-worktree-management) is implemented and working"
constraints:
    - "Command template must follow existing internal/commands/*.md patterns exactly"
    - "Generated script must be POSIX-compatible bash (no bashisms that break on sh)"
    - "No secrets should ever be copied without explicit user consent"
    - "Integration must not break existing 'autospec worktree create' functionality"
    - "Template must be project-agnostic as per constitution principles"
out_of_scope:
    - "Automatic detection of all possible secret file patterns"
    - "Support for Windows batch script generation"
    - "Interactive script generation (all decisions made from project analysis)"
    - "Syncing script changes back to main repo automatically"
    - "Remote worktree setup (only local worktrees supported)"
    - "Custom exclusion/inclusion patterns via config (future enhancement)"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-20T01:53:32Z"
    artifact_type: "spec"
