plan:
  branch: "066-worktree-setup-generator"
  created: "2025-12-20"
  spec_path: "specs/066-worktree-setup-generator/spec.yaml"

summary: |
  This feature adds a Claude command template (autospec.worktree-setup.md) that generates
  a project-specific setup-worktree.sh script. The generated script intelligently handles
  worktree setup by: (1) copying essential config directories like .autospec/ and .claude/,
  (2) excluding secrets by default (.env*, credentials.*, *.pem), and (3) running package
  manager install commands instead of copying large dependency directories (node_modules,
  vendor, __pycache__).

  The implementation adds a new CLI subcommand 'autospec worktree gen-script' that invokes
  Claude with the template. The template follows existing command patterns and adheres to
  PRIN-012 (Command Template Independence) by being project-agnostic. An optional --include-env
  flag allows users to explicitly opt-in to copying environment files.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.1"
      purpose: "CLI framework for command registration and flag handling"
    - name: "github.com/ariel-frischer/autospec/internal/workflow"
      version: "internal"
      purpose: "Claude execution for running command templates"
  storage: "None (file-based output only)"
  testing:
    framework: "go test"
    approach: "Unit tests for CLI command registration and flag parsing; integration tests verify template invocation"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Script generation completes within Claude execution timeout"
  constraints:
    - "Command template must be project-agnostic per PRIN-012"
    - "No MCP tools, Claude Code tools, or autospec internal paths in template"
    - "Generated script must be POSIX-compatible bash"
    - "Secrets excluded by default; explicit opt-in required"
  scale_scope: "Single-user CLI tool, local worktree management"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Unit tests for gen-script command will be written before implementation"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "No artifact validation required for script generation command"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "CLI startup <50ms; execution depends on Claude response time (external)"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Re-running gen-script with overwrite produces same result"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Will use 0=success, 1=validation failed, 4=missing dependencies"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "N/A"
      notes: "This feature generates shell scripts, not YAML artifacts"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All Go code passes go fmt, go vet; bash scripts pass shellcheck"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, map-based table tests"
    - name: "Command Template Independence (PRIN-012)"
      status: "PASS"
      notes: "Template contains no MCP tools, Claude Code tools, or internal paths"

research_findings:
  decisions:
    - topic: "Package manager detection strategy"
      decision: "Analyze lockfile presence and package manifest files"
      rationale: "Lockfiles uniquely identify package managers; manifest files serve as fallback"
      alternatives_considered:
        - "Parse .gitignore for dependency patterns (less reliable)"
        - "Execute package managers to check availability (slower, not portable)"
    - topic: "Secret file pattern matching"
      decision: "Use glob patterns for known secret file types"
      rationale: "Covers common cases (.env*, credentials.*, *.pem, *.key) without false positives"
      alternatives_considered:
        - "File content scanning for secrets (too slow, privacy concerns)"
        - "User-provided exclusion list only (poor UX for default case)"
    - topic: "Template approach for script generation"
      decision: "Claude command template analyzes project and generates complete script"
      rationale: "Leverages Claude's understanding of project structure for intelligent decisions"
      alternatives_considered:
        - "Static script with config file (inflexible for diverse projects)"
        - "Go code generates script directly (misses project-specific patterns)"
    - topic: "CLI subcommand structure"
      decision: "Add 'gen-script' as subcommand under existing 'worktree' command"
      rationale: "Consistent with existing worktree subcommands (create, list, remove, setup, prune)"
      alternatives_considered:
        - "New top-level command (fragments worktree functionality)"
        - "Flag on 'worktree setup' command (confuses run-time setup with generation)"

data_model:
  entities:
    - name: "WorktreeSetupScript"
      description: "The generated bash script for worktree setup"
      fields:
        - name: "output_path"
          type: "string"
          description: "Path where script is written"
          constraints: ".autospec/scripts/setup-worktree.sh"
        - name: "permissions"
          type: "os.FileMode"
          description: "File permissions for executable"
          constraints: "0755"
      relationships:
        - target: "WorktreeConfig"
          type: "uses"
          description: "Script uses config for copy_dirs baseline"
    - name: "PackageManager"
      description: "Detected package manager for dependency installation"
      fields:
        - name: "name"
          type: "string"
          description: "Package manager identifier"
          constraints: "npm|yarn|pnpm|go_mod|pip|poetry|cargo"
        - name: "lockfile"
          type: "string"
          description: "Lockfile that triggered detection"
          constraints: "package-lock.json|yarn.lock|pnpm-lock.yaml|go.sum|requirements.txt|poetry.lock|Cargo.lock"
        - name: "install_command"
          type: "string"
          description: "Command to run for installing dependencies"
          constraints: "Valid shell command"
      relationships:
        - target: "WorktreeSetupScript"
          type: "included_in"
          description: "Install commands are embedded in generated script"
    - name: "ExclusionPattern"
      description: "Patterns for files/directories to exclude from copy"
      fields:
        - name: "category"
          type: "string"
          description: "Type of exclusion"
          constraints: "dependencies|secrets|generated"
        - name: "patterns"
          type: "[]string"
          description: "Glob patterns to match"
          constraints: "Valid glob syntax"
      relationships:
        - target: "WorktreeSetupScript"
          type: "used_by"
          description: "Exclusions are applied in script copy logic"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/worktree.md"
      description: "Update with gen-script command documentation"
  source_code:
    - path: "internal/commands/autospec.worktree-setup.md"
      description: "Claude command template for generating setup script"
    - path: "internal/cli/worktree/gen_script.go"
      description: "CLI command implementation for 'worktree gen-script'"
  tests:
    - path: "internal/cli/worktree/gen_script_test.go"
      description: "Unit tests for gen-script command"

implementation_phases:
  - phase: 1
    name: "Command Template Creation"
    goal: "Create the project-agnostic Claude command template"
    deliverables:
      - "internal/commands/autospec.worktree-setup.md following existing template patterns"
      - "Template includes package manager detection instructions"
      - "Template specifies secret exclusion defaults"
      - "Template defines script output format"
  - phase: 2
    name: "CLI Command Implementation"
    goal: "Implement the 'autospec worktree gen-script' subcommand"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/cli/worktree/gen_script.go with command definition"
      - "Registration in internal/cli/worktree/worktree.go"
      - "--include-env flag for optional secret copying"
      - "Overwrite prompt or backup for existing scripts"
  - phase: 3
    name: "Testing and Documentation"
    goal: "Complete test coverage and update documentation"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Unit tests for CLI command in gen_script_test.go"
      - "Update docs/worktree.md with gen-script usage"
      - "Pass make test, make fmt, make lint, make build"

risks:
  - risk: "Claude may generate non-POSIX-compatible bash scripts"
    likelihood: "low"
    impact: "medium"
    mitigation: "Template explicitly requires POSIX compatibility; user can run shellcheck"
  - risk: "Template may inadvertently include Claude Code specific instructions"
    likelihood: "medium"
    impact: "high"
    mitigation: "CI grep check per PRIN-012 enforcement; code review validation"
  - risk: "Generated script may miss project-specific patterns"
    likelihood: "medium"
    impact: "low"
    mitigation: "Users can manually edit generated script; document customization"
  - risk: "Package manager detection may fail for unusual setups"
    likelihood: "low"
    impact: "low"
    mitigation: "Template includes fallback comment for manual configuration"

open_questions:
  - question: "Should the generated script support --dry-run mode?"
    context: "Users may want to preview what the script will do before execution"
    proposed_resolution: "Add dry-run mode in generated script header as optional feature"
  - question: "Should we validate generated script with shellcheck automatically?"
    context: "Ensures script quality but adds dependency"
    proposed_resolution: "Document shellcheck as recommended but not required; user responsibility"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-20T01:55:42Z"
  artifact_type: "plan"
