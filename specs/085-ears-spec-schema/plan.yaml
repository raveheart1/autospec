plan:
  branch: "085-ears-spec-schema"
  created: "2026-01-06"
  spec_path: "specs/085-ears-spec-schema/spec.yaml"

summary: |
  This plan extends autospec's spec.yaml schema to support EARS (Easy Approach to Requirements Syntax)
  formatted requirements. The implementation follows existing patterns: *bool toggle in VerificationConfig
  with level-based defaults, InjectableInstruction pattern for dynamic prompt injection into the specify
  stage, and SchemaField extensions for validation. EARS requirements provide machine-parseable
  requirement patterns (ubiquitous, event-driven, state-driven, unwanted, optional) that map directly
  to test types, enabling AI agents to unambiguously understand what to implement and how to test it.

technical_context:
  language: "Go"
  framework: "None"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for spec.yaml with EARS requirements"
    - name: "github.com/knadh/koanf"
      version: "v2.1.1"
      purpose: "Configuration management for ears_requirements toggle"
  storage: "None"
  testing:
    framework: "testing (stdlib)"
    approach: "Map-based table-driven tests with t.Parallel() for all new functionality"
  target_platform: "Linux, macOS, Windows (via WSL)"
  project_type: "cli"
  performance_goals: "<10ms per EARS requirement validation (existing validation performance contract)"
  constraints:
    - "MUST NOT break existing spec.yaml validation"
    - "MUST use InjectableInstruction for prompt injection (not hardcoded in commands)"
    - "MUST follow existing VerificationConfig *bool toggle pattern"
    - "EARS validation MUST only run when ears_requirements block present AND feature enabled"
    - "Command templates in internal/commands/*.md must remain project-agnostic"
  scale_scope: "Individual spec.yaml files, typically <100 EARS requirements per spec"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "All new functionality (VerificationConfig toggle, schema validation, instruction injection) will have tests written before implementation"
    - name: "Validation-First Workflow"
      status: "PASS"
      notes: "EARS validation integrates with existing artifact validation pipeline; pattern-specific validation ensures completeness"
    - name: "Performance Standards"
      status: "PASS"
      notes: "<10ms per EARS requirement validation aligns with existing performance contracts"
    - name: "YAML-First Artifacts"
      status: "PASS"
      notes: "EARS requirements are defined in YAML within spec.yaml, maintaining machine-readability"
    - name: "Go Coding Standards"
      status: "PASS"
      notes: "Implementation follows <40 line functions, error wrapping, map-based tests"
    - name: "Command Template Independence"
      status: "PASS"
      notes: "EARS guidance injected dynamically via InjectableInstruction, not hardcoded in internal/commands/specify.md"

research_findings:
  decisions:
    - topic: "EARS Feature Toggle Location"
      decision: "Add EarsRequirements *bool to VerificationConfig in internal/verification/config.go"
      rationale: "Follows existing pattern for AdversarialReview, Contracts, PropertyTests, MetamorphicTests toggles"
      alternatives_considered:
        - "Separate top-level config field (rejected: verification features belong in VerificationConfig)"
        - "Hardcoded based on level only (rejected: explicit override capability required)"
    - topic: "Level-Based Defaults for EARS"
      decision: "basic=disabled, enhanced=enabled, full=enabled (same as contracts toggle)"
      rationale: "EARS provides structured requirements similar to contracts - valuable at enhanced/full levels but optional at basic"
      alternatives_considered:
        - "Enable at all levels (rejected: basic level should remain minimal)"
        - "Only enable at full level (rejected: enhanced users benefit from structured requirements)"
    - topic: "Instruction Injection Pattern"
      decision: "Create BuildEarsInstructions() and InjectEarsInstructions() following risk_assessment.go pattern"
      rationale: "Consistent with existing InjectableInstruction pattern used by auto-commit and risk assessment"
      alternatives_considered:
        - "Modify specify.md template directly (rejected: violates command template independence principle)"
        - "Add EARS as config option in executor (rejected: less clean than InjectableInstruction pattern)"
    - topic: "Schema Extension Approach"
      decision: "Add optional ears_requirements array field to SpecSchema in internal/validation/schema.go"
      rationale: "Schema already defines optional arrays (edge_cases, constraints) - same pattern applies"
      alternatives_considered:
        - "Separate EARS schema file (rejected: EARS is part of spec.yaml, not a separate artifact)"
        - "Dynamic schema loading (rejected: over-engineering for single field addition)"
    - topic: "ID Uniqueness Validation"
      decision: "Cross-validate EARS IDs with functional requirement IDs during spec validation"
      rationale: "IDs must be globally unique to enable unambiguous requirement tracing"
      alternatives_considered:
        - "Allow duplicate IDs across sections (rejected: creates traceability confusion)"
        - "Prefix-based separation only (rejected: explicit uniqueness check is more reliable)"

data_model:
  entities:
    - name: "EarsRequirement"
      description: "A single EARS-formatted requirement with pattern-specific fields"
      fields:
        - name: "id"
          type: "string"
          description: "Unique identifier (e.g., EARS-001)"
          constraints: "Required, pattern ^EARS-\\d+$, unique across all requirements"
        - name: "pattern"
          type: "string"
          description: "EARS pattern type"
          constraints: "Required, enum: ubiquitous | event-driven | state-driven | unwanted | optional"
        - name: "text"
          type: "string"
          description: "Full EARS sentence following pattern template"
          constraints: "Required, should contain pattern keywords (shall, when, while, if, where)"
        - name: "test_type"
          type: "string"
          description: "Recommended test type for this requirement"
          constraints: "Required, enum: invariant | property | state-machine | exception | feature-flag"
        - name: "trigger"
          type: "string"
          description: "What triggers the action (event-driven pattern)"
          constraints: "Required for event-driven pattern"
        - name: "expected"
          type: "string"
          description: "Expected outcome (event-driven pattern)"
          constraints: "Required for event-driven pattern"
        - name: "state"
          type: "string"
          description: "System state during which action applies (state-driven pattern)"
          constraints: "Required for state-driven pattern"
        - name: "condition"
          type: "string"
          description: "Error condition that triggers handling (unwanted pattern)"
          constraints: "Required for unwanted pattern"
        - name: "feature"
          type: "string"
          description: "Feature flag controlling the behavior (optional pattern)"
          constraints: "Required for optional pattern"
      relationships:
        - target: "FunctionalRequirement"
          type: "sibling"
          description: "EARS requirements complement functional requirements, IDs must be unique across both"

    - name: "EarsPattern"
      description: "EARS sentence pattern template (compile-time constant, not persisted)"
      fields:
        - name: "ubiquitous"
          type: "string"
          description: "Template: 'The [system] shall [action]'"
          constraints: "No trigger word, always applies"
        - name: "event-driven"
          type: "string"
          description: "Template: 'When [trigger], the [system] shall [action]'"
          constraints: "Requires trigger and expected fields"
        - name: "state-driven"
          type: "string"
          description: "Template: 'While [state], the [system] shall [action]'"
          constraints: "Requires state field"
        - name: "unwanted"
          type: "string"
          description: "Template: 'If [condition], then the [system] shall [action]'"
          constraints: "Requires condition field"
        - name: "optional"
          type: "string"
          description: "Template: 'Where [feature], the [system] shall [action]'"
          constraints: "Requires feature field"

project_structure:
  documentation:
    - path: "docs/internal/YAML-STRUCTURED-OUTPUT.md"
      description: "Update with EARS requirements schema documentation"
  source_code:
    - path: "internal/verification/config.go"
      description: "Add EarsRequirements *bool toggle and update IsEnabled()"
    - path: "internal/verification/config_test.go"
      description: "Tests for EARS toggle with level defaults and explicit overrides"
    - path: "internal/validation/schema.go"
      description: "Add ears_requirements field to SpecSchema with pattern-specific children"
    - path: "internal/validation/ears_validation.go"
      description: "Pattern-specific validation logic for EARS requirements"
    - path: "internal/validation/ears_validation_test.go"
      description: "Tests for EARS validation including pattern-specific field requirements"
    - path: "internal/workflow/ears_instructions.go"
      description: "BuildEarsInstructions() and InjectEarsInstructions() functions"
    - path: "internal/workflow/ears_instructions_test.go"
      description: "Tests for EARS instruction building and injection"
    - path: "internal/workflow/stage_executor.go"
      description: "Wire EARS injection into specify stage execution"
  tests:
    - path: "internal/verification/config_test.go"
      description: "Tests for EarsRequirements toggle in VerificationConfig"
    - path: "internal/validation/ears_validation_test.go"
      description: "Pattern-specific EARS validation tests"
    - path: "internal/validation/artifact_spec_test.go"
      description: "Integration tests for spec.yaml with EARS requirements"
    - path: "internal/workflow/ears_instructions_test.go"
      description: "Tests for EARS instruction injection"

implementation_phases:
  - phase: 1
    name: "Configuration Toggle"
    goal: "Add EarsRequirements toggle to VerificationConfig with level-based defaults"
    deliverables:
      - "EarsRequirements *bool field in VerificationConfig struct"
      - "FeatureEarsRequirements constant"
      - "Updated IsEnabled() method with EARS case"
      - "Updated GetEffectiveToggles() to include EARS"
      - "Updated levelPreset struct and levelPresets map"
      - "Table-driven tests for toggle behavior"

  - phase: 2
    name: "Schema Extension"
    goal: "Extend SpecSchema to support optional ears_requirements field"
    dependencies:
      - "Phase 1"
    deliverables:
      - "ears_requirements SchemaField in SpecSchema"
      - "Pattern-specific child fields (trigger, expected, state, condition, feature)"
      - "Enum validation for pattern and test_type fields"
      - "ID pattern validation (^EARS-\\d+$)"
      - "Schema tests for ears_requirements structure"

  - phase: 3
    name: "EARS Validation Logic"
    goal: "Implement pattern-specific validation with helpful error messages"
    dependencies:
      - "Phase 2"
    deliverables:
      - "ValidateEarsRequirements() function"
      - "Pattern-specific field requirement validation"
      - "Cross-section ID uniqueness validation"
      - "Error messages with template examples"
      - "Table-driven tests for all patterns and edge cases"

  - phase: 4
    name: "Instruction Injection"
    goal: "Create EARS instruction builder and inject into specify stage"
    dependencies:
      - "Phase 1"
    deliverables:
      - "BuildEarsInstructions() returning InjectableInstruction"
      - "InjectEarsInstructions() for conditional injection"
      - "EARS template content (5 pattern templates with examples)"
      - "Integration with StageExecutor.ExecuteSpecify()"
      - "Tests for instruction building and injection"

  - phase: 5
    name: "Integration & Backwards Compatibility"
    goal: "Ensure existing specs work and full workflow functions correctly"
    dependencies:
      - "Phase 3"
      - "Phase 4"
    deliverables:
      - "Validation of existing specs in specs/ directory"
      - "End-to-end test with EARS-enabled spec.yaml"
      - "Documentation updates to YAML-STRUCTURED-OUTPUT.md"
      - "EARS coverage reporting in validation summary (optional)"

open_questions:
  - question: "Should EARS text be validated against pattern keywords?"
    context: "EARS text should contain pattern-specific keywords (shall, when, while, if, where) but strict validation might reject valid edge cases"
    proposed_resolution: "Implement as warning, not error, in initial version. Add strictness config later if needed."
  - question: "How should EARS coverage be reported?"
    context: "FR-011 suggests reporting EARS coverage in validation summary, but implementation details are unclear"
    proposed_resolution: "Add optional coverage metrics to validation output showing EARS count and functional requirement coverage percentage"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.2"
  created: "2026-01-06T07:04:01Z"
  artifact_type: "plan"
