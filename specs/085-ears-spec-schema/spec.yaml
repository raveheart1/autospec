feature:
  branch: "085-ears-spec-schema"
  created: "2026-01-06"
  status: "Draft"
  input: |
    Extend the spec.yaml schema to support EARS (Easy Approach to Requirements Syntax) formatted requirements.
    This provides machine-parseable requirements that map directly to test types. EARS provides five sentence
    patterns (Ubiquitous, Event-Driven, State-Driven, Unwanted Behavior, Optional) that force explicit triggers,
    conditions, and states, enabling AI agents to unambiguously understand what to implement and how to test it.

user_stories:
  - id: "US-001"
    title: "Enable EARS requirements in spec.yaml"
    priority: "P1"
    as_a: "specification author"
    i_want: "to write requirements in EARS format alongside traditional functional requirements"
    so_that: "AI agents can unambiguously parse requirements and map them to appropriate test types"
    why_this_priority: "Core feature - without EARS schema support, the entire feature is non-functional"
    independent_test: "Create a spec.yaml with ears_requirements block and validate it parses correctly"
    acceptance_scenarios:
      - given: "a spec.yaml file with an ears_requirements block"
        when: "the artifact validator processes the file"
        then: "the EARS requirements are validated according to pattern-specific rules"
      - given: "EARS requirements are enabled in verification config"
        when: "generating a new spec via /autospec.specify"
        then: "EARS template guidance is included in the agent prompt"

  - id: "US-002"
    title: "Configure EARS via verification level"
    priority: "P1"
    as_a: "project maintainer"
    i_want: "EARS requirements to be enabled by default at enhanced/full verification levels"
    so_that: "I get structured requirements automatically when using higher verification tiers"
    why_this_priority: "Configuration is essential for feature adoption and sensible defaults"
    independent_test: "Set verification level to enhanced and confirm EARS is enabled without explicit toggle"
    acceptance_scenarios:
      - given: "verification.level is set to 'basic'"
        when: "no explicit ears_requirements toggle is set"
        then: "EARS requirements validation is disabled"
      - given: "verification.level is set to 'enhanced' or 'full'"
        when: "no explicit ears_requirements toggle is set"
        then: "EARS requirements validation is enabled"
      - given: "verification.level is 'basic' and ears_requirements is explicitly true"
        when: "validating a spec.yaml"
        then: "EARS requirements validation is enabled (explicit override)"

  - id: "US-003"
    title: "Pattern-specific EARS validation"
    priority: "P1"
    as_a: "specification author"
    i_want: "validation errors with helpful messages when my EARS requirements are malformed"
    so_that: "I can quickly fix syntax issues and learn the correct format"
    why_this_priority: "Usability - authors need feedback to write correct EARS requirements"
    independent_test: "Submit spec.yaml with invalid EARS pattern and verify error includes template example"
    acceptance_scenarios:
      - given: "an event-driven EARS requirement without trigger field"
        when: "validation runs"
        then: "error message indicates trigger is required and shows event-driven template"
      - given: "a state-driven EARS requirement without state field"
        when: "validation runs"
        then: "error message indicates state is required"
      - given: "EARS text does not match pattern template structure"
        when: "validation runs"
        then: "error message shows correct template format"

  - id: "US-004"
    title: "Inject EARS guidance into specify command"
    priority: "P2"
    as_a: "specification author using /autospec.specify"
    i_want: "EARS templates and examples injected into the command when enabled"
    so_that: "I can author EARS requirements with proper guidance from the AI agent"
    why_this_priority: "Important for adoption but feature works without injection (manual authoring)"
    independent_test: "Enable EARS, run specify command, verify injected instructions contain EARS templates"
    acceptance_scenarios:
      - given: "EARS requirements are enabled via config"
        when: "executing the specify stage"
        then: "EARS instruction block is injected using InjectableInstruction pattern"
      - given: "EARS requirements are disabled"
        when: "executing the specify stage"
        then: "no EARS instructions are injected"

  - id: "US-005"
    title: "Backwards compatibility for existing specs"
    priority: "P1"
    as_a: "existing autospec user"
    i_want: "my specs without ears_requirements to continue working exactly as before"
    so_that: "I don't have to update all my existing specifications"
    why_this_priority: "Critical for adoption - breaking changes would frustrate existing users"
    independent_test: "Validate existing spec.yaml files in specs/ directory without ears_requirements block"
    acceptance_scenarios:
      - given: "a spec.yaml without ears_requirements block"
        when: "EARS is enabled in config"
        then: "validation passes (ears_requirements is optional)"
      - given: "a spec.yaml without ears_requirements block"
        when: "EARS is disabled in config"
        then: "validation passes unchanged from current behavior"

requirements:
  functional:
    - id: "FR-001"
      description: "The system MUST add EarsRequirements toggle to VerificationConfig following existing *bool pattern"
      testable: true
      acceptance_criteria: "VerificationConfig struct has EarsRequirements *bool field with koanf/yaml tags"

    - id: "FR-002"
      description: "The system MUST derive EARS enabled state from verification level when toggle is nil"
      testable: true
      acceptance_criteria: "basic=disabled, enhanced=enabled, full=enabled when EarsRequirements is nil"

    - id: "FR-003"
      description: "The system MUST allow explicit EarsRequirements toggle to override level default"
      testable: true
      acceptance_criteria: "Setting ears_requirements: false at enhanced level disables EARS"

    - id: "FR-004"
      description: "The system MUST add FeatureEarsRequirements constant and update IsEnabled() method"
      testable: true
      acceptance_criteria: "IsEnabled('ears_requirements') returns correct value based on toggle/level"

    - id: "FR-005"
      description: "The system MUST extend SpecSchema with optional ears_requirements field"
      testable: true
      acceptance_criteria: "SpecSchema includes ears_requirements array field with EARS-specific child schema"

    - id: "FR-006"
      description: "The system MUST validate EARS requirements have correct pattern-specific fields"
      testable: true
      acceptance_criteria: "Event-driven requires trigger/expected, state-driven requires state, unwanted requires condition"

    - id: "FR-007"
      description: "The system MUST validate EARS IDs are unique across functional and ears_requirements"
      testable: true
      acceptance_criteria: "Duplicate IDs produce validation error"

    - id: "FR-008"
      description: "The system MUST create BuildEarsInstructions() following InjectableInstruction pattern"
      testable: true
      acceptance_criteria: "Function returns InjectableInstruction with Name='EarsRequirements', Content with EARS templates"

    - id: "FR-009"
      description: "The system MUST create InjectEarsInstructions() for conditional injection"
      testable: true
      acceptance_criteria: "When enabled=true, appends EARS instruction block; when false, returns command unchanged"

    - id: "FR-010"
      description: "The system MUST wire EARS injection into specify stage execution"
      testable: true
      acceptance_criteria: "StageExecutor injects EARS instructions when feature is enabled"

    - id: "FR-011"
      description: "The system SHOULD report EARS coverage in validation summary"
      testable: true
      acceptance_criteria: "Summary includes count of EARS requirements and coverage of functional requirements"

    - id: "FR-012"
      description: "The system MUST NOT modify internal/commands/specify.md for EARS guidance"
      testable: true
      acceptance_criteria: "EARS guidance is injected dynamically via InjectableInstruction, not hardcoded"

  non_functional:
    - id: "NFR-001"
      category: "performance"
      description: "EARS validation MUST complete within 10ms per requirement"
      measurable_target: "<10ms per EARS requirement validation"

    - id: "NFR-002"
      category: "usability"
      description: "Error messages MUST include the correct EARS template for the pattern"
      measurable_target: "100% of pattern-specific errors include template example"

    - id: "NFR-003"
      category: "reliability"
      description: "All existing spec.yaml files MUST continue to validate without modification"
      measurable_target: "0 breaking changes to existing specs"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can write EARS requirements that are validated correctly"
      metric: "Percentage of valid EARS specs that pass validation"
      target: "100%"
    - id: "SC-002"
      description: "Users receive helpful error messages for invalid EARS requirements"
      metric: "Error messages include pattern template"
      target: "100% of pattern-specific errors"
    - id: "SC-003"
      description: "Existing specs without EARS continue working"
      metric: "Existing spec.yaml files in specs/ pass validation"
      target: "100%"
    - id: "SC-004"
      description: "EARS instructions are injected when feature is enabled"
      metric: "Injected command contains EARS templates"
      target: "When verification.ears_requirements is enabled"

key_entities:
  - name: "EarsRequirement"
    description: "A single EARS-formatted requirement with pattern-specific fields"
    attributes:
      - "id: unique identifier (e.g., EARS-001)"
      - "pattern: ubiquitous | event-driven | state-driven | unwanted | optional"
      - "text: full EARS sentence following pattern template"
      - "test_type: invariant | property | state-machine | exception | feature-flag"
      - "trigger: (event-driven) what triggers the action"
      - "expected: (event-driven) expected outcome"
      - "state: (state-driven) system state during which action applies"
      - "condition: (unwanted) error condition that triggers handling"
      - "feature: (optional) feature flag controlling the behavior"

  - name: "EarsPattern"
    description: "EARS sentence pattern defining structure and required fields"
    attributes:
      - "ubiquitous: 'The [system] shall [action]'"
      - "event-driven: 'When [trigger], the [system] shall [action]'"
      - "state-driven: 'While [state], the [system] shall [action]'"
      - "unwanted: 'If [condition], then the [system] shall [action]'"
      - "optional: 'Where [feature], the [system] shall [action]'"

  - name: "VerificationConfig"
    description: "Configuration struct holding verification settings and feature toggles"
    attributes:
      - "Level: basic | enhanced | full"
      - "EarsRequirements: *bool toggle for EARS feature"
      - "Existing toggles: AdversarialReview, Contracts, PropertyTests, MetamorphicTests"

edge_cases:
  - scenario: "Empty ears_requirements array"
    expected_behavior: "Valid - author explicitly indicates no EARS requirements"
  - scenario: "EARS ID conflicts with functional requirement ID"
    expected_behavior: "Validation error - IDs must be unique across both sections"
  - scenario: "Unknown pattern value in EARS requirement"
    expected_behavior: "Validation error listing valid pattern values"
  - scenario: "Mixed valid and invalid EARS requirements"
    expected_behavior: "All errors reported, not just first"
  - scenario: "EARS text missing pattern keywords (shall, when, while, if, where)"
    expected_behavior: "Warning or error depending on strictness setting"
  - scenario: "EarsRequirements toggle is null vs explicitly false"
    expected_behavior: "null inherits from level, false explicitly disables"

assumptions:
  - "EARS patterns follow Alistair Mavin et al. specification exactly"
  - "InjectableInstruction pattern is stable and appropriate for this feature"
  - "VerificationConfig *bool pattern is the standard for feature toggles"
  - "Validation performance contracts (<10ms) apply to EARS validation"
  - "spec.yaml is the only artifact that will contain EARS requirements"

constraints:
  - "MUST NOT break existing spec.yaml validation"
  - "MUST use InjectableInstruction for prompt injection (not hardcoded in commands)"
  - "MUST follow existing VerificationConfig toggle pattern"
  - "EARS validation MUST only run when ears_requirements block is present AND feature is enabled"

out_of_scope:
  - "Auto-generation of EARS requirements from prose functional requirements"
  - "EARS requirements in plan.yaml or tasks.yaml"
  - "Automatic test generation from EARS requirements"
  - "Integration with external requirements management tools"
  - "Multi-language EARS templates (English only)"
  - "EARS validation strictness levels (e.g., warn vs error)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "0.8.2"
  created: "2026-01-06T07:02:15Z"
  artifact_type: "spec"
