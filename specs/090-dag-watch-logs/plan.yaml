plan:
  branch: "090-dag-watch-logs"
  created: "2026-01-11"
  spec_path: "specs/090-dag-watch-logs/spec.yaml"

summary: |
  This plan implements real-time monitoring and log access for DAG runs through three
  CLI commands: `dag watch`, `dag logs`, and an enhanced `dag list`. The watch command
  provides a live-updating terminal table displaying spec status, progress, and duration
  with auto-refresh implemented in pure Go (no external dependencies). The logs command
  enables tail-f style streaming of per-spec log files with --latest and --no-follow
  options. The existing dag list command is enhanced to show run-ids prominently with
  spec counts and relative timestamps.

  Key technical decisions include using Go's terminal control for cursor positioning
  (avoiding ncurses complexity), fsnotify for efficient file watching, and human-readable
  run-id format (dag-YYYYMMDD-HHMMSS) for better UX. Log files use timestamped lines
  with configurable size limits and truncation to manage disk space.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8+"
      purpose: "CLI command framework"
    - name: "github.com/fatih/color"
      version: "v1.16+"
      purpose: "Terminal color output for status display"
    - name: "golang.org/x/term"
      version: "v0.16+"
      purpose: "Terminal size detection for table formatting"
    - name: "github.com/fsnotify/fsnotify"
      version: "v1.7+"
      purpose: "Efficient file change detection for log tailing"
  storage: "YAML files in .autospec/state/dag-runs/"
  testing:
    framework: "Go testing with testify/assert"
    approach: "Unit tests with map-based table-driven tests, integration tests for CLI commands"
  target_platform: "Linux, macOS (Intel and Apple Silicon)"
  project_type: "cli"
  performance_goals: "Watch table refresh < 500ms, log streaming latency < 100ms"
  constraints:
    - "Pure Go implementation (no external watch binary)"
    - "Log files must remain compatible with tail, grep, less"
    - "Append-only log writes during execution"
    - "Must work on macOS and Linux without platform-specific builds"
  scale_scope: "Single machine, up to ~20 concurrent specs in a DAG run"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All new commands will have tests written before implementation per FR-019"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "This feature monitors existing workflow artifacts, does not introduce new phase transitions"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "NFR-001 specifies 500ms refresh target, NFR-002 specifies 100ms log latency"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "N/A"
      notes: "Watch/logs are read-only operations without retry requirements"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Commands use exit 0 for success, 1 for validation/runtime errors"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "Run state persisted as YAML, log files are plain text for Unix tool compatibility"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "FR-020 requires make fmt && make lint passing"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "FR-017 requires functions under 40 lines, FR-018 requires error wrapping, FR-019 requires map-based table tests"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "No command templates modified by this feature"
    - name: "Cross-Platform Compatibility (PRIN-008)"
      status: "PASS"
      notes: "NFR-004 requires macOS and Linux compatibility, pure Go implementation ensures this"

research_findings:
  decisions:
    - topic: "Terminal UI library for watch command"
      decision: "Use ANSI escape codes directly via fmt.Print with cursor positioning"
      rationale: "Avoids heavy dependencies like tcell/tview; cursor positioning is sufficient for table refresh"
      alternatives_considered:
        - "github.com/charmbracelet/bubbletea - too heavyweight for simple table"
        - "github.com/rivo/tview - unnecessary TUI complexity"
        - "github.com/jroimartin/gocui - abandoned, not actively maintained"
    - topic: "File watching mechanism for log tailing"
      decision: "Use fsnotify for cross-platform file system notifications"
      rationale: "Efficient inotify/kqueue backend, well-maintained, avoids polling"
      alternatives_considered:
        - "Poll-based with time.Ticker - higher CPU usage"
        - "Tail library (hpcloud/tail) - adds unnecessary dependency"
    - topic: "Run-ID format change"
      decision: "Keep existing format (YYYYMMDD_HHMMSS_uuid) for backward compatibility"
      rationale: "Existing runs use this format; changing would break dag watch/logs for old runs"
      alternatives_considered:
        - "dag-YYYYMMDD-HHMMSS - more readable but breaks existing runs"
        - "Human-readable aliases - additional complexity"
    - topic: "Keyboard input handling for watch exit"
      decision: "Use golang.org/x/term for raw mode keyboard reading"
      rationale: "Enables 'q' key detection without Enter; required for clean UX"
      alternatives_considered:
        - "Signal-only exit (Ctrl+C) - less intuitive"
        - "syscall direct - not cross-platform"
    - topic: "Log file timestamping"
      decision: "Prefix lines during write with [HH:MM:SS] format"
      rationale: "Simple format, grep-friendly, matches spec requirement"
      alternatives_considered:
        - "ISO 8601 timestamps - too verbose for terminal display"
        - "Unix epoch - not human readable"

data_model:
  entities:
    - name: "DAGRun"
      description: "Existing entity representing a single DAG workflow execution"
      fields:
        - name: "RunID"
          type: "string"
          description: "Unique identifier for the run"
          constraints: "Format: YYYYMMDD_HHMMSS_<uuid>"
        - name: "Status"
          type: "RunStatus"
          description: "Overall run status"
          constraints: "Enum: running, completed, failed, interrupted"
        - name: "Specs"
          type: "map[string]*SpecState"
          description: "Per-spec execution state"
          constraints: "Keyed by spec ID"
        - name: "StartedAt"
          type: "time.Time"
          description: "When the run began"
          constraints: "Required, set at creation"
      relationships:
        - target: "SpecState"
          type: "one-to-many"
          description: "A run contains multiple spec states"
    - name: "SpecState"
      description: "Existing entity tracking execution state of a single spec"
      fields:
        - name: "SpecID"
          type: "string"
          description: "Identifier from dag.yaml"
          constraints: "Must match spec directory name"
        - name: "Status"
          type: "SpecStatus"
          description: "Execution status"
          constraints: "Enum: pending, running, completed, failed, blocked"
        - name: "CurrentStage"
          type: "string"
          description: "Current workflow stage"
          constraints: "One of: specify, plan, tasks, implement"
        - name: "CurrentTask"
          type: "string"
          description: "Task progress in implement stage"
          constraints: "Format: current/total (e.g., 8/12)"
      relationships:
        - target: "Log File"
          type: "one-to-one"
          description: "Each spec has one log file per run"
    - name: "Log File"
      description: "Captured stdout/stderr from autospec subprocess"
      fields:
        - name: "Path"
          type: "string"
          description: "File system path"
          constraints: "Format: .autospec/state/dag-runs/<run-id>/logs/<spec-id>.log"
        - name: "Size"
          type: "int64"
          description: "Current file size in bytes"
          constraints: "Max size enforced via truncation"
        - name: "Truncated"
          type: "bool"
          description: "Whether file has been truncated"
          constraints: "[TRUNCATED] marker present if true"
      relationships: []

api_contracts: []

project_structure:
  documentation:
    - path: "docs/public/dag-watch-logs.md"
      description: "User documentation for watch, logs, and enhanced list commands"
  source_code:
    - path: "internal/cli/dag/watch.go"
      description: "Watch command implementation with auto-refresh table"
    - path: "internal/cli/dag/logs.go"
      description: "Logs command with tail-f streaming and --no-follow option"
    - path: "internal/cli/dag/list.go"
      description: "Enhanced list command with spec counts and relative timestamps"
    - path: "internal/dag/watcher.go"
      description: "Core watch functionality: terminal rendering, keyboard input, refresh loop"
    - path: "internal/dag/tailer.go"
      description: "Log file tailing with fsnotify integration"
    - path: "internal/dag/logwriter.go"
      description: "Timestamped log writer and truncation logic"
    - path: "internal/dag/runstate.go"
      description: "Existing file - add helper functions for latest run selection"
  tests:
    - path: "internal/cli/dag/watch_test.go"
      description: "Unit tests for watch command"
    - path: "internal/cli/dag/logs_test.go"
      description: "Unit tests for logs command"
    - path: "internal/cli/dag/list_test.go"
      description: "Enhanced tests for list command output format"
    - path: "internal/dag/watcher_test.go"
      description: "Unit tests for table rendering and keyboard handling"
    - path: "internal/dag/tailer_test.go"
      description: "Unit tests for log tailing with mock file system"
    - path: "internal/dag/logwriter_test.go"
      description: "Unit tests for timestamping and truncation"

implementation_phases:
  - phase: 1
    name: "Core log infrastructure"
    goal: "Implement timestamped log writing with size management"
    deliverables:
      - "TimestampedWriter that prefixes lines with [HH:MM:SS]"
      - "Log truncation when max size exceeded (oldest 20% removed)"
      - "Integration with existing CreateSpecOutput function"
      - "Unit tests with map-based table pattern"
  - phase: 2
    name: "Log tailing with streaming"
    goal: "Implement tail -f style log streaming for dag logs command"
    dependencies:
      - "Phase 1"
    deliverables:
      - "LogTailer struct with fsnotify-based file watching"
      - "dag logs CLI command with run-id and spec-id arguments"
      - "--no-follow flag for dump-and-exit mode"
      - "--latest flag for most recent run shortcut"
      - "Log file path printed at command start"
  - phase: 3
    name: "Watch table display"
    goal: "Implement live-updating status table with auto-refresh"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Watcher struct with terminal control for table rendering"
      - "Table columns: SPEC, STATUS, PROGRESS, DURATION, LAST UPDATE"
      - "Auto-refresh with configurable interval (default 2s)"
      - "Keyboard input handling for 'q' exit"
      - "SIGINT/SIGTERM cleanup for terminal state restoration"
  - phase: 4
    name: "Watch command integration"
    goal: "Wire up dag watch CLI command with watcher functionality"
    dependencies:
      - "Phase 3"
    deliverables:
      - "dag watch CLI command with optional run-id argument"
      - "Auto-select most recent active run when no run-id provided"
      - "--interval flag for refresh rate customization"
      - "Graceful exit with terminal state restoration"
  - phase: 5
    name: "Enhanced list command"
    goal: "Update dag list to show run-ids prominently with enhanced metadata"
    dependencies: []
    deliverables:
      - "Run-id as first column in output"
      - "SPECS column showing completed/total count"
      - "STARTED column with relative timestamps (e.g., '5 min ago')"
      - "Maintain color-coded status display"
  - phase: 6
    name: "Edge cases and polish"
    goal: "Handle edge cases, add configuration, validate quality gates"
    dependencies:
      - "Phase 2"
      - "Phase 4"
      - "Phase 5"
    deliverables:
      - "Error handling for missing runs, invalid spec-ids"
      - "Terminal resize handling (SIGWINCH)"
      - "Configuration for dag.max_log_size in config.yml"
      - "Documentation for all new commands"
      - "make test && make fmt && make lint && make build all pass"

open_questions:
  - question: "Should dag watch continue after all specs complete or exit automatically?"
    context: "Watch could stay running for monitoring completed state or exit to avoid idle process"
    proposed_resolution: "Continue watching until 'q' or Ctrl+C to allow reviewing final state"
  - question: "Should log truncation add [TRUNCATED] at the beginning or at the truncation point?"
    context: "Beginning marker is cleaner; inline marker shows where content was cut"
    proposed_resolution: "Add at beginning of file with timestamp of when truncation occurred"
  - question: "How to handle concurrent run-id collisions (two runs starting same second)?"
    context: "Current format includes uuid suffix which handles this, but spec mentions subsecond precision"
    proposed_resolution: "Keep existing uuid suffix format for uniqueness, no change needed"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.2"
  created: "2026-01-11T17:18:30Z"
  artifact_type: "plan"
