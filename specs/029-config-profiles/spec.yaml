feature:
  branch: "029-config-profiles"
  created: "2025-12-16"
  status: "Draft"
  input: "Add config profile system: 'autospec config profiles' (list), 'autospec config use NAME' (switch), 'autospec config create NAME' (create from current). Store in ~/.config/autospec/profiles/. Add global --profile flag to use specific profile for single command."

user_stories:
  - id: "US-001"
    title: "List available configuration profiles"
    priority: "P1"
    as_a: "developer using autospec across multiple projects"
    i_want: "to list all available configuration profiles"
    so_that: "I can see which profiles exist and choose between them"
    why_this_priority: "Fundamental capability needed to discover and manage profiles"
    independent_test: "Run command with no profiles, one profile, and multiple profiles - verify list output"
    acceptance_scenarios:
      - given: "no profiles exist"
        when: "user runs 'autospec config profiles'"
        then: "message indicates no profiles exist and shows how to create one"
      - given: "one or more profiles exist in ~/.config/autospec/profiles/"
        when: "user runs 'autospec config profiles'"
        then: "all profile names are listed, with the active profile marked"

  - id: "US-002"
    title: "Switch to a different configuration profile"
    priority: "P1"
    as_a: "developer working on different projects with different settings"
    i_want: "to switch the active configuration profile"
    so_that: "subsequent commands use the selected profile's settings"
    why_this_priority: "Core functionality for profile management"
    independent_test: "Create two profiles with different timeout values, switch between them, verify config show reflects changes"
    acceptance_scenarios:
      - given: "a profile named 'work' exists"
        when: "user runs 'autospec config use work'"
        then: "the active profile is set to 'work' and confirmation is shown"
      - given: "no profile named 'nonexistent' exists"
        when: "user runs 'autospec config use nonexistent'"
        then: "error message indicates profile does not exist and suggests 'autospec config profiles' to list available profiles"

  - id: "US-003"
    title: "Create a new configuration profile from current settings"
    priority: "P1"
    as_a: "developer who has customized autospec for a specific project"
    i_want: "to save the current configuration as a named profile"
    so_that: "I can reuse these settings later or share the approach"
    why_this_priority: "Essential for creating the profile library that other commands depend on"
    independent_test: "Configure custom settings, create profile, verify profile file contains expected values"
    acceptance_scenarios:
      - given: "current configuration has customized values"
        when: "user runs 'autospec config create myprofile'"
        then: "profile is saved to ~/.config/autospec/profiles/myprofile.yml with current effective settings"
      - given: "a profile named 'existing' already exists"
        when: "user runs 'autospec config create existing'"
        then: "error indicates profile exists and suggests using --force to overwrite"
      - given: "a profile named 'existing' already exists"
        when: "user runs 'autospec config create existing --force'"
        then: "profile is overwritten with current settings"

  - id: "US-004"
    title: "Use a specific profile for a single command"
    priority: "P1"
    as_a: "developer who needs to temporarily use different settings"
    i_want: "to use a specific profile for just one command"
    so_that: "I can test or run one-off commands without switching the active profile"
    why_this_priority: "Critical for flexibility and avoiding profile switching overhead"
    independent_test: "Set active profile A, run command with --profile B, verify B's settings were used, verify active profile is still A"
    acceptance_scenarios:
      - given: "profile 'fast' exists with timeout=60"
        when: "user runs any autospec command with '--profile fast'"
        then: "the command uses settings from 'fast' profile, but active profile remains unchanged"
      - given: "no profile named 'invalid' exists"
        when: "user runs any command with '--profile invalid'"
        then: "error message indicates profile does not exist"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST store profiles as individual YAML files in ~/.config/autospec/profiles/"
      testable: true
      acceptance_criteria: "Profile files are stored at ~/.config/autospec/profiles/<name>.yml"
    - id: "FR-002"
      description: "MUST persist the active profile selection across sessions"
      testable: true
      acceptance_criteria: "Active profile is stored in a state file and loaded on startup"
    - id: "FR-003"
      description: "MUST validate profile names to prevent filesystem issues"
      testable: true
      acceptance_criteria: "Profile names allow only alphanumeric characters, hyphens, and underscores; invalid names rejected with clear error"
    - id: "FR-004"
      description: "MUST apply --profile flag before other configuration sources in the priority chain"
      testable: true
      acceptance_criteria: "Priority order becomes: environment > --profile > project > user > defaults"
    - id: "FR-005"
      description: "SHOULD show which profile is active in 'config show' output"
      testable: true
      acceptance_criteria: "'autospec config show' displays active profile name in header comments"
    - id: "FR-006"
      description: "MUST create profiles directory automatically when first profile is created"
      testable: true
      acceptance_criteria: "Directory is created with appropriate permissions (0755)"
    - id: "FR-007"
      description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
      testable: true
      acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"

  non_functional:
    - id: "NFR-001"
      category: "code_quality"
      description: "All functions must be under 40 lines; extract helpers for complex logic"
      measurable_target: "No function exceeds 40 lines excluding comments"
    - id: "NFR-002"
      category: "code_quality"
      description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
      measurable_target: "Zero bare 'return err' statements in new code"
    - id: "NFR-003"
      category: "code_quality"
      description: "Tests must use map-based table-driven pattern with t.Parallel()"
      measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
    - id: "NFR-004"
      category: "code_quality"
      description: "Accept interfaces, return concrete types"
      measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
    - id: "NFR-005"
      category: "performance"
      description: "Profile loading must not add noticeable latency to command startup"
      measurable_target: "Profile loading completes in under 10ms"
    - id: "NFR-006"
      category: "usability"
      description: "Error messages must guide users toward resolution"
      measurable_target: "All error messages include actionable suggestions"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can create and switch between profiles to manage different configurations"
      metric: "Profile operations complete successfully"
      target: "100% success rate for valid profile operations"
    - id: "SC-002"
      description: "Users can use a profile for a single command without changing active profile"
      metric: "Commands with --profile flag use correct settings"
      target: "Correct profile settings applied 100% of the time"
    - id: "SC-003"
      description: "Profile system integrates seamlessly with existing config hierarchy"
      metric: "Existing config tests continue to pass"
      target: "Zero regression in existing configuration functionality"

key_entities:
  - name: "Profile"
    description: "A named configuration preset stored as a YAML file"
    attributes:
      - "name (unique identifier, used as filename)"
      - "configuration values (same schema as config.yml)"
      - "file location (~/.config/autospec/profiles/<name>.yml)"
  - name: "ActiveProfile"
    description: "Reference to the currently selected profile"
    attributes:
      - "profile name"
      - "persisted in state file for session continuity"
  - name: "ProfilesDirectory"
    description: "Directory containing all user-defined profiles"
    attributes:
      - "location (~/.config/autospec/profiles/)"
      - "created on demand when first profile is saved"

edge_cases:
  - scenario: "Profile file exists but is malformed YAML"
    expected_behavior: "Error message identifies the malformed file and suggests validation or removal"
  - scenario: "Profile directory is not writable"
    expected_behavior: "Clear error message explaining permission issue and required directory"
  - scenario: "Active profile file was deleted externally"
    expected_behavior: "Warning shown on next command, falls back to default configuration"
  - scenario: "Profile name conflicts with reserved words or special characters"
    expected_behavior: "Validation rejects name with explanation of allowed characters"
  - scenario: "Very long profile name exceeds filesystem limits"
    expected_behavior: "Validation rejects with maximum length guidance"
  - scenario: "--profile flag with empty or whitespace-only value"
    expected_behavior: "Error message indicates profile name is required"

assumptions:
  - "Users have write access to ~/.config/autospec/ directory"
  - "Profile files are small enough that synchronous file I/O is acceptable"
  - "Users will create a reasonable number of profiles (not thousands)"
  - "Profile names follow common naming conventions (alphanumeric, hyphen, underscore)"
  - "The XDG Base Directory Specification is followed on Linux systems"

constraints:
  - "Must maintain backward compatibility with existing config system"
  - "Must not break existing CLI flag behavior or config file precedence"
  - "Profile storage location is fixed at ~/.config/autospec/profiles/"
  - "State file for active profile must coexist with existing retry state"

out_of_scope:
  - "Profile import/export functionality"
  - "Profile sharing via remote repositories"
  - "Profile inheritance or composition"
  - "GUI or TUI for profile management"
  - "Automatic profile switching based on directory or project"
  - "Profile encryption or access control"
  - "Deleting or renaming profiles (can be done manually via filesystem)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T23:03:22Z"
  artifact_type: "spec"
