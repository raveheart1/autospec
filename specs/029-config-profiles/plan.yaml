plan:
  branch: "029-config-profiles"
  created: "2025-12-16"
  spec_path: "specs/029-config-profiles/spec.yaml"

summary: |
  This feature adds a profile management system to autospec, allowing users to save, switch,
  and reuse different configuration presets. The implementation extends the existing config
  package with profile support while maintaining full backward compatibility. Profiles are
  stored as individual YAML files in ~/.config/autospec/profiles/, with an active profile
  state persisted similarly to the existing retry state pattern. A new global --profile flag
  enables one-off profile usage without switching the active profile.

  Key technical decisions: leverage koanf for profile loading (consistent with existing config),
  store active profile state in ~/.config/autospec/state/active-profile.yaml (separate from
  retry state), and integrate the profile layer into the existing config priority chain between
  environment variables and project config.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework for config subcommands"
    - name: "github.com/knadh/koanf/v2"
      version: "v2.1.0"
      purpose: "Hierarchical config loading, profile YAML parsing"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML serialization for profile files"
  storage: "Filesystem (YAML files in ~/.config/autospec/profiles/)"
  testing:
    framework: "go test"
    approach: "Map-based table-driven unit tests with t.Parallel(); integration tests for profile loading priority"
  target_platform: "Linux, macOS, Windows (cross-platform via os.UserConfigDir)"
  project_type: "cli"
  performance_goals: "Profile loading <10ms per NFR-005"
  constraints:
    - "Must maintain backward compatibility with existing config system"
    - "Must not break existing CLI flag behavior or config file precedence"
    - "Profile storage location fixed at ~/.config/autospec/profiles/"
    - "State file for active profile must coexist with existing retry state"
  scale_scope: "Reasonable number of profiles (tens, not thousands)"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All new code will have tests written before implementation per map-based table-driven pattern"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "Not a workflow phase transition; profile operations are config management"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Profile loading targeted at <10ms; will add benchmark tests"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Profile operations are idempotent; create --force for overwrite, atomic writes for state"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Will use exit code 3 for invalid profile names, exit code 1 for profile not found"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "Profiles stored as YAML files in XDG-compliant paths"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "Will run make fmt and make lint before completion"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, map-based table tests, interface-in concrete-out"

research_findings:
  decisions:
    - topic: "Profile storage location"
      decision: "~/.config/autospec/profiles/<name>.yml"
      rationale: "Follows XDG Base Directory Specification, consistent with existing user config path"
      alternatives_considered:
        - "Store in ~/.autospec/profiles/ (inconsistent with new YAML config location)"
        - "Store profiles in a single profiles.yaml file (harder to manage, share, delete)"
    - topic: "Active profile state location"
      decision: "~/.config/autospec/state/active-profile.yaml"
      rationale: "Separates profile state from retry state; cleaner separation of concerns"
      alternatives_considered:
        - "Add to ~/.autospec/state/retry.json (mixes unrelated concerns)"
        - "Store in ~/.config/autospec/active-profile (simple but separate file)"
    - topic: "Config priority chain integration"
      decision: "Environment > --profile flag > project > user > defaults"
      rationale: "Per FR-004, --profile should override user config but not project or env config"
      alternatives_considered:
        - "Profile replaces user config entirely (loses layering benefit)"
        - "Profile at lowest priority (not useful for overriding defaults)"
    - topic: "Profile name validation pattern"
      decision: "Alphanumeric, hyphen, underscore only; max 64 characters"
      rationale: "Safe for all filesystems, prevents path traversal, reasonable length limit"
      alternatives_considered:
        - "Allow spaces (filesystem complications)"
        - "Allow dots (conflicts with .yml extension handling)"

data_model:
  entities:
    - name: "Profile"
      description: "A named configuration preset stored as a YAML file"
      fields:
        - name: "name"
          type: "string"
          description: "Unique identifier used as filename (without .yml extension)"
          constraints: "Alphanumeric, hyphen, underscore only; 1-64 characters"
        - name: "configuration"
          type: "map[string]interface{}"
          description: "Configuration values (same schema as config.yml)"
          constraints: "Must be valid autospec configuration"
        - name: "path"
          type: "string"
          description: "Full filesystem path to the profile file"
          constraints: "Derived from name: ~/.config/autospec/profiles/<name>.yml"
      relationships:
        - target: "ActiveProfileState"
          type: "one-to-one"
          description: "At most one profile is active at a time"
    - name: "ActiveProfileState"
      description: "Persistent reference to the currently selected profile"
      fields:
        - name: "profile_name"
          type: "string"
          description: "Name of the active profile"
          constraints: "Must correspond to an existing profile file"
        - name: "set_at"
          type: "time.Time"
          description: "Timestamp when the profile was activated"
          constraints: "UTC timestamp"
      relationships:
        - target: "Profile"
          type: "many-to-one"
          description: "References a profile by name"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/PROFILES.md"
      description: "User documentation for profile management (optional, may defer)"
  source_code:
    - path: "internal/config/profile.go"
      description: "Profile management: list, load, save, validate profile names"
    - path: "internal/config/profile_state.go"
      description: "Active profile state persistence: load, save, get, set"
    - path: "internal/cli/config.go"
      description: "Extended with 'profiles', 'use', 'create' subcommands"
    - path: "internal/cli/root.go"
      description: "Add global --profile flag"
  tests:
    - path: "internal/config/profile_test.go"
      description: "Unit tests for profile operations"
    - path: "internal/config/profile_state_test.go"
      description: "Unit tests for active profile state"
    - path: "internal/cli/config_test.go"
      description: "Integration tests for config profile subcommands"

implementation_phases:
  - phase: 1
    name: "Profile Core Infrastructure"
    goal: "Implement profile storage, loading, and validation without CLI integration"
    deliverables:
      - "internal/config/profile.go with profile CRUD operations"
      - "internal/config/profile_test.go with comprehensive unit tests"
      - "Profile name validation with clear error messages"
      - "ProfilesDir() helper function"
  - phase: 2
    name: "Active Profile State Management"
    goal: "Implement persistent active profile tracking"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/config/profile_state.go with state persistence"
      - "internal/config/profile_state_test.go with unit tests"
      - "Atomic write pattern for state file"
      - "Fallback behavior when active profile is deleted"
  - phase: 3
    name: "Config Loading Integration"
    goal: "Integrate profiles into the configuration loading chain"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "Updated LoadWithOptions to support profile loading"
      - "Profile layer inserted at correct priority position"
      - "Integration tests for config priority chain"
  - phase: 4
    name: "CLI Commands Implementation"
    goal: "Add CLI subcommands for profile management"
    dependencies:
      - "Phase 3"
    deliverables:
      - "'autospec config profiles' command"
      - "'autospec config use NAME' command"
      - "'autospec config create NAME' command with --force flag"
      - "Updated 'config show' to display active profile"
  - phase: 5
    name: "Global --profile Flag"
    goal: "Add global flag for one-off profile usage"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Global --profile flag on root command"
      - "LoadOptions.ProfileOverride field"
      - "Integration with all commands that load config"
  - phase: 6
    name: "Final Integration and Testing"
    goal: "End-to-end testing and quality gates"
    dependencies:
      - "Phase 5"
    deliverables:
      - "make test passes all tests"
      - "make fmt produces no changes"
      - "make lint passes with no errors"
      - "make build succeeds"

risks:
  - risk: "Profile loading adds latency to CLI startup"
    likelihood: "low"
    impact: "medium"
    mitigation: "Lazy load profiles only when needed; benchmark tests enforce <10ms"
  - risk: "Breaking existing config behavior"
    likelihood: "low"
    impact: "high"
    mitigation: "Comprehensive integration tests; profile layer is opt-in only"
  - risk: "State file corruption"
    likelihood: "low"
    impact: "medium"
    mitigation: "Atomic temp-file-rename pattern per existing retry state"
  - risk: "Cross-platform path issues"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Use filepath.Join and os.UserConfigDir; test on multiple platforms"

open_questions:
  - question: "Should profile deletion be in scope?"
    context: "Spec marks delete/rename as out of scope (manual filesystem operation)"
    proposed_resolution: "Keep out of scope; users can rm ~/.config/autospec/profiles/<name>.yml"
  - question: "What happens if --profile is used with an invalid profile?"
    context: "Error should be clear and actionable"
    proposed_resolution: "Exit with code 3 (invalid arguments), suggest 'autospec config profiles' to list available"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T23:39:18Z"
  artifact_type: "plan"
