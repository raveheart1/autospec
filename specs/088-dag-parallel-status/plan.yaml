plan:
  branch: "088-dag-parallel-status"
  created: "2026-01-11"
  spec_path: "specs/088-dag-parallel-status/spec.yaml"

summary: |
  This plan extends the existing sequential DAG executor (Spec 2) to support parallel spec
  execution with configurable concurrency limits. The implementation adds --parallel and
  --max-parallel flags to dag run, a new dag status command for monitoring, and comprehensive
  progress tracking with prefixed output.

  Key technical decisions:
  - Leverage existing ParallelExecutor pattern from internal/workflow/parallel_executor.go
  - Use errgroup with SetLimit for concurrency control (already a dependency)
  - Extend existing DAGRun state model with parallel-specific tracking fields
  - Build on PrefixedWriter from internal/dag/output.go for output multiplexing
  - Implement dag status as a new CLI subcommand reading from state files

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "golang.org/x/sync/errgroup"
      version: "latest"
      purpose: "Controlled concurrency with SetLimit for parallel spec execution"
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI framework for dag run flags and dag status command"
    - name: "github.com/fatih/color"
      version: "existing"
      purpose: "Colored terminal output for status display"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML state file persistence"
  storage: "YAML state files in .autospec/state/dag-runs/"
  testing:
    framework: "go test"
    approach: "Unit tests with mocks for executor, integration tests for CLI commands"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Parallel execution overhead < 10% of sequential time"
  constraints:
    - "Must build on existing sequential dag run from Spec 2"
    - "Cannot implement resume capability (deferred to Spec 4)"
    - "State saved within 2 seconds of SIGINT"
    - "No data races (go test -race must pass)"
  scale_scope: "Up to 20 concurrent specs per run"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests defined before implementation for each component"
    - name: "Validation-First Workflow"
      status: "PASS"
      notes: "Existing DAG validation runs before parallel execution begins"
    - name: "Performance Standards"
      status: "PASS"
      notes: "NFR-001 specifies <10% overhead target with benchmark tests"
    - name: "Idempotency and Retry Logic"
      status: "PASS"
      notes: "State persistence uses atomic temp file + rename pattern"
    - name: "Standardized Exit Codes"
      status: "PASS"
      notes: "Uses existing exit code constants from clierrors package"
    - name: "Go Coding Standards"
      status: "PASS"
      notes: "Functions <40 lines, errors wrapped with context, map-based tests"
    - name: "Command Template Independence"
      status: "N/A"
      notes: "No slash commands modified - pure Go implementation"

research_findings:
  decisions:
    - topic: "Concurrency control mechanism"
      decision: "Use errgroup with SetLimit for parallel spec execution"
      rationale: "Already used in ParallelExecutor for task-level parallelism; proven pattern in codebase"
      alternatives_considered:
        - "sync.WaitGroup with semaphore channel - more manual, less elegant"
        - "worker pool pattern - overkill for spec-level parallelism"

    - topic: "State model extension"
      decision: "Add running_count and progress fields to DAGRun state"
      rationale: "Minimal changes to existing state model; backward compatible"
      alternatives_considered:
        - "Separate parallel state file - adds complexity for state management"
        - "In-memory only tracking - loses progress on interruption"

    - topic: "Failure handling strategy"
      decision: "Default: continue running, mark dependents as blocked; optional --fail-fast"
      rationale: "Matches spec requirements; maximizes value from each run"
      alternatives_considered:
        - "Always fail-fast - wastes progress on independent specs"
        - "Retry failed specs automatically - scope creep, reserved for Spec 4"

    - topic: "Signal handling approach"
      decision: "Use context cancellation with graceful shutdown timeout"
      rationale: "Existing pattern in run.go setupSignalHandler; propagates to errgroup"
      alternatives_considered:
        - "Direct process kill - loses state"
        - "Per-spec signal handling - complex and fragile"

data_model:
  entities:
    - name: "DAGRun (extended)"
      description: "Existing entity extended with parallel execution tracking fields"
      fields:
        - name: "running_count"
          type: "int"
          description: "Current number of concurrently executing specs"
          constraints: "0 <= running_count <= max_parallel"
        - name: "progress"
          type: "string"
          description: "Current progress display (e.g., '2/5 specs complete')"
          constraints: "Computed from spec statuses"
        - name: "max_parallel"
          type: "int"
          description: "Configured maximum concurrent specs"
          constraints: ">= 1"
      relationships:
        - target: "SpecState"
          type: "one-to-many"
          description: "Contains execution state for each spec"

    - name: "SpecState (existing)"
      description: "Tracks individual spec execution within a run - no changes needed"
      fields: []
      relationships: []

    - name: "ParallelExecutor (new)"
      description: "Orchestrates concurrent spec execution with controlled parallelism"
      fields:
        - name: "max_parallel"
          type: "int"
          description: "Maximum concurrent specs allowed"
          constraints: ">= 1, default 4"
        - name: "errgroup"
          type: "*errgroup.Group"
          description: "Concurrency primitive with SetLimit"
          constraints: "Not persisted"
        - name: "running_specs"
          type: "map[string]struct{}"
          description: "Currently executing spec IDs"
          constraints: "Protected by mutex"
        - name: "fail_fast"
          type: "bool"
          description: "Whether to stop all on first failure"
          constraints: "From CLI flag"
      relationships:
        - target: "Executor"
          type: "composition"
          description: "Wraps or extends existing Executor"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/dag-parallel.md"
      description: "User documentation for parallel DAG execution and dag status command"
  source_code:
    - path: "internal/dag/parallel.go"
      description: "ParallelExecutor extending Executor with concurrent execution"
    - path: "internal/dag/progress.go"
      description: "Progress tracking and display utilities"
    - path: "internal/cli/dag/run.go"
      description: "Extended with --parallel and --max-parallel flags"
    - path: "internal/cli/dag/status.go"
      description: "New dag status command implementation"
  tests:
    - path: "internal/dag/parallel_test.go"
      description: "Unit tests for ParallelExecutor with mocked command runner"
    - path: "internal/dag/progress_test.go"
      description: "Unit tests for progress tracking"
    - path: "internal/cli/dag/status_test.go"
      description: "Unit tests for dag status command"

implementation_phases:
  - phase: 1
    name: "Parallel Executor Core"
    goal: "Implement concurrent spec execution with errgroup concurrency control"
    deliverables:
      - "ParallelExecutor struct wrapping Executor with errgroup integration"
      - "executeSpecsConcurrently method using errgroup.SetLimit"
      - "Running spec tracking with mutex-protected map"
      - "Unit tests with mock command runner verifying concurrency limits"

  - phase: 2
    name: "State and Progress Tracking"
    goal: "Extend state model for parallel execution and implement progress display"
    dependencies:
      - "Phase 1"
    deliverables:
      - "DAGRun state extended with running_count and progress fields"
      - "Progress rendering function (X/Y specs complete)"
      - "Real-time progress updates during execution"
      - "Unit tests for state updates and progress rendering"

  - phase: 3
    name: "Failure Handling"
    goal: "Implement default failure handling and --fail-fast option"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "Default behavior: mark dependents as blocked, continue others"
      - "fail_fast flag implementation with errgroup context cancellation"
      - "Blocked spec status propagation"
      - "Unit tests for failure scenarios"

  - phase: 4
    name: "Signal Handling and Graceful Shutdown"
    goal: "Implement SIGINT handling with state preservation"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Context cancellation propagation to running specs"
      - "Graceful shutdown with brief wait for cleanup"
      - "State saved within 2 seconds of signal"
      - "Unit tests for interruption scenarios"

  - phase: 5
    name: "CLI Integration"
    goal: "Add --parallel, --max-parallel flags and dag status command"
    dependencies:
      - "Phase 1"
      - "Phase 2"
      - "Phase 3"
      - "Phase 4"
    deliverables:
      - "dag run --parallel flag enabling concurrent execution"
      - "dag run --max-parallel N flag with validation (>= 1)"
      - "Default max_parallel=4 when --parallel specified alone"
      - "dag status [run-id] command showing categorized spec states"
      - "Unit and integration tests for CLI commands"

  - phase: 6
    name: "Quality and Documentation"
    goal: "Final testing, race detection, and documentation"
    dependencies:
      - "Phase 5"
    deliverables:
      - "make test && make fmt && make lint && make build all pass"
      - "go test -race passes with zero race conditions"
      - "User documentation for dag parallel execution"
      - "CHANGELOG entry for new features"

open_questions:
  - question: "Should max-parallel have an upper bound to prevent resource exhaustion?"
    context: "Allowing unlimited parallel specs could overwhelm system resources"
    proposed_resolution: "Warn but allow high values; user is responsible for resource management"

  - question: "Should dag status show live updates or one-shot output?"
    context: "Live updates would require terminal manipulation; one-shot is simpler"
    proposed_resolution: "Implement one-shot first; live updates could be added in Spec 5 watch mode"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.2"
  created: "2026-01-11T09:17:44Z"
  artifact_type: "plan"
