plan:
  branch: "101-e2e-mock-testing"
  created: "2026-01-16"
  spec_path: "specs/101-e2e-mock-testing/spec.yaml"

summary: |
  Implement end-to-end testing infrastructure for autospec CLI commands using a mock Claude binary.
  The approach leverages the existing mock-claude.sh script and testutil infrastructure, extending them
  with dedicated E2E test helpers and fixtures. Tests will be isolated via Go build tags (//go:build e2e)
  to prevent them from running during normal test cycles, while providing comprehensive coverage of all
  workflow stages (specify, plan, tasks, implement) without incurring API costs or risking real API calls.

  Key technical decisions: use shell script mock (already exists), PATH isolation for safety,
  temp directory isolation per test, and the existing testutil patterns for consistency.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/stretchr/testify"
      version: "v1.8+"
      purpose: "Test assertions and requirements"
    - name: "github.com/spf13/cobra"
      version: "v1.8+"
      purpose: "CLI framework being tested"
  storage: "None"
  testing:
    framework: "Go testing"
    approach: "E2E tests with mock Claude binary, isolated via build tags, using PATH manipulation for safety"
  target_platform: "Linux, macOS"
  project_type: "cli"
  performance_goals: "E2E test suite completes in under 30 seconds"
  constraints:
    - "Windows support out of scope"
    - "No real Claude API calls permitted"
    - "Must use //go:build e2e tag for isolation"
    - "Tests must be deterministic and parallelizable"
  scale_scope: "Single project CLI testing"

constitution_check:
  constitution_path: "CLAUDE.md"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Plan creates test infrastructure before any production code changes; tests define expected behavior"
    - name: "Validation-First"
      status: "PASS"
      notes: "E2E tests validate complete workflow transitions and artifact generation"
    - name: "Performance Standards"
      status: "PASS"
      notes: "30-second target for full E2E suite; individual tests should be fast with mock responses"
    - name: "Idempotency"
      status: "PASS"
      notes: "Each test uses isolated temp directories; tests can be run repeatedly without side effects"
    - name: "Command Template Independence"
      status: "N/A"
      notes: "This feature does not modify command templates"

research_findings:
  decisions:
    - topic: "Mock Claude implementation"
      decision: "Use existing mocks/scripts/mock-claude.sh"
      rationale: "Already exists, well-tested, supports stage detection and artifact generation"
      alternatives_considered:
        - "Create Go-based mock binary"
        - "Use httptest server to mock API"
    - topic: "Test isolation approach"
      decision: "PATH isolation with temp directories"
      rationale: "Prevents any possibility of real claude invocation; existing testutil.GitIsolation provides good patterns"
      alternatives_considered:
        - "Environment variable toggle"
        - "Dependency injection only"
    - topic: "Build tag strategy"
      decision: "Use //go:build e2e tag"
      rationale: "Standard Go practice; matches existing integration tag pattern in tests/integration/"
      alternatives_considered:
        - "Separate test binary"
        - "Runtime skip conditions"
    - topic: "Test directory structure"
      decision: "Create tests/e2e/ directory"
      rationale: "Follows existing pattern with tests/integration/; clear separation of test types"
      alternatives_considered:
        - "Add to internal package tests"
        - "Create separate e2e module"
    - topic: "E2E helper location"
      decision: "Add E2EEnv to internal/testutil/"
      rationale: "Centralizes test utilities; consistent with existing helpers like GitIsolation and MockExecutor"
      alternatives_considered:
        - "Create tests/e2e/helpers/"
        - "Inline in test files"

data_model:
  entities:
    - name: "E2EEnv"
      description: "Test environment manager that provides isolated execution context for E2E tests"
      fields:
        - name: "t"
          type: "*testing.T"
          description: "Test context for cleanup and logging"
          constraints: "Required, not nil"
        - name: "tempDir"
          type: "string"
          description: "Root temporary directory for test isolation"
          constraints: "Created fresh per test"
        - name: "specsDir"
          type: "string"
          description: "Directory for spec artifacts"
          constraints: "Subdirectory of tempDir"
        - name: "binDir"
          type: "string"
          description: "Directory containing mock claude and autospec binaries"
          constraints: "Added to PATH"
        - name: "originalPath"
          type: "string"
          description: "Original PATH for restoration"
          constraints: "Captured on setup"
        - name: "originalEnv"
          type: "map[string]string"
          description: "Original environment variables for restoration"
          constraints: "Captures ANTHROPIC_API_KEY and similar"
      relationships:
        - target: "MockClaude"
          type: "one-to-one"
          description: "E2EEnv configures and invokes the mock claude script"
    - name: "CommandResult"
      description: "Captures the result of running an autospec command"
      fields:
        - name: "ExitCode"
          type: "int"
          description: "Command exit code"
          constraints: "0 for success, non-zero for errors"
        - name: "Stdout"
          type: "string"
          description: "Standard output content"
          constraints: "May be empty"
        - name: "Stderr"
          type: "string"
          description: "Standard error content"
          constraints: "Contains error messages on failure"
        - name: "Duration"
          type: "time.Duration"
          description: "Command execution time"
          constraints: "Used for performance validation"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "mocks/README.md"
      description: "Documentation for mock infrastructure (already exists, may need updates)"
  source_code:
    - path: "internal/testutil/e2e.go"
      description: "E2EEnv helper struct and setup functions"
    - path: "mocks/scripts/mock-claude.sh"
      description: "Mock Claude script (already exists)"
  tests:
    - path: "tests/e2e/"
      description: "E2E test directory"
    - path: "tests/e2e/stage_test.go"
      description: "Individual stage tests (specify, plan, tasks, implement)"
    - path: "tests/e2e/workflow_test.go"
      description: "Multi-stage workflow tests (prep, run)"
    - path: "tests/e2e/error_test.go"
      description: "Error handling tests (missing prereqs, mock failures)"
    - path: "testdata/e2e/responses/"
      description: "YAML response fixtures for mock claude"

implementation_phases:
  - phase: 1
    name: "E2E Test Infrastructure"
    goal: "Create the foundational test environment setup and helper utilities"
    deliverables:
      - "E2EEnv struct in internal/testutil/e2e.go with setup and cleanup"
      - "PATH isolation implementation"
      - "Autospec binary building during test setup"
      - "Environment sanitization (remove ANTHROPIC_API_KEY)"
  - phase: 2
    name: "Response Fixtures"
    goal: "Create valid YAML response fixtures for each workflow stage"
    dependencies:
      - "Phase 1"
    deliverables:
      - "testdata/e2e/responses/spec.yaml"
      - "testdata/e2e/responses/plan.yaml"
      - "testdata/e2e/responses/tasks.yaml"
      - "testdata/e2e/responses/constitution.yaml"
      - "testdata/e2e/responses/implement.txt"
  - phase: 3
    name: "Individual Stage Tests"
    goal: "Implement E2E tests for each workflow stage in isolation"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "TestE2E_Specify in tests/e2e/stage_test.go"
      - "TestE2E_Plan in tests/e2e/stage_test.go"
      - "TestE2E_Tasks in tests/e2e/stage_test.go"
      - "TestE2E_Implement in tests/e2e/stage_test.go"
  - phase: 4
    name: "Workflow Tests"
    goal: "Implement E2E tests for multi-stage workflows"
    dependencies:
      - "Phase 3"
    deliverables:
      - "TestE2E_PrepWorkflow in tests/e2e/workflow_test.go"
      - "TestE2E_FullWorkflow in tests/e2e/workflow_test.go"
  - phase: 5
    name: "Error Handling Tests"
    goal: "Implement E2E tests for error conditions and edge cases"
    dependencies:
      - "Phase 3"
    deliverables:
      - "TestE2E_MissingConstitution in tests/e2e/error_test.go"
      - "TestE2E_MissingPrereq in tests/e2e/error_test.go"
      - "TestE2E_MockFailure in tests/e2e/error_test.go"
  - phase: 6
    name: "Validation and Documentation"
    goal: "Verify all tests pass and update documentation"
    dependencies:
      - "Phase 4"
      - "Phase 5"
    deliverables:
      - "All E2E tests pass with go test -tags=e2e ./tests/e2e/..."
      - "make test && make fmt && make lint && make build passes"
      - "Update mocks/README.md with E2E test instructions"

risks:
  - risk: "Mock claude may not accurately simulate real claude behavior"
    likelihood: "low"
    impact: "medium"
    mitigation: "Mock already exists and is tested; focus on artifact generation which is deterministic"
  - risk: "PATH isolation may not work identically on all platforms"
    likelihood: "medium"
    impact: "low"
    mitigation: "Test on both Linux and macOS; document any platform-specific behavior"
  - risk: "Building autospec binary during tests adds overhead"
    likelihood: "high"
    impact: "low"
    mitigation: "Cache binary per test session; use t.TempDir() caching; accept tradeoff for true E2E testing"

open_questions:
  - question: "Should E2E tests build autospec fresh or use installed binary?"
    context: "Fresh build ensures testing current code; installed binary is faster but may be stale"
    proposed_resolution: "Build fresh during test setup, cache per test session using sync.Once"
  - question: "How to handle parallel E2E test execution?"
    context: "Parallel tests need truly isolated environments to avoid conflicts"
    proposed_resolution: "Each test gets unique temp directory; document that t.Parallel() is safe"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.9.0"
  created: "2026-01-16T10:17:28Z"
  artifact_type: "plan"
