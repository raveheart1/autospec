plan:
  branch: "038-test-coverage-85"
  created: "2025-12-17"
  spec_path: "specs/038-test-coverage-85/spec.yaml"

summary: |
  This plan systematically addresses test coverage gaps across all internal packages to meet
  the 85% minimum threshold (90% for critical packages). The approach prioritizes packages
  with the largest coverage deficits first: workflow (37.6%), completion (48.8%), notify
  (56.9%), commands (58.1%), git (63.6%), validation (65.1%), yaml (66.2%), spec (77.8%),
  and config (79.7%). Tests will use Go's native testing package with map-based table-driven
  patterns and t.Parallel() for parallel execution. Mocking strategies will be employed for
  external dependencies (file system, git CLI, notification systems) to ensure deterministic,
  fast-running tests.

technical_context:
  language: "Go 1.21+"
  framework: "None"
  primary_dependencies:
    - name: "testing"
      version: "standard library"
      purpose: "Native Go testing framework"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for test fixtures"
  storage: "None"
  testing:
    framework: "Go testing package"
    approach: |
      Unit tests with table-driven patterns, parallel execution via t.Parallel(),
      mocking external dependencies, temp directories for file system tests,
      interface-based dependency injection for testability
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Test suite completes within 60 seconds; no test flakiness"
  constraints:
    - "Must use Go's native testing package"
    - "Must not break existing tests"
    - "Tests must be deterministic and not flaky"
    - "Must be runnable in CI without special setup"
  scale_scope: "Unit test coverage for ~20 internal packages"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "This feature is explicitly about writing tests; all new code is test code"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "Not applicable - this is a test coverage improvement, not workflow change"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "NFR-005 requires test suite to complete within 60 seconds"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "All tests use map-based table-driven pattern with t.Parallel()"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "FR-013 requires make fmt to pass"

research_findings:
  decisions:
    - topic: "Testing approach for workflow package (37.6% -> 90%)"
      decision: "Use interface-based mocking for ClaudeExecutor and file system operations"
      rationale: "Workflow package has heavy external dependencies; interfaces enable isolated unit testing"
      alternatives_considered:
        - "Integration tests with real Claude CLI (too slow, non-deterministic)"
        - "Stubbing at OS level (too fragile, platform-specific)"
    - topic: "Testing approach for notify package (56.9% -> 85%)"
      decision: "Mock notification senders, test handler logic independently"
      rationale: "Notification sending involves OS-specific behavior; mocking allows cross-platform testing"
      alternatives_considered:
        - "Skip platform-specific code (would leave coverage gaps)"
        - "Use build tags for platform tests (too complex for coverage goals)"
    - topic: "Testing approach for completion package (48.8% -> 85%)"
      decision: "Test shell detection and RC file manipulation with temp directories"
      rationale: "File-based operations can be tested with t.TempDir()"
      alternatives_considered:
        - "Mock file system entirely (over-engineering for this use case)"
    - topic: "Coverage measurement tool"
      decision: "Use go test -cover with -coverprofile for detailed analysis"
      rationale: "Standard Go tooling, already in use, provides function-level detail"
      alternatives_considered:
        - "Third-party coverage tools (unnecessary complexity)"

data_model:
  entities:
    - name: "Test Case"
      description: "A single test scenario in a table-driven test"
      fields:
        - name: "name"
          type: "string (map key)"
          description: "Descriptive test case name"
          constraints: "Must be unique within test function"
        - name: "input"
          type: "varies"
          description: "Input values for the function under test"
          constraints: "Type-specific to function being tested"
        - name: "want"
          type: "varies"
          description: "Expected output or state"
          constraints: "Must be comparable"
        - name: "wantErr"
          type: "bool"
          description: "Whether an error is expected"
          constraints: "Optional, defaults to false"
      relationships:
        - target: "Test Function"
          type: "many-to-one"
          description: "Test cases belong to a test function"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "specs/038-test-coverage-85/spec.yaml"
      description: "Feature specification"
    - path: "specs/038-test-coverage-85/plan.yaml"
      description: "Implementation plan (this file)"
    - path: "specs/038-test-coverage-85/tasks.yaml"
      description: "Task breakdown (to be generated)"
  source_code:
    - path: "internal/*/*.go"
      description: "Production code (existing, no changes expected)"
  tests:
    - path: "internal/workflow/*_test.go"
      description: "Workflow package tests (major additions)"
    - path: "internal/completion/*_test.go"
      description: "Completion package tests (additions)"
    - path: "internal/notify/*_test.go"
      description: "Notification package tests (additions)"
    - path: "internal/commands/*_test.go"
      description: "Commands package tests (additions)"
    - path: "internal/git/*_test.go"
      description: "Git package tests (additions)"
    - path: "internal/validation/*_test.go"
      description: "Validation package tests (additions for 90% target)"
    - path: "internal/yaml/*_test.go"
      description: "YAML package tests (additions)"
    - path: "internal/spec/*_test.go"
      description: "Spec package tests (additions)"
    - path: "internal/config/*_test.go"
      description: "Config package tests (additions for 90% target)"

implementation_phases:
  - phase: 1
    name: "Critical Package Coverage - Workflow"
    goal: "Bring workflow package from 37.6% to 90%"
    deliverables:
      - "Tests for workflow.go (ExecuteAll, ExecuteSpecify, ExecutePlan, ExecuteTasks, ExecuteImplement methods)"
      - "Tests for executor.go (handleExecutionFailure, startProgressDisplay, completeStageSuccessNoNotify)"
      - "Tests for preflight.go (CheckArtifactDependencies, validateStageOrder)"
      - "Tests for phase_context.go (WriteContextFile, CleanupContextFile, GetContextFilePath)"
      - "Tests for claude.go (ExecuteSpecKitCommand)"

  - phase: 2
    name: "Low Coverage Packages - Completion & Notify"
    goal: "Bring completion (48.8% -> 85%) and notify (56.9% -> 85%)"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Tests for completion/install.go (Install, installFish, installRCFile, generateCompletionScript)"
      - "Tests for completion/shells.go (edge cases for getPowerShellProfilePath)"
      - "Tests for notify/handler.go (OnCommandComplete, OnStageComplete, OnError)"
      - "Tests for notify/sender_linux.go (SendVisual, SendSound, hasDisplay)"

  - phase: 3
    name: "Medium Coverage Packages - Commands, Git, Validation"
    goal: "Bring commands (58.1% -> 85%), git (63.6% -> 85%), validation (65.1% -> 90%)"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Tests for commands/embed.go (GetTemplateByFilename, IsAutospecTemplate)"
      - "Tests for commands/templates.go (GetInstalledCommands, GetDefaultCommandsDir, CommandExists, GetAutospecCommandNames)"
      - "Tests for git/git.go (CreateBranch, edge cases for parseBranchLine, addBranchWithDedup)"
      - "Tests for validation/artifact_analysis.go (all functions currently at 0%)"
      - "Tests for validation/artifact_checklist.go (all functions currently at 0%)"
      - "Tests for validation/artifact_constitution.go (all functions currently at 0%)"
      - "Tests for validation/artifact.go (Error, FormatFull, HasErrors, Type, nodeKindToString, getRootMapping)"

  - phase: 4
    name: "Higher Coverage Packages - YAML, Spec, Config"
    goal: "Bring yaml (66.2% -> 85%), spec (77.8% -> 85%), config (79.7% -> 90%)"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Tests for yaml/meta.go (ExtractMetaFromBytes, GetArtifactType, IsValidArtifactType)"
      - "Tests for yaml/migrate.go (parseChecklistMarkdown, parseAnalysisMarkdown, parseConstitutionMarkdown, MigrateDirectory)"
      - "Tests for yaml/validator.go (ValidateFile, Error, ValidateFileWithDetails)"
      - "Tests for spec/spec.go (GetSpecMetadata, FormatInfo)"
      - "Tests for spec/branch.go (TruncateBranchName edge cases)"
      - "Tests for config/migrate.go (MigrateUserConfig, MigrateProjectConfig)"
      - "Tests for config/defaults.go (GetDefaultConfigTemplate)"
      - "Tests for config/validate.go (validateNotificationConfig edge cases)"

  - phase: 5
    name: "Quality Gates & Final Verification"
    goal: "Verify all thresholds met, ensure test quality, pass all make targets"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Run full test suite and verify coverage thresholds"
      - "Verify no test flakiness (10 consecutive runs)"
      - "Pass make test, make fmt, make lint, make build"
      - "Generate final coverage report"

risks:
  - risk: "External dependency mocking complexity in workflow package"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Use interface-based dependency injection; create test helpers for common mock setups"

  - risk: "Platform-specific code in notify/completion packages may be hard to test"
    likelihood: "medium"
    impact: "low"
    mitigation: "Focus on testable logic paths; document any excluded platform-specific branches"

  - risk: "Test execution time may exceed 60 second target"
    likelihood: "low"
    impact: "medium"
    mitigation: "Use t.Parallel() extensively; avoid slow operations; use t.TempDir() over real FS"

  - risk: "Achieving 90% in workflow package may require refactoring"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Plan allows for minor refactoring to improve testability if needed"

  - risk: "Test flakiness due to race conditions"
    likelihood: "low"
    impact: "high"
    mitigation: "Run tests with -race flag during development; avoid shared state"

open_questions:
  - question: "Should platform-specific notification sender code (SendVisual, SendSound) be excluded from coverage requirements?"
    context: "These functions interact directly with OS notification systems and are difficult to test without the actual platform"
    proposed_resolution: "Aim for 85% in notify package overall; document any platform-specific exclusions"

  - question: "How should the workflow package's Claude CLI execution be mocked?"
    context: "The ExecuteSpecKitCommand and StreamCommand functions spawn real processes"
    proposed_resolution: "Use interface-based ClaudeExecutor mock that returns predefined outputs for different scenarios"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-17T20:05:03Z"
  artifact_type: "plan"
