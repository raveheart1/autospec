plan:
  branch: "049-phase-context-meta"
  created: "2025-12-18"
  spec_path: "specs/049-phase-context-meta/spec.yaml"

summary: |
  This implementation adds machine-readable metadata to phase context files to reduce redundant
  artifact reads during Claude agent implementation sessions. The core change adds a ContextMeta
  struct to PhaseContext with fields signaling that spec/plan/tasks are bundled, whether checklists
  exist, and explicit paths to skip. BuildPhaseContext will populate this metadata, including a
  directory existence check for checklists/. The implement.md template will be updated to document
  proper _context_meta usage, instructing Claude to honor these signals and avoid redundant reads.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3"
      purpose: "YAML serialization/deserialization of phase context files"
    - name: "github.com/spf13/cobra"
      version: "v1.8"
      purpose: "CLI command framework"
  storage: "YAML files in specs/<feature>/ directories"
  testing:
    framework: "go test with testify"
    approach: "Map-based table-driven unit tests with t.Parallel(); existing integration tests"
  target_platform: "linux/darwin/windows (cross-platform)"
  project_type: "cli"
  performance_goals: "Checklists directory existence check <1ms; validation functions <10ms"
  constraints:
    - "Backward compatible - existing phase contexts without _context_meta must continue to work"
    - "YAML underscore-prefixed keys must serialize correctly"
    - "Functions must be under 40 lines"
    - "Errors must be wrapped with context"
  scale_scope: "Single feature at a time; phase contexts are regenerated per phase execution"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Tests will be written before implementation per the constitution requirement"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "Phase context generation already validates artifact existence; metadata adds signals not validation"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "os.Stat for directory check is sub-millisecond; no validation function changes"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Phase context regeneration remains idempotent; metadata is derived from current state"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "ContextMeta is serialized as YAML with proper struct tags"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "New code will follow <40 line functions, error wrapping, map-based table tests"

research_findings:
  decisions:
    - topic: "ContextMeta struct placement"
      decision: "Define ContextMeta struct in phase_context.go alongside PhaseContext"
      rationale: "Co-location with PhaseContext keeps related types together; no separate types.go needed"
      alternatives_considered:
        - "Define in separate types.go file"
        - "Define inline as nested struct in PhaseContext"
    - topic: "YAML key naming convention"
      decision: "Use underscore prefix (_context_meta) for metadata section"
      rationale: "Underscore prefix clearly signals meta/internal field; consistent with existing _meta pattern in other artifacts"
      alternatives_considered:
        - "context_meta without underscore"
        - "meta or metadata as key name"
    - topic: "Checklists directory check location"
      decision: "Check directory existence in BuildPhaseContext before returning"
      rationale: "BuildPhaseContext has access to specDir; check happens once per phase context build"
      alternatives_considered:
        - "Check in WriteContextFile"
        - "Add separate method CheckChecklistsExist"
    - topic: "ContextMeta field ordering in YAML output"
      decision: "ContextMeta field placed first in PhaseContext struct for YAML ordering"
      rationale: "YAML serialization follows struct field order; placing first ensures _context_meta appears at top"
      alternatives_considered:
        - "Custom YAML marshaler to control order"
        - "Post-process YAML to reorder"

data_model:
  entities:
    - name: "ContextMeta"
      description: "Metadata structure embedded in phase context to signal file reading behavior"
      fields:
        - name: "PhaseArtifactsBundled"
          type: "bool"
          description: "Signals that spec, plan, tasks are bundled in this file"
          constraints: "Always true for generated phase contexts"
        - name: "BundledArtifacts"
          type: "[]string"
          description: "List of bundled artifact names for reference"
          constraints: "Static list: spec.yaml, plan.yaml, tasks.yaml (phase-filtered)"
        - name: "HasChecklists"
          type: "bool"
          description: "Whether checklists/ directory exists under spec directory"
          constraints: "True only if directory exists and is a directory (not file)"
        - name: "SkipReads"
          type: "[]string"
          description: "Explicit paths that should not be read separately"
          constraints: "Contains spec.yaml, plan.yaml, tasks.yaml paths relative to project root"
      relationships: []
    - name: "PhaseContext (modified)"
      description: "Existing struct that bundles spec, plan, and phase-filtered tasks"
      fields:
        - name: "ContextMeta"
          type: "ContextMeta"
          description: "New metadata field added to signal bundling"
          constraints: "YAML tag '_context_meta'; placed first for YAML ordering"
      relationships:
        - target: "ContextMeta"
          type: "composition"
          description: "PhaseContext embeds ContextMeta as a field"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "internal/commands/autospec.implement.md"
      description: "Implementation template - add Phase Context Metadata section"
  source_code:
    - path: "internal/workflow/phase_context.go"
      description: "Add ContextMeta struct; modify PhaseContext struct; update BuildPhaseContext"
  tests:
    - path: "internal/workflow/phase_context_test.go"
      description: "Add tests for ContextMeta population, YAML serialization, checklists detection"

implementation_phases:
  - phase: 1
    name: "Add ContextMeta Struct and Type Definitions"
    goal: "Define ContextMeta struct and add it to PhaseContext"
    deliverables:
      - "ContextMeta struct with YAML tags in phase_context.go"
      - "PhaseContext struct updated with ContextMeta field (first position)"
      - "Unit tests verifying struct definitions and YAML serialization"
  - phase: 2
    name: "Implement Metadata Population"
    goal: "Populate ContextMeta in BuildPhaseContext with actual values"
    dependencies:
      - "Phase 1"
    deliverables:
      - "BuildPhaseContext populates PhaseArtifactsBundled as true"
      - "BuildPhaseContext populates BundledArtifacts with static list"
      - "BuildPhaseContext checks checklists/ directory and sets HasChecklists"
      - "BuildPhaseContext populates SkipReads with actual artifact paths"
      - "Helper function for checklists directory check (if needed for line count)"
      - "Unit tests for all population scenarios"
  - phase: 3
    name: "Update Documentation"
    goal: "Document _context_meta usage in implement.md template"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "Phase Context Metadata section added to implement.md"
      - "Documentation explains each _context_meta field"
      - "Explicit instruction to NOT read files in skip_reads"
  - phase: 4
    name: "Integration Testing and Polish"
    goal: "Verify end-to-end functionality and backward compatibility"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "Integration tests for phase context generation with metadata"
      - "Verify existing tests pass (backward compatibility)"
      - "make test, make fmt, make lint, make build all pass"

risks:
  - risk: "YAML field ordering may not be guaranteed"
    likelihood: "low"
    impact: "low"
    mitigation: "gopkg.in/yaml.v3 preserves struct field order; place ContextMeta first in PhaseContext"
  - risk: "Claude agents may ignore _context_meta despite documentation"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Clear, explicit documentation in implement.md; out of scope to validate Claude behavior"
  - risk: "os.Stat may have platform-specific behavior"
    likelihood: "low"
    impact: "low"
    mitigation: "Standard library os.Stat is cross-platform; test on CI matrix"

open_questions:
  - question: "Should _context_meta include phase number for context?"
    context: "Phase number is already in PhaseContext.Phase field"
    proposed_resolution: "No duplication needed; _context_meta focuses on bundling signals"
  - question: "Should skip_reads paths be absolute or relative?"
    context: "Claude agents typically work from project root"
    proposed_resolution: "Use relative paths from project root (e.g., specs/feature/spec.yaml)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-18T07:45:02Z"
  artifact_type: "plan"
