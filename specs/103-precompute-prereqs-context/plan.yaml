plan:
  branch: "103-precompute-prereqs-context"
  created: "2026-01-16"
  spec_path: "specs/103-precompute-prereqs-context/spec.yaml"

summary: |
  This implementation introduces pre-computed prereqs context injection for slash commands,
  eliminating the need for agents to run bash commands to obtain feature paths and metadata.

  The approach extracts the existing PrereqsOutput logic from the CLI command into a reusable
  function, creates a new template rendering layer using Go's text/template package, and updates
  all affected command markdown files to use template variables ({{.FeatureDir}}, {{.SpecPath}}, etc.)
  instead of bash prereqs calls. Template rendering occurs during command installation or at
  invocation time, ensuring agents receive fully-resolved paths without any bash overhead.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "text/template"
      version: "stdlib"
      purpose: "Template variable substitution in command markdown files"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for prereqs output and command frontmatter"
    - name: "github.com/spf13/cobra"
      version: "v1.8.1"
      purpose: "CLI framework for command handling"
  storage: "None"
  testing:
    framework: "Go testing package"
    approach: "Unit tests with map-based table tests, integration tests for template rendering"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Pre-computed context injection adds less than 50ms to command startup"
  constraints:
    - "Must maintain command template independence - no MCP tools or autospec-internal paths in templates"
    - "Must not break existing workflows or custom user command files"
    - "Must work with existing agent presets (Claude, OpenCode)"
    - "Template rendering must happen in Go code, not in the agent"
  scale_scope: "Single-user CLI tool, 7 command files to migrate"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests will be written for PrereqsContext computation, template rendering, and command migration"
    - name: "Idiomatic Go"
      status: "PASS"
      notes: "Using stdlib text/template, error wrapping with fmt.Errorf, map-based table tests"
    - name: "Performance Standards"
      status: "PASS"
      notes: "NFR-001 requires <50ms latency; prereqs computation is lightweight file stat operations"
    - name: "Idempotent Operations"
      status: "PASS"
      notes: "Template rendering is stateless and idempotent; same inputs produce same outputs"
    - name: "Validation-First Workflow"
      status: "PASS"
      notes: "Template rendering validates required variables before substitution"
    - name: "Command Template Independence"
      status: "PASS"
      notes: "Template variables abstract paths; no hardcoded internal paths in command files"
    - name: "Actionable Errors"
      status: "PASS"
      notes: "Template rendering failures will include clear error messages with missing variable names"
    - name: "Schema-Driven Artifacts"
      status: "N/A"
      notes: "This feature does not introduce new YAML artifacts"

research_findings:
  decisions:
    - topic: "Template variable syntax"
      decision: "Use Go text/template syntax: {{.VariableName}}"
      rationale: "Go's text/template is already used in internal/cliagent/custom.go for custom agent templates; consistent with Go ecosystem"
      alternatives_considered:
        - "$VARIABLE_NAME shell-style variables"
        - "{{VARIABLE}} without dot prefix"
        - "Handlebars-style {{variable}}"
    - topic: "Where to perform template rendering"
      decision: "Render templates during slash command invocation, not during installation"
      rationale: "Dynamic rendering allows context-specific values (current feature, timestamp) without reinstalling commands"
      alternatives_considered:
        - "Render during InstallTemplates (static, would require reinstall for each feature)"
        - "Render in agent after slash command load"
    - topic: "How to inject context into agent prompts"
      decision: "Inject rendered markdown directly via prompt argument to agent"
      rationale: "Agents already receive slash commands as prompt content; rendering happens before passing to agent"
      alternatives_considered:
        - "Environment variables passed to agent subprocess"
        - "Separate context file read by agent"
    - topic: "Error handling for missing template variables"
      decision: "Fail with clear error message when required variable is missing"
      rationale: "Follows Actionable Errors constitution principle; prevents agents from receiving incomplete context"
      alternatives_considered:
        - "Silent empty string substitution"
        - "Default fallback values"
    - topic: "Backward compatibility for bash prereqs pattern"
      decision: "Keep autospec prereqs CLI command functional; old commands continue to work"
      rationale: "Allows gradual migration and supports custom user command files"
      alternatives_considered:
        - "Remove prereqs CLI entirely"
        - "Mark prereqs as deprecated with warnings"

data_model:
  entities:
    - name: "PrereqsContext"
      description: "Pre-computed context data for template rendering in slash commands"
      fields:
        - name: "FeatureDir"
          type: "string"
          description: "Path to the feature directory (e.g., specs/103-feature-name)"
          constraints: "Required for spec/plan/tasks/implement/checklist/clarify/analyze commands"
        - name: "FeatureSpec"
          type: "string"
          description: "Path to spec.yaml file"
          constraints: "Required when --require-spec is implicit"
        - name: "ImplPlan"
          type: "string"
          description: "Path to plan.yaml file"
          constraints: "Required for tasks/implement commands"
        - name: "TasksFile"
          type: "string"
          description: "Path to tasks.yaml file"
          constraints: "Required for implement command"
        - name: "AutospecVersion"
          type: "string"
          description: "Current autospec version string (e.g., 'autospec 0.9.0')"
          constraints: "Always available"
        - name: "CreatedDate"
          type: "string"
          description: "ISO 8601 timestamp for artifact creation"
          constraints: "Always available, generated at render time"
        - name: "IsGitRepo"
          type: "bool"
          description: "Whether current directory is in a git repository"
          constraints: "Always available"
        - name: "AvailableDocs"
          type: "[]string"
          description: "List of available artifact files in feature directory"
          constraints: "Optional, for informational display"
      relationships:
        - target: "CommandTemplate"
          type: "one-to-many"
          description: "PrereqsContext is used to render multiple CommandTemplates"

    - name: "CommandTemplate"
      description: "A slash command markdown file with template variable placeholders"
      fields:
        - name: "Name"
          type: "string"
          description: "Command name without extension (e.g., 'autospec.plan')"
          constraints: "Must match embedded template name"
        - name: "Content"
          type: "[]byte"
          description: "Raw markdown content with template placeholders"
          constraints: "Must be valid markdown with optional Go template syntax"
        - name: "RequiredVars"
          type: "[]string"
          description: "List of template variables this command requires"
          constraints: "Derived from command type (e.g., plan requires FeatureSpec)"
      relationships:
        - target: "PrereqsContext"
          type: "many-to-one"
          description: "Each command template is rendered with a single PrereqsContext"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/internal/template-rendering.md"
      description: "Internal documentation for template variable system (if complexity warrants)"
  source_code:
    - path: "internal/prereqs/context.go"
      description: "PrereqsContext struct and ComputeContext function extracted from CLI"
    - path: "internal/prereqs/context_test.go"
      description: "Unit tests for PrereqsContext computation"
    - path: "internal/commands/render.go"
      description: "Template rendering functions for command markdown files"
    - path: "internal/commands/render_test.go"
      description: "Unit tests for template rendering"
    - path: "internal/commands/autospec.plan.md"
      description: "Updated plan command with template variables"
    - path: "internal/commands/autospec.tasks.md"
      description: "Updated tasks command with template variables"
    - path: "internal/commands/autospec.implement.md"
      description: "Updated implement command with template variables"
    - path: "internal/commands/autospec.checklist.md"
      description: "Updated checklist command with template variables"
    - path: "internal/commands/autospec.clarify.md"
      description: "Updated clarify command with template variables"
    - path: "internal/commands/autospec.analyze.md"
      description: "Updated analyze command with template variables"
    - path: "internal/commands/autospec.constitution.md"
      description: "Updated constitution command with template variables"
  tests:
    - path: "internal/prereqs/*_test.go"
      description: "Unit tests for prereqs context computation"
    - path: "internal/commands/*_test.go"
      description: "Unit tests for template rendering and command metadata"

implementation_phases:
  - phase: 1
    name: "Extract PrereqsContext"
    goal: "Create reusable prereqs context computation separate from CLI command"
    deliverables:
      - "Create internal/prereqs/ package with PrereqsContext struct"
      - "Extract ComputeContext function from internal/cli/prereqs.go"
      - "Write unit tests for ComputeContext with various scenarios"
      - "Update prereqs CLI command to use new shared function"

  - phase: 2
    name: "Template Rendering Infrastructure"
    goal: "Build template rendering system for command markdown files"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Create RenderTemplate function in internal/commands/render.go"
      - "Define command requirements mapping (which commands need which variables)"
      - "Implement template variable validation"
      - "Write unit tests for rendering with various contexts"
      - "Add error handling for missing required variables"

  - phase: 3
    name: "Update Command Files"
    goal: "Migrate all affected command files to use template variables"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Update autospec.plan.md to use {{.FeatureDir}}, {{.FeatureSpec}}, etc."
      - "Update autospec.tasks.md with template variables"
      - "Update autospec.implement.md with template variables"
      - "Update autospec.checklist.md with template variables"
      - "Update autospec.clarify.md with template variables"
      - "Update autospec.analyze.md with template variables"
      - "Update autospec.constitution.md with template variables"
      - "Remove bash prereqs call instructions from updated commands"

  - phase: 4
    name: "Integration and Polish"
    goal: "Integrate template rendering into execution flow and ensure quality"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Integrate template rendering at slash command invocation point"
      - "Add E2E tests for command rendering with real feature context"
      - "Verify backward compatibility with existing workflows"
      - "Run make fmt && make lint && make test && make build"
      - "Update CHANGELOG.md with feature summary"

open_questions:
  - question: "Should template rendering happen at install time or invocation time?"
    context: "Install-time rendering would bake in values; invocation-time allows dynamic context"
    proposed_resolution: "Invocation-time rendering is preferred for dynamic values like CreatedDate and feature-specific paths"

  - question: "How should we handle commands invoked outside a feature context?"
    context: "Some commands like /autospec.constitution don't require a feature directory"
    proposed_resolution: "Define command requirements explicitly; constitution only needs AutospecVersion and CreatedDate"

  - question: "Should we add a --no-render flag for debugging raw templates?"
    context: "Developers may want to see unrendered templates for debugging"
    proposed_resolution: "Defer to future enhancement; current scope focuses on core functionality"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.9.0"
  created: "2026-01-16T22:43:51Z"
  artifact_type: "plan"
