feature:
    branch: "103-precompute-prereqs-context"
    created: "2026-01-16"
    status: "Completed"
    completed_at: 2026-01-16T23:09:24Z
    input: "Pre-compute prereqs context for slash commands to eliminate bash calls and reduce agent token usage"
user_stories:
    - id: "US-001"
      title: "Pre-computed prereqs context in slash commands"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "slash commands to receive pre-computed prereqs context"
      so_that: "the agent doesn't need to run bash commands to get feature paths and metadata"
      why_this_priority: "This is the core functionality - without it, no benefits are realized"
      independent_test: "Invoke a slash command and verify prereqs context is available without bash execution"
      acceptance_scenarios:
        - given: "I am in a feature branch with spec.yaml present"
          when: "I invoke /autospec.plan"
          then: "the agent receives pre-computed FEATURE_DIR, FEATURE_SPEC, AUTOSPEC_VERSION, and CREATED_DATE in the prompt context"
        - given: "I am in a feature branch with tasks.yaml present"
          when: "I invoke /autospec.implement"
          then: "the agent receives pre-computed paths including tasks file location without needing to run prereqs"
        - given: "prereqs detection fails (missing required files)"
          when: "I invoke a slash command that requires those files"
          then: "the agent receives an error context explaining what is missing"
    - id: "US-002"
      title: "Eliminate redundant bash calls across commands"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "slash commands to not require bash calls for context that autospec can pre-compute"
      so_that: "agent execution is faster and more reliable"
      why_this_priority: "Direct impact on performance and reliability for every command invocation"
      independent_test: "Run a slash command and verify no prereqs-related bash calls occur"
      acceptance_scenarios:
        - given: "I invoke any slash command that currently runs autospec prereqs"
          when: "the command executes"
          then: "zero bash calls are made for prereqs data (FEATURE_DIR, paths, version, date)"
        - given: "I invoke /autospec.constitution"
          when: "the command executes"
          then: "AUTOSPEC_VERSION and CREATED_DATE are pre-injected without bash calls"
    - id: "US-003"
      title: "Template variable substitution in command files"
      priority: "P1"
      as_a: "autospec maintainer"
      i_want: "command files to use template variables like {{.FeatureDir}}"
      so_that: "I can update command files to reference pre-computed context cleanly"
      why_this_priority: "Enables the implementation approach for all affected commands"
      independent_test: "Create a command file with template variables and verify they render correctly"
      acceptance_scenarios:
        - given: "a command file contains {{.FeatureDir}}"
          when: "autospec renders the command for the agent"
          then: "{{.FeatureDir}} is replaced with the actual feature directory path"
        - given: "a command file contains {{.IsGitRepo}}"
          when: "autospec renders the command"
          then: "{{.IsGitRepo}} is replaced with true or false based on git detection"
        - given: "a template variable has no value (e.g., feature not detected)"
          when: "autospec renders the command"
          then: "an appropriate error or empty value is provided based on command requirements"
    - id: "US-004"
      title: "Backward compatible command file updates"
      priority: "P2"
      as_a: "autospec user with existing workflows"
      i_want: "updated command files to work without breaking existing behavior"
      so_that: "I don't have to modify my workflow when upgrading"
      why_this_priority: "Important for adoption but not blocking core functionality"
      independent_test: "Run existing workflows after upgrade and verify identical outcomes"
      acceptance_scenarios:
        - given: "I upgrade autospec to a version with pre-computed prereqs"
          when: "I run /autospec.plan on an existing feature"
          then: "the plan is generated correctly using pre-computed context"
        - given: "I have custom command files that still use bash prereqs calls"
          when: "I run those commands"
          then: "they continue to work (bash fallback is available)"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST pre-compute and inject prereqs context before slash command execution"
          testable: true
          acceptance_criteria: "Slash commands receive prereqs data without requiring bash calls; verified by checking agent prompts contain prereqs context"
        - id: "FR-002"
          description: "MUST support template variable substitution in command markdown files"
          testable: true
          acceptance_criteria: "Variables like {{.FeatureDir}}, {{.SpecPath}}, {{.AutospecVersion}} are rendered with actual values"
        - id: "FR-003"
          description: "MUST inject the following prereqs fields: FEATURE_DIR, FEATURE_SPEC, IMPL_PLAN, TASKS_FILE, AUTOSPEC_VERSION, CREATED_DATE, IS_GIT_REPO"
          testable: true
          acceptance_criteria: "Each field is present in rendered command output when applicable"
        - id: "FR-004"
          description: "MUST handle missing prerequisites gracefully based on command requirements"
          testable: true
          acceptance_criteria: "Commands with --require-spec fail clearly if spec.yaml missing; commands without requirements render with available data"
        - id: "FR-005"
          description: "MUST update all affected command files to use template variables instead of bash prereqs calls"
          testable: true
          acceptance_criteria: "autospec.plan.md, autospec.tasks.md, autospec.implement.md, autospec.checklist.md, autospec.clarify.md, autospec.analyze.md, autospec.constitution.md use template variables"
        - id: "FR-006"
          description: "MUST maintain command template independence (no autospec-internal paths in templates)"
          testable: true
          acceptance_criteria: "Template variables abstract paths; no hardcoded internal paths in command files"
        - id: "FR-007"
          description: "SHOULD support fallback behavior for commands that need to run prereqs manually"
          testable: true
          acceptance_criteria: "If template rendering fails, error message guides user; autospec prereqs CLI still works"
        - id: "FR-008"
          description: "MUST run all quality gates: make test && make fmt && make lint && make build must exit 0"
          testable: true
          acceptance_criteria: "All make targets pass on CI"
    non_functional:
        - id: "NFR-001"
          category: "performance"
          description: "Pre-computed context injection MUST add less than 50ms to command startup"
          measurable_target: "< 50ms additional latency for prereqs computation"
        - id: "NFR-002"
          category: "code_quality"
          description: "Functions MUST be under 40 lines"
          measurable_target: "No function exceeds 40 lines"
        - id: "NFR-003"
          category: "code_quality"
          description: "Errors MUST be wrapped with context using fmt.Errorf"
          measurable_target: "All error returns use fmt.Errorf with %w"
        - id: "NFR-004"
          category: "code_quality"
          description: "Tests MUST use map-based table tests"
          measurable_target: "All new tests use map[string]struct pattern"
        - id: "NFR-005"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow this pattern"
        - id: "NFR-006"
          category: "reliability"
          description: "Template rendering failures MUST not crash autospec"
          measurable_target: "All template errors result in clear error messages, not panics"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Agent executes slash commands without running prereqs bash calls"
          metric: "Number of bash calls for prereqs data per command"
          target: "0 bash calls for prereqs in affected commands"
        - id: "SC-002"
          description: "Slash command execution completes faster due to eliminated bash overhead"
          metric: "Time from command invocation to agent receiving context"
          target: "Reduction in initial setup time (no agent bash round-trip)"
        - id: "SC-003"
          description: "All 7 affected command files updated to use template variables"
          metric: "Command files using template variables vs bash prereqs"
          target: "7/7 commands migrated"
        - id: "SC-004"
          description: "Existing workflows produce identical results after migration"
          metric: "Behavioral parity with previous version"
          target: "100% feature parity for all slash commands"
key_entities:
    - name: "PrereqsContext"
      description: "Pre-computed context data injected into slash command prompts"
      attributes:
        - "feature_dir: string - path to feature directory"
        - "feature_spec: string - path to spec.yaml"
        - "impl_plan: string - path to plan.yaml"
        - "tasks_file: string - path to tasks.yaml"
        - "autospec_version: string - current autospec version"
        - "created_date: string - ISO 8601 timestamp"
        - "is_git_repo: bool - whether current directory is in a git repo"
    - name: "CommandTemplate"
      description: "A slash command markdown file with template variable placeholders"
      attributes:
        - "path: string - file path to command markdown"
        - "variables: map[string]string - available template variables"
        - "requirements: list - required prereqs (spec, plan, tasks)"
edge_cases:
    - scenario: "Feature branch exists but spec.yaml is missing"
      expected_behavior: "Commands requiring spec fail with clear error; commands not requiring spec render with partial context"
    - scenario: "Not in a git repository"
      expected_behavior: "IS_GIT_REPO is false; commands still work with available context"
    - scenario: "Multiple feature directories match (ambiguous)"
      expected_behavior: "Same behavior as current prereqs CLI - use most recent or prompt for disambiguation"
    - scenario: "Template variable referenced but not available"
      expected_behavior: "Clear error message indicating which variable is missing and why"
    - scenario: "Custom user command files with old bash prereqs pattern"
      expected_behavior: "Continue to work - bash prereqs command remains functional"
    - scenario: "Running outside any feature context (e.g., from repo root on main branch)"
      expected_behavior: "Commands that require feature context fail clearly; commands like constitution that don't require it work"
assumptions:
    - "Template variable syntax will use Go text/template format ({{.VariableName}})"
    - "The existing prereqs CLI command logic can be refactored into a reusable function"
    - "Command files are rendered by autospec before being passed to the agent"
    - "All affected commands are invoked through autospec (not directly by users as raw markdown)"
constraints:
    - "Must maintain command template independence per constitution - no MCP tools or autospec-internal paths in templates"
    - "Must not break existing workflows or custom user command files"
    - "Must work with existing agent presets (Claude, OpenCode)"
    - "Template rendering must happen in Go code, not in the agent"
out_of_scope:
    - "Dynamic context injection based on runtime agent decisions"
    - "Pre-computing task content or spec content (only paths and metadata)"
    - "Modifying how agents parse or use the injected context"
    - "Changes to the prereqs CLI command behavior (only adding reusable function)"
    - "Support for custom template functions beyond simple variable substitution"
    - "Caching prereqs results across multiple command invocations"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.9.0"
    created: "2026-01-16T22:42:42Z"
    artifact_type: "spec"
