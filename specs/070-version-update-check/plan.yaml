plan:
  branch: "070-version-update-check"
  created: "2025-12-21"
  spec_path: "specs/070-version-update-check/spec.yaml"

summary: |
  Implement version update checking and self-update functionality for autospec. The solution
  adds a new internal/update package that fetches GitHub release information asynchronously,
  performs semantic version comparison, and downloads/installs updates with checksum verification.

  The version command is enhanced to display update availability non-blockingly using goroutines,
  while a new update command handles the actual binary replacement with backup and rollback
  capabilities. The design prioritizes user experience (instant version display) and safety
  (checksum verification, atomic file operations).

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "net/http"
      version: "standard library"
      purpose: "HTTP client for GitHub API requests and binary downloads"
    - name: "encoding/json"
      version: "standard library"
      purpose: "Parse GitHub API JSON responses"
    - name: "crypto/sha256"
      version: "standard library"
      purpose: "Verify downloaded binary checksums"
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI command framework (existing dependency)"
  storage: "None"
  testing:
    framework: "testing (standard library) + testify"
    approach: |
      Unit tests with mock HTTP responses for GitHub API interactions.
      Table-driven tests for version comparison logic.
      Integration tests for update flow using test fixtures.
  target_platform: "Linux (x86_64, arm64), macOS (x86_64, arm64)"
  project_type: "cli"
  performance_goals: "Version command displays within 100ms regardless of network"
  constraints:
    - "No external dependencies beyond standard library and existing dependencies"
    - "Non-blocking update check for version command"
    - "Checksum verification required before binary replacement"
    - "Must work on all supported platforms (Linux/macOS, amd64/arm64)"
  scale_scope: "Single user CLI tool with minimal network usage"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All new code will have tests written before implementation using table-driven patterns"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "This feature adds new commands, not workflow phase changes"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Version display <100ms enforced via async update check with goroutines"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Update command is idempotent; repeated runs skip if already up-to-date"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Uses existing exit codes: 0=success, 1=failure, 4=missing dependencies"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "N/A"
      notes: "No new YAML artifacts introduced"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All code must pass go fmt and go vet"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, map-based tests, interface-in/concrete-out"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "No template changes; this is core CLI functionality"
    - name: "Cross-Platform Compatibility (PRIN-008)"
      status: "PASS"
      notes: "Platform detection via runtime.GOOS/GOARCH; tested on Linux/Darwin"
    - name: "Explicit Dependencies (PRIN-009)"
      status: "PASS"
      notes: "Uses only standard library; no new external dependencies"
    - name: "Documentation Standards (PRIN-010)"
      status: "PASS"
      notes: "Public APIs documented; CHANGELOG.md entry required at release"

research_findings:
  decisions:
    - topic: "Update mechanism (curl vs self-update)"
      decision: "Self-update via Go net/http"
      rationale: |
        Using Go's net/http provides cross-platform compatibility without requiring
        external tools like curl. The binary can determine its own path via os.Executable()
        and replace itself atomically.
      alternatives_considered:
        - "Shell script with curl (requires curl installation, less portable)"
        - "Package manager integration (out of scope, complex per-platform)"
    - topic: "Version comparison approach"
      decision: "Simple semantic version parsing without external library"
      rationale: |
        Semantic version comparison is straightforward for our use case (vMAJOR.MINOR.PATCH).
        Adding a semver library would introduce unnecessary dependency for ~20 lines of code.
      alternatives_considered:
        - "github.com/Masterminds/semver (adds 50KB dependency)"
        - "github.com/hashicorp/go-version (adds 30KB dependency)"
    - topic: "Async update check implementation"
      decision: "Goroutine with channel and select with timeout"
      rationale: |
        Goroutine allows version info to display immediately while update check runs
        in background. Channel provides clean synchronization; select with short timeout
        prevents blocking if check is slow.
      alternatives_considered:
        - "Sequential with HTTP timeout only (still blocks briefly)"
        - "Fire-and-forget without result display (loses update notification)"
    - topic: "Binary download verification"
      decision: "SHA256 checksum from checksums.txt"
      rationale: |
        GoReleaser already generates checksums.txt with SHA256 hashes.
        SHA256 is cryptographically strong and standard for binary verification.
      alternatives_considered:
        - "GPG signature verification (more complex, requires key distribution)"
        - "No verification (security risk)"
    - topic: "Backup strategy"
      decision: "Rename current binary to .bak before replacement"
      rationale: |
        Simple and effective; allows manual recovery if needed.
        Atomic rename prevents partial state.
      alternatives_considered:
        - "Copy to separate backup directory (more complex path management)"
        - "No backup (risky if update fails mid-write)"

data_model:
  entities:
    - name: "ReleaseInfo"
      description: "GitHub release metadata from API response"
      fields:
        - name: "TagName"
          type: "string"
          description: "Version tag (e.g., v0.6.1)"
          constraints: "Must match semver pattern"
        - name: "Assets"
          type: "[]Asset"
          description: "List of release assets (binaries, checksums)"
          constraints: "Must contain platform-specific binary"
        - name: "PublishedAt"
          type: "time.Time"
          description: "Release publication timestamp"
          constraints: "Must be valid RFC3339 timestamp"
      relationships:
        - target: "Asset"
          type: "one-to-many"
          description: "Release contains multiple platform-specific assets"
    - name: "Asset"
      description: "Single release asset (binary or checksum file)"
      fields:
        - name: "Name"
          type: "string"
          description: "Asset filename (e.g., autospec_0.6.1_Linux_x86_64.tar.gz)"
          constraints: "Must follow goreleaser naming convention"
        - name: "BrowserDownloadURL"
          type: "string"
          description: "Direct download URL for asset"
          constraints: "Must be valid HTTPS URL"
        - name: "Size"
          type: "int64"
          description: "Asset size in bytes"
          constraints: "Must be positive"
      relationships: []
    - name: "UpdateCheck"
      description: "Result of checking for available updates"
      fields:
        - name: "CurrentVersion"
          type: "string"
          description: "Installed version"
          constraints: "Valid semver or 'dev'"
        - name: "LatestVersion"
          type: "string"
          description: "Latest available version from GitHub"
          constraints: "Valid semver"
        - name: "UpdateAvailable"
          type: "bool"
          description: "Whether newer version exists"
          constraints: "None"
        - name: "DownloadURL"
          type: "string"
          description: "URL to download latest binary for current platform"
          constraints: "Valid HTTPS URL when update available"
      relationships:
        - target: "ReleaseInfo"
          type: "derived-from"
          description: "UpdateCheck is computed from ReleaseInfo"

api_contracts:
  endpoints:
    - method: "GET"
      path: "https://api.github.com/repos/ariel-frischer/autospec/releases/latest"
      description: "Fetch latest release metadata from GitHub API"
      request:
        content_type: "application/json"
        body_schema: "None (query only)"
      response:
        success_code: 200
        body_schema: |
          {
            "tag_name": "v0.6.1",
            "published_at": "2025-12-20T...",
            "assets": [
              {
                "name": "autospec_0.6.1_Linux_x86_64.tar.gz",
                "browser_download_url": "https://github.com/..."
              }
            ]
          }
      errors:
        - code: 403
          description: "Rate limit exceeded (X-RateLimit-Remaining: 0)"
        - code: 404
          description: "No releases found"

project_structure:
  documentation:
    - path: "docs/self-update.md"
      description: "User documentation for version checking and update commands"
  source_code:
    - path: "internal/update/check.go"
      description: "GitHub API client for fetching release info and version comparison"
    - path: "internal/update/download.go"
      description: "Binary download, checksum verification, and extraction"
    - path: "internal/update/install.go"
      description: "Binary backup and replacement logic"
    - path: "internal/update/version.go"
      description: "Semantic version parsing and comparison"
    - path: "internal/cli/util/version.go"
      description: "Enhanced version command with async update check (existing file)"
    - path: "internal/cli/util/update.go"
      description: "New update command implementation"
  tests:
    - path: "internal/update/*_test.go"
      description: "Unit tests for update package with mock HTTP responses"
    - path: "internal/cli/util/version_test.go"
      description: "Tests for enhanced version command"
    - path: "internal/cli/util/update_test.go"
      description: "Tests for update command"

implementation_phases:
  - phase: 1
    name: "Core Update Package"
    goal: "Implement the internal/update package with version checking and comparison logic"
    deliverables:
      - "internal/update/version.go with semver parsing and comparison"
      - "internal/update/check.go with GitHub API client"
      - "Unit tests for version comparison (table-driven)"
      - "Unit tests for release info parsing with mock HTTP"
  - phase: 2
    name: "Enhanced Version Command"
    goal: "Add non-blocking update availability display to version command"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Async update check using goroutines in version command"
      - "Update notification line in version output"
      - "Graceful handling of network failures"
      - "Tests for async behavior and timeout handling"
  - phase: 3
    name: "Download and Verification"
    goal: "Implement binary download with checksum verification"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/update/download.go with streaming download"
      - "Progress display during download"
      - "Checksum parsing from checksums.txt"
      - "SHA256 verification of downloaded binary"
      - "Tar.gz extraction"
      - "Tests with mock download responses"
  - phase: 4
    name: "Update Command"
    goal: "Implement the autospec update command with safe binary replacement"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "internal/update/install.go with backup and atomic replacement"
      - "internal/cli/util/update.go command implementation"
      - "Platform detection for correct binary selection"
      - "Error handling for permission and path issues"
      - "Tests for update flow and error cases"
  - phase: 5
    name: "Documentation and Polish"
    goal: "Add documentation and handle edge cases"
    dependencies:
      - "Phase 4"
    deliverables:
      - "docs/self-update.md user documentation"
      - "Dev build handling (skip update check)"
      - "Edge case handling (permissions, unusual paths)"
      - "Quality gates pass (make test, make lint, make build)"

risks:
  - risk: "GitHub API rate limiting"
    likelihood: "low"
    impact: "medium"
    mitigation: |
      Handle 403 responses gracefully; version command silently skips update notification.
      Consider caching last check result with TTL for frequent users.
  - risk: "Binary replacement fails mid-write"
    likelihood: "low"
    impact: "high"
    mitigation: |
      Use atomic rename pattern: download to temp file, verify checksum, rename in place.
      Keep backup until new binary is confirmed working.
  - risk: "Platform detection fails"
    likelihood: "very low"
    impact: "high"
    mitigation: |
      Use runtime.GOOS and runtime.GOARCH which are reliable.
      Clear error message if no matching asset found.
  - risk: "Goreleaser naming convention changes"
    likelihood: "low"
    impact: "medium"
    mitigation: |
      Asset name construction matches current .goreleaser.yaml template.
      Test against actual release assets during development.

open_questions:
  - question: "Should we cache the last update check result?"
    context: "Reduces API calls for users who run version frequently"
    proposed_resolution: "Skip caching in initial implementation; add if rate limiting becomes issue"
  - question: "How to handle running update when binary is in use?"
    context: "On Windows (WSL), replacing running binary may have issues"
    proposed_resolution: "Document WSL limitation; binary rename should work on Linux/macOS"
  - question: "Should checksum verification failure abort or warn?"
    context: "Security vs usability tradeoff"
    proposed_resolution: "Abort by default with clear error message explaining the issue"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.6.1"
  created: "2025-12-21T06:00:39Z"
  artifact_type: "plan"
