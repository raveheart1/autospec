_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "dev"
  created: "2025-12-14T06:35:00Z"
  artifact_type: "spec"

spec:
  title: "Flexible Phase Workflow"
  branch: "008-flexible-phase-workflow"
  created: "2025-12-13"
  status: "Draft"
  input: "Allow users to run custom combinations of SpecKit phases in any order with safety warnings"

user_stories:
  - id: "US-001"
    title: "Custom Phase Combination"
    priority: "P1"
    description: |
      As a developer working on a feature with an existing spec, I want to run only the plan
      and implement phases without regenerating the spec, so that I can resume work efficiently
      without redundant steps.
    why_priority: |
      This is the core value proposition - enabling flexible phase combinations saves time for
      experienced users who know exactly which phases they need.
    independent_test: |
      Can be fully tested by running the tool with `-pi` flags on an existing spec branch and
      verifying both plan and implement phases execute in order.
    acceptance_scenarios:
      - given: "I am on a branch with an existing spec.md file"
        when: "I run the command with plan and implement flags only"
        then: "the system executes plan followed by implement phases, skipping the specify phase"
      - given: "I specify multiple phases via flags"
        when: "I run the command"
        then: "the phases always execute in the canonical order (specify -> plan -> tasks -> implement) regardless of the order I specified the flags"
      - given: "I am on a spec branch with all artifacts present"
        when: "I run a subset of phases"
        then: "the system proceeds immediately without any confirmation prompts"

  - id: "US-002"
    title: "Run All Phases with Single Flag"
    priority: "P1"
    description: |
      As a developer starting a new feature, I want a quick way to run all four phases with a
      single command or flag, so that I can set up a complete workflow with minimal typing.
    why_priority: "This is the most common workflow use case and must be easy to invoke."
    independent_test: |
      Can be fully tested by running the tool with `-a` flag and a feature description,
      verifying all four phases execute sequentially.
    acceptance_scenarios:
      - given: "I have a feature description"
        when: "I run the command with the 'all phases' flag"
        then: "the system executes specify, plan, tasks, and implement phases in sequence"
      - given: "I run the 'all' subcommand with a feature description"
        when: "the command completes"
        then: "the result is identical to running with the 'all phases' flag"

  - id: "US-003"
    title: "Safety Warnings for Missing Prerequisites"
    priority: "P2"
    description: |
      As a developer who may accidentally skip required phases, I want the system to warn me
      when prerequisite artifacts are missing and ask for confirmation, so that I don't waste
      time running phases that will fail.
    why_priority: |
      Prevents user frustration from failed executions due to missing dependencies, providing
      a safety net without blocking advanced users.
    independent_test: |
      Can be fully tested by attempting to run tasks phase without a plan.md file present and
      verifying a warning appears with confirmation prompt.
    acceptance_scenarios:
      - given: "I request the tasks phase but plan.md does not exist"
        when: "I run the command"
        then: "the system displays a warning about the missing prerequisite and asks for confirmation before proceeding"
      - given: "I am shown a prerequisite warning"
        when: "I confirm with 'y'"
        then: "the system proceeds with execution"
      - given: "I am shown a prerequisite warning"
        when: "I decline with 'n' or press Enter"
        then: "the system aborts without executing any phases"

  - id: "US-004"
    title: "Skip Confirmation Prompts"
    priority: "P2"
    description: |
      As an automation script or experienced user, I want to skip all confirmation prompts,
      so that I can run commands non-interactively or without interruption.
    why_priority: "Essential for CI/CD integration and power users who want streamlined execution."
    independent_test: |
      Can be fully tested by running with the 'yes' flag when prerequisites are missing and
      verifying no prompt appears.
    acceptance_scenarios:
      - given: "I pass the 'skip confirmation' flag"
        when: "prerequisites are missing"
        then: "the system proceeds without showing a confirmation prompt"
      - given: "I set the 'skip confirmations' environment variable"
        when: "I run a command with missing prerequisites"
        then: "the system proceeds without prompts"
      - given: "I configure 'skip confirmations' in my config file"
        when: "I run commands"
        then: "all confirmation prompts are skipped by default"

  - id: "US-005"
    title: "Explicit Spec Selection"
    priority: "P3"
    description: |
      As a developer working across multiple features, I want to explicitly specify which spec
      to work with, so that I can run phases on a different spec than my current branch suggests.
    why_priority: "Provides flexibility for advanced workflows where branch naming conventions don't apply."
    independent_test: |
      Can be fully tested by passing an explicit spec name flag while on a different branch and
      verifying the specified spec is used.
    acceptance_scenarios:
      - given: "I am on branch 'main'"
        when: "I run a command with an explicit spec name flag"
        then: "the system uses the specified spec instead of trying to detect from branch"
      - given: "I provide a non-existent spec name"
        when: "I run the command without specify phase"
        then: "the system displays an error indicating the spec was not found"

  - id: "US-006"
    title: "Branch-Aware Spec Detection"
    priority: "P3"
    description: |
      As a developer following git workflow conventions, I want the system to automatically
      detect which spec I'm working on based on my current branch name, so that I don't have
      to specify it manually.
    why_priority: "Reduces friction for users following standard naming conventions, making the tool feel intelligent."
    independent_test: |
      Can be fully tested by checking out a spec branch and running a phase command without
      specifying the spec name.
    acceptance_scenarios:
      - given: "I am on branch '007-yaml-output'"
        when: "I run a phase command without specifying a spec"
        then: "the system detects and uses spec '007-yaml-output'"
      - given: "I am on a non-spec branch like 'main'"
        when: "I run a phase command without the specify phase and without explicit spec selection"
        then: "the system displays an error with suggestions on how to proceed"
      - given: "I am in detached HEAD state or outside a git repository"
        when: "I run a phase command"
        then: "the system falls back to using the most recently modified spec directory"

edge_cases:
  - question: "What happens when the user provides conflicting flags (e.g., both `-s` requiring a description and no description provided)?"
    answer: "System displays an error: 'Feature description required when using specify phase'"
  - question: "What happens when the user specifies no phase flags at all?"
    answer: "System shows help/usage information"
  - question: "What happens when the git repository is in an unusual state (detached HEAD, no git, corrupted)?"
    answer: "System falls back to most recent spec directory detection"
  - question: "What happens when prerequisites are missing but the user confirms to proceed?"
    answer: "System attempts execution; individual phase may fail with appropriate error messages"
  - question: "What happens when all phase flags and the 'all' flag are provided together?"
    answer: "System treats this as equivalent to 'all' - no conflict, phases execute once"

requirements:
  functional:
    - id: "FR-001"
      description: "System MUST support individual phase flags (`-s`/`--specify`, `-p`/`--plan`, `-t`/`--tasks`, `-i`/`--implement`) that can be combined in any order."
    - id: "FR-002"
      description: "System MUST support an 'all phases' shortcut (`-a`/`--all`) that enables all four phases."
    - id: "FR-003"
      description: "System MUST execute selected phases in canonical order (specify -> plan -> tasks -> implement) regardless of the order flags are specified."
    - id: "FR-004"
      description: "System MUST detect the current spec from the git branch name when the branch follows the pattern `NNN-feature-name`."
    - id: "FR-005"
      description: "System MUST display a warning and request confirmation when attempting to run a phase without its prerequisite artifacts present."
    - id: "FR-006"
      description: "System MUST support skipping confirmation prompts via flag (`-y`/`--yes`), environment variable (`AUTOSPEC_YES`), or configuration setting (`skip_confirmations`)."
    - id: "FR-007"
      description: "System MUST support explicit spec selection via the `--spec` flag, overriding branch-based detection."
    - id: "FR-008"
      description: "System MUST require a feature description argument when the specify phase is included in the execution."
    - id: "FR-009"
      description: "System MUST display an error with actionable suggestions when on a non-spec branch without the specify phase and without explicit spec selection."
    - id: "FR-010"
      description: "System MUST fall back to the most recently modified spec directory when git branch detection fails (detached HEAD, no git repository)."
    - id: "FR-011"
      description: "System MUST rename the existing 'full' subcommand to 'all' for executing all four phases in sequence."
    - id: "FR-012"
      description: "System MUST show help/usage when invoked without any phase flags or subcommands."

  key_entities:
    - name: "PhaseConfig"
      description: "Represents the user's selected phases (specify, plan, tasks, implement, all) and determines execution order."
    - name: "PreflightResult"
      description: "Contains the results of prerequisite checking including detected spec, existing artifacts, warnings, and whether confirmation is needed."
    - name: "Artifact Dependency Map"
      description: |
        Defines the relationship between phases and their required/produced artifacts:
        - specify -> creates spec.md
        - plan -> requires spec.md, creates plan.md
        - tasks -> requires plan.md, creates tasks.md
        - implement -> requires tasks.md

success_criteria:
  - id: "SC-001"
    description: "Users can specify any combination of phases and have them execute in the correct order within the same command invocation."
  - id: "SC-002"
    description: "Users can run the complete four-phase workflow with 3 or fewer characters of flags (`-a`)."
  - id: "SC-003"
    description: "Warning messages for missing prerequisites are displayed in under 1 second after command invocation."
  - id: "SC-004"
    description: "Users on spec branches with all artifacts present experience zero confirmation prompts for any phase combination."
  - id: "SC-005"
    description: "Users receive actionable error messages with specific suggestions when spec detection fails."

assumptions:
  - "Users are familiar with Unix-style short flags that can be combined (e.g., `-spi` similar to `tar -xvf`)."
  - "The existing git integration and spec detection logic can be extended without breaking changes."
  - "The Cobra CLI framework supports adding persistent flags to the root command that work alongside subcommands."
  - "Confirmation prompts use simple y/N input on stdin; no complex terminal UI is required."
  - "The canonical phase order (specify -> plan -> tasks -> implement) is fixed and will not change."

constraints: []

out_of_scope: []
