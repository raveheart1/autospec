plan:
  branch: "039-blocked-task-reason"
  created: "2025-12-17"
  spec_path: "specs/039-blocked-task-reason/spec.yaml"

summary: |
  This implementation adds a blocked_reason field to the task management system, enabling
  developers and AI agents to document why tasks are blocked. The approach extends the
  existing TaskItem struct with an optional BlockedReason field, adds validation warnings
  (not errors) for blocked tasks missing reasons, and introduces new CLI commands for
  blocking/unblocking tasks. The implementation follows existing codebase patterns,
  particularly the YAML node traversal pattern used in update-task for preserving file
  formatting, and the validation warning system for non-breaking checks.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing with node-level access for format-preserving updates"
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework"
  storage: "YAML files (tasks.yaml)"
  testing:
    framework: "Go testing package"
    approach: "Map-based table-driven tests with t.Parallel(), following existing patterns"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Validation functions <10ms per constitution PRIN-003"
  constraints:
    - "Backward compatible with existing tasks.yaml files (NFR-006)"
    - "blocked_reason field must be optional"
    - "Validation emits warnings, not errors, for missing blocked_reason"
    - "New CLI commands must use lifecycle wrapper for notifications"
    - "Functions must be under 40 lines (NFR-001)"
    - "All errors must be wrapped with context (NFR-002)"
  scale_scope: "Single-developer or small team workflow tool"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All tasks include corresponding test tasks before implementation"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "Validation added for blocked_reason field using existing ValidationResult pattern"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "blocked_reason validation adds minimal overhead (<1ms) per NFR-005"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "N/A"
      notes: "No retry logic needed for task blocking operations"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Commands will use existing exit code patterns"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "blocked_reason stored in tasks.yaml as optional YAML field"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "Will pass make fmt and make lint before completion"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Map-based tests, error wrapping, <40 line functions enforced"

research_findings:
  decisions:
    - topic: "Where to add blocked_reason field"
      decision: "Add to TaskItem struct in internal/validation/tasks_yaml.go"
      rationale: "TaskItem is the canonical task representation used throughout the codebase"
      alternatives_considered:
        - "Separate BlockedTask struct - rejected for unnecessary complexity"
        - "Map[string]interface{} for flexible fields - rejected for type safety"
    - topic: "CLI command structure for block/unblock"
      decision: "Create new 'task' parent command with 'block', 'unblock', and 'list' subcommands"
      rationale: "Groups related operations under semantic parent; matches spec requirement for 'autospec task block' syntax"
      alternatives_considered:
        - "Extend update-task to accept --reason flag - rejected as it conflates two distinct operations"
        - "Separate block-task and unblock-task commands - rejected for poor discoverability"
    - topic: "Validation severity for missing blocked_reason"
      decision: "Emit warning, not error, when blocked task lacks reason"
      rationale: "Maintains backward compatibility; blocked tasks without reasons should validate but prompt user"
      alternatives_considered:
        - "Error - rejected as it breaks existing workflows"
        - "Silent acceptance - rejected as it defeats the purpose of the feature"
    - topic: "YAML update mechanism"
      decision: "Extend findAndUpdateTask pattern from update_task.go to handle blocked_reason"
      rationale: "Preserves YAML formatting and comments; proven pattern in codebase"
      alternatives_considered:
        - "Full parse/marshal cycle - rejected as it loses formatting"
        - "sed/text manipulation - rejected as error-prone and non-portable"

data_model:
  entities:
    - name: "TaskItem"
      description: "Individual task within a phase, extended with blocked_reason"
      fields:
        - name: "ID"
          type: "string"
          description: "Unique task identifier (e.g., T001)"
          constraints: "Required, matches ^T\\d+$ pattern"
        - name: "Title"
          type: "string"
          description: "Human-readable task title"
          constraints: "Required"
        - name: "Status"
          type: "string"
          description: "Current task state"
          constraints: "Required, enum: Pending|InProgress|Completed|Blocked"
        - name: "Type"
          type: "string"
          description: "Task category"
          constraints: "Required, enum: setup|implementation|test|documentation|refactor"
        - name: "Parallel"
          type: "bool"
          description: "Whether task can run in parallel with others"
          constraints: "Optional, defaults to false"
        - name: "StoryID"
          type: "string"
          description: "Associated user story reference"
          constraints: "Optional"
        - name: "FilePath"
          type: "string"
          description: "Target file for task"
          constraints: "Optional"
        - name: "Dependencies"
          type: "[]string"
          description: "Task IDs that must complete first"
          constraints: "Optional, must reference existing task IDs"
        - name: "AcceptanceCriteria"
          type: "[]string"
          description: "Conditions for task completion"
          constraints: "Optional"
        - name: "BlockedReason"
          type: "string"
          description: "Explanation for why task is blocked (NEW)"
          constraints: "Optional, warning if status=Blocked and field missing"
      relationships:
        - target: "TaskPhase"
          type: "many-to-one"
          description: "Tasks belong to exactly one phase"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "internal/commands/autospec.implement.md"
      description: "Update to document task block/unblock syntax"
  source_code:
    - path: "internal/validation/tasks_yaml.go"
      description: "TaskItem struct with BlockedReason field"
    - path: "internal/validation/artifact_tasks.go"
      description: "Validation logic for blocked_reason warnings"
    - path: "internal/cli/task.go"
      description: "New parent 'task' command"
    - path: "internal/cli/task_block.go"
      description: "Block subcommand implementation"
    - path: "internal/cli/task_unblock.go"
      description: "Unblock subcommand implementation"
    - path: "internal/cli/task_list.go"
      description: "List subcommand with status filters"
    - path: "internal/cli/status.go"
      description: "Update to display blocked reasons"
    - path: "internal/cli/artifact.go"
      description: "Update summary output to show blocked reasons"
  tests:
    - path: "internal/validation/tasks_yaml_test.go"
      description: "Tests for BlockedReason field parsing"
    - path: "internal/validation/artifact_tasks_test.go"
      description: "Tests for blocked_reason validation warnings"
    - path: "internal/cli/task_test.go"
      description: "Tests for task command and subcommands"
    - path: "internal/cli/status_test.go"
      description: "Tests for blocked reason display"

implementation_phases:
  - phase: 1
    name: "Data Model Extension"
    goal: "Add BlockedReason field to TaskItem struct and ensure parsing works"
    deliverables:
      - "TaskItem struct with BlockedReason field (yaml:blocked_reason,omitempty)"
      - "Unit tests for parsing tasks with blocked_reason"
      - "Backward compatibility tests for tasks without blocked_reason"
  - phase: 2
    name: "Validation Logic"
    goal: "Add warning for blocked tasks without reason"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Validation warning when status=Blocked and blocked_reason missing"
      - "No error when blocked_reason present on non-Blocked task"
      - "Unit tests for validation edge cases"
  - phase: 3
    name: "Core CLI Commands"
    goal: "Implement task block and unblock commands"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Parent 'task' command structure"
      - "'task block <id> --reason <text>' command"
      - "'task unblock <id> [--status <status>]' command"
      - "YAML node manipulation for blocked_reason field"
      - "Unit tests for block/unblock operations"
  - phase: 4
    name: "Status Display Updates"
    goal: "Show blocked reasons in status and artifact output"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "Update autospec st to display blocked task reasons"
      - "Update artifact command summary to include blocked reasons"
      - "FormatTaskSummary updates for blocked reason display"
  - phase: 5
    name: "Task List Command"
    goal: "Implement filtered task listing"
    dependencies:
      - "Phase 3"
    deliverables:
      - "'task list' command with --blocked, --pending, --in-progress, --completed filters"
      - "Filtered output with blocked reasons when applicable"
  - phase: 6
    name: "Documentation and Polish"
    goal: "Update documentation and ensure quality gates pass"
    dependencies:
      - "Phase 3"
      - "Phase 4"
      - "Phase 5"
    deliverables:
      - "Update autospec.implement.md with block/unblock syntax"
      - "Ensure make test, make fmt, make lint, make build all pass"
      - "Edge case handling (empty reason, very long reason, re-blocking)"

risks:
  - risk: "YAML formatting lost when adding blocked_reason field"
    likelihood: "low"
    impact: "medium"
    mitigation: "Use yaml.Node traversal pattern from update_task.go; test with varied YAML styles"
  - risk: "Validation warning mechanism doesn't exist"
    likelihood: "low"
    impact: "low"
    mitigation: "ValidationResult already supports warnings via AddWarning method"
  - risk: "Breaking existing tasks.yaml files"
    likelihood: "low"
    impact: "high"
    mitigation: "omitempty tag ensures missing field is ignored; extensive backward compat tests"

open_questions:
  - question: "Should blocked_reason be preserved in history when unblocking?"
    context: "Spec explicitly defers --keep-reason flag to future enhancement"
    proposed_resolution: "Clear blocked_reason on unblock; document this behavior"
  - question: "How to handle truncation of very long blocked reasons in display?"
    context: "Spec mentions display may truncate for readability"
    proposed_resolution: "Truncate to 80 chars in status output with '...' suffix; show full in verbose mode"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-17T21:24:48Z"
  artifact_type: "plan"
