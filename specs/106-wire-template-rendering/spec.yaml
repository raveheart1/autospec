feature:
    branch: "106-wire-template-rendering"
    created: "2026-01-28"
    status: "Completed"
    completed_at: 2026-01-28T10:35:42Z
    input: "Template variables like {{.FeatureDir}} and {{.FeatureSpec}} in command templates are not rendered before being passed to Claude during workflow execution. Claude sees literal template syntax instead of actual paths, causing workflow failures."
user_stories:
    - id: "US-001"
      title: "Automated workflow execution with correct paths"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "workflow commands (plan, tasks, implement) to automatically receive correct spec file paths"
      so_that: "I can run automated workflows without manually specifying paths in prompts"
      why_this_priority: "This is the core value proposition of autospec - automated end-to-end workflows. Without working template rendering, the primary use case is broken."
      independent_test: "Run 'autospec run' on a feature branch and verify Claude receives rendered paths instead of {{.FeatureDir}} literals"
      acceptance_scenarios:
        - given: "a feature branch (e.g., 002-my-feature) with a spec.yaml in specs/002-my-feature/"
          when: "I run 'autospec plan' without any additional path arguments"
          then: "Claude receives the command with {{.FeatureDir}} replaced by 'specs/002-my-feature/' and {{.FeatureSpec}} replaced by 'specs/002-my-feature/spec.yaml'"
        - given: "a feature branch with existing spec.yaml and plan.yaml"
          when: "I run 'autospec tasks' without any additional path arguments"
          then: "Claude receives the command with {{.FeatureDir}}, {{.FeatureSpec}}, and {{.ImplPlan}} all replaced with actual paths"
        - given: "a feature branch with existing tasks.yaml"
          when: "I run 'autospec implement' without any additional path arguments"
          then: "Claude receives the command with {{.FeatureDir}} and {{.TasksFile}} replaced with actual paths"
    - id: "US-002"
      title: "Full pipeline execution without manual intervention"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "the complete specify → plan → tasks → implement pipeline to work automatically"
      so_that: "I can run 'autospec run' and have the entire workflow execute without path-related failures"
      why_this_priority: "The pipeline is the main automation feature. Users currently must provide manual workarounds for every stage."
      independent_test: "Run 'autospec run -pti' on a new feature and verify all stages complete without Claude searching wrong directories"
      acceptance_scenarios:
        - given: "a new feature with a spec.yaml"
          when: "I run 'autospec run -pti'"
          then: "plan, tasks, and implement stages all execute with correct paths without Claude searching .autospec/features/ or other wrong directories"
        - given: "a feature branch"
          when: "I run 'autospec prep'"
          then: "both plan and tasks stages receive correctly rendered template variables"
    - id: "US-003"
      title: "Auxiliary workflow commands with correct paths"
      priority: "P2"
      as_a: "developer using autospec"
      i_want: "clarify, analyze, and checklist commands to receive correct spec paths"
      so_that: "all spec-related commands work consistently without manual path specification"
      why_this_priority: "These are supporting commands that enhance the workflow but are not on the critical path."
      independent_test: "Run 'autospec clarify' and verify it receives {{.FeatureDir}} and {{.FeatureSpec}} as actual paths"
      acceptance_scenarios:
        - given: "a feature branch with spec.yaml"
          when: "I run 'autospec clarify'"
          then: "Claude receives the command with {{.FeatureDir}} and {{.FeatureSpec}} replaced with actual paths"
        - given: "a feature branch with spec.yaml"
          when: "I run 'autospec analyze'"
          then: "Claude receives the command with {{.FeatureDir}} and {{.FeatureSpec}} replaced with actual paths"
        - given: "a feature branch with spec.yaml"
          when: "I run 'autospec checklist'"
          then: "Claude receives the command with {{.FeatureDir}} and {{.FeatureSpec}} replaced with actual paths"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST call prereqs.ComputeContext() in workflow execution before building stage commands"
          testable: true
          acceptance_criteria: "StageExecutor methods call ComputeContext and store the result for use in command building"
        - id: "FR-002"
          description: "MUST render template variables in slash commands using commands.RenderTemplate() before passing to Claude"
          testable: true
          acceptance_criteria: "All {{.FeatureDir}}, {{.FeatureSpec}}, {{.ImplPlan}}, and {{.TasksFile}} variables are replaced with actual paths"
        - id: "FR-003"
          description: "MUST use the existing render-command implementation pattern as reference"
          testable: true
          acceptance_criteria: "Workflow execution follows the same context computation and rendering flow as render-command CLI"
        - id: "FR-004"
          description: "MUST render templates for all affected commands: plan, tasks, implement, clarify, analyze, checklist"
          testable: true
          acceptance_criteria: "Each of the six commands has its template variables rendered before execution"
        - id: "FR-005"
          description: "SHOULD provide clear error messages when context computation fails (e.g., no spec found for current branch)"
          testable: true
          acceptance_criteria: "Error messages indicate what's missing and suggest remediation (e.g., 'No spec.yaml found for branch X. Run autospec specify first.')"
        - id: "FR-006"
          description: "MUST preserve existing behavior for commands without path variables (specify, constitution)"
          testable: true
          acceptance_criteria: "Commands that don't use path templates continue to work unchanged"
        - id: "FR-007"
          description: "MUST make test, fmt, lint, and build all pass with exit code 0"
          testable: true
          acceptance_criteria: "Running 'make test && make fmt && make lint && make build' succeeds"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "Functions MUST be under 40 lines"
          measurable_target: "No function exceeds 40 lines of code"
        - id: "NFR-002"
          category: "code_quality"
          description: "Errors MUST be wrapped with context using fmt.Errorf with %w"
          measurable_target: "All error returns use fmt.Errorf('doing X: %w', err) pattern"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests MUST use map-based table test pattern"
          measurable_target: "New tests use map[string]struct{} with for name, tt := range tests"
        - id: "NFR-004"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "New code follows this pattern where applicable"
        - id: "NFR-005"
          category: "reliability"
          description: "Template rendering MUST be idempotent"
          measurable_target: "Rendering an already-rendered template produces the same output"
        - id: "NFR-006"
          category: "performance"
          description: "Template rendering SHOULD add minimal latency"
          measurable_target: "Context computation and rendering complete in under 100ms"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Users can run 'autospec run' without manually specifying paths"
          metric: "Successful completion rate of autospec run without path arguments"
          target: "100% success when spec.yaml exists for current branch"
        - id: "SC-002"
          description: "Claude no longer sees literal {{.FeatureDir}} text in commands"
          metric: "Presence of unrendered template variables in Claude's input"
          target: "0 occurrences of {{.Variable}} patterns in executed commands"
        - id: "SC-003"
          description: "Workflow stages find spec files on first attempt"
          metric: "Number of directory search attempts before locating spec files"
          target: "1 attempt (direct path access, no searching)"
        - id: "SC-004"
          description: "All six affected commands work with auto-detected paths"
          metric: "Commands (plan, tasks, implement, clarify, analyze, checklist) working without manual paths"
          target: "6 out of 6 commands working"
key_entities:
    - name: "StageExecutor"
      description: "Component that builds and executes workflow stage commands"
      attributes:
        - "Builds command strings for Claude"
        - "Currently missing template rendering step"
        - "Located in internal/workflow/stage_executor.go"
    - name: "TemplateContext"
      description: "Data structure containing values for template variables"
      attributes:
        - "FeatureDir: path to feature directory"
        - "FeatureSpec: path to spec.yaml"
        - "ImplPlan: path to plan.yaml"
        - "TasksFile: path to tasks.yaml"
    - name: "ComputeContext"
      description: "Function that determines paths from git branch and environment"
      attributes:
        - "Detects current feature from git branch"
        - "Computes all derived paths"
        - "Located in internal/prereqs/context.go"
edge_cases:
    - scenario: "No git branch detected (detached HEAD)"
      expected_behavior: "Return clear error indicating branch detection failed and suggest checking out a feature branch"
    - scenario: "Branch name doesn't match feature pattern (e.g., 'main' or 'fix-typo')"
      expected_behavior: "Return error indicating no spec found for branch and suggest running 'autospec specify' first"
    - scenario: "Feature directory exists but spec.yaml is missing"
      expected_behavior: "Return error indicating spec.yaml not found in expected location"
    - scenario: "Template contains variables not in context"
      expected_behavior: "Return error listing the missing variables"
    - scenario: "User provides explicit path in prompt alongside auto-detected path"
      expected_behavior: "User-provided path in prompt takes precedence over auto-detected path"
assumptions:
    - "The existing prereqs.ComputeContext() and commands.RenderTemplate() functions work correctly"
    - "The render-command CLI implementation is the reference pattern to follow"
    - "Git branch naming convention (NNN-feature-name) is consistently used"
    - "Spec files are always located in specs/<branch-name>/ directory"
    - "Claude Code passes slash commands to the .claude/commands/ templates verbatim"
constraints:
    - "Must use existing infrastructure (prereqs, commands packages) - no new rendering systems"
    - "Must not change the command template format or variable names"
    - "Must maintain backward compatibility with manual path specification in prompts"
    - "Must not require changes to Claude Code itself"
out_of_scope:
    - "Changing template variable syntax (e.g., from Go templates to another format)"
    - "Adding new template variables beyond the existing ones"
    - "Modifying the render-command CLI"
    - "Changes to how Claude Code processes slash commands"
    - "Adding caching for computed context values"
    - "UI/UX improvements beyond error messages"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.10.1"
    created: "2026-01-28T09:33:23Z"
    artifact_type: "spec"
