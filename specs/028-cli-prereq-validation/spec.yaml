feature:
  branch: "028-cli-prereq-validation"
  created: "2025-12-16"
  status: "Draft"
  input: "Add prerequisite validation to all CLI commands. All stages (except constitution) must check constitution exists. Core stages (plan, tasks, implement) and optional stages (clarify, checklist, analyze) must check their required artifacts exist before invoking Claude. See .dev/tasks/024-cli-prerequisite-validation.md for full details."

user_stories:
  - id: "US-001"
    title: "Fail fast on missing constitution"
    priority: "P1"
    as_a: "developer using autospec"
    i_want: "to get an immediate error when running any stage command without a project constitution"
    so_that: "I don't waste time and API costs waiting for Claude to fail predictably"
    why_this_priority: "Constitution is foundational to all stages - missing it guarantees failure"
    independent_test: "Run any stage command (specify, plan, tasks, implement) without a constitution file and verify instant CLI error"
    acceptance_scenarios:
      - given: "no constitution.yaml exists in .autospec/memory/"
        when: "I run 'autospec specify'"
        then: "CLI immediately shows error with suggestion to run 'autospec constitution' first"
      - given: "no constitution.yaml exists in .autospec/memory/"
        when: "I run 'autospec plan'"
        then: "CLI immediately shows error before invoking Claude"
      - given: "constitution.yaml exists in .autospec/memory/"
        when: "I run any stage command"
        then: "validation passes and command proceeds to next check or execution"

  - id: "US-002"
    title: "Fail fast on missing spec.yaml for dependent stages"
    priority: "P1"
    as_a: "developer using autospec"
    i_want: "to get an immediate error when running plan, clarify, or checklist without spec.yaml"
    so_that: "I receive instant feedback instead of waiting for Claude to discover the missing file"
    why_this_priority: "These stages fundamentally depend on spec.yaml and cannot proceed without it"
    independent_test: "Run 'autospec plan' without spec.yaml present and verify instant CLI error"
    acceptance_scenarios:
      - given: "constitution exists but spec.yaml does not exist in the spec directory"
        when: "I run 'autospec plan'"
        then: "CLI shows error: 'spec.yaml not found' with suggestion to run 'autospec specify' first"
      - given: "constitution exists but spec.yaml does not exist"
        when: "I run 'autospec clarify'"
        then: "CLI shows error with actionable suggestion"
      - given: "constitution and spec.yaml both exist"
        when: "I run 'autospec plan'"
        then: "validation passes and command proceeds"

  - id: "US-003"
    title: "Fail fast on missing plan.yaml for tasks stage"
    priority: "P1"
    as_a: "developer using autospec"
    i_want: "to get an immediate error when running tasks without plan.yaml"
    so_that: "I don't incur API costs for a predictably failing operation"
    why_this_priority: "Tasks stage requires plan.yaml to generate task breakdown"
    independent_test: "Run 'autospec tasks' without plan.yaml and verify instant error"
    acceptance_scenarios:
      - given: "constitution exists but plan.yaml does not exist in the spec directory"
        when: "I run 'autospec tasks'"
        then: "CLI shows error: 'plan.yaml not found' with suggestion to run 'autospec plan' first"

  - id: "US-004"
    title: "Fail fast on missing tasks.yaml for implement stage"
    priority: "P1"
    as_a: "developer using autospec"
    i_want: "to get an immediate error when running implement without tasks.yaml"
    so_that: "I get instant feedback about what prerequisite is missing"
    why_this_priority: "Implementation requires tasks.yaml to know what to build"
    independent_test: "Run 'autospec implement' without tasks.yaml and verify instant error"
    acceptance_scenarios:
      - given: "constitution exists but tasks.yaml does not exist in the spec directory"
        when: "I run 'autospec implement'"
        then: "CLI shows error: 'tasks.yaml not found' with suggestion to run 'autospec tasks' first"

  - id: "US-005"
    title: "Validate all prerequisites for analyze command"
    priority: "P1"
    as_a: "developer using autospec"
    i_want: "the analyze command to check all required artifacts before running"
    so_that: "I know exactly which artifacts are missing before invoking Claude"
    why_this_priority: "Analyze requires the most artifacts and is most expensive to fail"
    independent_test: "Run 'autospec analyze' with various missing artifacts and verify comprehensive error messages"
    acceptance_scenarios:
      - given: "constitution exists but spec.yaml, plan.yaml, and tasks.yaml are missing"
        when: "I run 'autospec analyze'"
        then: "CLI shows error listing all missing artifacts with their remediation commands"
      - given: "only plan.yaml is missing"
        when: "I run 'autospec analyze'"
        then: "CLI shows error specifically for plan.yaml with suggestion to run 'autospec plan'"

  - id: "US-006"
    title: "Smart prerequisite checking for run command with stage flags"
    priority: "P1"
    as_a: "developer using autospec"
    i_want: "the run command to only check prerequisites for the first stage in a chain"
    so_that: "I can run 'autospec run -spt' without needing spec.yaml already present"
    why_this_priority: "Run command chains stages where earlier stages create prereqs for later stages"
    independent_test: "Run 'autospec run -spt' with only constitution and verify it starts specify stage"
    acceptance_scenarios:
      - given: "constitution exists but no spec.yaml"
        when: "I run 'autospec run -spt'"
        then: "validation passes because specify will create spec.yaml for plan"
      - given: "constitution exists but no spec.yaml"
        when: "I run 'autospec run -pti'"
        then: "CLI shows error because plan needs spec.yaml and no earlier stage creates it"
      - given: "constitution exists with spec.yaml but no plan.yaml"
        when: "I run 'autospec run -ti'"
        then: "CLI shows error because tasks needs plan.yaml and no earlier stage creates it"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST validate constitution.yaml exists before all stages except constitution command itself"
      testable: true
      acceptance_criteria: "Every stage command (specify, plan, tasks, implement, clarify, checklist, analyze) checks constitution first"
    - id: "FR-002"
      description: "MUST validate spec.yaml exists before plan, clarify, checklist, and analyze stages"
      testable: true
      acceptance_criteria: "These commands fail fast with clear error when spec.yaml is missing"
    - id: "FR-003"
      description: "MUST validate plan.yaml exists before tasks and analyze stages"
      testable: true
      acceptance_criteria: "These commands fail fast with clear error when plan.yaml is missing"
    - id: "FR-004"
      description: "MUST validate tasks.yaml exists before implement and analyze stages"
      testable: true
      acceptance_criteria: "These commands fail fast with clear error when tasks.yaml is missing"
    - id: "FR-005"
      description: "MUST provide actionable error messages that suggest the command to run"
      testable: true
      acceptance_criteria: "Error messages include 'Run autospec <command> first' suggestions"
    - id: "FR-006"
      description: "MUST handle run command with stage flags by checking only first stage's external prerequisites"
      testable: true
      acceptance_criteria: "run -spt only checks constitution; run -pti checks constitution + spec.yaml"
    - id: "FR-007"
      description: "MUST list all missing artifacts when multiple are absent (analyze command)"
      testable: true
      acceptance_criteria: "Analyze command error shows complete list of missing files with remediation steps"
    - id: "FR-008"
      description: "SHOULD centralize validation logic in WorkflowOrchestrator for maintainability"
      testable: true
      acceptance_criteria: "Single validation function handles all prerequisite checks"
    - id: "FR-009"
      description: "MUST update relevant documentation files (not README) to reflect prerequisite validation behavior"
      testable: true
      acceptance_criteria: "docs/reference.md and docs/troubleshooting.md updated with prerequisite validation info"
    - id: "FR-010"
      description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
      testable: true
      acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
  non_functional:
    - id: "NFR-001"
      category: "performance"
      description: "Prerequisite validation must complete in under 10ms"
      measurable_target: "<10ms for all file existence checks combined"
    - id: "NFR-002"
      category: "usability"
      description: "Error messages must be clear and actionable"
      measurable_target: "Every error includes the specific missing file and command to create it"
    - id: "NFR-003"
      category: "reliability"
      description: "Validation must be consistent across all CLI entry points"
      measurable_target: "Same validation rules applied whether using individual commands or run command"
    - id: "NFR-004"
      category: "code_quality"
      description: "All functions must be under 40 lines; extract helpers for complex logic"
      measurable_target: "No function exceeds 40 lines excluding comments"
    - id: "NFR-005"
      category: "code_quality"
      description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
      measurable_target: "Zero bare 'return err' statements in new code"
    - id: "NFR-006"
      category: "code_quality"
      description: "Tests must use map-based table-driven pattern with t.Parallel()"
      measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
    - id: "NFR-007"
      category: "code_quality"
      description: "Accept interfaces, return concrete types"
      measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users receive immediate feedback when prerequisites are missing"
      metric: "Time from command execution to error display"
      target: "Under 100ms (no Claude invocation)"
    - id: "SC-002"
      description: "All CLI commands validate their prerequisites consistently"
      metric: "Percentage of commands with prerequisite validation"
      target: "100% of stage commands (7 total: specify, plan, tasks, implement, clarify, checklist, analyze)"
    - id: "SC-003"
      description: "Error messages guide users to resolution"
      metric: "Percentage of errors with actionable suggestions"
      target: "100% of prerequisite errors include remediation command"
    - id: "SC-004"
      description: "No API costs incurred for predictably failing operations"
      metric: "Claude invocations when prerequisites missing"
      target: "Zero Claude invocations when validation fails"

key_entities:
  - name: "Stage"
    description: "A workflow step in the autospec pipeline (specify, plan, tasks, implement, etc.)"
    attributes:
      - "name: identifier for the stage"
      - "requiredArtifacts: list of artifacts that must exist before execution"
      - "producedArtifact: the artifact this stage creates"
  - name: "Artifact"
    description: "A YAML file produced by a stage (constitution.yaml, spec.yaml, plan.yaml, tasks.yaml)"
    attributes:
      - "filename: the file name"
      - "location: path relative to spec directory or project root"
      - "producingCommand: the autospec command that creates it"
  - name: "PrerequisiteError"
    description: "An error indicating missing required artifacts"
    attributes:
      - "missingFiles: list of files that don't exist"
      - "remediationCommands: commands to create missing files"

edge_cases:
  - scenario: "User runs command from wrong directory (no spec detected)"
    expected_behavior: "Error message indicates no spec found, suggests specifying spec name or creating new feature"
  - scenario: "Artifact file exists but is empty or corrupted"
    expected_behavior: "File existence check passes; content validation is separate concern (existing preflight checks)"
  - scenario: "User has spec.yaml but in non-standard location"
    expected_behavior: "Existing DetectCurrentSpec logic handles this; validation uses detected spec directory"
  - scenario: "Constitution command itself is run without constitution"
    expected_behavior: "No error - constitution is the one command that doesn't require constitution"
  - scenario: "Run command with -a flag (all stages)"
    expected_behavior: "Only checks constitution since specify is first stage and creates spec.yaml"

assumptions:
  - "Existing file detection logic (DetectCurrentSpec) correctly identifies spec directory"
  - "StageConfig.GetAllRequiredArtifacts() correctly excludes artifacts produced by earlier selected stages"
  - "Constitution path is always .autospec/memory/constitution.yaml relative to project root"
  - "Artifact file existence is sufficient for prerequisite check; content validity is a separate concern"

constraints:
  - "Must use existing infrastructure (artifactDependencies map, GetRequiredArtifacts function)"
  - "Must maintain backward compatibility with existing CLI behavior for valid inputs"
  - "Must not add new command-line flags (no --skip-prereqs)"
  - "Exit codes must follow existing conventions (exit code 3 for invalid arguments/prerequisites)"

out_of_scope:
  - "Content validation of artifact files (handled by existing preflight checks)"
  - "Adding --skip-prereqs flag (users can use slash commands directly if needed)"
  - "Prerequisite validation for slash commands (they run inside active Claude session)"
  - "Validation of artifact schema/structure (separate from existence check)"
  - "Changes to the constitution command itself"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T21:06:47Z"
  artifact_type: "spec"
