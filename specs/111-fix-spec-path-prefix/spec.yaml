feature:
    branch: "111-fix-spec-path-prefix"
    created: "2026-01-30"
    status: "Completed"
    completed_at: 2026-01-30T10:47:39Z
    input: |
        Bug found: In the autospec run -ti command, when the tasks stage completes and validation runs,
        it looks for the wrong path specs/-110-dag-spec-validation/ instead of specs/110-dag-spec-validation/.

        ROOT CAUSE CONFIRMED: When --spec flag or SPECIFY_FEATURE env var is used, spec.Metadata is
        constructed with Name=fullSpecName (e.g., "110-dag-spec-validation") but Number is left empty.
        Later, fmt.Sprintf("%s-%s", Number, Name) produces "-110-dag-spec-validation" (leading dash).

        Bug locations:
        - internal/cli/run.go:175-178 - --spec flag handling (Number not set)
        - internal/prereqs/context.go:159-163 - SPECIFY_FEATURE env var handling (Number not set)

        Affected code (14 locations use fmt.Sprintf("%s-%s", Number, Name)):
        - internal/workflow/stage_executor.go:112, 186
        - internal/workflow/orchestrator.go:335, 422
        - internal/cli/run.go:248, 322
        - internal/cli/clarify.go:93, checklist.go:98, analyze.go:95
        - internal/cli/update_agent_context.go:80
        - internal/cli/stages/plan.go:108, tasks.go:108, implement.go:254

        Note: sanitizePromptForCLI (commit 8935e79) is NOT the cause - it only adds newlines, not dashes.
user_stories:
    - id: "US-001"
      title: "Spec path validation uses correct directory name"
      priority: "P1"
      as_a: "developer using autospec run command"
      i_want: "validation to use the correct spec directory path"
      so_that: "workflow stages complete successfully without path resolution errors"
      why_this_priority: "Bug blocks core workflow functionality - users cannot complete autospec run -ti"
      independent_test: "Run autospec run -ti on a spec with numeric prefix (e.g., 110-feature) and verify validation succeeds"
      acceptance_scenarios:
        - given: "a spec directory named 110-dag-spec-validation exists"
          when: "autospec run -ti executes the tasks stage"
          then: "validation looks for specs/110-dag-spec-validation/, not specs/-110-dag-spec-validation/"
        - given: "a spec with any numeric prefix (001 through 999)"
          when: "validation runs after any stage in autospec run"
          then: "the spec path is constructed as specs/NNN-name/ without leading dash"
    - id: "US-002"
      title: "Spec name format preserved through workflow stages"
      priority: "P1"
      as_a: "developer running multi-stage workflows"
      i_want: "the spec name format to be preserved correctly through all stages"
      so_that: "each stage can locate artifacts in the correct directory"
      why_this_priority: "Affects all multi-stage workflows (run -spti, run -ti, run -pi)"
      independent_test: "Execute run -spti and verify spec name is consistent in debug output across all stages"
      acceptance_scenarios:
        - given: "autospec run -spti creates spec 111-fix-spec-path-prefix"
          when: "workflow transitions from specify to plan to tasks to implement"
          then: "each stage uses specs/111-fix-spec-path-prefix/ as the spec directory"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST construct spec directory path as specsDir/NUMBER-NAME where NUMBER is the 3-digit spec number and NAME is the feature name"
          testable: true
          acceptance_criteria: "Unit test verifies path construction for spec names 001-feature through 999-feature"
        - id: "FR-002"
          description: "MUST NOT prepend any characters (including dash) to the spec number when constructing paths"
          testable: true
          acceptance_criteria: "Regression test confirms no leading dash in spec path for numeric-prefixed specs"
        - id: "FR-003"
          description: "MUST maintain consistent spec name format (NUMBER-NAME) across all workflow stages"
          testable: true
          acceptance_criteria: "Integration test runs full workflow and verifies spec name consistency via debug output"
        - id: "FR-004"
          description: "MUST parse spec name into Number and Name components when constructing Metadata from --spec flag or SPECIFY_FEATURE env var"
          testable: true
          acceptance_criteria: "Unit test verifies Metadata.Number='110' and Metadata.Name='dag-spec-validation' when input is '110-dag-spec-validation'"
        - id: "FR-005"
          description: "MUST fix both bug locations: run.go:175-178 and prereqs/context.go:159-163"
          testable: true
          acceptance_criteria: "Both locations correctly parse spec name into Number and Name before constructing Metadata"
        - id: "FR-006"
          description: "MUST ensure make test && make fmt && make lint && make build all exit 0"
          testable: true
          acceptance_criteria: "All quality gates pass after fix is implemented"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "Functions must be under 40 lines"
          measurable_target: "No function exceeds 40 lines"
        - id: "NFR-002"
          category: "code_quality"
          description: "Errors must be wrapped with context using fmt.Errorf"
          measurable_target: "All error returns include context prefix"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests must use map-based table test pattern"
          measurable_target: "New tests use map[string]struct pattern"
        - id: "NFR-004"
          category: "reliability"
          description: "Validation path construction must be deterministic"
          measurable_target: "Same input always produces same path output"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "autospec run -ti completes without path resolution errors"
          metric: "Command exit code and absence of 'specs/-' in error messages"
          target: "Exit code 0 for valid specs; no paths starting with specs/-"
        - id: "SC-002"
          description: "All existing tests continue to pass"
          metric: "make test exit code"
          target: "Exit code 0"
        - id: "SC-003"
          description: "Regression test prevents future path prefix bugs"
          metric: "New test coverage for spec path construction"
          target: "At least one test case verifies no leading dash in path"
key_entities:
    - name: "specName"
      description: "String identifier for a spec in format NUMBER-NAME (e.g., 110-dag-spec-validation)"
      attributes:
        - "number: 3-digit prefix (001-999)"
        - "name: kebab-case feature name"
        - "combined format: NUMBER-NAME"
        - "constructed via fmt.Sprintf('%s-%s', Number, Name) in 14 locations"
    - name: "specDir"
      description: "Full filesystem path to spec directory"
      attributes:
        - "constructed as specsDir/specName"
        - "must not have leading dash before NUMBER"
    - name: "Metadata"
      description: "Struct containing parsed spec information from spec.go"
      attributes:
        - "Number: string (e.g., '110') - MUST be populated"
        - "Name: string (e.g., 'dag-spec-validation') - feature name only, not full spec name"
        - "Directory: full path to spec"
        - "BUG: run.go:175-178 and prereqs/context.go:159-163 set Name=fullSpecName but leave Number empty"
edge_cases:
    - scenario: "Spec number at boundary (001 or 999)"
      expected_behavior: "Path constructed correctly without leading dash"
    - scenario: "Feature name starts with number (e.g., 110-2fa-implementation)"
      expected_behavior: "Only first 3-digit group treated as spec number"
    - scenario: "Empty spec name passed to validation"
      expected_behavior: "Error returned with clear message"
    - scenario: "Spec directory doesn't exist"
      expected_behavior: "Validation fails with 'not found' error, not path construction error"
    - scenario: "Using --spec flag with full spec name (e.g., --spec 110-dag-spec-validation)"
      expected_behavior: "Metadata.Number and Metadata.Name are correctly parsed from the full spec name"
    - scenario: "Using SPECIFY_FEATURE env var with full spec name"
      expected_behavior: "Metadata.Number and Metadata.Name are correctly parsed from the env var value"
assumptions:
    - "Spec names always follow the NNN-name pattern per existing validation"
clarifications:
    - date: "2026-01-30"
      question: "Where is the spec path incorrectly constructedâ€”during CLI argument preparation, workflow execution, or artifact validation?"
      answer: "Bug is in spec.Metadata construction when using --spec flag or SPECIFY_FEATURE env var. Number field is left empty, causing fmt.Sprintf to produce leading dash."
      applied_to: "assumptions, key_entities, edge_cases, requirements.functional"
constraints:
    - "Fix must not break existing sanitizePromptForCLI security measures"
    - "Fix must maintain backward compatibility with existing spec directories"
    - "Fix must not change the spec naming convention (NNN-name format)"
out_of_scope:
    - "Changing the spec naming convention"
    - "Modifying how sanitizePromptForCLI handles leading dashes for prompts"
    - "Adding new CLI flags or configuration options"
    - "Refactoring the entire workflow execution flow"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.10.3"
    created: "2026-01-30T10:20:06Z"
    artifact_type: "spec"
