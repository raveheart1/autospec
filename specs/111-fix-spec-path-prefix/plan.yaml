plan:
  branch: "111-fix-spec-path-prefix"
  created: "2026-01-30"
  spec_path: "specs/111-fix-spec-path-prefix/spec.yaml"

summary: |
  This fix addresses a bug where spec paths are incorrectly constructed with a leading dash
  (e.g., "specs/-110-dag-spec-validation/" instead of "specs/110-dag-spec-validation/") when
  using the --spec flag or SPECIFY_FEATURE environment variable.

  The root cause is that two code locations construct spec.Metadata with the full spec name
  (e.g., "110-dag-spec-validation") in the Name field but leave the Number field empty. When
  downstream code constructs paths using fmt.Sprintf("%s-%s", Number, Name), the empty Number
  produces a leading dash.

  The fix will leverage the existing spec.GetSpecMetadata() function which already correctly
  parses spec names into Number and Name components using the specDirPattern regex. Both bug
  locations (run.go and prereqs/context.go) will be updated to use this function instead of
  manually constructing Metadata structs.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "cobra"
      version: "v1.8.0"
      purpose: "CLI framework"
    - name: "testify"
      version: "v1.9.0"
      purpose: "Test assertions"
  storage: "None"
  testing:
    framework: "Go testing with testify"
    approach: "Unit tests with map-based table tests for path construction; existing tests must pass"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Validation <10ms per constitution"
  constraints:
    - "Must maintain backward compatibility with existing spec directories"
    - "Must not change spec naming convention (NNN-name format)"
    - "Must not break sanitizePromptForCLI security measures"
    - "Functions must be under 40 lines"
    - "Tests must use map-based table test pattern"
  scale_scope: "Local CLI tool, single user"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Plan includes test creation before implementation changes"
    - name: "Idiomatic Go"
      status: "PASS"
      notes: "Fix reuses existing GetSpecMetadata function; error handling follows fmt.Errorf wrapping pattern"
    - name: "Performance Standards"
      status: "PASS"
      notes: "No new validation functions; existing regex parsing is <10ms"
    - name: "Idempotent Operations"
      status: "N/A"
      notes: "Bug fix does not introduce new operations"
    - name: "Validation-First Workflow"
      status: "PASS"
      notes: "Spec directory validation already exists at both bug locations"
    - name: "Command Template Independence"
      status: "N/A"
      notes: "No template changes required"
    - name: "Actionable Errors"
      status: "PASS"
      notes: "Error messages will retain existing context including spec name"
    - name: "Schema-Driven Artifacts"
      status: "N/A"
      notes: "No artifact schema changes"
    - name: "Test Safety"
      status: "PASS"
      notes: "Tests will use t.TempDir() for isolation"

research_findings:
  decisions:
    - topic: "Approach for fixing Metadata construction"
      decision: "Use existing spec.GetSpecMetadata() function"
      rationale: "GetSpecMetadata already correctly parses spec names using specDirPattern regex and returns properly populated Metadata structs with Number and Name fields"
      alternatives_considered:
        - "Add helper function to parse spec names - rejected as duplicating existing logic"
        - "Inline regex parsing at each bug location - rejected as violating DRY"
    - topic: "Test strategy for regression prevention"
      decision: "Add table-driven tests in spec_test.go for GetSpecMetadata edge cases"
      rationale: "Centralizes spec name parsing tests in the spec package where the logic lives"
      alternatives_considered:
        - "Add tests in run_test.go and prereqs_test.go - rejected as testing internal implementation details"

data_model:
  entities:
    - name: "Metadata"
      description: "Struct containing parsed spec information"
      fields:
        - name: "Name"
          type: "string"
          description: "Feature name only (e.g., 'dag-spec-validation'), NOT full spec name"
          constraints: "Must not include the numeric prefix"
        - name: "Number"
          type: "string"
          description: "3-digit spec number (e.g., '110')"
          constraints: "Must match ^\\d{3}$ pattern"
        - name: "Directory"
          type: "string"
          description: "Full filesystem path to spec directory"
          constraints: "Must exist and be a directory"
        - name: "Branch"
          type: "string"
          description: "Git branch name if in git repo"
          constraints: "Optional, may be empty"
        - name: "Detection"
          type: "DetectionMethod"
          description: "How the spec was detected"
          constraints: "One of: git_branch, fallback, env_var, explicit"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/internal/architecture.md"
      description: "System architecture (no changes needed)"
  source_code:
    - path: "internal/spec/spec.go"
      description: "Spec detection and metadata (existing GetSpecMetadata to be reused)"
    - path: "internal/cli/run.go"
      description: "Run command - BUG LOCATION 1: lines 175-178"
    - path: "internal/prereqs/context.go"
      description: "Prereqs context - BUG LOCATION 2: lines 159-163"
  tests:
    - path: "internal/spec/spec_test.go"
      description: "Spec package tests - add regression tests for leading dash bug"
    - path: "internal/cli/run_test.go"
      description: "Run command tests (if exists)"

implementation_phases:
  - phase: 1
    name: "Test-First Development"
    goal: "Write regression tests that fail before the fix and pass after"
    deliverables:
      - "Add table test case to spec_test.go verifying GetSpecMetadata correctly parses '110-dag-spec-validation'"
      - "Add table test case verifying Number='110' and Name='dag-spec-validation' (not full spec name)"
      - "Add edge case test for spec name starting with number (e.g., '110-2fa-implementation')"
      - "Run tests to confirm they pass (GetSpecMetadata already works correctly)"
  - phase: 2
    name: "Fix Bug Location 1 (run.go)"
    goal: "Replace manual Metadata construction with GetSpecMetadata call"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Modify internal/cli/run.go:175-178 to use spec.GetSpecMetadata(cfg.SpecsDir, specName)"
      - "Handle error from GetSpecMetadata with appropriate error message"
      - "Set Detection field to spec.DetectionExplicit"
  - phase: 3
    name: "Fix Bug Location 2 (context.go)"
    goal: "Replace manual Metadata construction with GetSpecMetadata call"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Modify internal/prereqs/context.go:159-163 to use spec.GetSpecMetadata(specsDir, envFeature)"
      - "Handle error from GetSpecMetadata appropriately"
      - "Set Detection field to spec.DetectionEnvVar"
  - phase: 4
    name: "Validation and Quality Gates"
    goal: "Ensure all tests pass and code quality standards are met"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "Run make test to verify all existing tests pass"
      - "Run make fmt to ensure code formatting"
      - "Run make lint to verify no linting errors"
      - "Run make build to ensure compilation succeeds"

open_questions:
  - question: "Should GetSpecMetadata's error handling be changed if the spec doesn't exist but was explicitly specified?"
    context: "Current code at run.go:171-174 explicitly checks if spec exists before constructing Metadata. GetSpecMetadata also does this check internally."
    proposed_resolution: "Keep the existing explicit existence check for better error messages ('spec not found' vs generic error). Only use GetSpecMetadata for parsing after existence is confirmed, or accept GetSpecMetadata's error message."

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.10.3"
  created: "2026-01-30T10:36:45Z"
  artifact_type: "plan"
