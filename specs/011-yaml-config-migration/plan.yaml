_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "dev"
  created: "2025-12-14T00:00:00Z"
  artifact_type: "plan"

plan:
  branch: "011-yaml-config-migration"
  created: "2025-12-14"
  spec_path: "specs/011-yaml-config-migration/spec.yaml"

summary: |
  This implementation migrates autospec's configuration system from JSON to YAML format,
  introduces a two-tier configuration hierarchy (user-level at ~/.config/autospec/config.yml
  and project-level at .autospec/config.yml), and updates the config loading logic to use
  koanf's YAML parser. The migration maintains backward compatibility with environment
  variable overrides and provides clear error messages for YAML validation failures.

  Key technical decisions include using Go's os.UserConfigDir() for XDG compliance,
  leveraging the existing koanf library with its YAML parser module, and implementing
  a migration command for existing JSON configs. The init command is modified to create
  only user-level config by default, with a new subcommand for project-level config creation.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/knadh/koanf/v2"
      version: "v2.3.0"
      purpose: "Hierarchical configuration management with merge support"
    - name: "github.com/knadh/koanf/parsers/yaml"
      version: "v0.1.0"
      purpose: "YAML parser for koanf configuration loading"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing and validation (already a dependency)"
    - name: "github.com/go-playground/validator/v10"
      version: "v10.28.0"
      purpose: "Struct validation for configuration values"
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI framework for command structure"
  storage: "File system (YAML files at ~/.config/autospec/ and .autospec/)"
  testing:
    framework: "Go testing with testify"
    approach: "Unit tests for config loading, validation, and migration. Integration tests for CLI commands."
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Configuration loading under 100ms (NFR-003)"
  constraints:
    - "Must maintain backward compatibility with AUTOSPEC_* environment variables"
    - "Must not break existing workflows during migration period"
    - "Must work cross-platform (Linux, macOS, Windows)"
    - "Configuration must remain human-readable and editable"
  scale_scope: "Single-user CLI tool with local file-based configuration"

constitution_check:
  constitution_path: ".specify/memory/constitution.md"
  gates:
    - name: "Test-First Development"
      status: "N/A"
      notes: "Constitution is a template, not project-specific. Will follow TDD during implementation."
    - name: "Validation-First"
      status: "PASS"
      notes: "Plan includes YAML validation with clear error messages including line numbers."
    - name: "Performance Standards"
      status: "PASS"
      notes: "Config loading target is 100ms, well within sub-second validation requirement."

research_findings:
  decisions:
    - topic: "User-level config location"
      decision: "Use ~/.config/autospec/config.yml (XDG Base Directory compliant)"
      rationale: "os.UserConfigDir() provides cross-platform XDG compliance. Returns ~/.config on Linux, ~/Library/Application Support on macOS, %APPDATA% on Windows."
      alternatives_considered:
        - "~/.autospec/config.yml - rejected as non-standard location"
        - "~/.autospecrc - rejected as less discoverable"
    - topic: "YAML parser for koanf"
      decision: "Use github.com/knadh/koanf/parsers/yaml"
      rationale: "Koanf already in use for config management. YAML parser is a separate module that integrates seamlessly with existing code pattern."
      alternatives_considered:
        - "Direct gopkg.in/yaml.v3 usage - rejected to maintain consistency with koanf pattern"
        - "Custom parser - rejected as unnecessary complexity"
    - topic: "JSON migration strategy"
      decision: "Provide explicit migration command (autospec config migrate)"
      rationale: "Explicit migration is clearer than auto-migration and gives users control. Warning message when JSON detected."
      alternatives_considered:
        - "Auto-migrate on first load - rejected as potentially surprising"
        - "Support both formats indefinitely - rejected as maintenance burden"
    - topic: "Project config creation"
      decision: "New subcommand: autospec init --project or autospec config init --project"
      rationale: "Keeps init simple for new users while providing explicit path for project-specific config."
      alternatives_considered:
        - "autospec init --local - confusing naming"
        - "Separate autospec project-init command - inconsistent with existing pattern"
    - topic: "XDG_CONFIG_HOME support"
      decision: "Respect XDG_CONFIG_HOME environment variable if set"
      rationale: "Required for spec edge case (XDG_CONFIG_HOME is set to custom location). os.UserConfigDir() handles this automatically."
      alternatives_considered:
        - "Hard-code ~/.config path - rejected as non-compliant"

data_model:
  entities:
    - name: "Configuration"
      description: "The merged effective configuration used by autospec at runtime"
      fields:
        - name: "claude_cmd"
          type: "string"
          description: "Claude CLI command to execute"
          constraints: "required"
        - name: "claude_args"
          type: "[]string"
          description: "Default arguments for Claude CLI"
          constraints: "optional"
        - name: "use_api_key"
          type: "bool"
          description: "Whether to use API key mode"
          constraints: "default: false"
        - name: "custom_claude_cmd"
          type: "string"
          description: "Custom command template with {{PROMPT}} placeholder"
          constraints: "must contain {{PROMPT}} if set"
        - name: "specify_cmd"
          type: "string"
          description: "SpecKit CLI command"
          constraints: "required"
        - name: "max_retries"
          type: "int"
          description: "Maximum retry attempts for failed phases"
          constraints: "min=1, max=10"
        - name: "specs_dir"
          type: "string"
          description: "Directory for feature specifications"
          constraints: "required"
        - name: "state_dir"
          type: "string"
          description: "Directory for retry state storage"
          constraints: "required"
        - name: "skip_preflight"
          type: "bool"
          description: "Skip preflight dependency checks"
          constraints: "default: false"
        - name: "timeout"
          type: "int"
          description: "Command execution timeout in seconds"
          constraints: "0 or 1-604800"
        - name: "show_progress"
          type: "bool"
          description: "Show progress indicators during execution"
          constraints: "default: false"
        - name: "skip_confirmations"
          type: "bool"
          description: "Skip confirmation prompts"
          constraints: "default: false"
      relationships:
        - target: "UserConfiguration"
          type: "composed-from"
          description: "User-level settings provide base values"
        - target: "ProjectConfiguration"
          type: "composed-from"
          description: "Project-level settings override user-level"
    - name: "UserConfiguration"
      description: "User-level configuration stored at ~/.config/autospec/config.yml"
      fields:
        - name: "file_path"
          type: "string"
          description: "Canonical path to user config file"
          constraints: "~/.config/autospec/config.yml or $XDG_CONFIG_HOME/autospec/config.yml"
        - name: "scope"
          type: "string"
          description: "Configuration scope"
          constraints: "constant: user"
      relationships:
        - target: "Configuration"
          type: "contributes-to"
          description: "Provides default values for all projects"
    - name: "ProjectConfiguration"
      description: "Project-level configuration stored at .autospec/config.yml"
      fields:
        - name: "file_path"
          type: "string"
          description: "Path to project config file"
          constraints: ".autospec/config.yml relative to project root"
        - name: "scope"
          type: "string"
          description: "Configuration scope"
          constraints: "constant: project"
      relationships:
        - target: "Configuration"
          type: "contributes-to"
          description: "Overrides user-level settings when present"

api_contracts:
  endpoints:
    - method: "CLI"
      path: "autospec init"
      description: "Initialize user-level configuration (changed from current behavior)"
      request:
        content_type: "CLI arguments"
        body_schema: |
          --force, -f: Overwrite existing config without prompting
      response:
        success_code: 0
        body_schema: |
          Creates ~/.config/autospec/config.yml with defaults
          Installs command templates and scripts (unchanged)
      errors:
        - code: 1
          description: "Failed to create config directory or write file"
    - method: "CLI"
      path: "autospec init --project"
      description: "Create project-level configuration in current directory"
      request:
        content_type: "CLI arguments"
        body_schema: |
          --force, -f: Overwrite existing config without prompting
      response:
        success_code: 0
        body_schema: |
          Creates .autospec/config.yml with defaults
      errors:
        - code: 1
          description: "Failed to create .autospec directory or write file"
    - method: "CLI"
      path: "autospec config migrate"
      description: "Migrate existing JSON config files to YAML format"
      request:
        content_type: "CLI arguments"
        body_schema: |
          --user: Migrate user-level config only
          --project: Migrate project-level config only
          --dry-run: Show what would be migrated without making changes
      response:
        success_code: 0
        body_schema: |
          Converts config.json to config.yml
          Optionally removes or renames old JSON file
      errors:
        - code: 1
          description: "No JSON config found to migrate"
        - code: 2
          description: "Migration failed (parse error, write error)"
    - method: "CLI"
      path: "autospec config show"
      description: "Display effective configuration with source information"
      request:
        content_type: "CLI arguments"
        body_schema: |
          --json: Output as JSON
          --yaml: Output as YAML (default)
      response:
        success_code: 0
        body_schema: |
          Displays merged configuration values
          Shows source (default/user/project/env) for each value
      errors:
        - code: 1
          description: "Configuration loading failed"

project_structure:
  documentation:
    - path: "CLAUDE.md"
      description: "Update configuration section with new YAML paths and precedence"
    - path: "README.md"
      description: "Update configuration documentation for new structure"
  source_code:
    - path: "internal/config/config.go"
      description: "Update Load() to support YAML and new paths"
    - path: "internal/config/paths.go"
      description: "New file for config path resolution (XDG support)"
    - path: "internal/config/migrate.go"
      description: "New file for JSON to YAML migration logic"
    - path: "internal/config/validate.go"
      description: "New file for YAML-specific validation with line numbers"
    - path: "internal/cli/init.go"
      description: "Update init command for user-level only default"
    - path: "internal/cli/config.go"
      description: "Implement config subcommands (show, migrate)"
  tests:
    - path: "internal/config/config_test.go"
      description: "Update existing tests, add YAML-specific tests"
    - path: "internal/config/paths_test.go"
      description: "Tests for path resolution and XDG support"
    - path: "internal/config/migrate_test.go"
      description: "Tests for JSON to YAML migration"
    - path: "internal/config/validate_test.go"
      description: "Tests for YAML validation error messages"
    - path: "internal/cli/init_test.go"
      description: "Tests for updated init command behavior"
    - path: "internal/cli/config_test.go"
      description: "Tests for config subcommands"

implementation_phases:
  - phase: 1
    name: "Core YAML Configuration Loading"
    goal: "Replace JSON config loading with YAML while maintaining all existing functionality"
    deliverables:
      - "Add koanf YAML parser dependency"
      - "Create paths.go with UserConfigPath() and ProjectConfigPath() functions"
      - "Update config.go Load() to use YAML parser and new paths"
      - "Update defaults.go if needed for YAML compatibility"
      - "Write unit tests for path resolution"
      - "Write unit tests for YAML config loading"
  - phase: 2
    name: "Configuration Precedence and Merging"
    goal: "Implement correct precedence: env > project YAML > user YAML > defaults"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Update Load() to load user config from ~/.config/autospec/config.yml"
      - "Update Load() to load project config from .autospec/config.yml"
      - "Ensure proper merge order with koanf"
      - "Write integration tests for precedence behavior"
      - "Test partial config override scenarios"
  - phase: 3
    name: "YAML Validation with Error Messages"
    goal: "Provide clear, actionable error messages for YAML syntax and schema errors"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Create validate.go with YAML syntax validation"
      - "Implement error messages with file path and line numbers"
      - "Handle edge cases (empty file, missing file, permission errors)"
      - "Handle unknown keys gracefully (warn in debug mode)"
      - "Write unit tests for all error scenarios"
  - phase: 4
    name: "Init Command Update"
    goal: "Change init to create user-level config by default, add --project flag"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Update init.go to create user config at ~/.config/autospec/config.yml"
      - "Add --project flag to create .autospec/config.yml"
      - "Remove --global flag (user-level is now default)"
      - "Update help text and examples"
      - "Write tests for new init behavior"
  - phase: 5
    name: "Migration Command"
    goal: "Provide migration path from JSON to YAML for existing users"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Create migrate.go with JSON to YAML conversion logic"
      - "Implement autospec config migrate command"
      - "Add --dry-run flag for preview"
      - "Add warning when JSON config detected during load"
      - "Write tests for migration scenarios"
  - phase: 6
    name: "Config Show Command"
    goal: "Implement config show command for debugging configuration"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Implement autospec config show command"
      - "Show effective values with source attribution"
      - "Support --yaml and --json output formats"
      - "Write tests for config show"
  - phase: 7
    name: "Documentation Update"
    goal: "Update all documentation to reflect new configuration system"
    dependencies:
      - "Phase 4"
      - "Phase 5"
      - "Phase 6"
    deliverables:
      - "Update CLAUDE.md configuration section"
      - "Update README.md with new config paths and commands"
      - "Add migration guide for existing users"
      - "Update CLI help text throughout"

risks:
  - risk: "Breaking existing user workflows"
    likelihood: "medium"
    impact: "high"
    mitigation: "Provide migration command, detect JSON and show migration warning, support transition period"
  - risk: "Platform-specific path issues (Windows backslashes, macOS Library paths)"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Use os.UserConfigDir() which handles platform differences, test on all platforms"
  - risk: "YAML parsing edge cases (special characters, unicode)"
    likelihood: "low"
    impact: "low"
    mitigation: "Use well-tested yaml.v3 library, add comprehensive test cases"
  - risk: "Users confused by two config locations"
    likelihood: "medium"
    impact: "low"
    mitigation: "Clear documentation, config show command shows source of each value"

open_questions:
  - question: "Should JSON config support be deprecated immediately or maintained for a transition period?"
    context: "Spec mentions 'JSON format will be deprecated but may remain supported for a transition period'"
    proposed_resolution: "Support JSON reading for one major version with deprecation warning, then remove"
  - question: "Should autospec init --project create config even if user config doesn't exist?"
    context: "Spec says init should NOT create project config by default, but doesn't clarify if project config can exist alone"
    proposed_resolution: "Allow project config creation independently, but recommend user config first"
  - question: "What happens when both config.json and config.yml exist in same location?"
    context: "Edge case in spec: YAML takes precedence, warning issued about JSON file being ignored"
    proposed_resolution: "Implement as specified - load YAML, warn about JSON being ignored, suggest migration"
