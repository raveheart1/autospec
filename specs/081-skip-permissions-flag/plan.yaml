plan:
  branch: "081-skip-permissions-flag"
  created: "2026-01-05"
  spec_path: "specs/081-skip-permissions-flag/spec.yaml"

summary: |
  This feature adds a simple boolean configuration field `skip_permissions` that enables
  autonomous mode (--dangerously-skip-permissions) for Claude agent execution without
  requiring verbose custom_agent configuration boilerplate. When set to true, the value
  flows through Configuration -> ClaudeExecutor -> ExecOptions.Autonomous -> command args.

  The implementation follows established patterns from existing boolean config fields
  (UseSubscription, AutoCommit) and leverages the already-working ExecOptions.Autonomous
  and appendAutonomousArgs() infrastructure. The change requires updates to four config
  files (config.go, schema.go, defaults.go, template) plus wiring in workflow/claude.go.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "koanf"
      version: "v2"
      purpose: "Hierarchical configuration management with env var support"
    - name: "yaml.v3"
      version: "v3"
      purpose: "YAML parsing for config files"
  storage: "None"
  testing:
    framework: "go test"
    approach: "Unit tests with map-based table-driven pattern, integration tests for config loading"
  target_platform: "Linux, macOS, Windows (cross-platform Go binary)"
  project_type: "cli"
  performance_goals: "Config loading <100ms (existing contract)"
  constraints:
    - "Default must be false for security reasons (opt-in dangerous flag)"
    - "Environment variable must follow AUTOSPEC_* naming convention"
    - "Must work with existing ExecOptions.Autonomous flow"
    - "Only affects Claude agent (other agents have different autonomous mechanisms)"
  scale_scope: "Single config field addition affecting Claude agent execution"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Will write tests before implementation for config loading, schema validation, and command building"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "Config field addition doesn't affect workflow phase validation"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Single boolean field read has negligible impact on config loading (<100ms)"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Changes follow existing patterns - no new functions needed, just field additions"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "Will run make fmt && make lint before commit"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "Config field uses YAML with koanf tags, follows existing field patterns"

research_findings:
  decisions:
    - topic: "Where to read skip_permissions and pass to ExecOptions.Autonomous"
      decision: "Read in ClaudeExecutor.executeWithAgent() from config, pass to ExecOptions"
      rationale: "ClaudeExecutor already has access to config via UseSubscription field; mirrors that pattern"
      alternatives_considered:
        - "Read in Orchestrator - rejected: would require plumbing through many layers"
        - "Read in workflow.Executor - rejected: ClaudeExecutor is closer to agent execution"

    - topic: "Field name choice"
      decision: "Use skip_permissions (16 chars) per spec constraint"
      rationale: "Concise, self-documenting, avoids duplicating the verbose flag name"
      alternatives_considered:
        - "autonomous_mode - too generic, doesn't convey the permission-skipping aspect"
        - "dangerously_skip_permissions - too verbose, copies the full flag name"

    - topic: "Environment variable handling"
      decision: "Use AUTOSPEC_SKIP_PERMISSIONS - automatic via existing koanf env loader"
      rationale: "koanf envTransform already converts AUTOSPEC_* to config keys via underscore mapping"
      alternatives_considered:
        - "Manual env var handling - rejected: unnecessary duplication of existing mechanism"

    - topic: "Configuration struct placement"
      decision: "Add SkipPermissions field to Configuration struct in config.go"
      rationale: "Follows pattern of other boolean fields (UseSubscription, AutoCommit, SkipPreflight)"
      alternatives_considered:
        - "Nested config struct - rejected: overkill for single boolean field"

data_model:
  entities:
    - name: "Configuration"
      description: "Main autospec config struct holding all settings"
      fields:
        - name: "SkipPermissions"
          type: "bool"
          description: "When true, adds --dangerously-skip-permissions flag to Claude commands"
          constraints: "Must default to false (opt-in for security)"
      relationships:
        - target: "ClaudeExecutor"
          type: "one-to-one"
          description: "Config value flows to ClaudeExecutor which builds ExecOptions"

    - name: "ExecOptions"
      description: "Options passed to agent execution (already exists)"
      fields:
        - name: "Autonomous"
          type: "bool"
          description: "Already exists - enables headless mode with no user confirmations"
          constraints: "Set from Configuration.SkipPermissions for Claude agent"
      relationships:
        - target: "BaseAgent"
          type: "one-to-one"
          description: "ExecOptions.Autonomous triggers appendAutonomousArgs() in BaseAgent"

    - name: "ClaudeExecutor"
      description: "Handles CLI agent command execution in workflow package"
      fields:
        - name: "SkipPermissions"
          type: "bool"
          description: "New field to hold the config value"
          constraints: "Set from Configuration during executor creation"
      relationships:
        - target: "Configuration"
          type: "one-to-one"
          description: "ClaudeExecutor receives config value during construction"
        - target: "ExecOptions"
          type: "one-to-one"
          description: "ClaudeExecutor sets ExecOptions.Autonomous from SkipPermissions"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/reference.md"
      description: "May need update to document new config option"
  source_code:
    - path: "internal/config/config.go"
      description: "Add SkipPermissions field to Configuration struct"
    - path: "internal/config/schema.go"
      description: "Add skip_permissions entry to KnownKeys map"
    - path: "internal/config/defaults.go"
      description: "Add skip_permissions default value (false) and template comment"
    - path: "internal/workflow/claude.go"
      description: "Add SkipPermissions field to ClaudeExecutor, wire to ExecOptions.Autonomous"
  tests:
    - path: "internal/config/config_test.go"
      description: "Add tests for skip_permissions config loading and env var override"
    - path: "internal/workflow/claude_test.go"
      description: "Add tests verifying ExecOptions.Autonomous is set from SkipPermissions"

implementation_phases:
  - phase: 1
    name: "Config Infrastructure"
    goal: "Add skip_permissions field to configuration system"
    deliverables:
      - "Add SkipPermissions bool field to Configuration struct in config.go"
      - "Add skip_permissions entry to KnownKeys map in schema.go"
      - "Add skip_permissions default (false) to GetDefaults() in defaults.go"
      - "Add skip_permissions comment to GetDefaultConfigTemplate() in defaults.go"
      - "Unit tests for config loading and env var precedence"

  - phase: 2
    name: "Executor Wiring"
    goal: "Pass skip_permissions value through ClaudeExecutor to ExecOptions"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Add SkipPermissions field to ClaudeExecutor struct"
      - "Set ExecOptions.Autonomous from SkipPermissions in executeWithAgent()"
      - "Update all ClaudeExecutor instantiation sites to pass config.SkipPermissions"
      - "Unit tests verifying Autonomous flag is set correctly"

  - phase: 3
    name: "Quality Gates"
    goal: "Ensure all quality checks pass"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Run make fmt and fix any formatting issues"
      - "Run make lint and fix any linter errors"
      - "Run make test and ensure all tests pass"
      - "Run make build and ensure clean build"

open_questions:
  - question: "Should there be a warning when skip_permissions is enabled?"
    context: "The flag is dangerous and could lead to unintended changes"
    proposed_resolution: "Out of scope per spec - existing SkipPermissionsNoticeShown logic handles this"

  - question: "Should skip_permissions work with custom_agent?"
    context: "Custom agents have full control over their command args"
    proposed_resolution: "No - spec states custom_agent takes full control; skip_permissions is ignored for custom agents"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.1"
  created: "2026-01-06T03:28:05Z"
  artifact_type: "plan"
