feature:
  branch: "081-skip-permissions-flag"
  created: "2026-01-06"
  status: "Draft"
  input: |
    Simple boolean configuration setting for Claude execution with --dangerously-skip-permissions flag.
    A concise flag name that when enabled applies the Claude arg. Default false (opt-in because it is dangerous).
    Currently users must use the verbose custom_agent configuration to enable this flag - too much boilerplate.

user_stories:
  - id: "US-001"
    title: "Enable autonomous mode via simple config flag"
    priority: "P1"
    as_a: "developer using autospec with Claude agent"
    i_want: "a simple boolean configuration option to enable autonomous mode"
    so_that: "I don't have to write verbose custom_agent configuration just to skip permission prompts"
    why_this_priority: "Core feature request - eliminates significant configuration friction"
    independent_test: "Set the flag and verify --dangerously-skip-permissions appears in Claude command"
    acceptance_scenarios:
      - given: "skip_permissions is set to true in config"
        when: "autospec runs a workflow stage with Claude agent"
        then: "--dangerously-skip-permissions flag is included in the Claude CLI command"
      - given: "skip_permissions is not set (defaults to false)"
        when: "autospec runs a workflow stage with Claude agent"
        then: "--dangerously-skip-permissions flag is NOT included in the Claude CLI command"
      - given: "a non-Claude agent is configured (e.g., gemini, opencode)"
        when: "skip_permissions is set to true"
        then: "the setting has no effect (other agents don't support this flag)"

  - id: "US-002"
    title: "Configure skip_permissions via environment variable"
    priority: "P2"
    as_a: "developer running autospec in CI/CD"
    i_want: "to set skip_permissions via environment variable"
    so_that: "I can enable autonomous mode without modifying config files in ephemeral environments"
    why_this_priority: "Follows established config pattern, important for CI/CD usage"
    independent_test: "Set AUTOSPEC_SKIP_PERMISSIONS=true and verify flag is applied"
    acceptance_scenarios:
      - given: "AUTOSPEC_SKIP_PERMISSIONS environment variable is set to true"
        when: "autospec runs with Claude agent"
        then: "--dangerously-skip-permissions flag is included in the command"
      - given: "env var is true but config file sets skip_permissions: false"
        when: "autospec runs with Claude agent"
        then: "environment variable takes precedence (flag is included)"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST add skip_permissions boolean field to Configuration struct"
      testable: true
      acceptance_criteria: "Field exists in internal/config/config.go with koanf tag"
    - id: "FR-002"
      description: "MUST default skip_permissions to false (opt-in for safety)"
      testable: true
      acceptance_criteria: "New configs have skip_permissions: false by default"
    - id: "FR-003"
      description: "MUST only apply --dangerously-skip-permissions when agent is Claude"
      testable: true
      acceptance_criteria: "Test verifies flag appears only for Claude agent, not for gemini/opencode/other agents"
    - id: "FR-004"
      description: "MUST pass skip_permissions value through to ExecOptions.Autonomous field"
      testable: true
      acceptance_criteria: "When skip_permissions is true, ExecOptions.Autonomous is set to true"
    - id: "FR-005"
      description: "MUST support AUTOSPEC_SKIP_PERMISSIONS environment variable"
      testable: true
      acceptance_criteria: "Environment variable overrides config file value"
    - id: "FR-006"
      description: "SHOULD include skip_permissions in generated config file comments"
      testable: true
      acceptance_criteria: "autospec init shows skip_permissions option in generated config template"
    - id: "FR-007"
      description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
      testable: true
      acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"

  non_functional:
    - id: "NFR-001"
      category: "code_quality"
      description: "All functions must be under 40 lines; extract helpers for complex logic"
      measurable_target: "No function exceeds 40 lines excluding comments"
    - id: "NFR-002"
      category: "code_quality"
      description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
      measurable_target: "Zero bare 'return err' statements in new code"
    - id: "NFR-003"
      category: "code_quality"
      description: "Tests must use map-based table-driven pattern"
      measurable_target: "All new test functions use map[string]struct pattern"
    - id: "NFR-004"
      category: "code_quality"
      description: "Accept interfaces, return concrete types"
      measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
    - id: "NFR-005"
      category: "security"
      description: "Configuration must default to most restrictive setting (false)"
      measurable_target: "skip_permissions defaults to false in loadDefaults()"
    - id: "NFR-006"
      category: "usability"
      description: "Config field name must be concise and self-documenting"
      measurable_target: "Field name is skip_permissions (16 chars) not dangerously_skip_permissions"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can enable autonomous mode with a single line of config"
      metric: "Lines of config required to enable autonomous mode"
      target: "1 line (skip_permissions: true) vs current 6+ lines with custom_agent"
    - id: "SC-002"
      description: "Existing workflows continue to work without modification"
      metric: "Backward compatibility test suite"
      target: "100% of existing tests pass without changes"
    - id: "SC-003"
      description: "Configuration follows existing patterns"
      metric: "Consistency with other boolean config fields"
      target: "Same pattern as use_subscription, auto_commit, enable_risk_assessment"

key_entities:
  - name: "Configuration"
    description: "The main config struct that holds all autospec settings"
    attributes:
      - "skip_permissions: bool - new field to enable autonomous mode"
      - "Follows same pattern as UseSubscription and AutoCommit fields"
  - name: "ExecOptions"
    description: "Options passed to agent execution"
    attributes:
      - "Autonomous: bool - already exists, needs to be set from config"
  - name: "ClaudeExecutor"
    description: "Workflow executor that wraps agent execution"
    attributes:
      - "Needs to read skip_permissions from config and pass to ExecOptions"

edge_cases:
  - scenario: "skip_permissions set to true with non-Claude agent (gemini, opencode, cline, etc.)"
    expected_behavior: "ExecOptions.Autonomous is set true but each agent's AutonomousFlag determines what flag (if any) is added - Claude adds --dangerously-skip-permissions, others add their own or nothing"
  - scenario: "custom_agent config overrides agent_preset: claude"
    expected_behavior: "custom_agent takes full control; skip_permissions is ignored for custom agents"
  - scenario: "Environment variable AUTOSPEC_SKIP_PERMISSIONS set to invalid value"
    expected_behavior: "Parse as boolean - non-true values default to false"
  - scenario: "skip_permissions true with agent_preset: gemini"
    expected_behavior: "Gemini agent receives Autonomous=true but Gemini has no AutonomousFlag, so no flag is added"

assumptions:
  - "The existing ExecOptions.Autonomous field and appendAutonomousArgs() logic already works correctly"
  - "Each agent defines its own AutonomousFlag in Caps - Claude uses --dangerously-skip-permissions, others vary"
  - "The appendAutonomousArgs() method already checks AutonomousFlag != '' before adding the flag"
  - "Users understand the security implications of enabling this flag (documented elsewhere)"

constraints:
  - "Field name must be concise - avoid replicating the full flag name"
  - "Must follow existing config field patterns for consistency"
  - "Environment variable must follow AUTOSPEC_* naming convention"
  - "Default must be false for security reasons"

out_of_scope:
  - "Adding similar flags for other agents (each agent has different autonomous mechanisms)"
  - "Adding CLI flag override (--skip-permissions on command line)"
  - "Adding warnings or confirmations when enabling this setting"
  - "Documenting security implications (already covered by existing SkipPermissionsNoticeShown logic)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.1"
  created: "2026-01-06T03:19:55Z"
  artifact_type: "spec"
