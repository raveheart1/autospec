plan:
  branch: "077-opencode-agent-preset"
  created: "2026-01-02"
  spec_path: "specs/077-opencode-agent-preset/spec.yaml"

summary: |
  This plan implements first-class OpenCode agent support in autospec, enabling users to run
  spec-based development workflows using OpenCode as their AI agent. The implementation adds
  a new PromptMethod type for OpenCode's unique command invocation pattern, implements the
  Configurator interface for OpenCode to install slash commands and configure permissions,
  refactors command templates to be agent-agnostic by using AGENTS.md as the primary
  constitution source, and enables the existing multi-agent selection UI in production builds.

  Key technical decisions include: (1) Adding a new PromptMethodSubcommandWithFlag type to
  handle OpenCode's `opencode run <args> --command <name>` pattern rather than overloading
  ExtraArgs, (2) Installing commands to .opencode/command/ (singular) per OpenCode's
  directory structure, (3) Configuring permissions in ./opencode.json at project root, and
  (4) Restricting production builds to Claude and OpenCode agents only while keeping all
  agents available in dev builds.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.1"
      purpose: "CLI framework for command structure"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for opencode.json and config files"
    - name: "github.com/fatih/color"
      version: "v1.18.0"
      purpose: "Terminal color output for init command"
    - name: "golang.org/x/term"
      version: "v0.27.0"
      purpose: "Terminal detection for interactive prompts"
  storage: "JSON (opencode.json)"
  testing:
    framework: "go test"
    approach: "Table-driven unit tests for all new functions; integration tests for init flow"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "All validation functions <10ms; CLI startup <50ms"
  constraints:
    - "Must maintain backward compatibility with Claude Code"
    - "Cannot introduce agent-specific logic in internal/commands/*.md"
    - "Production builds: Claude + OpenCode only"
    - "All functions under 40 lines"
    - "All errors wrapped with context"
  scale_scope: "Single developer workflow automation"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All new functions will have table-driven tests written before implementation"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "OpenCode agent validation follows existing cliagent.Validate() pattern"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "OpenCode Configurator operations are file I/O only, will complete <10ms"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "ConfigureProject() is idempotent - can be called multiple times safely"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "All code follows function length, error wrapping, and testing requirements"
    - name: "Command Template Independence (PRIN-012)"
      status: "PASS"
      notes: "Templates updated to use AGENTS.md with fallback - no agent-specific syntax"

research_findings:
  decisions:
    - topic: "OpenCode slash command invocation pattern"
      decision: "Add new PromptMethodSubcommandWithFlag type"
      rationale: |
        OpenCode uses 'opencode run <args> --command <command-name>' which differs from
        existing patterns. This needs a new PromptMethod type rather than using ExtraArgs
        because the --command flag comes AFTER the args/prompt, which is semantically
        different from default args that come before.
      alternatives_considered:
        - "Use ExtraArgs to append --command flag (rejected: order matters)"
        - "Modify PromptMethodSubcommand to accept optional CommandFlag field (rejected: breaks existing usage)"

    - topic: "OpenCode command directory structure"
      decision: "Install to .opencode/command/ (singular)"
      rationale: |
        OpenCode uses .opencode/command/ (singular) while Claude uses .claude/commands/
        (plural). This is documented in OpenCode's architecture and must be respected.
      alternatives_considered:
        - "Use same .claude/commands/ path for all agents (rejected: doesn't work with OpenCode)"

    - topic: "OpenCode permission configuration"
      decision: "Add 'autospec *': 'allow' to ./opencode.json permission.bash section"
      rationale: |
        OpenCode's permission system uses glob patterns in opencode.json at project root.
        The 'autospec *' pattern allows all autospec CLI commands without prompting.
      alternatives_considered:
        - "Skip permission configuration (rejected: would require manual approval for every command)"
        - "Add specific command permissions (rejected: glob is cleaner and matches Claude pattern)"

    - topic: "Production agent filtering"
      decision: "Gate production builds to Claude + OpenCode only via build.ProductionAgents()"
      rationale: |
        The existing MultiAgentEnabled() flag controls whether agent selection UI shows.
        Adding a new ProductionAgents() function allows fine-grained control over which
        agents are available in production vs dev builds.
      alternatives_considered:
        - "Hardcode list in init command (rejected: violates single responsibility)"
        - "Config-based agent filtering (rejected: adds complexity, users shouldn't choose unsupported agents)"

    - topic: "Template constitution reference update"
      decision: "Use AGENTS.md as primary with fallback to CLAUDE.md"
      rationale: |
        AGENTS.md serves as universal agent instructions file for multi-agent support.
        Fallback to CLAUDE.md maintains backward compatibility for existing projects.
      alternatives_considered:
        - "Use only AGENTS.md (rejected: breaks existing projects with CLAUDE.md)"
        - "Create separate templates per agent (rejected: violates single-source principle)"

data_model:
  entities:
    - name: "PromptMethodSubcommandWithFlag"
      description: "New prompt delivery method for subcommand + trailing flag pattern"
      fields:
        - name: "Method"
          type: "PromptMethod"
          description: "Constant value PromptMethodSubcommandWithFlag"
          constraints: "Must equal 'subcommand-with-flag'"
        - name: "Flag"
          type: "string"
          description: "Subcommand name (e.g., 'run')"
          constraints: "Non-empty"
        - name: "CommandFlag"
          type: "string"
          description: "Flag for command name (e.g., '--command')"
          constraints: "Non-empty for this method"
      relationships:
        - target: "PromptDelivery"
          type: "field-of"
          description: "CommandFlag field added to PromptDelivery struct"

    - name: "OpenCodeConfig"
      description: "OpenCode configuration from opencode.json"
      fields:
        - name: "Permission"
          type: "OpenCodePermission"
          description: "Permission settings object"
          constraints: "Optional, created if missing"
      relationships:
        - target: "opencode.json"
          type: "serialized-to"
          description: "JSON file at project root"

    - name: "OpenCodePermission"
      description: "Permission rules for OpenCode"
      fields:
        - name: "Bash"
          type: "map[string]string"
          description: "Bash command permission rules"
          constraints: "Keys are glob patterns, values are 'allow'|'ask'|'deny'"
      relationships:
        - target: "OpenCodeConfig"
          type: "field-of"
          description: "Nested under Permission field"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/internal/agents.md"
      description: "Agent configuration documentation (update with OpenCode details)"
  source_code:
    - path: "internal/cliagent/capabilities.go"
      description: "Add PromptMethodSubcommandWithFlag constant"
    - path: "internal/cliagent/base.go"
      description: "Handle new prompt method in BuildCommand()"
    - path: "internal/cliagent/opencode.go"
      description: "Implement Configurator interface with ConfigureProject()"
    - path: "internal/opencode/settings.go"
      description: "New package for opencode.json manipulation"
    - path: "internal/commands/templates.go"
      description: "Add GetCommandsDir(agentName) for agent-specific paths"
    - path: "internal/commands/autospec.*.md"
      description: "Update CLAUDE.md references to AGENTS.md pattern"
    - path: "internal/cli/config/init_cmd.go"
      description: "Add --ai flag and enable production multi-agent"
    - path: "internal/build/version.go"
      description: "Add ProductionAgents() function"
  tests:
    - path: "internal/cliagent/opencode_test.go"
      description: "Tests for OpenCode Configurator and command building"
    - path: "internal/opencode/settings_test.go"
      description: "Tests for opencode.json loading and manipulation"
    - path: "internal/commands/templates_test.go"
      description: "Tests for agent-specific command directory logic"
    - path: "internal/cli/config/init_cmd_test.go"
      description: "Tests for --ai flag and multi-agent init flow"

implementation_phases:
  - phase: 1
    name: "Core Agent Infrastructure"
    goal: "Add new prompt method type and update OpenCode agent configuration"
    deliverables:
      - "Add PromptMethodSubcommandWithFlag constant to capabilities.go"
      - "Add CommandFlag field to PromptDelivery struct"
      - "Update BuildCommand() in base.go to handle new method"
      - "Update NewOpenCode() to use new prompt method with CommandFlag"
      - "Write tests for new prompt method behavior"

  - phase: 2
    name: "OpenCode Settings Package"
    goal: "Create package for opencode.json manipulation"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Create internal/opencode/ package"
      - "Implement Settings struct for opencode.json structure"
      - "Implement Load() function with JSON parsing"
      - "Implement Save() function with atomic file write"
      - "Implement AddBashPermission() for permission management"
      - "Implement CheckBashPermission() for idempotency"
      - "Write table-driven tests for all functions"

  - phase: 3
    name: "OpenCode Configurator"
    goal: "Implement Configurator interface for OpenCode agent"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Implement ConfigureProject() on OpenCode struct"
      - "Install command templates to .opencode/command/"
      - "Add 'autospec *' permission to opencode.json"
      - "Handle edge cases (existing config, non-autospec commands)"
      - "Write tests for ConfigureProject() behavior"

  - phase: 4
    name: "Agent-Agnostic Command Templates"
    goal: "Update templates to use AGENTS.md with CLAUDE.md fallback"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Update autospec.plan.md CLAUDE.md reference"
      - "Update autospec.constitution.md CLAUDE.md reference"
      - "Update autospec.analyze.md CLAUDE.md references"
      - "Add GetCommandsDir(agentName) to templates.go"
      - "Update InstallTemplates() to accept agent name parameter"
      - "Write tests for agent-specific directory logic"

  - phase: 5
    name: "Init Command Enhancement"
    goal: "Add --ai flag and enable production multi-agent selection"
    dependencies:
      - "Phase 3"
      - "Phase 4"
    deliverables:
      - "Add --ai flag to init command (comma-separated agent list)"
      - "Add ProductionAgents() to internal/build/version.go"
      - "Update handleAgentConfiguration() to filter by ProductionAgents()"
      - "Enable multi-agent selection UI in production builds"
      - "Call correct Configurator for each selected agent"
      - "Write tests for --ai flag parsing and agent filtering"

  - phase: 6
    name: "Feature Parity Verification"
    goal: "Ensure all autospec features work identically for OpenCode"
    dependencies:
      - "Phase 5"
    deliverables:
      - "Verify retry prompt injection works with OpenCode"
      - "Verify timeout configuration works with OpenCode"
      - "Verify all config options work with OpenCode"
      - "Update docs/internal/agents.md with OpenCode details"
      - "Run full quality gates (make test, fmt, lint, build)"

risks:
  - risk: "OpenCode CLI behavior may differ from documentation"
    likelihood: "low"
    impact: "medium"
    mitigation: "Verify command patterns against actual OpenCode CLI during Phase 1"

  - risk: "opencode.json schema may change between versions"
    likelihood: "low"
    impact: "medium"
    mitigation: "Use minimal schema with only required fields; preserve unknown fields on save"

  - risk: "Template updates break existing Claude Code workflows"
    likelihood: "low"
    impact: "high"
    mitigation: "AGENTS.md fallback to CLAUDE.md ensures backward compatibility"

  - risk: "Multi-agent selection UI confuses production users"
    likelihood: "medium"
    impact: "low"
    mitigation: "Default to Claude; clear labeling; only show Claude + OpenCode in production"

open_questions:
  - question: "Should autospec init --ai without arguments show interactive prompt?"
    context: "FR-008 mentions enabling existing multi-select checklist UI without --ai flag"
    proposed_resolution: "Yes - autospec init (no --ai) shows interactive checklist; --ai claude,opencode bypasses prompt"

  - question: "How should constitution file precedence work with multiple agents?"
    context: "AGENTS.md is primary, but projects may have agent-specific files"
    proposed_resolution: "AGENTS.md (universal) > agent-specific (CLAUDE.md/OPENCODE.md) > none (warn user)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2026-01-02T01:32:44Z"
  artifact_type: "plan"
