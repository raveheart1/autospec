feature:
    branch: "089-dag-resume-merge"
    created: "2026-01-11"
    status: "Completed"
    completed_at: 2026-01-11T17:14:20Z
    input: |
        DAG Resume & Merge - Resume failed/interrupted runs and auto-merge completed specs
        with AI-assisted conflict resolution. Part of DAG Multi-Spec Orchestration.

        Commands:
        - autospec dag resume <run-id> - Resume paused/failed run
        - autospec dag merge <run-id> [--branch <target>] - Merge completed specs to target branch
        - autospec dag merge --continue - Continue merge after manual conflict resolution
        - autospec dag cleanup <run-id> - Remove worktrees for completed run

        Resume: Load run state, skip completed specs, detect stale processes via lock file
        with heartbeat mechanism, retry failed/interrupted specs.

        Merge: Auto-merge in dependency order, configurable conflict handling (manual or agent),
        AI-assisted conflict resolution with fallback to manual.

        Cleanup: Remove worktrees after merge, preserve failed/unmerged for debugging.
user_stories:
    - id: "US-001"
      title: "Resume interrupted DAG run"
      priority: "P1"
      as_a: "developer running multi-spec workflows"
      i_want: "to resume a paused or failed DAG run from where it left off"
      so_that: "I don't lose progress and can continue without restarting everything"
      why_this_priority: "Core functionality - interrupted runs are common and losing progress is costly"
      independent_test: "Start a DAG run, interrupt it, then resume and verify only incomplete specs are processed"
      acceptance_scenarios:
        - given: "a DAG run was interrupted with 3 of 5 specs completed"
          when: "I run 'dag resume <run-id>'"
          then: "only the 2 incomplete specs are executed, completed specs are skipped"
        - given: "a spec failed during execution"
          when: "I run 'dag resume <run-id>'"
          then: "the failed spec is retried from its failure point"
        - given: "a process became stale (heartbeat >2 minutes old)"
          when: "I run 'dag resume <run-id>'"
          then: "the stale spec is marked as interrupted and can be retried"
    - id: "US-002"
      title: "Merge completed specs automatically"
      priority: "P1"
      as_a: "developer with multiple completed specs"
      i_want: "to merge all completed specs to a target branch in one command"
      so_that: "I can consolidate work efficiently without manual branch management"
      why_this_priority: "Core functionality - merging is the culmination of the DAG workflow"
      independent_test: "Complete multiple specs in worktrees, merge them all to main, verify all changes present"
      acceptance_scenarios:
        - given: "a DAG run with 3 completed specs"
          when: "I run 'dag merge <run-id>'"
          then: "all 3 specs are merged to the base branch in dependency order"
        - given: "spec A depends on spec B"
          when: "I run 'dag merge <run-id>'"
          then: "spec B is merged before spec A regardless of completion order"
        - given: "I want to merge to a different branch"
          when: "I run 'dag merge <run-id> --branch develop'"
          then: "specs are merged to the develop branch instead of the default"
    - id: "US-003"
      title: "Resolve merge conflicts with AI assistance"
      priority: "P1"
      as_a: "developer encountering merge conflicts"
      i_want: "the system to attempt automatic conflict resolution using AI"
      so_that: "I can merge most conflicts without manual intervention"
      why_this_priority: "Key differentiator - AI-assisted resolution saves significant time"
      independent_test: "Create conflicting changes, trigger merge, verify AI resolves or provides context for manual resolution"
      acceptance_scenarios:
        - given: "a merge conflict occurs with on_conflict set to 'agent'"
          when: "the merge process encounters the conflict"
          then: "an agent is spawned with spec context to resolve the conflict automatically"
        - given: "a merge conflict occurs with on_conflict set to 'manual'"
          when: "the merge process encounters the conflict"
          then: "a copy-pastable context block is output for manual resolution"
        - given: "the agent fails to resolve after 3 attempts"
          when: "all resolution attempts fail"
          then: "the spec is marked as merge_failed and manual intervention is requested"
    - id: "US-004"
      title: "Continue merge after manual resolution"
      priority: "P2"
      as_a: "developer who resolved a conflict manually"
      i_want: "to continue the merge process from where it paused"
      so_that: "I don't have to restart the entire merge operation"
      why_this_priority: "Important for workflow continuity but depends on US-003"
      independent_test: "Pause on conflict, resolve manually, run continue, verify remaining specs merge"
      acceptance_scenarios:
        - given: "a merge was paused due to an unresolved conflict"
          when: "I resolve the conflict manually and run 'dag merge --continue'"
          then: "the merge resumes with the remaining specs"
        - given: "I want to skip a failed spec"
          when: "I run 'dag merge --skip-failed'"
          then: "the failed spec is skipped and merge continues with others"
    - id: "US-005"
      title: "Clean up worktrees after completion"
      priority: "P2"
      as_a: "developer with completed DAG runs"
      i_want: "to clean up worktrees that are no longer needed"
      so_that: "I don't accumulate disk space and cluttered directories"
      why_this_priority: "Important for maintenance but not critical for core workflow"
      independent_test: "Complete and merge specs, run cleanup, verify worktrees are removed"
      acceptance_scenarios:
        - given: "a DAG run with all specs merged"
          when: "I run 'dag cleanup <run-id>'"
          then: "all worktrees for merged specs are deleted"
        - given: "a DAG run with some unmerged specs"
          when: "I run 'dag cleanup <run-id>'"
          then: "merged specs are deleted, unmerged are kept with a warning"
        - given: "a worktree has uncommitted changes"
          when: "I run 'dag cleanup <run-id>'"
          then: "the worktree is kept unless --force is specified"
    - id: "US-006"
      title: "Detect and handle stale processes"
      priority: "P2"
      as_a: "developer resuming after a crash or timeout"
      i_want: "the system to detect processes that are no longer running"
      so_that: "I can safely resume without conflicts from zombie processes"
      why_this_priority: "Enables reliable resume functionality"
      independent_test: "Simulate stale lock file with old heartbeat, resume, verify spec marked as interrupted"
      acceptance_scenarios:
        - given: "a lock file exists with a heartbeat older than 2 minutes"
          when: "I run 'dag resume <run-id>'"
          then: "the spec is marked as interrupted and available for retry"
        - given: "a lock file exists with a recent heartbeat"
          when: "I run 'dag resume <run-id>'"
          then: "the spec is considered still running and not retried"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST load run state from .autospec/state/dag-runs/<run-id>.yaml on resume"
          testable: true
          acceptance_criteria: "Run state is correctly loaded with all spec statuses preserved"
        - id: "FR-002"
          description: "MUST skip specs with status 'completed' when resuming"
          testable: true
          acceptance_criteria: "Completed specs are not re-executed on resume"
        - id: "FR-003"
          description: "MUST detect stale processes via lock file heartbeat mechanism"
          testable: true
          acceptance_criteria: "Lock files with heartbeat >2 minutes old are identified as stale"
        - id: "FR-004"
          description: "MUST update lock file heartbeat every 30 seconds while spec is running"
          testable: true
          acceptance_criteria: "Heartbeat timestamp is refreshed at 30-second intervals"
        - id: "FR-005"
          description: "MUST merge specs in dependency order (dependencies first)"
          testable: true
          acceptance_criteria: "If A depends on B, B is merged before A"
        - id: "FR-006"
          description: "MUST use base_branch from dag.yaml as default merge target"
          testable: true
          acceptance_criteria: "Merge uses configured base_branch when --branch not specified"
        - id: "FR-007"
          description: "MUST support --branch flag to override merge target"
          testable: true
          acceptance_criteria: "Merge uses flag value instead of base_branch when provided"
        - id: "FR-008"
          description: "MUST spawn agent for conflict resolution when on_conflict is 'agent'"
          testable: true
          acceptance_criteria: "Agent is invoked with proper context when conflict detected"
        - id: "FR-009"
          description: "MUST output copy-pastable context block when on_conflict is 'manual'"
          testable: true
          acceptance_criteria: "Context block includes file path, conflict diff, and spec info"
        - id: "FR-010"
          description: "MUST fall back to manual mode after 3 failed agent resolution attempts"
          testable: true
          acceptance_criteria: "After 3 failures, spec marked as merge_failed and context output"
        - id: "FR-011"
          description: "MUST support 'dag merge --continue' to resume paused merge"
          testable: true
          acceptance_criteria: "Merge continues from the paused spec after manual resolution"
        - id: "FR-012"
          description: "MUST support 'dag merge --skip-failed' to skip unresolvable specs"
          testable: true
          acceptance_criteria: "Failed spec is skipped and remaining specs are merged"
        - id: "FR-013"
          description: "MUST delete worktree after successful merge when --cleanup specified"
          testable: true
          acceptance_criteria: "Worktree is removed after its spec is successfully merged"
        - id: "FR-014"
          description: "MUST preserve worktrees for failed or unmerged specs"
          testable: true
          acceptance_criteria: "Unmerged worktrees remain for debugging purposes"
        - id: "FR-015"
          description: "MUST check for uncommitted changes before deleting worktree"
          testable: true
          acceptance_criteria: "Warning displayed if worktree has uncommitted changes"
        - id: "FR-016"
          description: "MUST support --force flag to bypass cleanup safety checks"
          testable: true
          acceptance_criteria: "Worktree deleted regardless of uncommitted changes when --force used"
        - id: "FR-017"
          description: "MUST provide agent with spec ID, name, and description during conflict resolution"
          testable: true
          acceptance_criteria: "Agent context includes full spec metadata from dag.yaml"
        - id: "FR-018"
          description: "MUST update run state with merge status for each spec"
          testable: true
          acceptance_criteria: "Run state reflects merged, merge_failed, or unmerged status"
        - id: "FR-019"
          description: "MUST support 'dag cleanup --all' to clean all old run worktrees"
          testable: true
          acceptance_criteria: "All worktrees from completed runs are cleaned up"
        - id: "FR-020"
          description: "MUST include conflict markers and both branch names in agent context"
          testable: true
          acceptance_criteria: "Context shows <<<<<<< HEAD, =======, >>>>>>> branch markers with names"
        - id: "FR-021"
          description: "MUST make test && make fmt && make lint && make build all exit 0"
          testable: true
          acceptance_criteria: "All quality gates pass with no errors"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "Functions MUST be under 40 lines"
          measurable_target: "No function exceeds 40 lines of code"
        - id: "NFR-002"
          category: "code_quality"
          description: "Errors MUST be wrapped with context using fmt.Errorf"
          measurable_target: "All error returns use fmt.Errorf('doing X: %w', err) pattern"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests MUST use map-based table tests"
          measurable_target: "All table tests use map[string]struct pattern"
        - id: "NFR-004"
          category: "reliability"
          description: "Lock file heartbeat MUST survive process crashes"
          measurable_target: "Stale lock detection works correctly after ungraceful termination"
        - id: "NFR-005"
          category: "usability"
          description: "Conflict context block MUST be self-contained and copy-pastable"
          measurable_target: "User can paste block to any AI assistant without additional context"
        - id: "NFR-006"
          category: "performance"
          description: "Resume command MUST load state and begin execution within 2 seconds"
          measurable_target: "Time from command invocation to first spec execution <2s"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Users can resume an interrupted DAG run and continue from where it stopped"
          metric: "Percentage of interrupted runs that can be successfully resumed"
          target: "100% of runs with valid state files can be resumed"
        - id: "SC-002"
          description: "Completed specs are merged to target branch in correct dependency order"
          metric: "Merge order correctness"
          target: "100% of merges respect dependency ordering"
        - id: "SC-003"
          description: "AI-assisted conflict resolution reduces manual intervention"
          metric: "Percentage of conflicts resolved automatically in agent mode"
          target: ">70% of simple conflicts resolved without user action"
        - id: "SC-004"
          description: "Stale processes are correctly detected and handled"
          metric: "Detection accuracy for processes with heartbeat >2 minutes old"
          target: "100% of stale locks identified correctly"
        - id: "SC-005"
          description: "Worktree cleanup frees disk space without losing important work"
          metric: "Successful cleanup rate for merged specs"
          target: "100% of merged spec worktrees can be cleaned"
key_entities:
    - name: "RunState"
      description: "Persistent state of a DAG run stored in YAML format"
      attributes:
        - "run_id: unique identifier for the run"
        - "status: overall run status (running, paused, completed, failed)"
        - "spec_states: map of spec ID to execution state"
        - "merge_status: map of spec ID to merge state"
    - name: "LockFile"
      description: "Process lock for an executing spec to detect stale processes"
      attributes:
        - "pid: process ID of the running spec executor"
        - "started_at: timestamp when execution began"
        - "heartbeat: last heartbeat timestamp (updated every 30s)"
    - name: "ConflictContext"
      description: "Information provided to agent or user for conflict resolution"
      attributes:
        - "file_path: path to the conflicted file"
        - "conflict_diff: the conflict markers and content"
        - "spec_id: identifier of the spec being merged"
        - "spec_name: human-readable name of the spec"
        - "spec_description: full description from dag.yaml"
        - "source_branch: branch being merged from"
        - "target_branch: branch being merged into"
    - name: "MergeResult"
      description: "Outcome of a merge operation for a spec"
      attributes:
        - "status: merged, merge_failed, skipped, pending"
        - "conflicts: list of conflicted files if any"
        - "resolution_method: agent, manual, or skipped"
edge_cases:
    - scenario: "Resume when all specs are already completed"
      expected_behavior: "Report that all specs are complete, no action taken"
    - scenario: "Resume with corrupted or missing state file"
      expected_behavior: "Error message indicating state file issue, suggest starting fresh"
    - scenario: "Merge with circular dependencies in dag.yaml"
      expected_behavior: "Error during DAG validation, not during merge (validation happens earlier)"
    - scenario: "Multiple conflicts in same merge"
      expected_behavior: "Handle each conflict sequentially, fail on first unresolvable in agent mode"
    - scenario: "Cleanup when worktree directory no longer exists"
      expected_behavior: "Skip with warning, update state to reflect cleanup"
    - scenario: "Resume when another process is actively running the same run"
      expected_behavior: "Detect via fresh heartbeat, warn user, refuse to resume"
    - scenario: "Merge when target branch has diverged significantly"
      expected_behavior: "Merge each spec individually, conflicts handled per spec"
    - scenario: "Agent produces syntactically invalid code during resolution"
      expected_behavior: "Count as failed attempt, retry up to 3 times, then fallback to manual"
    - scenario: "Lock file exists but PID is reused by different process"
      expected_behavior: "Use heartbeat staleness, not PID, to determine if process is dead"
assumptions:
    - "Run state files in .autospec/state/dag-runs/ are not manually modified"
    - "Git worktrees are created in a predictable location based on run-id"
    - "The agent CLI is available and configured for conflict resolution"
    - "Network connectivity is not required for local merge operations"
    - "File system supports atomic writes for lock file updates"
    - "Heartbeat interval of 30 seconds is sufficient for most operations"
    - "2-minute staleness threshold balances detection speed with false positives"
    - "Three agent retry attempts is sufficient before falling back to manual"
constraints:
    - "Must use existing .autospec/state/ directory structure for state storage"
    - "Must integrate with existing worktree management (internal/worktree package)"
    - "Must use existing agent abstraction (internal/agent package) for spawning agents"
    - "Lock files must be compatible across different operating systems"
    - "Merge operations use standard git merge, not rebase or squash"
    - "Sequential merges only - no octopus merge strategy"
out_of_scope:
    - "Pre-merge testing or validation (repository-agnostic approach)"
    - "Octopus merge strategy (sequential merges only)"
    - "Parallel merge execution (merges are sequential by dependency order)"
    - "Conflict prevention through spec isolation (conflicts are expected)"
    - "Custom merge strategies (uses git merge default)"
    - "Remote branch operations (local merges only)"
    - "Automatic retry of entire failed runs (only individual spec retry)"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.8.2"
    created: "2026-01-11T10:06:18Z"
    artifact_type: "spec"
