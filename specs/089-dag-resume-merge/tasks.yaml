tasks:
    branch: "089-dag-resume-merge"
    created: "2026-01-11"
    spec_path: "specs/089-dag-resume-merge/spec.yaml"
    plan_path: "specs/089-dag-resume-merge/plan.yaml"
summary:
    total_tasks: 28
    total_phases: 8
    parallel_opportunities: 12
    estimated_complexity: "high"
phases:
    - number: 1
      title: "Setup"
      purpose: "Extend existing types with merge-related fields"
      tasks:
        - id: "T001"
          title: "Add MergeStatus type and MergeState struct to internal/dag/types.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/types.go"
          dependencies: []
          acceptance_criteria:
            - "MergeStatus enum with values: pending, merged, merge_failed, skipped"
            - "MergeState struct with Status, MergedAt, Conflicts, ResolutionMethod, Error fields"
            - "ExecutionConfig extended with BaseBranch and OnConflict fields"
            - "OnConflict supports 'agent' and 'manual' modes"
        - id: "T002"
          title: "Extend SpecState with MergeState field in internal/dag/runstate.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/runstate.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "SpecState struct includes MergeState field"
            - "YAML serialization handles MergeState correctly"
            - "Backwards compatible with existing run state files (MergeState defaults to nil)"
    - number: 2
      title: "Foundational - Spec Locking with Heartbeat"
      purpose: "Implement heartbeat-based stale process detection"
      tasks:
        - id: "T003"
          title: "Create SpecLock struct and file operations in internal/dag/speclock.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/speclock.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "SpecLock struct with SpecID, RunID, PID, StartedAt, Heartbeat fields"
            - "AcquireSpecLock() creates lock file at .autospec/state/dag-runs/<run-id>/<spec-id>.lock"
            - "ReleaseSpecLock() removes lock file"
            - "ReadSpecLock() parses existing lock file"
            - "YAML format for lock file contents"
        - id: "T004"
          title: "Implement heartbeat update mechanism in internal/dag/speclock.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/speclock.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "StartHeartbeat() returns cancel function and starts goroutine"
            - "Heartbeat updates lock file every 30 seconds"
            - "UpdateHeartbeat() writes new timestamp atomically"
            - "Goroutine stops cleanly when context cancelled"
        - id: "T005"
          title: "Implement IsSpecLockStale() function in internal/dag/speclock.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/speclock.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "Returns true if heartbeat is older than 2 minutes"
            - "Returns false if heartbeat is within 2 minutes"
            - "Handles missing lock file gracefully (returns false)"
        - id: "T006"
          title: "Add tests for speclock functionality in internal/dag/speclock_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/speclock_test.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "Map-based table tests for AcquireSpecLock, ReleaseSpecLock, ReadSpecLock"
            - "Test heartbeat update writes new timestamp"
            - "Test IsSpecLockStale with fresh and old heartbeats"
            - "Test concurrent access to lock files"
    - number: 3
      title: "User Story 1 - Resume Interrupted DAG Run"
      purpose: "Enable resuming paused or failed DAG runs from where they left off"
      story_reference: "US-001"
      independent_test: "Start a DAG run, interrupt it, then resume and verify only incomplete specs are processed"
      tasks:
        - id: "T007"
          title: "Implement LoadAndValidateRun() in internal/dag/resume.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/dag/resume.go"
          dependencies: ["T002"]
          acceptance_criteria:
            - "Loads run state from .autospec/state/dag-runs/<run-id>.yaml"
            - "Validates run state file exists and is parseable"
            - "Returns error with helpful message if state file corrupted or missing"
        - id: "T008"
          title: "Implement DetectStaleSpecs() in internal/dag/resume.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/resume.go"
          dependencies: ["T005", "T007"]
          acceptance_criteria:
            - "Iterates through running specs and checks their lock files"
            - "Marks specs with stale locks as 'interrupted'"
            - "Updates run state with new spec statuses"
            - "Uses 2-minute staleness threshold from IsSpecLockStale()"
        - id: "T009"
          title: "Implement filterCompletedSpecs() helper in internal/dag/resume.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/resume.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Filters out specs with status 'completed'"
            - "Returns list of specs to resume (pending, failed, interrupted)"
            - "Preserves original dependency order"
        - id: "T010"
          title: "Implement Resume() method on Executor in internal/dag/resume.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/resume.go"
          dependencies: ["T008", "T009"]
          acceptance_criteria:
            - "Loads run state, detects stale specs, filters completed"
            - "Acquires spec locks before resuming each spec"
            - "Integrates with existing ParallelExecutor for execution"
            - "Updates run state after each spec completes"
        - id: "T011"
          title: "Add CLI command: autospec dag resume in internal/cli/dag/resume.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cli/dag/resume.go"
          dependencies: ["T010"]
          acceptance_criteria:
            - "Command accepts <run-id> argument"
            - "Validates run-id exists in state directory"
            - "Calls Executor.Resume() with loaded run state"
            - "Outputs progress for resumed specs"
            - "Proper error handling with exit codes"
        - id: "T012"
          title: "Add tests for resume functionality in internal/dag/resume_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/resume_test.go"
          dependencies: ["T011"]
          acceptance_criteria:
            - "Test LoadAndValidateRun with valid, corrupted, and missing state"
            - "Test DetectStaleSpecs marks stale locks as interrupted"
            - "Test filterCompletedSpecs excludes completed specs"
            - "Test Resume() with mixed spec statuses"
            - "Map-based table-driven test structure"
    - number: 4
      title: "User Story 2 - Merge Completed Specs Automatically"
      purpose: "Merge all completed specs to a target branch in dependency order"
      story_reference: "US-002"
      independent_test: "Complete multiple specs in worktrees, merge them all to main, verify all changes present"
      tasks:
        - id: "T013"
          title: "Implement ComputeMergeOrder() in internal/dag/merge.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-002"
          file_path: "internal/dag/merge.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "Returns specs sorted by dependency order (dependencies first)"
            - "Reuses existing taskgraph topological sort if available"
            - "Only includes specs with status 'completed'"
            - "Handles circular dependency detection (should error)"
        - id: "T014"
          title: "Implement MergeSpec() for single spec merge in internal/dag/merge.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/merge.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "Performs git merge of spec's worktree branch into target"
            - "Returns MergeResult with status, conflicts list"
            - "Does not commit on conflict (leaves for resolution)"
            - "Uses standard git merge (no rebase or squash)"
        - id: "T015"
          title: "Implement Merge() orchestration in internal/dag/merge.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/merge.go"
          dependencies: ["T014"]
          acceptance_criteria:
            - "Iterates through specs in dependency order"
            - "Calls MergeSpec() for each completed spec"
            - "Updates MergeState in run state after each merge"
            - "Uses base_branch from dag.yaml as default target"
            - "Supports --branch flag to override target"
        - id: "T016"
          title: "Add CLI command: autospec dag merge in internal/cli/dag/merge.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/dag/merge.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "Command accepts <run-id> argument"
            - "Supports --branch <target> flag for override"
            - "Outputs progress as each spec is merged"
            - "Proper error handling and exit codes"
        - id: "T017"
          title: "Add tests for merge functionality in internal/dag/merge_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/merge_test.go"
          dependencies: ["T016"]
          acceptance_criteria:
            - "Test ComputeMergeOrder respects dependencies"
            - "Test MergeSpec returns correct status"
            - "Test Merge() processes specs in order"
            - "Test --branch flag overrides base_branch"
            - "Map-based table-driven test structure"
    - number: 5
      title: "User Story 3 - AI-Assisted Conflict Resolution"
      purpose: "Attempt automatic conflict resolution using AI with fallback to manual"
      story_reference: "US-003"
      independent_test: "Create conflicting changes, trigger merge, verify AI resolves or provides context for manual resolution"
      tasks:
        - id: "T018"
          title: "Implement DetectConflicts() in internal/dag/conflict.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-003"
          file_path: "internal/dag/conflict.go"
          dependencies: ["T014"]
          acceptance_criteria:
            - "Parses git status after failed merge to find conflicted files"
            - "Returns list of file paths with conflicts"
            - "Works across Linux, macOS, Windows"
        - id: "T019"
          title: "Implement BuildConflictContext() in internal/dag/conflict.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/conflict.go"
          dependencies: ["T018"]
          acceptance_criteria:
            - "Creates ConflictContext with file_path, conflict_diff, spec info"
            - "Extracts conflict markers (<<<<<<< ======= >>>>>>>) from file"
            - "Includes spec_id, spec_name, spec_description from dag.yaml"
            - "Includes source_branch and target_branch names"
        - id: "T020"
          title: "Implement ResolveWithAgent() in internal/dag/conflict.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/conflict.go"
          dependencies: ["T019"]
          acceptance_criteria:
            - "Spawns agent using cliagent.Execute() with conflict context"
            - "Agent resolves conflict and stages changes"
            - "Returns success/failure based on agent exit code"
            - "Validates resolution produces parseable code (syntax check)"
        - id: "T021"
          title: "Implement OutputManualContext() in internal/dag/conflict.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-003"
          file_path: "internal/dag/conflict.go"
          dependencies: ["T019"]
          acceptance_criteria:
            - "Outputs copy-pastable block with full conflict context"
            - "Block is self-contained (can be pasted to any AI assistant)"
            - "Includes file path, conflict diff, spec info, branch names"
            - "Clear formatting for easy copy-paste"
        - id: "T022"
          title: "Implement conflict resolution retry logic in internal/dag/merge.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/merge.go"
          dependencies: ["T020", "T021"]
          acceptance_criteria:
            - "On conflict, check on_conflict setting (agent or manual)"
            - "Agent mode: try ResolveWithAgent() up to 3 times"
            - "After 3 failures, fall back to manual mode"
            - "Manual mode: call OutputManualContext() and pause merge"
            - "Update MergeState with resolution_method used"
        - id: "T023"
          title: "Add tests for conflict handling in internal/dag/conflict_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/conflict_test.go"
          dependencies: ["T022"]
          acceptance_criteria:
            - "Test DetectConflicts finds all conflicted files"
            - "Test BuildConflictContext includes all required fields"
            - "Test ResolveWithAgent success and failure cases"
            - "Test OutputManualContext format is copy-pastable"
            - "Test retry logic falls back after 3 attempts"
            - "Map-based table-driven test structure"
    - number: 6
      title: "User Story 4 - Continue Merge After Manual Resolution"
      purpose: "Allow resuming merge after manual conflict resolution"
      story_reference: "US-004"
      independent_test: "Pause on conflict, resolve manually, run continue, verify remaining specs merge"
      tasks:
        - id: "T024"
          title: "Add --continue and --skip-failed flags to dag merge command"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/cli/dag/merge.go"
          dependencies: ["T016", "T022"]
          acceptance_criteria:
            - "--continue flag resumes paused merge from last position"
            - "--skip-failed flag skips merge_failed specs and continues"
            - "Merge state tracks current position for resume"
            - "Both flags work independently and together"
    - number: 7
      title: "User Story 5 - Worktree Cleanup"
      purpose: "Clean up worktrees after completion with safety checks"
      story_reference: "US-005"
      independent_test: "Complete and merge specs, run cleanup, verify worktrees are removed"
      tasks:
        - id: "T025"
          title: "Implement CleanupRun() in internal/dag/cleanup.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-005"
          file_path: "internal/dag/cleanup.go"
          dependencies: ["T002"]
          acceptance_criteria:
            - "Removes worktrees for specs with merge status 'merged'"
            - "Preserves worktrees for unmerged/failed specs"
            - "Checks for uncommitted changes before deleting"
            - "Warns if worktree has unpushed commits"
            - "Supports --force to bypass safety checks"
        - id: "T026"
          title: "Add CLI command: autospec dag cleanup in internal/cli/dag/cleanup.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/cli/dag/cleanup.go"
          dependencies: ["T025"]
          acceptance_criteria:
            - "Command accepts <run-id> argument"
            - "Supports --force flag to bypass checks"
            - "Supports --all flag to clean all old runs"
            - "Outputs summary of cleaned/kept worktrees"
            - "Proper error handling and exit codes"
        - id: "T027"
          title: "Add tests for cleanup functionality in internal/dag/cleanup_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-005"
          file_path: "internal/dag/cleanup_test.go"
          dependencies: ["T026"]
          acceptance_criteria:
            - "Test CleanupRun removes merged worktrees"
            - "Test preservation of unmerged worktrees"
            - "Test uncommitted changes detection"
            - "Test --force bypasses all checks"
            - "Test --all cleans multiple runs"
            - "Map-based table-driven test structure"
    - number: 8
      title: "Polish & Integration"
      purpose: "Documentation, integration testing, and quality gates"
      tasks:
        - id: "T028"
          title: "Create user documentation in docs/public/dag-resume-merge.md"
          status: "Completed"
          type: "documentation"
          parallel: true
          story_id: null
          file_path: "docs/public/dag-resume-merge.md"
          dependencies: ["T024", "T027"]
          acceptance_criteria:
            - "Documents dag resume, merge, and cleanup commands"
            - "Includes examples for each command and flag combination"
            - "Explains on_conflict configuration options"
            - "Covers common edge cases and troubleshooting"
        - id: "T029"
          title: "Ensure make test && make fmt && make lint && make build all pass"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: null
          dependencies: ["T012", "T017", "T023", "T024", "T027", "T028"]
          acceptance_criteria:
            - "make test exits 0 with all tests passing"
            - "make fmt exits 0 with no formatting changes"
            - "make lint exits 0 with no warnings or errors"
            - "make build exits 0 producing valid binary"
            - "All functions under 40 lines"
            - "All errors wrapped with context"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: []
        - story_id: "US-002"
          depends_on: []
          blocks: ["US-003", "US-004"]
        - story_id: "US-003"
          depends_on: ["US-002"]
          blocks: ["US-004"]
        - story_id: "US-004"
          depends_on: ["US-002", "US-003"]
          blocks: []
        - story_id: "US-005"
          depends_on: []
          blocks: []
        - story_id: "US-006"
          depends_on: []
          blocks: ["US-001"]
    phase_order:
        - phase: 1
          blocks: [2, 3, 4, 5, 7]
        - phase: 2
          blocks: [3]
        - phase: 3
          blocks: []
        - phase: 4
          blocks: [5, 6]
        - phase: 5
          blocks: [6]
        - phase: 6
          blocks: []
        - phase: 7
          blocks: [8]
        - phase: 8
          blocks: []
parallel_execution:
    - phase: 2
      parallel_groups:
        - tasks: ["T003"]
          rationale: "Speclock is independent of runstate extension"
    - phase: 3
      parallel_groups:
        - tasks: ["T007"]
          rationale: "LoadAndValidateRun can be developed independently"
    - phase: 4
      parallel_groups:
        - tasks: ["T013"]
          rationale: "ComputeMergeOrder is independent algorithm work"
    - phase: 5
      parallel_groups:
        - tasks: ["T018", "T021"]
          rationale: "DetectConflicts and OutputManualContext are independent"
    - phase: 7
      parallel_groups:
        - tasks: ["T025"]
          rationale: "Cleanup logic independent of other phases"
    - phase: 8
      parallel_groups:
        - tasks: ["T028"]
          rationale: "Documentation can be written while tests finalize"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3]
        description: "Setup + Spec Locking + Resume - core resume functionality"
        validation: "Can resume an interrupted DAG run and complete remaining specs"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2]
          deliverable: "Spec locking with heartbeat mechanism in place"
        - milestone: "Resume Working"
          phases: [1, 2, 3]
          deliverable: "dag resume command fully functional"
        - milestone: "Merge Working"
          phases: [1, 2, 3, 4]
          deliverable: "dag merge command with dependency ordering"
        - milestone: "Conflict Resolution"
          phases: [1, 2, 3, 4, 5]
          deliverable: "AI-assisted and manual conflict resolution"
        - milestone: "Continue Merge"
          phases: [1, 2, 3, 4, 5, 6]
          deliverable: "dag merge --continue and --skip-failed"
        - milestone: "Cleanup"
          phases: [1, 2, 3, 4, 5, 6, 7]
          deliverable: "dag cleanup command with safety checks"
        - milestone: "Complete"
          phases: [1, 2, 3, 4, 5, 6, 7, 8]
          deliverable: "Full feature with documentation and quality gates"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.8.2"
    created: "2026-01-11T10:11:58Z"
    artifact_type: "tasks"
