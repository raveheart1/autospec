plan:
  branch: "079-init-path-argument"
  created: "2026-01-02"
  spec_path: "specs/079-init-path-argument/spec.yaml"

summary: |
  Enhance the autospec init command to accept an optional path argument, enabling
  project initialization at arbitrary filesystem locations without requiring users
  to change directories first. This follows the familiar pattern established by
  git init <path>.

  The implementation adds path resolution (relative, absolute, tilde expansion),
  automatic directory creation, a --here flag for explicit current directory
  initialization, and ensures all subprocess working directories (constitution
  workflow) operate on the correct target path. Backward compatibility with
  existing init behavior (no arguments) is preserved.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.1"
      purpose: "CLI framework for command parsing and flag handling"
    - name: "os/user"
      version: "stdlib"
      purpose: "Tilde expansion to user home directory"
    - name: "path/filepath"
      version: "stdlib"
      purpose: "Cross-platform path resolution and manipulation"
  storage: "None"
  testing:
    framework: "go test"
    approach: "Map-based table tests with t.Parallel(), mocked constitution runner"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Path resolution completes in <10ms per constitution principle PRIN-003"
  constraints:
    - "Must maintain backward compatibility with existing 'autospec init' usage"
    - "Must work across supported operating systems (Linux, macOS, Windows)"
    - "Path resolution must complete before any initialization operations begin"
    - "Functions must be <40 lines per constitution principle PRIN-011"
  scale_scope: "Single directory initialization per invocation"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Plan includes comprehensive test tasks before implementation"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "Not a workflow phase transition feature"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Path resolution is simple string/filesystem operation, well under 10ms"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "N/A"
      notes: "Init is one-time initialization operation (explicit exception)"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Uses existing exit code patterns (3=invalid arguments for path errors)"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "N/A"
      notes: "Not an artifact-producing feature"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All code will pass go fmt and go vet"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, errors wrapped with context, table-driven tests"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "Not a command template change"
    - name: "Cross-Platform Compatibility (PRIN-008)"
      status: "PASS"
      notes: "Uses filepath.Abs for platform-agnostic path handling"
    - name: "Explicit Dependencies (PRIN-009)"
      status: "PASS"
      notes: "Uses only stdlib for new functionality"
    - name: "Documentation Standards (PRIN-010)"
      status: "PASS"
      notes: "CLI help text updated, docs/public/reference.md to be updated"

research_findings:
  decisions:
    - topic: "Path resolution approach"
      decision: "Use filepath.Abs after manual tilde expansion"
      rationale: "Go's filepath.Abs handles relative-to-absolute conversion cross-platform; tilde requires manual expansion via os/user.Current()"
      alternatives_considered:
        - "os.ExpandEnv - doesn't handle tilde"
        - "Third-party path library - unnecessary dependency"
    - topic: "Working directory propagation mechanism"
      decision: "Change process working directory before constitution execution"
      rationale: "Constitution workflow uses current working directory implicitly; changing cwd before execution is simplest and maintains existing subprocess behavior"
      alternatives_considered:
        - "Thread WorkDir through all function calls - invasive refactor"
        - "Add WorkDir to orchestrator config - still requires cwd change for subprocess"
    - topic: "--here flag vs positional argument priority"
      decision: "Path argument takes precedence when both provided"
      rationale: "Explicit argument should override flag; matches behavior users expect from explicit specification"
      alternatives_considered:
        - "Error when both provided - less flexible"
        - "Flag takes precedence - counterintuitive"
    - topic: "Directory creation permissions"
      decision: "Use os.MkdirAll with 0755 permissions"
      rationale: "Standard directory permissions; MkdirAll creates parent directories as needed"
      alternatives_considered:
        - "0700 (user-only) - too restrictive for shared projects"
        - "Require directory to exist - less convenient UX"

data_model:
  entities:
    - name: "InitPath"
      description: "Resolved target directory path for initialization"
      fields:
        - name: "raw"
          type: "string"
          description: "User-provided path argument"
          constraints: "Optional; empty means current directory"
        - name: "resolved"
          type: "string"
          description: "Absolute path after resolution"
          constraints: "Must be a valid directory path (not a file)"
        - name: "created"
          type: "bool"
          description: "Whether the directory was created by init"
          constraints: "None"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/reference.md"
      description: "CLI reference update for init path argument and --here flag"
  source_code:
    - path: "internal/cli/config/init_cmd.go"
      description: "Main init command implementation with path handling"
    - path: "internal/cli/config/path.go"
      description: "Path resolution helper functions (new file)"
  tests:
    - path: "internal/cli/config/init_cmd_test.go"
      description: "Init command tests including path scenarios"
    - path: "internal/cli/config/path_test.go"
      description: "Unit tests for path resolution functions"

implementation_phases:
  - phase: 1
    name: "Path Resolution Foundation"
    goal: "Create path resolution utilities with comprehensive tests"
    deliverables:
      - "path.go with ResolvePath function (tilde expansion, relative to absolute)"
      - "path_test.go with table-driven tests for all path variants"
      - "Tests pass: relative, absolute, tilde, dot, empty paths"
  - phase: 2
    name: "Command Signature and Flag Updates"
    goal: "Update init command to accept path argument and --here flag"
    deliverables:
      - "Command Use changed to 'init [path]'"
      - "--here flag added"
      - "Args validation for 0-1 positional arguments"
      - "Unit tests for flag/argument parsing"
    dependencies:
      - "Phase 1"
  - phase: 3
    name: "Directory Creation and Validation"
    goal: "Implement directory creation with proper error handling"
    deliverables:
      - "Create target directory if non-existent (MkdirAll with 0755)"
      - "Error if path exists and is a file"
      - "Permission error handling"
      - "Unit tests for directory creation scenarios"
    dependencies:
      - "Phase 2"
  - phase: 4
    name: "Working Directory Integration"
    goal: "Ensure all operations use resolved path as working directory"
    deliverables:
      - "Change cwd before constitution workflow execution"
      - "Update configureSelectedAgents to use resolved path"
      - "Update project config path handling for --project flag"
      - "Integration tests verifying correct directory usage"
    dependencies:
      - "Phase 3"
  - phase: 5
    name: "Documentation and Final Validation"
    goal: "Update documentation and verify all tests pass"
    deliverables:
      - "Updated docs/public/reference.md with new syntax"
      - "Updated init command help text"
      - "All tests pass including edge cases"
      - "make lint && make test passes"
    dependencies:
      - "Phase 4"

open_questions:
  - question: "Should we restore original working directory after init completes?"
    context: "Currently plan to change cwd; unclear if it should be restored"
    proposed_resolution: "Restore original cwd after init to avoid surprising side effects for callers"
  - question: "Behavior when path is symlink"
    context: "Spec says 'beyond OS defaults' but may need explicit testing"
    proposed_resolution: "Follow symlink (OS default behavior), document this in help text"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.7.3"
  created: "2026-01-02T19:27:32Z"
  artifact_type: "plan"
