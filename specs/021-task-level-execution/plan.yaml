plan:
  branch: "021-task-level-execution"
  created: "2025-12-16"
  spec_path: "specs/021-task-level-execution/spec.yaml"

summary: |
  This implementation adds task-level execution (--tasks flag) to the autospec implement command,
  providing the finest granularity of context isolation. Each task in tasks.yaml runs in a separate
  Claude session, preventing context accumulation issues in long implementations. The feature
  integrates with existing phase-level execution (--phases) and default single-session modes,
  using the established retry infrastructure for per-task tracking.

  Key technical decisions:
  1. Extend PhaseExecutionOptions with TaskMode flag and FromTask field
  2. Add new TaskExecutionMode constant to workflow package
  3. Modify /autospec.implement slash command to accept task ID filter (--task T001)
  4. Leverage existing validation.ParseTasksYAML for task dependency resolution
  5. Use existing retry.RetryStore with task-level key format (spec:task:T001)
  6. Respect existing exit code conventions (0=success, 1=validation fail, 2=retries exhausted)

technical_context:
  language: "Go"
  framework: "Cobra CLI (v1.10.1)"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI framework for implement command flags"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "Parse tasks.yaml for task list and dependencies"
    - name: "github.com/ariel-frischer/autospec/internal/validation"
      version: "internal"
      purpose: "TaskItem, ParseTasksYAML, dependency validation"
    - name: "github.com/ariel-frischer/autospec/internal/retry"
      version: "internal"
      purpose: "Task-level retry state tracking"
  storage: "JSON (retry.json in ~/.autospec/state/)"
  testing:
    framework: "go test"
    approach: "Table-driven unit tests for new functions, integration tests for CLI flags"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "<2 seconds orchestration overhead between task sessions"
  constraints:
    - "Must maintain backward compatibility with default implement behavior"
    - "Must integrate with existing retry state infrastructure"
    - "Exit codes must follow existing conventions"
    - "Must be mutually exclusive with --phases flag"
  scale_scope: "10-50 tasks per spec typical, up to 100 tasks supported"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Plan includes test tasks before implementation for all new functions"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "Task completion validated after each session before proceeding"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "<2s orchestration overhead meets sub-second validation contract"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Task-level retry state tracks per-task completion for recovery"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Uses existing exit codes: 0=success, 1=validation fail, 2=retries exhausted"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "Reads tasks.yaml, updates task status via existing update-task command"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All new code will pass go fmt and go vet"
    - name: "Cross-Platform Compatibility (PRIN-008)"
      status: "PASS"
      notes: "No platform-specific code required"
    - name: "Explicit Dependencies (PRIN-009)"
      status: "PASS"
      notes: "No new external dependencies required"
    - name: "Documentation Standards (PRIN-010)"
      status: "PASS"
      notes: "CLAUDE.md will be updated with new flags and usage examples"

research_findings:
  decisions:
    - topic: "Task iteration approach"
      decision: "Use existing ParseTasksYAML to get task list, iterate in dependency order"
      rationale: "Leverages existing task parsing infrastructure, dependency info already available"
      alternatives_considered:
        - "New task iterator abstraction - unnecessary complexity"
        - "Shell script orchestration - inconsistent with Go-first approach"
    - topic: "Session isolation mechanism"
      decision: "Each task runs via separate ClaudeExecutor.Execute() call"
      rationale: "Matches existing phase-level session approach in ExecuteImplementWithPhases"
      alternatives_considered:
        - "Claude API sessions - not available in CLI mode"
        - "Environment variable injection - doesn't clear context"
    - topic: "Task filter implementation"
      decision: "Extend /autospec.implement slash command with --task T001 parameter"
      rationale: "Consistent with --phase N pattern, allows Claude to focus on single task"
      alternatives_considered:
        - "Separate slash command /autospec.implement-task - unnecessary proliferation"
        - "Prompt injection only - less explicit, harder to validate"
    - topic: "Retry state key format"
      decision: "Use spec:implement:task:T001 format for task-level tracking"
      rationale: "Extends existing spec:phase pattern, distinguishes from phase retries"
      alternatives_considered:
        - "Separate task state store - adds complexity"
        - "No task-level tracking - poor recovery experience"
    - topic: "Dependency validation"
      decision: "Check task dependencies field against completed task IDs before execution"
      rationale: "Tasks already have dependencies field, just need runtime enforcement"
      alternatives_considered:
        - "Build full dependency graph - overkill for sequential execution"
        - "Trust Claude to handle dependencies - unreliable"

data_model:
  entities:
    - name: "TaskExecutionState"
      description: "Tracks progress through task-level execution mode"
      fields:
        - name: "spec_name"
          type: "string"
          description: "Spec being implemented"
          constraints: "Required, must match existing spec directory"
        - name: "current_task_id"
          type: "string"
          description: "Task ID currently being executed"
          constraints: "Format T001, T002, etc."
        - name: "completed_task_ids"
          type: "[]string"
          description: "List of task IDs that completed successfully"
          constraints: "Populated during --tasks execution"
        - name: "total_tasks"
          type: "int"
          description: "Total number of tasks to execute"
          constraints: "Derived from tasks.yaml"
        - name: "last_task_attempt"
          type: "time.Time"
          description: "Timestamp of last task execution attempt"
          constraints: "ISO 8601 format in JSON"
      relationships:
        - target: "RetryStore"
          type: "one-to-one"
          description: "TaskExecutionState stored within RetryStore.TaskStates map"
    - name: "TaskItem"
      description: "Existing task definition from tasks.yaml (no changes needed)"
      fields:
        - name: "ID"
          type: "string"
          description: "Unique task identifier"
          constraints: "Format TNNN"
        - name: "Status"
          type: "string"
          description: "Current task status"
          constraints: "Pending|InProgress|Completed|Blocked"
        - name: "Dependencies"
          type: "[]string"
          description: "Task IDs that must complete before this task"
          constraints: "Must reference valid task IDs"
      relationships:
        - target: "TaskPhase"
          type: "many-to-one"
          description: "Each task belongs to exactly one phase"

api_contracts:
  endpoints:
    - method: "CLI"
      path: "autospec implement --tasks"
      description: "Run each task in a separate Claude session"
      request:
        content_type: "flags"
        body_schema: |
          --tasks: boolean flag, enables task-level execution
          --from-task: string, task ID to start from (e.g., T003)
      response:
        success_code: 0
        body_schema: "Progress output showing Task X of Y: TXXX - Title"
      errors:
        - code: 1
          description: "Task validation failed (task not marked Completed)"
        - code: 2
          description: "Retry limit exhausted for a task"
        - code: 3
          description: "Invalid arguments (--tasks with --phases)"
    - method: "CLI"
      path: "/autospec.implement --task T001"
      description: "Execute single task by ID (internal, used by orchestrator)"
      request:
        content_type: "slash command argument"
        body_schema: "--task TXXX where TXXX is a valid task ID"
      response:
        success_code: 0
        body_schema: "Task completion status"
      errors:
        - code: 1
          description: "Task not found or task not marked Completed after execution"

project_structure:
  documentation:
    - path: "CLAUDE.md"
      description: "Add --tasks and --from-task flags to implement command documentation"
  source_code:
    - path: "internal/cli/implement.go"
      description: "Add --tasks and --from-task flags, mutual exclusivity with phase flags"
    - path: "internal/workflow/workflow.go"
      description: "Add ExecuteImplementWithTasks method for task-level orchestration"
    - path: "internal/workflow/phase_config.go"
      description: "Extend PhaseExecutionOptions with TaskMode and FromTask fields"
    - path: "internal/validation/tasks_yaml.go"
      description: "Add GetTaskByID, GetTasksInDependencyOrder helper functions"
    - path: "internal/retry/retry.go"
      description: "Add TaskExecutionState struct and related functions"
    - path: ".claude/commands/autospec.implement.md"
      description: "Add task-specific execution section for --task TXXX parameter"
  tests:
    - path: "internal/cli/implement_test.go"
      description: "Tests for --tasks flag parsing and mutual exclusivity"
    - path: "internal/workflow/workflow_test.go"
      description: "Tests for ExecuteImplementWithTasks orchestration logic"
    - path: "internal/validation/tasks_yaml_test.go"
      description: "Tests for GetTaskByID, dependency ordering functions"
    - path: "internal/retry/retry_test.go"
      description: "Tests for task-level state tracking"

implementation_phases:
  - phase: 1
    name: "Task Validation Infrastructure"
    goal: "Add helper functions for task lookup and dependency validation"
    deliverables:
      - "GetTaskByID function in validation/tasks_yaml.go"
      - "GetTasksInDependencyOrder function for topological sort"
      - "ValidateTaskDependenciesMet function to check if dependencies are Completed"
      - "Unit tests for all new validation functions"
  - phase: 2
    name: "Retry State Extension"
    goal: "Extend retry infrastructure to support task-level tracking"
    deliverables:
      - "TaskExecutionState struct in retry/retry.go"
      - "LoadTaskState, SaveTaskState, MarkTaskComplete functions"
      - "Unit tests for task state persistence"
    dependencies:
      - "Phase 1"
  - phase: 3
    name: "CLI Flag Implementation"
    goal: "Add --tasks and --from-task flags to implement command"
    deliverables:
      - "--tasks boolean flag"
      - "--from-task string flag with task ID validation"
      - "Mutual exclusivity with --phases, --phase, --from-phase"
      - "Unit tests for flag parsing and validation"
    dependencies:
      - "Phase 2"
  - phase: 4
    name: "Workflow Orchestration"
    goal: "Implement task-level execution loop in workflow package"
    deliverables:
      - "PhaseExecutionOptions.TaskMode and FromTask fields"
      - "ExecuteImplementWithTasks method"
      - "executeSingleTaskSession helper method"
      - "Integration with task status validation"
    dependencies:
      - "Phase 3"
  - phase: 5
    name: "Slash Command Extension"
    goal: "Modify /autospec.implement to accept task ID filter"
    deliverables:
      - "Updated .claude/commands/autospec.implement.md with --task parameter"
      - "Task-specific execution section in slash command"
    dependencies:
      - "Phase 4"
  - phase: 6
    name: "Documentation and Polish"
    goal: "Update documentation and ensure code quality"
    deliverables:
      - "Updated CLAUDE.md with --tasks and --from-task usage"
      - "Run make fmt to ensure code formatting"
      - "Run make test to verify all tests pass"
    dependencies:
      - "Phase 5"

risks:
  - risk: "Task dependency cycles could cause infinite loops"
    likelihood: "low"
    impact: "high"
    mitigation: "Existing circular dependency detection in tasks validation; add cycle check in GetTasksInDependencyOrder"
  - risk: "Claude may not complete task in single session"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Retry logic with configurable max attempts; task marked InProgress allows manual resume"
  - risk: "External modification of tasks.yaml during execution"
    likelihood: "low"
    impact: "medium"
    mitigation: "Re-read tasks.yaml before each task to pick up status changes (documented edge case)"
  - risk: "Performance overhead from multiple Claude sessions"
    likelihood: "medium"
    impact: "low"
    mitigation: "Expected tradeoff for context isolation; document that --tasks is slower but more reliable"

open_questions:
  - question: "Should --from-task validate that specified task's dependencies are met?"
    context: "User might try to resume from a task whose dependencies haven't completed"
    proposed_resolution: "Yes - check dependencies are Completed before starting, error if not met"
  - question: "Should we track retry count per-task or per-session?"
    context: "If a task fails validation, do we retry that specific task or the whole sequence?"
    proposed_resolution: "Per-task retry tracking allows finer-grained recovery"
  - question: "What happens if task ID in --from-task doesn't exist?"
    context: "User typo or task removed from tasks.yaml"
    proposed_resolution: "Exit with code 3 (invalid arguments) and list available task IDs"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T07:48:02Z"
  artifact_type: "plan"
