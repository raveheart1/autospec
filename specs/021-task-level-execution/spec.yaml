feature:
  branch: "021-task-level-execution"
  created: "2025-12-16"
  status: "Draft"
  input: "Add --tasks flag to implement command that runs each individual task in a separate Claude session. PROBLEM: Even phase-level batching (--phases) may not be granular enough - phases with 5+ tasks still accumulate context, and some complex tasks benefit from complete isolation. KEY INSIGHT: tasks.yaml has individual task entries with IDs - just need orchestration to run one task per session. RELATION TO --phases: --tasks is the most granular execution mode (1 task = 1 session), --phases is mid-level (1 phase = 1 session), default is coarse (all tasks = 1 session). DEFAULT BEHAVIOR: 'autospec implement' (no flags) = single session, backward compatible. NEW FLAG: --tasks (run all tasks sequentially, each in fresh Claude session). EXECUTION WITH --tasks: for each task in tasks.yaml (respecting dependency order), start fresh Claude session, run /autospec.implement with single task ID filter, validate task completed, end session (context cleared), repeat for next task. IMPLEMENTATION: modify /autospec.implement slash command to accept single task ID filter, update ExecuteImplement() to loop through tasks with fresh Claude sessions when --tasks set, respect task dependencies (skip if dependency not completed), track individual task completion in retry state, add task-level validation between transitions. BENEFITS: maximum context isolation per task, ideal for complex/long-running tasks, finest-grained recovery points, easiest to debug failures, can combine with --from-task to resume from specific task. FUTURE: --tasks could support parallel execution for independent tasks (no shared dependencies), but sequential is the MVP."

user_stories:
  - id: "US-001"
    title: "Execute tasks in isolated sessions"
    priority: "P1"
    as_a: "developer running autospec implement"
    i_want: "to run each task from tasks.yaml in a separate Claude session using --tasks flag"
    so_that: "each task gets maximum context isolation, preventing context accumulation issues in long implementations"
    why_this_priority: "Core feature - without this, the entire --tasks flag has no purpose"
    independent_test: "Run autospec implement --tasks on a spec with multiple tasks and verify each task starts with fresh context"
    acceptance_scenarios:
      - given: "a tasks.yaml with 5 tasks in dependency order"
        when: "user runs 'autospec implement --tasks'"
        then: "each task executes in a separate Claude session sequentially, with context cleared between tasks"
      - given: "a tasks.yaml with tasks T001, T002, T003"
        when: "user runs 'autospec implement --tasks'"
        then: "T001 completes in session 1, T002 completes in session 2, T003 completes in session 3"

  - id: "US-002"
    title: "Respect task dependencies in isolated execution"
    priority: "P1"
    as_a: "developer with complex task dependencies"
    i_want: "the --tasks execution mode to respect task dependency order"
    so_that: "tasks with prerequisites are not attempted until dependencies are completed"
    why_this_priority: "Critical for correctness - executing tasks out of order could cause failures"
    independent_test: "Create tasks with dependencies and verify execution order follows dependency graph"
    acceptance_scenarios:
      - given: "task T003 depends on T001 and T002"
        when: "running with --tasks flag"
        then: "T003 only starts after both T001 and T002 are marked Completed"
      - given: "task T002 depends on T001 which is Blocked"
        when: "running with --tasks flag"
        then: "T002 is skipped with appropriate message indicating dependency not satisfied"

  - id: "US-003"
    title: "Resume from specific task"
    priority: "P1"
    as_a: "developer whose implementation was interrupted"
    i_want: "to resume task-level execution from a specific task using --from-task"
    so_that: "I can continue from where I left off without re-running completed tasks"
    why_this_priority: "Essential for recovery - without this, any interruption requires full restart"
    independent_test: "Run --tasks, interrupt at T003, then resume with --from-task T003"
    acceptance_scenarios:
      - given: "tasks T001-T005 where T001-T002 are Completed"
        when: "user runs 'autospec implement --tasks --from-task T003'"
        then: "execution starts at T003, skipping T001 and T002"
      - given: "user specifies --from-task T099 which doesn't exist"
        when: "running autospec implement"
        then: "error message indicates task ID not found in tasks.yaml"

  - id: "US-004"
    title: "Single task filter for implement command"
    priority: "P1"
    as_a: "developer wanting to run one specific task"
    i_want: "the /autospec.implement slash command to accept a task ID filter"
    so_that: "Claude can be directed to work on exactly one task in a session"
    why_this_priority: "Required infrastructure - --tasks mode depends on this capability"
    independent_test: "Run /autospec.implement with task ID T002 and verify only T002 is worked on"
    acceptance_scenarios:
      - given: "tasks.yaml contains tasks T001, T002, T003"
        when: "/autospec.implement is called with task filter T002"
        then: "Claude only works on T002, marks T002 as Completed, does not touch other tasks"

  - id: "US-005"
    title: "Task completion validation between sessions"
    priority: "P2"
    as_a: "developer running --tasks mode"
    i_want: "validation that each task completed before starting the next"
    so_that: "failures are caught early and execution doesn't proceed with incomplete prerequisites"
    why_this_priority: "Important for reliability but system can function with manual verification initially"
    independent_test: "Simulate task failing to complete and verify next task is not started"
    acceptance_scenarios:
      - given: "task T001 execution session ends without T001 marked Completed"
        when: "orchestrator checks completion before T002"
        then: "T002 is not started, user is notified T001 did not complete"
      - given: "task T001 marked as Completed after session"
        when: "orchestrator validates completion"
        then: "T002 session is started"

  - id: "US-006"
    title: "Backward compatible default behavior"
    priority: "P1"
    as_a: "existing autospec user"
    i_want: "'autospec implement' without flags to work exactly as before"
    so_that: "my existing workflows are not disrupted by this new feature"
    why_this_priority: "Non-negotiable - breaking existing behavior would harm existing users"
    independent_test: "Run autospec implement without --tasks and verify single session runs all tasks"
    acceptance_scenarios:
      - given: "user has existing workflow using 'autospec implement'"
        when: "running without --tasks or --phases flags"
        then: "all tasks run in single Claude session as they did before"

  - id: "US-007"
    title: "Track task-level execution in retry state"
    priority: "P2"
    as_a: "developer experiencing intermittent failures"
    i_want: "task-level execution state tracked in retry state"
    so_that: "I can see which tasks completed and resume from failure points"
    why_this_priority: "Enhances recovery but manual tracking is possible workaround"
    independent_test: "Run --tasks, check retry state shows per-task tracking"
    acceptance_scenarios:
      - given: "running with --tasks flag"
        when: "T001 completes and T002 fails"
        then: "retry state shows T001 completed, T002 at retry count N"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST add --tasks flag to implement command CLI"
      testable: true
      acceptance_criteria: "'autospec implement --help' shows --tasks flag with description"
    - id: "FR-002"
      description: "MUST add --from-task flag to implement command CLI"
      testable: true
      acceptance_criteria: "'autospec implement --help' shows --from-task flag accepting task ID"
    - id: "FR-003"
      description: "MUST execute each task in separate Claude session when --tasks is set"
      testable: true
      acceptance_criteria: "Observable: each task starts fresh claude process invocation"
    - id: "FR-004"
      description: "MUST respect task dependencies - skip tasks whose dependencies are not Completed"
      testable: true
      acceptance_criteria: "Task with unmet dependency is skipped with warning message"
    - id: "FR-005"
      description: "MUST modify /autospec.implement slash command to accept optional task ID filter"
      testable: true
      acceptance_criteria: "Slash command documentation shows task ID parameter"
    - id: "FR-006"
      description: "MUST validate task completion before starting next task"
      testable: true
      acceptance_criteria: "If task status is not Completed after session, next task is not started"
    - id: "FR-007"
      description: "MUST maintain backward compatibility - no flags means single session for all tasks"
      testable: true
      acceptance_criteria: "'autospec implement' with no flags runs all tasks in one session"
    - id: "FR-008"
      description: "SHOULD track per-task retry state when running in --tasks mode"
      testable: true
      acceptance_criteria: "retry.json contains task-level entries after --tasks execution"
    - id: "FR-009"
      description: "MUST display progress: 'Task X of Y: TXXX - Task title'"
      testable: true
      acceptance_criteria: "Console output shows task progress during --tasks execution"
    - id: "FR-010"
      description: "MUST exit with appropriate code on task failure (exit 1 for validation failure)"
      testable: true
      acceptance_criteria: "Failed task execution returns exit code 1"
  non_functional:
    - id: "NFR-001"
      category: "usability"
      description: "Task progress MUST be clearly visible during execution"
      measurable_target: "Each task transition displays task ID, title, and progress (X of Y)"
    - id: "NFR-002"
      category: "reliability"
      description: "System MUST not lose track of task completion status between sessions"
      measurable_target: "tasks.yaml accurately reflects completed tasks after any interruption"
    - id: "NFR-003"
      category: "performance"
      description: "Orchestration overhead between tasks SHOULD be minimal"
      measurable_target: "Less than 2 seconds between task session end and next task session start"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can execute implementations at task granularity"
      metric: "Successful completion of --tasks execution on multi-task spec"
      target: "All tasks complete, each in isolated session"
    - id: "SC-002"
      description: "Users can resume interrupted task-level execution"
      metric: "--from-task successfully resumes from specified task"
      target: "No re-execution of already-completed tasks"
    - id: "SC-003"
      description: "Existing users experience no workflow disruption"
      metric: "Default implement behavior unchanged"
      target: "Zero behavioral changes when no new flags used"
    - id: "SC-004"
      description: "Task failures are isolated and recoverable"
      metric: "Failed task does not affect completed task status"
      target: "100% of completed tasks remain marked Completed after failure"

key_entities:
  - name: "Task"
    description: "Individual unit of work defined in tasks.yaml with ID, title, phase, and dependencies"
    attributes:
      - "id (e.g., T001, T002)"
      - "title"
      - "phase"
      - "status (Pending, InProgress, Completed, Blocked)"
      - "depends_on (list of task IDs)"
  - name: "TaskSession"
    description: "A Claude execution session scoped to a single task"
    attributes:
      - "task_id"
      - "session_start_time"
      - "session_end_time"
      - "completion_status"
  - name: "TaskExecutionState"
    description: "Retry/progress tracking for task-level execution"
    attributes:
      - "current_task_index"
      - "completed_tasks"
      - "failed_task_id"
      - "retry_count"

edge_cases:
  - scenario: "Task file is modified externally during --tasks execution"
    expected_behavior: "Re-read tasks.yaml before each task to pick up changes"
  - scenario: "Task has circular dependency"
    expected_behavior: "Existing circular dependency detection handles this - error before execution"
  - scenario: "All tasks already Completed when --tasks is run"
    expected_behavior: "Report 'All tasks already completed' and exit successfully"
  - scenario: "--from-task specifies task whose dependencies are not met"
    expected_behavior: "Error message listing unmet dependencies, do not execute"
  - scenario: "User interrupts with Ctrl+C during task execution"
    expected_behavior: "Current task may be left InProgress, resumable via --from-task"
  - scenario: "Task completes but validation fails (task not marked Completed)"
    expected_behavior: "Retry logic applies to that task, up to max_retries"
  - scenario: "Using --tasks and --phases together"
    expected_behavior: "Error: --tasks and --phases are mutually exclusive"
  - scenario: "Using --tasks with --phase or --from-phase"
    expected_behavior: "Error: --tasks cannot be combined with phase-level flags"

assumptions:
  - "tasks.yaml follows existing schema with task IDs in format T001, T002, etc."
  - "Task dependencies are already validated for cycles before implementation starts"
  - "Each task can be meaningfully completed in isolation (no implicit state sharing needed)"
  - "The /autospec.implement slash command can be extended without breaking existing integrations"
  - "Retry state file format can be extended to include task-level tracking"
  - "Tasks are uniquely identified by their ID within a tasks.yaml file"

constraints:
  - "Must integrate with existing ExecuteImplement() workflow without restructuring"
  - "Must use existing retry state infrastructure (retry.json)"
  - "Must maintain consistency with --phases flag UX patterns"
  - "Claude CLI invocation patterns must match existing phase execution"
  - "Exit codes must follow existing conventions (0=success, 1=validation fail, 2=retries exhausted)"

out_of_scope:
  - "Parallel task execution (future enhancement mentioned but not MVP)"
  - "Task-level progress persistence beyond retry state"
  - "GUI or TUI for task selection"
  - "Modifying task dependency structure at runtime"
  - "Cross-spec task execution"
  - "Task-level timeout configuration (uses existing command timeout)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T07:45:13Z"
  artifact_type: "spec"
