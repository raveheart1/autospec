tasks:
    branch: "097-dag-inline-state"
    created: "2026-01-12"
    spec_path: "specs/097-dag-inline-state/spec.yaml"
    plan_path: "specs/097-dag-inline-state/plan.yaml"
summary:
    total_tasks: 32
    total_phases: 10
    parallel_opportunities: 8
    estimated_complexity: "high"
phases:
    - number: 1
      title: "Setup"
      purpose: "Project initialization and type definitions"
      tasks:
        - id: "T001"
          title: "Add RunState, SpecState, LayerStaging inline types to internal/dag/types.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/types.go"
          dependencies: []
          acceptance_criteria:
            - "RunState struct with Status, StartedAt, CompletedAt fields exists"
            - "SpecState struct with all runtime fields (status, worktree, timestamps, commit info) exists"
            - "LayerStaging struct with Branch and SpecsMerged fields exists"
            - "All fields have yaml omitempty tags"
            - "New types do NOT include redundant fields like spec_id, layer_id, blocked_by"
        - id: "T002"
          title: "Extend DAGConfig in internal/dag/types.go with Run, Specs, Staging fields"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/types.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "DAGConfig has Run *RunState field with yaml:run,omitempty tag"
            - "DAGConfig has Specs map[string]*SpecState field with yaml:specs,omitempty tag"
            - "DAGConfig has Staging map[string]*LayerStaging field with yaml:staging,omitempty tag"
            - "dag.yaml without state sections parses correctly (backward compatible)"
            - "dag.yaml with state sections parses all runtime state"
    - number: 2
      title: "Foundational"
      purpose: "Core infrastructure for inline state that MUST be complete before user stories"
      tasks:
        - id: "T003"
          title: "Create internal/dag/writer.go with SaveDAGWithState function"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/writer.go"
          dependencies: ["T002"]
          acceptance_criteria:
            - "SaveDAGWithState(path string, config *DAGConfig) error function exists"
            - "Uses atomic write (temp file + rename) pattern"
            - "Adds YAML comment separator before state sections"
            - "Preserves definition sections when writing state"
            - "Returns wrapped error on failure"
        - id: "T004"
          title: "Create internal/dag/migrate.go with legacy state migration logic"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/migrate.go"
          dependencies: ["T002"]
          acceptance_criteria:
            - "MigrateLegacyState(dagPath string) error function exists"
            - "DetectLegacyStateFile(dagPath string) (string, bool) function exists"
            - "Reads legacy state from .autospec/state/dag-runs/"
            - "Converts DAGRun state to inline RunState/SpecState/LayerStaging"
            - "Removes legacy state file after successful migration"
            - "Returns nil if no legacy state exists"
        - id: "T005"
          title: "Add tests for inline state types in internal/dag/types_test.go"
          status: "Completed"
          type: "test"
          parallel: true
          story_id: null
          file_path: "internal/dag/types_test.go"
          dependencies: ["T002"]
          acceptance_criteria:
            - "Test parsing dag.yaml with state sections present"
            - "Test parsing dag.yaml without state sections (backward compat)"
            - "Test omitempty behavior - nil state fields not written"
            - "Test all state field types parse correctly"
        - id: "T006"
          title: "Add tests for writer.go in internal/dag/writer_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/writer_test.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "Test atomic write completes successfully"
            - "Test definition sections are preserved"
            - "Test state sections are added with comment separator"
            - "Test partial write leaves original file intact"
            - "Test error handling for permission issues"
        - id: "T007"
          title: "Add tests for migrate.go in internal/dag/migrate_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/migrate_test.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "Test legacy state file detection"
            - "Test successful migration converts all fields"
            - "Test legacy file is removed after migration"
            - "Test no-op when no legacy state exists"
            - "Test migration fails gracefully with clear error"
    - number: 3
      title: "User Story 1 - View DAG progress in single file (US-001)"
      purpose: "Enable users to see both DAG definition and execution state in one file"
      story_reference: "US-001"
      independent_test: "Open dag.yaml and verify both definition sections and runtime state sections are present and readable"
      tasks:
        - id: "T008"
          title: "Update parser.go to populate Specs map from layers on load"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/parser.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "LoadDAG returns DAGConfig with Run, Specs, Staging fields populated if present"
            - "If state sections missing, those fields are nil"
            - "Definition sections (schema_version, dag, layers) always parsed"
            - "Error message identifies malformed state sections"
        - id: "T009"
          title: "Add YAML comment separator constant and formatting in writer.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/writer.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "StateCommentSeparator constant defined as '# ====== RUNTIME STATE (auto-managed, do not edit) ======'"
            - "Comment is written before state sections"
            - "Comment is not written if no state exists"
        - id: "T010"
          title: "Update parser_test.go with inline state parsing tests"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/parser_test.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "Test dag.yaml with embedded state parses all state fields"
            - "Test dag.yaml without state parses definition only"
            - "Test malformed state section returns clear error"
    - number: 4
      title: "User Story 2 - Run DAG without run_id generation (US-002)"
      purpose: "Remove run_id generation and use file path as sole identifier"
      story_reference: "US-002"
      independent_test: "Execute dag run and verify no run_id appears in output or file system"
      tasks:
        - id: "T011"
          title: "Update executor.go to write state to dag.yaml instead of separate file"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/executor.go"
          dependencies: ["T003", "T008"]
          acceptance_criteria:
            - "State writes update dag.yaml in-place using SaveDAGWithState"
            - "No files created in .autospec/state/dag-runs/ for new executions"
            - "State initialization creates Run and Specs sections"
            - "Each spec status change triggers state write"
        - id: "T012"
          title: "Remove run_id generation from NewDAGRun in runstate.go"
          status: "Completed"
          type: "refactor"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/runstate.go"
          dependencies: ["T011"]
          acceptance_criteria:
            - "generateRunID function removed or deprecated"
            - "NewDAGRun does not generate or store run_id"
            - "RunID field in DAGRun marked as deprecated with comment"
            - "WorkflowPath becomes the primary identifier"
        - id: "T013"
          title: "Update internal/cli/dag/run.go to use inline state"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T011", "T012"]
          acceptance_criteria:
            - "dag run command writes state to dag.yaml"
            - "No run_id displayed in command output"
            - "State file path not displayed (file is dag.yaml itself)"
            - "Auto-migration triggered if legacy state file detected"
        - id: "T014"
          title: "Add executor inline state tests to internal/dag/executor_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/executor_test.go"
          dependencies: ["T011"]
          acceptance_criteria:
            - "Test state written to dag.yaml not separate file"
            - "Test no files created in .autospec/state/dag-runs/"
            - "Test state persists through spec execution"
    - number: 5
      title: "User Story 3 - Resume interrupted DAG execution (US-003)"
      purpose: "Enable resuming execution from where it left off"
      story_reference: "US-003"
      independent_test: "Interrupt a running DAG, restart it, and verify only incomplete specs are re-executed"
      tasks:
        - id: "T015"
          title: "Update executor.go resume logic to read state from dag.yaml"
          status: "InProgress"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/executor.go"
          dependencies: ["T011"]
          acceptance_criteria:
            - "On start, check if dag.yaml has existing Run state"
            - "If Run.Status is running or interrupted, resume from current state"
            - "Completed specs are skipped based on Specs[id].Status"
            - "Running specs from interrupted session are re-executed"
            - "Pending specs execute normally"
        - id: "T016"
          title: "Add resume logic tests to internal/dag/resume_test.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/resume_test.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "Test completed specs are skipped on resume"
            - "Test running specs are re-executed on resume"
            - "Test pending specs execute normally on resume"
            - "Test fresh run ignores existing state"
    - number: 6
      title: "User Story 4 - Start fresh DAG execution (US-004)"
      purpose: "Enable clearing all previous state and starting fresh"
      story_reference: "US-004"
      independent_test: "Run dag run --fresh on a DAG with existing state and verify all specs restart"
      tasks:
        - id: "T017"
          title: "Add --fresh flag to internal/cli/dag/run.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "--fresh flag defined in command flags"
            - "When --fresh specified, clear Run, Specs, Staging before execution"
            - "Clears state by setting fields to nil then saving"
            - "Execution proceeds as if no prior state existed"
        - id: "T018"
          title: "Add clearState helper function to executor.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/dag/executor.go"
          dependencies: ["T011"]
          acceptance_criteria:
            - "ClearInlineState(config *DAGConfig) function sets Run, Specs, Staging to nil"
            - "Function saves cleared state to dag.yaml"
            - "Returns error if write fails"
        - id: "T019"
          title: "Add tests for --fresh flag in internal/cli/dag/run_test.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-004"
          file_path: "internal/cli/dag/run_test.go"
          dependencies: ["T017"]
          acceptance_criteria:
            - "Test --fresh clears existing state"
            - "Test --fresh results in all specs executing"
            - "Test --fresh without existing state works normally"
    - number: 7
      title: "User Story 5 - View DAG status from single file (US-005)"
      purpose: "Enable viewing current status by reading the DAG file directly"
      story_reference: "US-005"
      independent_test: "Run dag status and verify it correctly displays information from the dag.yaml file"
      tasks:
        - id: "T020"
          title: "Update internal/cli/dag/status.go to read state from dag.yaml"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/cli/dag/status.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "dag status reads from dag.yaml embedded state"
            - "No lookup to .autospec/state/dag-runs/ for new runs"
            - "Displays '(no state)' if no Run section exists"
            - "Shows spec status, progress, timestamps from embedded state"
        - id: "T021"
          title: "Add tests for updated status command in internal/cli/dag/status_test.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-005"
          file_path: "internal/cli/dag/status_test.go"
          dependencies: ["T020"]
          acceptance_criteria:
            - "Test status displays from embedded state"
            - "Test status shows '(no state)' when no Run section"
            - "Test status shows correct progress counts"
    - number: 8
      title: "User Story 6 - List DAGs with embedded status (US-006)"
      purpose: "Enable listing all DAG files with their current status"
      story_reference: "US-006"
      independent_test: "Create multiple DAGs in various states and run dag list to verify correct status display"
      tasks:
        - id: "T022"
          title: "Update internal/cli/dag/list.go to show status from embedded state"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-006"
          file_path: "internal/cli/dag/list.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "dag list reads each dag.yaml and extracts embedded state"
            - "Shows status, progress, last activity from Run/Specs sections"
            - "Shows '(no state)' for DAGs without Run section"
            - "Does not require .autospec/state/dag-runs/ lookup"
        - id: "T023"
          title: "Add tests for updated list command in internal/cli/dag/list_test.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-006"
          file_path: "internal/cli/dag/list_test.go"
          dependencies: ["T022"]
          acceptance_criteria:
            - "Test list shows embedded status correctly"
            - "Test list handles DAGs without state"
            - "Test list shows progress from Specs counts"
    - number: 9
      title: "User Stories 7 & 8 - Cleanup and Migration (US-007, US-008)"
      purpose: "Enable cleanup of worktrees and migration of existing state files"
      story_reference: "US-007, US-008"
      independent_test: "Run dag cleanup and dag migrate-state to verify correct behavior"
      tasks:
        - id: "T024"
          title: "Update internal/cli/dag/cleanup.go to clear state sections"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-007"
          file_path: "internal/cli/dag/cleanup.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "dag cleanup removes worktrees then clears Run, Specs, Staging from dag.yaml"
            - "Uses ClearInlineState helper"
            - "Returns error if state write fails"
        - id: "T025"
          title: "Add --keep-state flag to internal/cli/dag/cleanup.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-007"
          file_path: "internal/cli/dag/cleanup.go"
          dependencies: ["T024"]
          acceptance_criteria:
            - "--keep-state flag defined in command flags"
            - "When --keep-state specified, remove worktrees but preserve state sections"
            - "State remains readable for reference after cleanup"
        - id: "T026"
          title: "Create internal/cli/dag/migrate.go command for explicit migration"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-008"
          file_path: "internal/cli/dag/migrate.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "dag migrate-state command exists"
            - "Takes dag.yaml path as argument"
            - "Calls MigrateLegacyState from migrate.go"
            - "Reports success/failure clearly"
            - "Removes legacy state file after successful migration"
        - id: "T027"
          title: "Update internal/cli/dag/merge.go to read state from dag.yaml"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/cli/dag/merge.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "dag merge reads spec state from embedded Specs section"
            - "Updates Merge field in SpecState after merge"
            - "Writes updated state back to dag.yaml"
        - id: "T028"
          title: "Add tests for cleanup and migrate commands"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-007"
          file_path: "internal/cli/dag/cleanup_test.go"
          dependencies: ["T024", "T025", "T026"]
          acceptance_criteria:
            - "Test cleanup clears state by default"
            - "Test cleanup --keep-state preserves state"
            - "Test migrate-state migrates and removes legacy file"
    - number: 10
      title: "Polish & Cross-Cutting Concerns"
      purpose: "Final cleanup, documentation, and validation"
      tasks:
        - id: "T029"
          title: "Remove unused run_id generation code from runstate.go"
          status: "Pending"
          type: "refactor"
          parallel: true
          story_id: null
          file_path: "internal/dag/runstate.go"
          dependencies: ["T012", "T013"]
          acceptance_criteria:
            - "generateRunID function removed"
            - "Run-id based SaveState and LoadState marked deprecated"
            - "No new code paths use run_id generation"
            - "Existing legacy support preserved for migration"
        - id: "T030"
          title: "Update runstate_test.go for inline state changes"
          status: "Pending"
          type: "test"
          parallel: true
          story_id: null
          file_path: "internal/dag/runstate_test.go"
          dependencies: ["T029"]
          acceptance_criteria:
            - "Tests updated to not rely on run_id generation"
            - "Legacy compatibility tests preserved"
            - "New tests verify workflow-path based state"
        - id: "T031"
          title: "Register migrate-state subcommand in internal/cli/dag/dag.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/cli/dag/dag.go"
          dependencies: ["T026"]
          acceptance_criteria:
            - "migrate-state command registered as subcommand of dag"
            - "Help text describes migration purpose"
            - "Command appears in dag --help output"
        - id: "T032"
          title: "Run make test && make fmt && make lint && make build"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: null
          file_path: null
          dependencies: ["T029", "T030", "T031"]
          acceptance_criteria:
            - "make test exits 0 with all tests passing"
            - "make fmt exits 0 with no formatting changes"
            - "make lint exits 0 with no linting errors"
            - "make build exits 0 producing valid binary"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-002", "US-005", "US-006"]
        - story_id: "US-002"
          depends_on: ["US-001"]
          blocks: ["US-003", "US-004"]
        - story_id: "US-003"
          depends_on: ["US-002"]
          blocks: []
        - story_id: "US-004"
          depends_on: ["US-002"]
          blocks: []
        - story_id: "US-005"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-006"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-007"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-008"
          depends_on: ["US-001"]
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2]
        - phase: 2
          blocks: [3, 4, 5, 6, 7, 8, 9]
        - phase: 3
          blocks: [4]
        - phase: 4
          blocks: [5, 6]
        - phase: 5
          blocks: []
        - phase: 6
          blocks: []
        - phase: 7
          blocks: []
        - phase: 8
          blocks: []
        - phase: 9
          blocks: [10]
        - phase: 10
          blocks: []
parallel_execution:
    - phase: 2
      parallel_groups:
        - tasks: ["T003", "T004", "T005"]
          rationale: "Writer, migrate, and type tests can be developed in parallel - different files, no dependencies"
    - phase: 9
      parallel_groups:
        - tasks: ["T024", "T026", "T027"]
          rationale: "Cleanup, migrate command, and merge update are independent CLI commands"
    - phase: 10
      parallel_groups:
        - tasks: ["T029", "T030"]
          rationale: "Runstate refactor and test updates can be done in parallel"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3, 4]
        description: "Schema extension + State writer + View progress + Run without run_id"
        validation: "Execute dag run and verify state appears in dag.yaml with no separate state file created"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2]
          deliverable: "DAGConfig extended with inline state types; writer and migrate functions available"
        - milestone: "Core Inline State"
          phases: [1, 2, 3, 4]
          deliverable: "DAG execution writes state to dag.yaml; no run_id generation; single file source of truth"
        - milestone: "Resume and Fresh"
          phases: [1, 2, 3, 4, 5, 6]
          deliverable: "Interrupted DAGs can resume; --fresh flag resets state"
        - milestone: "CLI Complete"
          phases: [1, 2, 3, 4, 5, 6, 7, 8, 9]
          deliverable: "All dag commands (status, list, cleanup, merge, migrate-state) work with inline state"
        - milestone: "Full Implementation"
          phases: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
          deliverable: "Legacy code cleaned up; all tests pass; ready for release"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec v0.8.2"
    created: "2026-01-12T09:21:56Z"
    artifact_type: "tasks"
