plan:
  branch: "097-dag-inline-state"
  created: "2026-01-12"
  spec_path: "specs/097-dag-inline-state/spec.yaml"

summary: |
  This implementation consolidates DAG runtime state directly into the dag.yaml file,
  eliminating the separate state file in .autospec/state/dag-runs/. The key change is
  architectural: the workflow file path becomes the sole identifier (no run_id generation),
  and state sections (run, specs, staging) are embedded at the bottom of the dag.yaml file
  with clear visual separation from the definition sections.

  The approach extends DAGConfig with optional runtime state fields (Run, Specs, Staging)
  with omitempty tags, implements atomic in-place file updates preserving definition sections,
  adds auto-migration from legacy state files, and updates all CLI commands to read/write
  inline state. This simplifies the user experience from "two files to understand" to
  "single source of truth" while maintaining full backward compatibility during migration.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing and serialization for dag.yaml with state sections"
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework"
  storage: "File-based YAML (dag.yaml with embedded state)"
  testing:
    framework: "testing (stdlib)"
    approach: "Map-based table-driven unit tests with t.Parallel(); integration tests for file operations"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "State read/write operations <100ms; validation <10ms"
  constraints:
    - "Must maintain backward compatibility with existing dag.yaml definition schemas"
    - "State sections must be optional - dag.yaml without state is valid"
    - "Must support migration from existing .autospec/state/dag-runs/ state files"
    - "Cannot break existing dag run, dag status, dag list, dag merge, dag cleanup commands"
    - "Single-user execution: concurrent runs of same DAG file are not supported"
    - "Atomic file writes required for state persistence (temp file + rename)"
  scale_scope: "Single developer workflows with 1-50 specs per DAG"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All new code will have tests written before implementation using map-based table-driven pattern"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "State sections are validated on load; malformed state triggers clear error messages"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "State operations target <100ms; validation <10ms per spec requirement"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "State writes use atomic temp-file-rename pattern; operations are idempotent"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "State embedded in standard YAML format using gopkg.in/yaml.v3"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines; errors wrapped with fmt.Errorf; map-based tests"

research_findings:
  decisions:
    - topic: "State embedding approach"
      decision: "Add optional Run, Specs, Staging fields to DAGConfig struct with yaml omitempty tags"
      rationale: "Cleanest approach - single struct handles both definition and state; omitempty ensures clean output when no state exists"
      alternatives_considered:
        - "Sibling .state file (gitstats.yaml + gitstats.yaml.state)"
        - "Separate struct with manual YAML concatenation"
        - "Custom YAML marshaler for section separation"
    - topic: "Run ID elimination"
      decision: "Remove run_id generation entirely; workflow file path is the sole identifier"
      rationale: "Matches documented philosophy; simplifies discovery; eliminates unnecessary indirection"
      alternatives_considered:
        - "Keep run_id as optional fallback"
        - "Generate run_id but don't expose to users"
    - topic: "State section visual separation"
      decision: "Use YAML comment marker before state sections when writing"
      rationale: "Clear visual distinction for users reading the file; no schema changes required"
      alternatives_considered:
        - "Separate YAML documents (---)"
        - "Custom section marker field"
    - topic: "Legacy state migration"
      decision: "Auto-migrate on dag run; explicit dag migrate-state command for manual migration"
      rationale: "Seamless transition for existing users; explicit command for controlled migration"
      alternatives_considered:
        - "Require manual migration only"
        - "Maintain dual-read indefinitely"
    - topic: "Atomic write strategy"
      decision: "Write to temp file in same directory, then atomic rename"
      rationale: "Prevents partial writes and corruption; same pattern used by existing retry state"
      alternatives_considered:
        - "Write directly with file locks"
        - "Backup file before write"

data_model:
  entities:
    - name: "DAGConfig"
      description: "Extended root configuration struct containing both DAG definition and runtime state"
      fields:
        - name: "SchemaVersion"
          type: "string"
          description: "Format version (e.g., '1.0')"
          constraints: "Required"
        - name: "DAG"
          type: "DAGMetadata"
          description: "DAG identification metadata"
          constraints: "Required"
        - name: "Execution"
          type: "ExecutionConfig"
          description: "Execution configuration options"
          constraints: "Optional with defaults"
        - name: "Layers"
          type: "[]Layer"
          description: "Ordered list of execution layers"
          constraints: "Required, at least one layer"
        - name: "Run"
          type: "*RunState"
          description: "Overall execution state (runtime, optional)"
          constraints: "omitempty - only present during/after execution"
        - name: "Specs"
          type: "map[string]SpecState"
          description: "Per-spec runtime state (runtime, optional)"
          constraints: "omitempty - only present during/after execution"
        - name: "Staging"
          type: "map[string]LayerStaging"
          description: "Layer staging branch state (runtime, optional)"
          constraints: "omitempty - only present during/after execution"
      relationships:
        - target: "RunState"
          type: "one-to-one"
          description: "DAGConfig has at most one RunState for current execution"
        - target: "SpecState"
          type: "one-to-many"
          description: "DAGConfig has zero-to-many SpecState entries keyed by spec ID"
        - target: "LayerStaging"
          type: "one-to-many"
          description: "DAGConfig has zero-to-many LayerStaging entries keyed by layer ID"

    - name: "RunState"
      description: "Overall execution state for the DAG run (replaces part of DAGRun)"
      fields:
        - name: "Status"
          type: "string"
          description: "Overall run status"
          constraints: "One of: pending, running, completed, failed, interrupted"
        - name: "StartedAt"
          type: "time.Time"
          description: "Execution start timestamp"
          constraints: "Required when status != pending"
        - name: "CompletedAt"
          type: "*time.Time"
          description: "Execution completion timestamp"
          constraints: "Optional, set when status is completed/failed"
      relationships:
        - target: "DAGConfig"
          type: "belongs-to"
          description: "RunState is embedded within DAGConfig"

    - name: "SpecState"
      description: "Runtime state for an individual spec (slimmed down from DAGRun.Specs)"
      fields:
        - name: "Status"
          type: "string"
          description: "Spec execution status"
          constraints: "One of: pending, running, completed, failed, blocked"
        - name: "Worktree"
          type: "string"
          description: "Absolute path to worktree"
          constraints: "Optional, set when worktree created"
        - name: "StartedAt"
          type: "*time.Time"
          description: "Spec execution start timestamp"
          constraints: "Optional"
        - name: "CompletedAt"
          type: "*time.Time"
          description: "Spec execution completion timestamp"
          constraints: "Optional"
        - name: "CurrentStage"
          type: "string"
          description: "Current workflow stage (specify/plan/tasks/implement)"
          constraints: "Optional"
        - name: "CommitSHA"
          type: "string"
          description: "SHA of implementation commit"
          constraints: "Optional, 40-char hex when set"
        - name: "CommitStatus"
          type: "string"
          description: "Commit verification status"
          constraints: "One of: pending, committed, failed"
        - name: "FailureReason"
          type: "string"
          description: "Error details if failed"
          constraints: "Optional"
        - name: "ExitCode"
          type: "int"
          description: "Exit code of autospec run command"
          constraints: "Optional"
        - name: "Merge"
          type: "*MergeState"
          description: "Merge status details"
          constraints: "Optional"
      relationships:
        - target: "DAGConfig"
          type: "belongs-to"
          description: "SpecState entries are embedded in DAGConfig.Specs map"

    - name: "LayerStaging"
      description: "State tracking for layer staging branches"
      fields:
        - name: "Branch"
          type: "string"
          description: "Full staging branch name"
          constraints: "Format: dag/<dag-id>/stage-<layer-id>"
        - name: "SpecsMerged"
          type: "[]string"
          description: "List of spec IDs merged into this staging"
          constraints: "Optional, may be empty"
      relationships:
        - target: "DAGConfig"
          type: "belongs-to"
          description: "LayerStaging entries are embedded in DAGConfig.Staging map"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/internal/dag-inline-state.md"
      description: "Internal documentation explaining inline state architecture (if needed)"
  source_code:
    - path: "internal/dag/types.go"
      description: "Extended DAGConfig with Run, Specs, Staging fields"
    - path: "internal/dag/runstate.go"
      description: "Modified state types; migration functions; removal of run_id generation"
    - path: "internal/dag/executor.go"
      description: "Modified to write state to dag.yaml instead of separate file"
    - path: "internal/dag/loader.go"
      description: "Extended to parse state sections when loading dag.yaml"
    - path: "internal/dag/writer.go"
      description: "New file for atomic dag.yaml writes preserving definition + adding state"
    - path: "internal/dag/migrate.go"
      description: "New file for legacy state file migration logic"
    - path: "internal/cli/dag/run.go"
      description: "Updated to use inline state; --fresh clears state sections"
    - path: "internal/cli/dag/status.go"
      description: "Updated to read state from dag.yaml"
    - path: "internal/cli/dag/list.go"
      description: "Updated to show status from embedded state"
    - path: "internal/cli/dag/cleanup.go"
      description: "Updated to clear state sections; --keep-state flag"
    - path: "internal/cli/dag/merge.go"
      description: "Updated to read state from dag.yaml"
    - path: "internal/cli/dag/migrate.go"
      description: "New command for explicit state migration"
  tests:
    - path: "internal/dag/types_test.go"
      description: "Tests for extended DAGConfig with state fields"
    - path: "internal/dag/runstate_test.go"
      description: "Updated tests for new state types"
    - path: "internal/dag/writer_test.go"
      description: "Tests for atomic dag.yaml writes"
    - path: "internal/dag/migrate_test.go"
      description: "Tests for legacy state migration"
    - path: "internal/dag/executor_test.go"
      description: "Updated tests for inline state execution"

implementation_phases:
  - phase: 1
    name: "Schema Extension"
    goal: "Extend DAGConfig to support embedded state sections"
    deliverables:
      - "Add Run, Specs, Staging fields to DAGConfig in types.go"
      - "Define InlineRunState, InlineSpecState, InlineLayerStaging types"
      - "Ensure omitempty tags for clean output when no state"
      - "Tests for parsing dag.yaml with and without state sections"

  - phase: 2
    name: "State Writer"
    goal: "Implement atomic state persistence to dag.yaml"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Create writer.go with SaveDAGWithState function"
      - "Implement atomic write (temp file + rename)"
      - "Add YAML comment separator before state sections"
      - "Tests for atomic writes, preserving definition, adding state"

  - phase: 3
    name: "Migration Support"
    goal: "Enable seamless transition from legacy state files"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "Create migrate.go with MigrateLegacyState function"
      - "Implement auto-detection of legacy state files"
      - "Add dag migrate-state CLI command"
      - "Tests for migration scenarios including edge cases"

  - phase: 4
    name: "Executor Integration"
    goal: "Modify executor to use inline state exclusively"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "Update executor to write state to dag.yaml"
      - "Remove run_id generation code paths"
      - "Update state initialization and persistence"
      - "Implement --fresh flag to clear state sections"
      - "Tests for executor with inline state"

  - phase: 5
    name: "CLI Command Updates"
    goal: "Update all dag commands to use inline state"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Update dag status to read from dag.yaml"
      - "Update dag list to show embedded status"
      - "Update dag cleanup with --keep-state flag"
      - "Update dag merge to read from dag.yaml"
      - "Tests for all updated CLI commands"

  - phase: 6
    name: "Cleanup and Validation"
    goal: "Remove legacy code and ensure all tests pass"
    dependencies:
      - "Phase 5"
    deliverables:
      - "Remove unused run_id generation code"
      - "Remove legacy state file creation (keep read for migration)"
      - "Update documentation"
      - "Final integration testing"
      - "make test && make fmt && make lint && make build all exit 0"

open_questions:
  - question: "Should the YAML comment marker be customizable?"
    context: "The spec mentions a visual separator between definition and state sections"
    proposed_resolution: "Use fixed marker '# ====== RUNTIME STATE (auto-managed, do not edit) ======' - simple and clear"
  - question: "Should dag cleanup remove worktrees before or after clearing state?"
    context: "Order might matter if cleanup fails partway through"
    proposed_resolution: "Remove worktrees first, then clear state - if worktree removal fails, state still reflects reality"
  - question: "How to handle dag.yaml that has been externally modified during execution?"
    context: "User might edit definition while execution is running"
    proposed_resolution: "Re-read file before each state write, merge definition from file with state from memory (spec requirement)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.8.2"
  created: "2026-01-12T09:19:15Z"
  artifact_type: "plan"
