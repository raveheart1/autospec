feature:
    branch: "097-dag-inline-state"
    created: "2026-01-12"
    status: "Completed"
    completed_at: 2026-01-12T10:19:51Z
    input: ".dev/tasks/dag-orchestration/spec-12-inline-state.md"
user_stories:
    - id: "US-001"
      title: "View DAG progress in single file"
      priority: "P1"
      as_a: "developer running multi-spec workflows"
      i_want: "to see both DAG definition and execution state in a single file"
      so_that: "I can understand current progress without cross-referencing multiple files"
      why_this_priority: "Core value proposition - eliminates the fundamental problem of split state"
      independent_test: "Open dag.yaml and verify both definition sections and runtime state sections are present and readable"
      acceptance_scenarios:
        - given: "A DAG file with active execution"
          when: "I open the dag.yaml file"
          then: "I see definition (dag, execution, layers) at the top and runtime state (run, specs, staging) at the bottom"
        - given: "A DAG file with no prior execution"
          when: "I open the dag.yaml file"
          then: "I see only the definition sections with no runtime state sections"
    - id: "US-002"
      title: "Run DAG without run_id generation"
      priority: "P1"
      as_a: "developer executing DAG workflows"
      i_want: "to run a DAG using only the file path as identifier"
      so_that: "I don't need to track generated run IDs to manage my workflows"
      why_this_priority: "Eliminates unnecessary indirection and complexity in the primary workflow"
      independent_test: "Execute dag run and verify no run_id appears in output or file system"
      acceptance_scenarios:
        - given: "A valid dag.yaml file"
          when: "I run 'autospec dag run path/to/dag.yaml'"
          then: "execution starts and state is written directly to the dag.yaml file without generating a run_id"
        - given: "A running DAG execution"
          when: "I check the file system"
          then: "no state file exists in .autospec/state/dag-runs/"
    - id: "US-003"
      title: "Resume interrupted DAG execution"
      priority: "P1"
      as_a: "developer whose DAG execution was interrupted"
      i_want: "to resume execution from where it left off"
      so_that: "I don't lose progress on completed specs"
      why_this_priority: "Critical for reliability - interruptions happen frequently"
      independent_test: "Interrupt a running DAG, restart it, and verify only incomplete specs are re-executed"
      acceptance_scenarios:
        - given: "A dag.yaml with specs in various states (completed, running, pending)"
          when: "I run 'autospec dag run path/to/dag.yaml'"
          then: "completed specs are skipped and execution resumes from incomplete specs"
        - given: "A dag.yaml with a spec marked as 'running' from an interrupted execution"
          when: "I run 'autospec dag run path/to/dag.yaml'"
          then: "the previously running spec is re-executed from the beginning"
    - id: "US-004"
      title: "Start fresh DAG execution"
      priority: "P1"
      as_a: "developer wanting to re-run a DAG from scratch"
      i_want: "to clear all previous state and start fresh"
      so_that: "I can re-execute all specs without manually editing the file"
      why_this_priority: "Essential for debugging and re-running workflows"
      independent_test: "Run dag run --fresh on a DAG with existing state and verify all specs restart"
      acceptance_scenarios:
        - given: "A dag.yaml with completed specs"
          when: "I run 'autospec dag run path/to/dag.yaml --fresh'"
          then: "the run, specs, and staging sections are cleared and all specs execute from the beginning"
    - id: "US-005"
      title: "View DAG status from single file"
      priority: "P1"
      as_a: "developer monitoring DAG progress"
      i_want: "to view current status by reading the DAG file directly"
      so_that: "I don't need to look up separate state files"
      why_this_priority: "Primary user interface for monitoring - must work reliably"
      independent_test: "Run dag status and verify it correctly displays information from the dag.yaml file"
      acceptance_scenarios:
        - given: "A dag.yaml with embedded state"
          when: "I run 'autospec dag status path/to/dag.yaml'"
          then: "status is read from the dag.yaml file and displayed correctly"
        - given: "A dag.yaml without any state sections"
          when: "I run 'autospec dag status path/to/dag.yaml'"
          then: "status shows 'no state' or equivalent indication"
    - id: "US-006"
      title: "List DAGs with embedded status"
      priority: "P2"
      as_a: "developer managing multiple DAG workflows"
      i_want: "to list all DAG files with their current status"
      so_that: "I can see which workflows are running, completed, or not yet started"
      why_this_priority: "Important for multi-DAG management but not blocking core workflow"
      independent_test: "Create multiple DAGs in various states and run dag list to verify correct status display"
      acceptance_scenarios:
        - given: "Multiple dag.yaml files in .autospec/dags/"
          when: "I run 'autospec dag list'"
          then: "each DAG file is listed with status, progress, and last activity extracted from embedded state"
        - given: "A dag.yaml with no state sections"
          when: "I run 'autospec dag list'"
          then: "the DAG is listed with '(no state)' indicator"
    - id: "US-007"
      title: "Clean up DAG execution"
      priority: "P2"
      as_a: "developer who has finished a DAG execution"
      i_want: "to clean up worktrees and optionally clear state"
      so_that: "I can reclaim disk space and prepare for future runs"
      why_this_priority: "Important for maintenance but not blocking primary workflow"
      independent_test: "Run dag cleanup and verify worktrees are removed and state is cleared from dag.yaml"
      acceptance_scenarios:
        - given: "A dag.yaml with completed execution and created worktrees"
          when: "I run 'autospec dag cleanup path/to/dag.yaml'"
          then: "worktrees are removed and state sections are cleared from dag.yaml"
        - given: "A dag.yaml with completed execution"
          when: "I run 'autospec dag cleanup path/to/dag.yaml --keep-state'"
          then: "worktrees are removed but state sections remain in dag.yaml for reference"
    - id: "US-008"
      title: "Migrate existing state files"
      priority: "P2"
      as_a: "developer with existing DAG state files"
      i_want: "to migrate state into the dag.yaml file"
      so_that: "I can use the new inline state format without losing progress"
      why_this_priority: "Enables smooth transition but not blocking new workflows"
      independent_test: "Create legacy state file, run migration, verify state appears in dag.yaml"
      acceptance_scenarios:
        - given: "A dag.yaml with a corresponding state file in .autospec/state/dag-runs/"
          when: "I run 'autospec dag run path/to/dag.yaml'"
          then: "state is automatically migrated from the state file into dag.yaml"
        - given: "A successful auto-migration"
          when: "migration completes"
          then: "the old state file is removed from .autospec/state/dag-runs/"
        - given: "A dag.yaml with legacy state file"
          when: "I run 'autospec dag migrate-state path/to/dag.yaml'"
          then: "state is explicitly migrated and old state file is removed"
requirements:
    functional:
        - id: "FR-001"
          description: "DAGConfig struct MUST include optional Run, Specs, and Staging fields for runtime state"
          testable: true
          acceptance_criteria: "DAGConfig has Run *RunState, Specs map[string]SpecState, and Staging map[string]LayerStaging fields with yaml omitempty tags"
        - id: "FR-002"
          description: "State writes MUST update the dag.yaml file in-place preserving definition sections"
          testable: true
          acceptance_criteria: "After state update, dag.yaml contains original definition plus updated state sections"
        - id: "FR-003"
          description: "State reads MUST parse state sections from dag.yaml when present"
          testable: true
          acceptance_criteria: "Loading a dag.yaml with state sections populates Run, Specs, and Staging fields"
        - id: "FR-004"
          description: "The --fresh flag MUST clear run, specs, and staging sections before starting execution"
          testable: true
          acceptance_criteria: "Running with --fresh on a DAG with existing state results in empty state before execution begins"
        - id: "FR-005"
          description: "Run_id generation MUST be removed from the codebase"
          testable: true
          acceptance_criteria: "No code generates or uses run_id for DAG state tracking"
        - id: "FR-006"
          description: "The .autospec/state/dag-runs/ directory MUST no longer be used for new state"
          testable: true
          acceptance_criteria: "New DAG executions do not create files in .autospec/state/dag-runs/"
        - id: "FR-007"
          description: "SpecState MUST store only runtime data that cannot be derived from the definition"
          testable: true
          acceptance_criteria: "SpecState contains status, worktree, timestamps, commit info, and failure info but not spec_id, layer_id, or blocked_by"
        - id: "FR-008"
          description: "dag cleanup MUST remove worktrees and clear state sections by default"
          testable: true
          acceptance_criteria: "After cleanup, worktrees are removed and dag.yaml has no run, specs, or staging sections"
        - id: "FR-009"
          description: "dag cleanup --keep-state MUST remove worktrees but preserve state sections"
          testable: true
          acceptance_criteria: "After cleanup with --keep-state, worktrees are removed but state sections remain in dag.yaml"
        - id: "FR-010"
          description: "Auto-migration MUST detect and migrate state from legacy state files on dag run"
          testable: true
          acceptance_criteria: "Running dag run with a legacy state file present migrates state to dag.yaml and removes the old file"
        - id: "FR-011"
          description: "dag status MUST read state directly from the dag.yaml file"
          testable: true
          acceptance_criteria: "dag status displays correct information from embedded state without accessing separate state files"
        - id: "FR-012"
          description: "dag list MUST show status extracted from embedded state for each DAG file"
          testable: true
          acceptance_criteria: "dag list displays status, progress, and last activity from each dag.yaml's embedded state"
        - id: "FR-013"
          description: "The merge command MUST read state from dag.yaml"
          testable: true
          acceptance_criteria: "dag merge operations use state information from dag.yaml's embedded state sections"
        - id: "FR-014"
          description: "All unit and integration tests MUST pass after implementation"
          testable: true
          acceptance_criteria: "make test && make fmt && make lint && make build all exit 0"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "Functions MUST be under 40 lines"
          measurable_target: "No function exceeds 40 lines of code"
        - id: "NFR-002"
          category: "code_quality"
          description: "Errors MUST be wrapped with context using fmt.Errorf"
          measurable_target: "All error returns use fmt.Errorf with %w verb"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests MUST use map-based table test pattern"
          measurable_target: "All new test functions use map[string]struct{} pattern"
        - id: "NFR-004"
          category: "reliability"
          description: "State writes MUST be atomic to prevent corruption"
          measurable_target: "Write to temp file then rename to prevent partial writes"
        - id: "NFR-005"
          category: "usability"
          description: "State sections MUST be visually separated from definition in output"
          measurable_target: "YAML comment marker separates definition from state sections"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Users can view complete DAG definition and state in a single file"
          metric: "Number of files required to understand DAG state"
          target: "1 file (dag.yaml only)"
        - id: "SC-002"
          description: "No run_id identifiers are generated or required"
          metric: "Presence of run_id in code, output, or file system"
          target: "Zero occurrences"
        - id: "SC-003"
          description: "Legacy state files are not created for new executions"
          metric: "Files created in .autospec/state/dag-runs/ for new DAG runs"
          target: "Zero new files"
        - id: "SC-004"
          description: "All DAG commands work with inline state"
          metric: "Commands that correctly read/write inline state"
          target: "100% of dag commands (run, status, list, merge, cleanup)"
        - id: "SC-005"
          description: "Interrupted DAG executions can be resumed"
          metric: "Successful resume after interruption"
          target: "100% of interrupted runs resume correctly"
        - id: "SC-006"
          description: "Existing state files migrate automatically"
          metric: "Successful auto-migration on dag run"
          target: "100% of legacy state files migrate successfully"
key_entities:
    - name: "DAGConfig"
      description: "Root configuration struct containing both DAG definition and runtime state"
      attributes:
        - "SchemaVersion, DAG, Execution, Layers (definition)"
        - "Run, Specs, Staging (runtime state, optional)"
    - name: "RunState"
      description: "Overall execution state for the DAG run"
      attributes:
        - "Status (pending, running, completed, failed)"
        - "StartedAt, CompletedAt timestamps"
    - name: "SpecState"
      description: "Runtime state for an individual spec within the DAG"
      attributes:
        - "Status, Worktree path"
        - "StartedAt, CompletedAt timestamps"
        - "CurrentStage, CommitSHA, CommitStatus"
        - "FailureReason, ExitCode, Merge state"
    - name: "LayerStaging"
      description: "State tracking for layer staging branches"
      attributes:
        - "Branch name"
        - "SpecsMerged list"
edge_cases:
    - scenario: "DAG file is modified externally during execution"
      expected_behavior: "State writes preserve external definition changes by re-reading before write"
    - scenario: "DAG file becomes read-only during execution"
      expected_behavior: "State write fails with clear error message indicating permission issue"
    - scenario: "Multiple specs complete simultaneously"
      expected_behavior: "State writes are serialized to prevent concurrent write conflicts"
    - scenario: "Legacy state file exists but dag.yaml already has state"
      expected_behavior: "Embedded state takes precedence, legacy file is ignored with warning"
    - scenario: "Migration fails partway through"
      expected_behavior: "Original state file is preserved, dag.yaml is not corrupted"
    - scenario: "dag.yaml has malformed state sections"
      expected_behavior: "Clear error message identifying the parsing issue; definition sections still readable"
assumptions:
    - "Single-user execution: concurrent runs of the same DAG file are not supported"
    - "Git provides version history for dag.yaml changes during execution"
    - "YAML library preserves field ordering when marshaling"
    - "File system supports atomic rename operations for safe writes"
    - "Users have write permissions to dag.yaml files they execute"
constraints:
    - "Must maintain backward compatibility with existing dag.yaml definition schemas"
    - "State sections must be optional - dag.yaml without state is valid"
    - "Must support migration from existing .autospec/state/dag-runs/ state files"
    - "Cannot break existing dag run, dag status, dag list, dag merge, dag cleanup commands"
out_of_scope:
    - "Multiple concurrent runs of the same DAG file"
    - "Historical run archiving or versioning"
    - "State file backup mechanisms (git history sufficient)"
    - "YAML anchors/aliases in state sections"
    - "State encryption or obfuscation"
    - "Remote state storage"
    - "State synchronization across machines"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "v0.8.2"
    created: "2026-01-12T09:17:47Z"
    artifact_type: "spec"
