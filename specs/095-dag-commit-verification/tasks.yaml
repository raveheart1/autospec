tasks:
    branch: "095-dag-commit-verification"
    created: "2026-01-12"
    spec_path: "specs/095-dag-commit-verification/spec.yaml"
    plan_path: "specs/095-dag-commit-verification/plan.yaml"
summary:
    total_tasks: 24
    total_phases: 7
    parallel_opportunities: 8
    estimated_complexity: "medium"
phases:
    - number: 1
      title: "Setup"
      purpose: "Extend existing data types for commit tracking"
      tasks:
        - id: "T001"
          title: "Extend SpecState with commit status fields in internal/dag/types.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/types.go"
          dependencies: []
          acceptance_criteria:
            - "SpecState struct includes CommitStatus field (pending | committed | failed)"
            - "SpecState struct includes CommitSHA field (40-char hex or empty)"
            - "SpecState struct includes CommitAttempts field (int)"
            - "YAML tags match existing naming convention (snake_case)"
        - id: "T002"
          title: "Add VerificationIssue type in internal/dag/types.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/types.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "VerificationIssue struct with SpecID, Reason, CommitsAhead, UncommittedFiles fields"
            - "Reason constrained to 'no_commits' or 'uncommitted_changes'"
    - number: 2
      title: "Foundational"
      purpose: "Git helper functions and configuration extensions that all user stories depend on"
      tasks:
        - id: "T003"
          title: "Implement git helper functions in internal/dag/githelpers.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/githelpers.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "hasUncommittedChanges(worktreePath) returns bool, error using git status --porcelain"
            - "getUncommittedFiles(worktreePath) returns []string of uncommitted file paths"
            - "getCommitsAhead(worktreePath, targetBranch) returns int, error using git rev-list --count"
            - "getCommitSHA(worktreePath) returns current HEAD SHA"
            - "All functions complete within 5 seconds per worktree"
            - "All errors wrapped with context"
        - id: "T004"
          title: "Add tests for git helper functions in internal/dag/githelpers_test.go"
          status: "Completed"
          type: "test"
          parallel: true
          story_id: null
          file_path: "internal/dag/githelpers_test.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "Map-based table tests for hasUncommittedChanges (clean, modified, untracked, deleted)"
            - "Map-based table tests for getUncommittedFiles"
            - "Map-based table tests for getCommitsAhead (ahead, at target, behind)"
            - "Tests use temporary git repositories"
            - "All tests pass"
        - id: "T005"
          title: "Extend DAGExecutionConfig with autocommit fields in internal/dag/config.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/config.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "DAGExecutionConfig includes Autocommit bool field (default true)"
            - "DAGExecutionConfig includes AutocommitCmd string field"
            - "DAGExecutionConfig includes AutocommitRetries int field (default 1, range 0-10)"
            - "Config loading respects environment variable overrides (DAG_AUTOCOMMIT, etc.)"
            - "YAML tags use snake_case (autocommit, autocommit_cmd, autocommit_retries)"
        - id: "T006"
          title: "Implement template variable expansion for autocommit_cmd"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/commit.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "expandTemplateVars function expands {{spec_id}}, {{worktree}}, {{branch}}, {{base_branch}}, {{dag_id}}"
            - "Uses text/template for expansion"
            - "Returns error for invalid templates"
    - number: 3
      title: "User Story 1 - Automatic commit verification after spec execution"
      purpose: "Verify commits are made after each spec completes and retry if needed"
      story_reference: "US-001"
      independent_test: "Run dag run on a spec where agent didn't commit, verify retry happens"
      tasks:
        - id: "T007"
          title: "Implement CommitVerifier struct in internal/dag/commit.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/commit.go"
          dependencies: ["T003", "T005", "T006"]
          acceptance_criteria:
            - "CommitVerifier struct with config, stdout, stderr, cmdRunner fields"
            - "NewCommitVerifier constructor accepts DAGExecutionConfig and io.Writers"
            - "Struct follows existing pattern from MergeExecutor"
        - id: "T008"
          title: "Implement PostExecutionCommitFlow method in internal/dag/commit.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/commit.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Returns nil immediately if no uncommitted changes"
            - "Logs warning and returns nil if autocommit disabled"
            - "Retries commit up to AutocommitRetries times"
            - "Uses custom command if AutocommitCmd set, otherwise agent session"
            - "Verifies commit after each attempt (no uncommitted changes AND commits ahead > 0)"
            - "Returns error after all retries exhausted"
            - "Function under 40 lines (extract helpers)"
        - id: "T009"
          title: "Implement RunCustomCommitCmd method in internal/dag/commit.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/dag/commit.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Expands template variables in command"
            - "Executes command in worktree directory"
            - "Returns error if command fails"
            - "Respects timeout (30 seconds default)"
        - id: "T010"
          title: "Implement RunAgentCommitSession method in internal/dag/commit.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/dag/commit.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Constructs commit-focused prompt with git status output"
            - "Runs autospec with prompt in worktree directory"
            - "Passes --no-auto-commit flag to prevent recursion"
            - "Returns error if agent session fails"
        - id: "T011"
          title: "Integrate commit verification into DAG executor in internal/dag/executor.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/executor.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "executeSpec calls PostExecutionCommitFlow after successful autospec run"
            - "Updates SpecState.CommitStatus based on result"
            - "Updates SpecState.CommitSHA on successful commit"
            - "Marks spec as failed if commit verification fails"
            - "Existing tests continue to pass"
        - id: "T012"
          title: "Add tests for CommitVerifier in internal/dag/commit_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/commit_test.go"
          dependencies: ["T008", "T009", "T010"]
          acceptance_criteria:
            - "Map-based table tests for PostExecutionCommitFlow"
            - "Tests cover: no changes (success), changes committed by agent (success)"
            - "Tests cover: retry succeeds, all retries fail"
            - "Tests cover: custom command used when configured"
            - "Tests cover: agent session used when no custom command"
            - "Uses mock CommandRunner for isolation"
    - number: 4
      title: "User Story 2 - Manual commit trigger for DAG worktrees"
      purpose: "Allow developers to manually commit changes across worktrees"
      story_reference: "US-002"
      independent_test: "Run dag commit on worktrees with uncommitted changes, verify commits are made"
      tasks:
        - id: "T013"
          title: "Implement dag commit command in internal/cli/dag/commit.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/dag/commit.go"
          dependencies: ["T007", "T011"]
          acceptance_criteria:
            - "Cobra command 'dag commit <workflow.yaml>'"
            - "Loads run state for specified workflow"
            - "Iterates completed specs with uncommitted changes"
            - "Runs commit flow for each spec"
            - "Reports success/failure for each spec"
        - id: "T014"
          title: "Add --only flag to dag commit for single-spec commits"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-002"
          file_path: "internal/cli/dag/commit.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "--only <spec-id> flag filters to single spec"
            - "Returns error if spec not found in run state"
            - "Only processes specified spec"
        - id: "T015"
          title: "Add --dry-run flag to dag commit for preview mode"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-002"
          file_path: "internal/cli/dag/commit.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "--dry-run shows what would be committed without making changes"
            - "Lists uncommitted files for each spec"
            - "No actual commits are made"
        - id: "T016"
          title: "Add --cmd flag to dag commit for custom command override"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-002"
          file_path: "internal/cli/dag/commit.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "--cmd <command> overrides autocommit_cmd for this invocation"
            - "Template variables expanded in provided command"
        - id: "T017"
          title: "Add tests for dag commit command in internal/cli/dag/commit_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/dag/commit_test.go"
          dependencies: ["T013", "T014", "T015", "T016"]
          acceptance_criteria:
            - "Map-based table tests for dag commit command"
            - "Tests cover: commit all, --only, --dry-run, --cmd flags"
            - "Tests cover: no uncommitted changes, workflow not found"
            - "Uses mock CommandRunner"
    - number: 5
      title: "User Story 3 - Merge pre-flight verification"
      purpose: "Block merges when no commits exist or uncommitted changes present"
      story_reference: "US-003"
      independent_test: "Run dag merge on branches with no commits ahead, verify it fails with clear message"
      tasks:
        - id: "T018"
          title: "Implement verifyAllSpecs method in internal/dag/merge.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/merge.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "verifyAllSpecs returns map[string]*VerificationIssue"
            - "Checks for uncommitted changes in each completed spec"
            - "Checks for commits ahead of target branch"
            - "Returns issue for specs with no commits or uncommitted changes"
        - id: "T019"
          title: "Implement printVerificationReport for user-friendly output"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-003"
          file_path: "internal/dag/merge.go"
          dependencies: ["T018"]
          acceptance_criteria:
            - "Shows checkmark for specs ready to merge with commit count"
            - "Shows X for specs with issues"
            - "Lists uncommitted files for specs with uncommitted changes"
            - "Shows summary with counts by category"
            - "Includes actionable remediation suggestions"
        - id: "T020"
          title: "Integrate pre-flight verification into merge command"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/merge.go"
          dependencies: ["T018", "T019"]
          acceptance_criteria:
            - "Pre-flight runs before any merges"
            - "Default behavior: fail if any issues found"
            - "--skip-no-commits flag skips specs with no commits (still fails on uncommitted changes)"
            - "--force flag bypasses all verification"
            - "Output matches spec examples"
        - id: "T021"
          title: "Add tests for merge pre-flight verification in internal/dag/merge_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/merge_test.go"
          dependencies: ["T018", "T019", "T020"]
          acceptance_criteria:
            - "Map-based table tests for verifyAllSpecs"
            - "Tests cover: all ready, some no commits, some uncommitted, mixed issues"
            - "Tests cover: --skip-no-commits behavior"
            - "Tests verify output format"
    - number: 6
      title: "User Story 4 & 5 - Configuration and CLI flags"
      purpose: "Add autocommit configuration and extended CLI flags for dag run"
      story_reference: "US-004,US-005"
      independent_test: "Set different autocommit configs, verify behavior matches; complete dag run and verify merge prompt"
      tasks:
        - id: "T022"
          title: "Add --autocommit and --no-autocommit flags to dag run"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T011"]
          acceptance_criteria:
            - "--autocommit flag forces autocommit enabled"
            - "--no-autocommit flag forces autocommit disabled"
            - "Flags override both config file and dag.yaml settings"
            - "Mutually exclusive (error if both set)"
        - id: "T023"
          title: "Add --merge and --no-merge-prompt flags with post-run prompt"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-005"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T011", "T020"]
          acceptance_criteria:
            - "--merge flag auto-accepts merge prompt (for CI)"
            - "--no-merge-prompt flag skips prompt entirely"
            - "Default: prompts in interactive mode with Y as default"
            - "On partial success: suggests --skip-failed flag"
            - "Non-interactive terminals skip prompt automatically"
    - number: 7
      title: "Polish & Cross-Cutting Concerns"
      purpose: "Documentation and final validation"
      tasks:
        - id: "T024"
          title: "Update documentation and validate build"
          status: "Completed"
          type: "documentation"
          parallel: false
          story_id: null
          file_path: "docs/public/dag-commit-verification.md"
          dependencies: ["T012", "T017", "T021", "T022", "T023"]
          acceptance_criteria:
            - "docs/public/dag-commit-verification.md documents commit verification feature"
            - "docs/public/reference.md updated with dag commit command and new flags"
            - "make test passes"
            - "make fmt passes"
            - "make lint passes"
            - "make build passes"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-002"]
        - story_id: "US-002"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-003"
          depends_on: []
          blocks: []
        - story_id: "US-004"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-005"
          depends_on: ["US-001", "US-003"]
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2]
        - phase: 2
          blocks: [3, 4, 5]
        - phase: 3
          blocks: [4, 6]
        - phase: 4
          blocks: [7]
        - phase: 5
          blocks: [6, 7]
        - phase: 6
          blocks: [7]
parallel_execution:
    - phase: 1
      parallel_groups:
        - tasks: ["T001", "T002"]
          rationale: "T002 only needs T001 to define the types, can be done in same edit pass"
    - phase: 2
      parallel_groups:
        - tasks: ["T004", "T005"]
          rationale: "Tests for git helpers and config extension are independent"
    - phase: 3
      parallel_groups:
        - tasks: ["T009", "T010"]
          rationale: "Custom command and agent session methods are independent implementations"
    - phase: 4
      parallel_groups:
        - tasks: ["T014", "T015", "T016"]
          rationale: "All flags extend the base dag commit command independently"
    - phase: 5
      parallel_groups:
        - tasks: ["T019"]
          rationale: "Report printing can be developed alongside verification logic"
    - phase: 6
      parallel_groups:
        - tasks: ["T022", "T023"]
          rationale: "Autocommit flags and merge prompt flags are independent CLI extensions"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3, 5]
        description: "Setup + Foundational + Automatic commit verification + Merge pre-flight"
        validation: "dag run verifies commits, dag merge blocks on uncommitted changes"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2]
          deliverable: "Git helpers and config extensions in place; types extended"
        - milestone: "Core Verification"
          phases: [1, 2, 3]
          deliverable: "Automatic commit verification works after spec completion"
        - milestone: "Merge Protection"
          phases: [1, 2, 3, 5]
          deliverable: "dag merge pre-flight verification blocks bad merges"
        - milestone: "Manual Recovery"
          phases: [1, 2, 3, 4, 5]
          deliverable: "dag commit command enables manual commit recovery"
        - milestone: "Full Feature"
          phases: [1, 2, 3, 4, 5, 6, 7]
          deliverable: "Complete feature with all CLI flags and documentation"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec v0.8.2"
    created: "2026-01-12T06:30:06Z"
    artifact_type: "tasks"
