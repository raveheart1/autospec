feature:
    branch: "095-dag-commit-verification"
    created: "2026-01-12"
    status: "Completed"
    completed_at: 2026-01-12T07:13:22Z
    input: |
        DAG Commit Verification to solve the problem where `autospec dag merge` reports success
        even when worktrees have uncommitted code. Root cause: Agents don't always follow
        auto-commit instructions. The spec is marked "completed" when autospec run exits 0,
        regardless of whether code was committed. When dag merge runs, it merges branches
        with no commits ahead of main, which git considers a success ("Already up to date").

        Three-pronged solution:
        1. Post-execution commit flow: After autospec run succeeds, verify and ensure commits are made
        2. Dedicated dag commit command: Manual trigger for commit flow
        3. Merge pre-flight verification: Block merges when no commits exist
user_stories:
    - id: "US-001"
      title: "Automatic commit verification after spec execution"
      priority: "P1"
      as_a: "developer running DAG workflows"
      i_want: "the system to automatically verify that commits were made after each spec completes"
      so_that: "I don't end up with uncommitted code that silently fails to merge"
      why_this_priority: "Core problem - without this, the entire DAG workflow produces no actual code changes"
      independent_test: "Run dag run on a spec where agent didn't commit, verify retry happens"
      acceptance_scenarios:
        - given: "autospec run completes successfully in a worktree"
          when: "the agent committed all changes"
          then: "the spec is marked completed without retry"
        - given: "autospec run completes successfully in a worktree"
          when: "uncommitted changes exist and autocommit is enabled"
          then: "the system retries commit flow up to configured retry count"
        - given: "autospec run completes and commit retry exhausts all attempts"
          when: "uncommitted changes still exist"
          then: "the spec is marked as failed with commit failure reason"
    - id: "US-002"
      title: "Manual commit trigger for DAG worktrees"
      priority: "P1"
      as_a: "developer with uncommitted DAG changes"
      i_want: "a dedicated command to commit changes across worktrees"
      so_that: "I can fix uncommitted changes without re-running the entire DAG"
      why_this_priority: "Essential recovery mechanism when automatic commit fails"
      independent_test: "Run dag commit on worktrees with uncommitted changes, verify commits are made"
      acceptance_scenarios:
        - given: "a completed DAG run with uncommitted changes in some worktrees"
          when: "I run 'autospec dag commit workflow.yaml'"
          then: "the system commits changes in all worktrees with pending changes"
        - given: "a completed DAG run with uncommitted changes"
          when: "I run 'dag commit --only <spec-id>'"
          then: "only the specified spec's worktree is committed"
        - given: "a completed DAG run"
          when: "I run 'dag commit --dry-run'"
          then: "I see what would be committed without making changes"
    - id: "US-003"
      title: "Merge pre-flight verification"
      priority: "P1"
      as_a: "developer merging DAG results"
      i_want: "the merge command to verify branches have commits before merging"
      so_that: "I don't get false success messages when nothing was actually merged"
      why_this_priority: "Prevents the exact failure case described in the problem"
      independent_test: "Run dag merge on branches with no commits ahead, verify it fails with clear message"
      acceptance_scenarios:
        - given: "completed specs where some have no commits ahead of target branch"
          when: "I run 'autospec dag merge'"
          then: "the merge fails before any merges happen with a clear report"
        - given: "completed specs where some have uncommitted changes"
          when: "I run 'autospec dag merge'"
          then: "the merge fails and lists the files that need committing"
        - given: "some specs have no commits ahead"
          when: "I run 'dag merge --skip-no-commits'"
          then: "only specs with actual commits are merged"
    - id: "US-004"
      title: "Autocommit configuration"
      priority: "P2"
      as_a: "developer customizing DAG behavior"
      i_want: "to configure autocommit settings at config and DAG level"
      so_that: "I can control commit verification behavior per project or workflow"
      why_this_priority: "Flexibility is important but core functionality must work first"
      independent_test: "Set different autocommit configs, verify behavior matches settings"
      acceptance_scenarios:
        - given: "autocommit is disabled in config"
          when: "a spec completes with uncommitted changes"
          then: "a warning is logged but the spec is not marked failed"
        - given: "a custom autocommit_cmd is configured"
          when: "commit retry is triggered"
          then: "the custom command is executed instead of agent session"
        - given: "autocommit is set in both config and dag.yaml"
          when: "dag run executes"
          then: "the dag.yaml setting takes precedence"
    - id: "US-005"
      title: "Post-run merge prompt"
      priority: "P2"
      as_a: "developer completing a DAG run"
      i_want: "to be prompted to merge after completion"
      so_that: "I can quickly proceed to merge without running a separate command"
      why_this_priority: "Quality of life improvement, not core functionality"
      independent_test: "Complete dag run, verify merge prompt appears"
      acceptance_scenarios:
        - given: "all specs completed successfully"
          when: "dag run finishes"
          then: "I'm prompted to run dag merge with Y as default"
        - given: "some specs failed"
          when: "dag run finishes"
          then: "I'm prompted to merge completed specs with --skip-failed suggestion"
        - given: "--no-merge-prompt flag is set"
          when: "dag run finishes"
          then: "no prompt is shown"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST verify commit status immediately after each spec's autospec run completes"
          testable: true
          acceptance_criteria: "Post-execution hook runs after autospec run exit, before marking spec complete"
        - id: "FR-002"
          description: "MUST detect uncommitted changes using git status --porcelain"
          testable: true
          acceptance_criteria: "hasUncommittedChanges returns true when git status output is non-empty"
        - id: "FR-003"
          description: "MUST detect commits ahead of target branch using git rev-list --count"
          testable: true
          acceptance_criteria: "getCommitsAhead returns correct count for branches ahead/at/behind target"
        - id: "FR-004"
          description: "MUST retry commit flow when uncommitted changes exist and autocommit is enabled"
          testable: true
          acceptance_criteria: "Retry loop executes up to autocommit_retries times"
        - id: "FR-005"
          description: "MUST support custom commit command via autocommit_cmd config"
          testable: true
          acceptance_criteria: "Custom command executed with template variables expanded"
        - id: "FR-006"
          description: "MUST run agent commit session when no custom command configured"
          testable: true
          acceptance_criteria: "Agent invoked with commit-focused prompt in worktree directory"
        - id: "FR-007"
          description: "MUST provide dag commit command for manual commit triggering"
          testable: true
          acceptance_criteria: "Command exists, commits pending changes in completed specs"
        - id: "FR-008"
          description: "MUST support --only flag in dag commit for single-spec commits"
          testable: true
          acceptance_criteria: "Only specified spec's worktree is processed"
        - id: "FR-009"
          description: "MUST support --dry-run flag in dag commit"
          testable: true
          acceptance_criteria: "Shows what would be committed without making changes"
        - id: "FR-010"
          description: "MUST verify all specs before any merge in dag merge command"
          testable: true
          acceptance_criteria: "Pre-flight check runs on all completed specs before first merge"
        - id: "FR-011"
          description: "MUST fail dag merge when specs have no commits ahead and --skip-no-commits not set"
          testable: true
          acceptance_criteria: "Merge aborts with error listing problematic specs"
        - id: "FR-012"
          description: "MUST support --skip-no-commits flag to skip specs without commits"
          testable: true
          acceptance_criteria: "Only specs with commits are merged, others logged as skipped"
        - id: "FR-013"
          description: "MUST track commit status in run state (pending | committed | failed)"
          testable: true
          acceptance_criteria: "dag-runs/<run-id>.yaml includes commit_status, commit_sha, commit_attempts"
        - id: "FR-014"
          description: "MUST support dag.autocommit config option with default true"
          testable: true
          acceptance_criteria: "Config loading defaults autocommit to true"
        - id: "FR-015"
          description: "MUST support dag.autocommit_retries config option with default 1"
          testable: true
          acceptance_criteria: "Config loading defaults retries to 1"
        - id: "FR-016"
          description: "MUST support per-DAG autocommit override in dag.yaml execution section"
          testable: true
          acceptance_criteria: "dag.yaml autocommit setting overrides config when present"
        - id: "FR-017"
          description: "MUST support --autocommit and --no-autocommit flags on dag run"
          testable: true
          acceptance_criteria: "Flags override both config and dag.yaml settings"
        - id: "FR-018"
          description: "MUST prompt for merge after dag run completion in interactive mode"
          testable: true
          acceptance_criteria: "Prompt appears after run, default is Y"
        - id: "FR-019"
          description: "MUST support --no-merge-prompt flag to skip post-run prompt"
          testable: true
          acceptance_criteria: "No prompt when flag is set"
        - id: "FR-020"
          description: "MUST support --merge flag for auto-accepting merge prompt"
          testable: true
          acceptance_criteria: "Merge runs automatically without prompt when flag set"
        - id: "FR-021"
          description: "MUST expand template variables in autocommit_cmd (spec_id, worktree, branch, base_branch, dag_id)"
          testable: true
          acceptance_criteria: "All documented template variables correctly substituted"
        - id: "FR-022"
          description: "MUST provide clear error messages with actionable remediation steps"
          testable: true
          acceptance_criteria: "Error messages include file lists and specific command suggestions"
        - id: "FR-023"
          description: "MUST wrap all errors with context using fmt.Errorf pattern"
          testable: true
          acceptance_criteria: "No bare return err statements in new code"
        - id: "FR-024"
          description: "All functions MUST be under 40 lines"
          testable: true
          acceptance_criteria: "No function exceeds 40 lines"
        - id: "FR-025"
          description: "All tests MUST use map-based table test pattern"
          testable: true
          acceptance_criteria: "Tests use map[string]struct with t.Run"
        - id: "FR-026"
          description: "Implementation MUST pass make test && make fmt && make lint && make build"
          testable: true
          acceptance_criteria: "All commands exit 0"
    non_functional:
        - id: "NFR-001"
          category: "performance"
          description: "Git status and rev-list checks must complete within 5 seconds per worktree"
          measurable_target: "< 5 seconds for any single worktree check"
        - id: "NFR-002"
          category: "reliability"
          description: "Commit verification must be idempotent"
          measurable_target: "Multiple runs produce same result if no external changes"
        - id: "NFR-003"
          category: "usability"
          description: "Error messages must include specific file lists and remediation commands"
          measurable_target: "All error paths include actionable next steps"
        - id: "NFR-004"
          category: "code_quality"
          description: "Functions under 40 lines"
          measurable_target: "No function exceeds 40 lines"
        - id: "NFR-005"
          category: "code_quality"
          description: "Errors wrapped with context"
          measurable_target: "All errors use fmt.Errorf(\"doing X: %w\", err) pattern"
        - id: "NFR-006"
          category: "code_quality"
          description: "Map-based table tests"
          measurable_target: "All tests use map[string]struct pattern"
        - id: "NFR-007"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow this pattern"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "DAG merge no longer succeeds when worktrees have uncommitted code"
          metric: "Merge failure rate when uncommitted changes exist"
          target: "100% of merges fail with clear error when specs have uncommitted changes"
        - id: "SC-002"
          description: "Users can recover from uncommitted changes without re-running DAG"
          metric: "Successful recovery via dag commit command"
          target: "dag commit successfully commits pending changes in worktrees"
        - id: "SC-003"
          description: "Automatic commit retry recovers from agent failures"
          metric: "Specs successfully committed after retry"
          target: "At least 90% of uncommitted specs recover via retry"
        - id: "SC-004"
          description: "Users receive clear guidance on how to fix commit issues"
          metric: "Error message actionability"
          target: "All error messages include specific commands to run"
        - id: "SC-005"
          description: "Post-run merge prompt streamlines workflow"
          metric: "User can merge immediately after successful run"
          target: "Single Y/Enter press initiates merge after run completion"
key_entities:
    - name: "CommitStatus"
      description: "State of commits for a spec (pending, committed, failed)"
      attributes:
        - "status: pending | committed | failed"
        - "commit_sha: string (SHA of implementation commit)"
        - "commit_attempts: int (number of attempts made)"
    - name: "VerificationIssue"
      description: "Problem detected during pre-merge verification"
      attributes:
        - "spec_id: string"
        - "reason: no_commits | uncommitted_changes"
        - "commits_ahead: int"
        - "uncommitted_files: []string"
    - name: "AutocommitConfig"
      description: "Configuration for automatic commit behavior"
      attributes:
        - "enabled: bool (default true)"
        - "cmd: string (custom commit command with template vars)"
        - "retries: int (default 1)"
edge_cases:
    - scenario: "Worktree has been deleted or moved since run completed"
      expected_behavior: "Log error and mark spec as needing attention, skip in verification"
    - scenario: "Git repository is in detached HEAD state"
      expected_behavior: "Log error, cannot verify commits ahead of branch"
    - scenario: "Target branch has advanced since spec was created"
      expected_behavior: "Still count commits ahead correctly using rev-list"
    - scenario: "Custom commit command fails with non-zero exit"
      expected_behavior: "Count as failed attempt, retry if attempts remain"
    - scenario: "Agent commit session times out"
      expected_behavior: "Count as failed attempt, respect timeout settings"
    - scenario: "All files in worktree are in .gitignore"
      expected_behavior: "No uncommitted changes detected, spec considered committed"
    - scenario: "Only deleted files in uncommitted changes"
      expected_behavior: "Detected as uncommitted changes, commit flow triggered"
    - scenario: "Merge conflict during dag merge"
      expected_behavior: "Existing merge failure handling, not changed by this feature"
    - scenario: "Non-interactive terminal (CI/CD environment)"
      expected_behavior: "No merge prompt shown, use --merge flag for auto-merge"
assumptions:
    - "Git is available in PATH on the execution environment"
    - "Worktrees are valid git repositories with correct remotes"
    - "Target branch exists and is fetchable"
    - "Agent preset already includes auto-commit instructions (this feature adds verification)"
    - "Run state persists between dag run and dag commit/merge commands"
    - "Users understand git basics (commits, branches, staging)"
constraints:
    - "Must work with existing DAG executor architecture (internal/dag package)"
    - "Must use existing config loading patterns (internal/config)"
    - "Must integrate with existing run state storage (dag-runs/<run-id>.yaml)"
    - "Must not break existing dag run/merge commands for users with default settings"
    - "Must follow existing error handling patterns (wrapped errors)"
    - "Must follow existing CLI patterns (cobra commands, flags)"
out_of_scope:
    - "Automatic .gitignore pattern detection (agent decides what to ignore)"
    - "Commit message validation or linting"
    - "Force-commit option that bypasses verification"
    - "Squash or rebase options during merge"
    - "Push to remote (merge is local only)"
    - "Conflict resolution during merge"
    - "Branch protection rule integration"
    - "PR creation (merge is to local branch only)"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec v0.8.2"
    created: "2026-01-12T06:25:12Z"
    artifact_type: "spec"
