plan:
  branch: "095-dag-commit-verification"
  created: "2026-01-11"
  spec_path: "specs/095-dag-commit-verification/spec.yaml"

summary: |
  This plan implements a three-pronged approach to solve the DAG commit verification problem
  where `autospec dag merge` reports success even when worktrees have uncommitted code.

  The solution adds: (1) post-execution commit verification after each spec completes,
  with retry logic using either custom commands or agent sessions; (2) a new `dag commit`
  command for manual recovery; (3) merge pre-flight verification that blocks merges when
  no commits exist. The implementation extends existing DAG executor patterns with new
  configuration options, git helper functions, and enhanced state tracking for commit status.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "spf13/cobra"
      version: "v1.8.x"
      purpose: "CLI command framework"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.x"
      purpose: "YAML parsing for state and config files"
    - name: "knadh/koanf"
      version: "v2.x"
      purpose: "Hierarchical configuration loading"
  storage: "YAML files (.autospec/state/dag-runs/*.state)"
  testing:
    framework: "Go testing package"
    approach: "Map-based table-driven tests with dependency injection (CommandRunner interface)"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Git status and rev-list checks must complete within 5 seconds per worktree"
  constraints:
    - "Must integrate with existing DAG executor architecture (internal/dag)"
    - "Must use existing config loading patterns (internal/config)"
    - "Must integrate with existing run state storage (dag-runs/<workflow-hash>.state)"
    - "Must not break existing dag run/merge commands for users with default settings"
    - "Must follow existing error handling patterns (fmt.Errorf with %w)"
    - "Must follow existing CLI patterns (cobra commands, flags)"
    - "Functions must be <40 lines"
  scale_scope: "Typical DAG workflows have 3-20 specs, each in separate worktree"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All new packages and functions will have table-driven tests written before implementation"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "Pre-flight verification validates commit state before merge proceeds"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Git commands are lightweight; 5-second timeout per worktree ensures responsiveness"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Commit verification is idempotent; retry count is configurable (1-10)"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Commit failures will use exit code 1 (retryable), exhausted retries use exit code 2"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "Commit status tracked in YAML state files; config in YAML"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All code will pass go fmt and go vet before commit"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, map-based table tests, interface parameters"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "No changes to internal/commands templates required"

research_findings:
  decisions:
    - topic: "Where to implement commit verification logic"
      decision: "New file internal/dag/commit.go with CommitVerifier struct"
      rationale: "Follows existing pattern of feature-specific files (merge.go, executor.go)"
      alternatives_considered:
        - "Inline in executor.go (rejected: would bloat already large file)"
        - "Separate package (rejected: tight coupling with DAG state)"
    - topic: "How to detect uncommitted changes"
      decision: "Use git status --porcelain for uncommitted detection"
      rationale: "Reliable, machine-parseable output; commonly used pattern"
      alternatives_considered:
        - "git diff --cached (rejected: doesn't show untracked files)"
        - "git status -s (rejected: porcelain is more stable)"
    - topic: "How to count commits ahead"
      decision: "Use git rev-list --count <target>..HEAD"
      rationale: "Direct count without parsing commit list; efficient for large histories"
      alternatives_considered:
        - "git log --oneline | wc -l (rejected: slower, parsing overhead)"
        - "git cherry (rejected: designed for different use case)"
    - topic: "Agent commit session implementation"
      decision: "Re-run autospec with commit-focused prompt using existing CommandRunner"
      rationale: "Reuses existing infrastructure; consistent with DAG executor patterns"
      alternatives_considered:
        - "Direct Claude CLI invocation (rejected: bypasses autospec's agent abstraction)"
        - "Inline agent SDK (rejected: adds dependency, complexity)"
    - topic: "Custom commit command template variables"
      decision: "Use double-brace syntax ({{spec_id}}, {{worktree}}, etc.) with text/template"
      rationale: "Standard Go templating; familiar syntax; easy to implement"
      alternatives_considered:
        - "Environment variables (rejected: less explicit, harder to document)"
        - "Positional arguments (rejected: not self-documenting)"

data_model:
  entities:
    - name: "CommitStatus"
      description: "Tracks the commit state of a spec after execution"
      fields:
        - name: "Status"
          type: "string"
          description: "Current commit state"
          constraints: "One of: pending, committed, failed"
        - name: "CommitSHA"
          type: "string"
          description: "SHA of the implementation commit (if committed)"
          constraints: "40-character hex string or empty"
        - name: "CommitAttempts"
          type: "int"
          description: "Number of commit attempts made"
          constraints: "Non-negative integer"
      relationships:
        - target: "SpecState"
          type: "embedded"
          description: "CommitStatus is embedded within SpecState"

    - name: "VerificationIssue"
      description: "Problem detected during pre-merge verification"
      fields:
        - name: "SpecID"
          type: "string"
          description: "Identifier of the spec with the issue"
          constraints: "Must match a spec in the DAG"
        - name: "Reason"
          type: "string"
          description: "Type of verification failure"
          constraints: "One of: no_commits, uncommitted_changes"
        - name: "CommitsAhead"
          type: "int"
          description: "Number of commits ahead of target branch"
          constraints: "Non-negative integer"
        - name: "UncommittedFiles"
          type: "[]string"
          description: "List of files with uncommitted changes"
          constraints: "Each entry is a relative file path"
      relationships:
        - target: "MergeExecutor"
          type: "used-by"
          description: "MergeExecutor creates VerificationIssues during pre-flight check"

    - name: "AutocommitConfig"
      description: "Configuration for automatic commit behavior"
      fields:
        - name: "Enabled"
          type: "bool"
          description: "Whether post-execution commit verification is enabled"
          constraints: "Defaults to true"
        - name: "Cmd"
          type: "string"
          description: "Custom commit command with template variables"
          constraints: "Optional; if empty, uses agent session"
        - name: "Retries"
          type: "int"
          description: "Maximum number of commit retry attempts"
          constraints: "Range 0-10, defaults to 1"
      relationships:
        - target: "DAGExecutionConfig"
          type: "embedded"
          description: "AutocommitConfig fields are part of DAGExecutionConfig"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/dag-commit-verification.md"
      description: "User documentation for commit verification feature"
  source_code:
    - path: "internal/dag/commit.go"
      description: "CommitVerifier struct and commit verification logic"
    - path: "internal/dag/githelpers.go"
      description: "Git helper functions (hasUncommittedChanges, getCommitsAhead, etc.)"
    - path: "internal/dag/config.go"
      description: "Extended DAGExecutionConfig with autocommit fields"
    - path: "internal/dag/runstate.go"
      description: "Extended SpecState with commit status fields"
    - path: "internal/dag/executor.go"
      description: "Extended to call commit verification after spec completion"
    - path: "internal/dag/merge.go"
      description: "Extended with pre-flight verification and new flags"
    - path: "internal/cli/dag/commit.go"
      description: "New dag commit command implementation"
    - path: "internal/cli/dag/run.go"
      description: "Extended with --autocommit, --no-autocommit, --merge, --no-merge-prompt flags"
    - path: "internal/cli/dag/merge.go"
      description: "Extended with --skip-no-commits flag"
  tests:
    - path: "internal/dag/commit_test.go"
      description: "Tests for CommitVerifier and commit flow logic"
    - path: "internal/dag/githelpers_test.go"
      description: "Tests for git helper functions"
    - path: "internal/dag/merge_test.go"
      description: "Extended tests for pre-flight verification"
    - path: "internal/cli/dag/commit_test.go"
      description: "Tests for dag commit command"

implementation_phases:
  - phase: 1
    name: "Git Helpers and Core Types"
    goal: "Implement git helper functions and extend data types for commit tracking"
    deliverables:
      - "internal/dag/githelpers.go with hasUncommittedChanges, getUncommittedFiles, getCommitsAhead, getCommitSHA"
      - "internal/dag/githelpers_test.go with table-driven tests using temp git repos"
      - "Extended SpecState with CommitStatus, CommitSHA, CommitAttempts fields in types.go"
      - "VerificationIssue type definition"

  - phase: 2
    name: "Configuration Extensions"
    goal: "Add autocommit configuration options to DAG config system"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Extended DAGExecutionConfig with Autocommit, AutocommitCmd, AutocommitRetries fields"
      - "Extended LoadDAGConfig to handle new fields with environment variable overrides"
      - "Template variable expansion for autocommit_cmd"
      - "Configuration validation tests"

  - phase: 3
    name: "Commit Verifier Implementation"
    goal: "Implement CommitVerifier struct with post-execution commit flow"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "internal/dag/commit.go with CommitVerifier struct"
      - "PostExecutionCommitFlow method implementing retry logic"
      - "RunCustomCommitCmd method with template expansion"
      - "RunAgentCommitSession method for agent-based commit"
      - "internal/dag/commit_test.go with comprehensive table-driven tests"

  - phase: 4
    name: "Executor Integration"
    goal: "Integrate commit verification into DAG executor"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Extended executeSpec in executor.go to call PostExecutionCommitFlow"
      - "State updates for commit status after each spec"
      - "Extended executor tests for commit verification scenarios"

  - phase: 5
    name: "Merge Pre-flight Verification"
    goal: "Add pre-flight verification to merge command"
    dependencies:
      - "Phase 1"
    deliverables:
      - "verifyAllSpecs method in merge.go"
      - "printVerificationReport for user-friendly output"
      - "--skip-no-commits flag for dag merge"
      - "Extended merge tests for verification scenarios"

  - phase: 6
    name: "DAG Commit Command"
    goal: "Implement new dag commit CLI command"
    dependencies:
      - "Phase 3"
    deliverables:
      - "internal/cli/dag/commit.go with cobra command"
      - "--only flag for single-spec commit"
      - "--dry-run flag for preview mode"
      - "--cmd flag for custom command override"
      - "internal/cli/dag/commit_test.go"

  - phase: 7
    name: "Extended CLI Flags"
    goal: "Add remaining CLI flags to dag run and dag merge"
    dependencies:
      - "Phase 4"
      - "Phase 5"
    deliverables:
      - "--autocommit and --no-autocommit flags on dag run"
      - "--merge and --no-merge-prompt flags on dag run"
      - "Post-run merge prompt implementation"
      - "Extended CLI tests for new flags"

  - phase: 8
    name: "Documentation and Polish"
    goal: "Complete documentation and final integration testing"
    dependencies:
      - "Phase 6"
      - "Phase 7"
    deliverables:
      - "docs/public/dag-commit-verification.md user documentation"
      - "Updated docs/public/reference.md with new commands and flags"
      - "make test && make fmt && make lint && make build all pass"

open_questions:
  - question: "Should custom commit command timeout be configurable separately from spec timeout?"
    context: "Custom commands might need different timeouts than full spec execution"
    proposed_resolution: "Use a reasonable default (30 seconds) initially; add config option in future if needed"
  - question: "How should the system handle worktrees that were manually deleted since the run completed?"
    context: "Edge case where user removes worktrees before running dag commit or dag merge"
    proposed_resolution: "Log error, mark spec as needing attention, skip in verification (already in spec edge cases)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.8.2"
  created: "2026-01-12T06:27:04Z"
  artifact_type: "plan"
