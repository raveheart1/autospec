feature:
    branch: "064-worktree-management"
    created: "2025-12-20"
    status: "Completed"
    completed_at: 2025-12-20T01:09:10Z
    input: |
        Worktree Management Command - A new autospec worktree command for managing git worktrees
        with project-aware setup automation. When running multiple autospec all commands in parallel
        across worktrees, the .autospec/ directory is not git-tracked, so git worktree add doesn't
        copy it. Projects also need setup (npm install, etc.) run manually. This command automates
        worktree creation with automatic copying of non-tracked directories and execution of
        project-specific setup scripts.
user_stories:
    - id: "US-001"
      title: "Create worktree with automatic setup"
      priority: "P1"
      as_a: "developer running parallel autospec workflows"
      i_want: "to create a git worktree with a single command that automatically copies non-tracked configs and runs project setup"
      so_that: "I can immediately start working in the new worktree without manual configuration steps"
      why_this_priority: "Core functionality - this is the primary use case that solves the manual setup problem"
      independent_test: "Create a worktree and verify all expected files exist and setup completed"
      acceptance_scenarios:
        - given: "a git repository with .autospec/ directory and a setup script"
          when: "I run 'autospec worktree create zoom --branch feat/zoom-engine'"
          then: "a new worktree is created at the configured location with .autospec/ copied and setup script executed"
        - given: "a git repository with no setup script"
          when: "I run 'autospec worktree create zoom --branch feat/zoom'"
          then: "a new worktree is created with .autospec/ copied and no setup errors occur"
        - given: "a worktree with the same name already exists"
          when: "I attempt to create another worktree with the same name"
          then: "an error is returned indicating the name is already in use"
    - id: "US-002"
      title: "List tracked worktrees"
      priority: "P1"
      as_a: "developer managing multiple parallel features"
      i_want: "to see all tracked worktrees with their status, branch, and age"
      so_that: "I can understand which worktrees exist and their current state"
      why_this_priority: "Essential for managing multiple worktrees - users need visibility into what exists"
      independent_test: "Create multiple worktrees and verify list shows all with correct information"
      acceptance_scenarios:
        - given: "multiple tracked worktrees exist"
          when: "I run 'autospec worktree list'"
          then: "a table is displayed showing name, path, branch, status, and relative creation time for each worktree"
        - given: "no worktrees have been created"
          when: "I run 'autospec worktree list'"
          then: "a message indicates no worktrees are tracked"
    - id: "US-003"
      title: "Remove worktree safely"
      priority: "P1"
      as_a: "developer finished with a feature branch"
      i_want: "to remove a worktree with safety checks for uncommitted or unpushed changes"
      so_that: "I don't accidentally lose work when cleaning up"
      why_this_priority: "Critical safety feature to prevent data loss"
      independent_test: "Attempt removal with uncommitted changes and verify warning; force removal and verify cleanup"
      acceptance_scenarios:
        - given: "a worktree with uncommitted changes"
          when: "I run 'autospec worktree remove zoom'"
          then: "an error is returned indicating uncommitted changes and suggesting --force"
        - given: "a worktree with unpushed commits"
          when: "I run 'autospec worktree remove zoom'"
          then: "an error is returned indicating unpushed commits and suggesting --force"
        - given: "a worktree with uncommitted changes"
          when: "I run 'autospec worktree remove zoom --force'"
          then: "the worktree is removed and tracking entry deleted"
        - given: "a clean worktree with all changes pushed"
          when: "I run 'autospec worktree remove zoom'"
          then: "the worktree is removed without requiring --force"
    - id: "US-004"
      title: "Run setup on existing worktree"
      priority: "P2"
      as_a: "developer with manually created worktrees"
      i_want: "to run the project setup script on an existing worktree"
      so_that: "I can configure worktrees that weren't created with autospec"
      why_this_priority: "Useful for adoption and edge cases but not the primary workflow"
      independent_test: "Manually create a git worktree, run setup command, verify configuration applied"
      acceptance_scenarios:
        - given: "a manually created git worktree at ../my-worktree"
          when: "I run 'autospec worktree setup ../my-worktree'"
          then: "the setup script executes copying .autospec/ and running project initialization"
        - given: "the path does not exist"
          when: "I run 'autospec worktree setup ../nonexistent'"
          then: "an error is returned indicating the path doesn't exist"
    - id: "US-005"
      title: "Prune stale worktree entries"
      priority: "P2"
      as_a: "developer who has manually removed worktree directories"
      i_want: "to clean up stale tracking entries for worktrees that no longer exist"
      so_that: "the worktree list stays accurate and clean"
      why_this_priority: "Maintenance feature - useful but not essential for core workflow"
      independent_test: "Delete a worktree directory manually, run prune, verify entry removed from tracking"
      acceptance_scenarios:
        - given: "tracked worktrees where some paths no longer exist on disk"
          when: "I run 'autospec worktree prune'"
          then: "stale entries are removed and a count of removed entries is displayed"
        - given: "all tracked worktrees have valid paths"
          when: "I run 'autospec worktree prune'"
          then: "no entries are removed and the count shows zero"
    - id: "US-006"
      title: "Custom worktree path"
      priority: "P2"
      as_a: "developer with specific directory organization preferences"
      i_want: "to specify a custom path when creating a worktree"
      so_that: "I can organize worktrees in my preferred locations"
      why_this_priority: "Flexibility feature - default paths work for most users"
      independent_test: "Create worktree with custom path flag and verify it's created at specified location"
      acceptance_scenarios:
        - given: "I want to create a worktree at /tmp/zoom-dev"
          when: "I run 'autospec worktree create zoom --branch feat/zoom --path /tmp/zoom-dev'"
          then: "the worktree is created at /tmp/zoom-dev instead of the default location"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST create git worktrees using 'git worktree add' command"
          testable: true
          acceptance_criteria: "New worktree appears in 'git worktree list' output after creation"
        - id: "FR-002"
          description: "MUST copy .autospec/ directory to new worktrees during creation"
          testable: true
          acceptance_criteria: ".autospec/ exists in new worktree with same contents as source"
        - id: "FR-003"
          description: "SHOULD copy .claude/ directory to new worktrees if it exists"
          testable: true
          acceptance_criteria: ".claude/ copied when present; no error when absent"
        - id: "FR-004"
          description: "MUST execute project setup script if configured and exists"
          testable: true
          acceptance_criteria: "Setup script runs with correct arguments (path, name, branch)"
        - id: "FR-005"
          description: "MUST persist worktree state to .autospec/state/worktrees.yaml"
          testable: true
          acceptance_criteria: "State file contains accurate worktree entries after create/remove operations"
        - id: "FR-006"
          description: "MUST check for uncommitted changes before removal without --force"
          testable: true
          acceptance_criteria: "Error returned when uncommitted changes exist; removal proceeds with --force"
        - id: "FR-007"
          description: "MUST check for unpushed commits before removal without --force"
          testable: true
          acceptance_criteria: "Error returned when unpushed commits exist; removal proceeds with --force"
        - id: "FR-008"
          description: "MUST remove worktree using 'git worktree remove' command"
          testable: true
          acceptance_criteria: "Worktree removed from 'git worktree list' after removal"
        - id: "FR-009"
          description: "MUST display worktrees in tabular format with name, path, branch, status, and relative time"
          testable: true
          acceptance_criteria: "List output contains all expected columns with human-readable time format"
        - id: "FR-010"
          description: "MUST support worktree status values: active, merged, abandoned, stale"
          testable: true
          acceptance_criteria: "Status can be set and retrieved for each value"
        - id: "FR-011"
          description: "MUST detect and remove stale worktree entries during prune operation"
          testable: true
          acceptance_criteria: "Entries where path doesn't exist are removed; count returned"
        - id: "FR-012"
          description: "MUST support configurable base directory for worktree creation"
          testable: true
          acceptance_criteria: "Worktrees created in configured base_dir when set"
        - id: "FR-013"
          description: "MUST support configurable directory prefix for worktree names"
          testable: true
          acceptance_criteria: "Directory name uses configured prefix (e.g., 'wt-zoom' with prefix 'wt-')"
        - id: "FR-014"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-002"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern with t.Parallel()"
          measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
        - id: "NFR-004"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
        - id: "NFR-005"
          category: "usability"
          description: "Command output should provide clear feedback on success and failure"
          measurable_target: "All commands output descriptive messages; errors include actionable guidance"
        - id: "NFR-006"
          category: "reliability"
          description: "Operations must be idempotent where possible"
          measurable_target: "Creating existing worktree returns clear error; prune safe to run multiple times"
        - id: "NFR-007"
          category: "performance"
          description: "List operation should complete quickly for reasonable worktree counts"
          measurable_target: "List completes in under 1 second for up to 50 worktrees"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Users can create a fully-configured worktree with a single command"
          metric: "Steps required to create ready-to-use worktree"
          target: "1 command instead of 4+ manual commands"
        - id: "SC-002"
          description: "Users can view all managed worktrees with their status at a glance"
          metric: "Information completeness in list output"
          target: "Name, path, branch, status, and age visible for each worktree"
        - id: "SC-003"
          description: "Users are protected from accidentally losing uncommitted or unpushed work"
          metric: "Safety check coverage"
          target: "100% of remove operations check for uncommitted and unpushed changes"
        - id: "SC-004"
          description: "Worktree state persists across CLI invocations"
          metric: "State persistence accuracy"
          target: "State file accurately reflects all tracked worktrees after any operation"
key_entities:
    - name: "Worktree"
      description: "Represents a git worktree with tracking metadata"
      attributes:
        - "name: unique identifier for the worktree"
        - "path: absolute filesystem path to worktree"
        - "branch: git branch checked out in worktree"
        - "status: current state (active, merged, abandoned, stale)"
        - "created_at: timestamp of creation"
        - "setup_completed: whether setup script ran successfully"
        - "last_accessed: timestamp of last access"
        - "merged_at: timestamp when branch was merged (if applicable)"
    - name: "WorktreeState"
      description: "Container for all tracked worktrees persisted to YAML"
      attributes:
        - "version: schema version for state file"
        - "worktrees: list of tracked Worktree entries"
    - name: "WorktreeConfig"
      description: "Configuration for worktree management"
      attributes:
        - "base_dir: parent directory for new worktrees"
        - "prefix: directory name prefix"
        - "setup_script: path to setup script"
        - "auto_setup: whether to run setup automatically"
        - "track_status: whether to persist worktree state"
    - name: "Manager"
      description: "Interface for worktree CRUD operations"
      attributes:
        - "Create: create new worktree with setup"
        - "List: retrieve all tracked worktrees"
        - "Get: retrieve worktree by name"
        - "Remove: delete worktree with safety checks"
        - "Setup: run setup script on worktree"
        - "Prune: remove stale entries"
        - "UpdateStatus: change worktree status"
edge_cases:
    - scenario: "Setup script fails during worktree creation"
      expected_behavior: "Worktree is created but marked as setup_completed=false; warning logged but creation succeeds"
    - scenario: "Worktree path already exists on filesystem"
      expected_behavior: "Git worktree add fails; error returned to user with clear message"
    - scenario: "Worktree removed manually outside of autospec"
      expected_behavior: "Entry marked as stale on next list/prune; prune removes tracking entry"
    - scenario: "Setup script doesn't exist but is configured"
      expected_behavior: "Warning logged; worktree creation succeeds without running setup"
    - scenario: "Branch name already exists as local branch"
      expected_behavior: "Git worktree add uses existing branch instead of creating new"
    - scenario: "State file is corrupted or invalid YAML"
      expected_behavior: "Error returned with suggestion to delete/recreate state file"
    - scenario: "User tries to remove the main worktree"
      expected_behavior: "Error returned indicating main worktree cannot be removed via this command"
    - scenario: "Concurrent worktree operations on same state file"
      expected_behavior: "File locking or atomic writes prevent corruption"
assumptions:
    - "Git is installed and available in PATH"
    - "User has write access to the base directory for worktree creation"
    - "The .autospec/ directory exists in the source repository"
    - "Setup scripts are bash-compatible (#!/bin/bash)"
    - "State file format follows YAML 1.1 specification"
    - "Worktree names contain only alphanumeric characters, hyphens, and underscores"
constraints:
    - "Must use git worktree commands for worktree management (not manual directory creation)"
    - "State file must be stored in .autospec/state/ directory"
    - "Setup script execution is synchronous (blocks until complete)"
    - "Worktree names must be unique within a project"
    - "Remove operation requires worktree path to exist for safety checks (unless --force)"
out_of_scope:
    - "Automatic merge detection and status updates"
    - "Remote worktree synchronization across machines"
    - "Git submodule handling within worktrees"
    - "Custom per-worktree configuration"
    - "Worktree templates beyond the setup script"
    - "Background/async setup execution"
    - "Integration with autospec run/implement commands"
    - "Shell completion for worktree names"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-20T00:47:07Z"
    artifact_type: "spec"
