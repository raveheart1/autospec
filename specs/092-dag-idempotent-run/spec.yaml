feature:
  branch: "092-dag-idempotent-run"
  created: "2026-01-11"
  status: "Draft"
  input: |
    Spec 7: Idempotent DAG Run - Make `dag run` idempotent by automatically resuming
    if state exists. Remove `dag resume` and `dag retry` commands. Add --fresh, --only,
    and --clean flags. Key workflow path to state file instead of opaque run-ids.

user_stories:
  - id: "US-001"
    title: "Run DAG workflow idempotently"
    priority: "P1"
    as_a: "developer using autospec DAG orchestration"
    i_want: "to run `dag run workflow.yaml` and have it automatically resume if interrupted"
    so_that: "I don't need to remember opaque run-ids or use separate resume commands"
    why_this_priority: "Core functionality change that simplifies the entire UX"
    independent_test: "Run a workflow, interrupt it, run the same command again and verify it resumes"
    acceptance_scenarios:
      - given: "no prior state exists for workflow.yaml"
        when: "I run `dag run workflow.yaml`"
        then: "a fresh execution starts and state is saved keyed by workflow filename"
      - given: "partial state exists for workflow.yaml (3/5 specs completed)"
        when: "I run `dag run workflow.yaml`"
        then: "execution resumes from where it left off, skipping completed specs"
      - given: "all specs completed for workflow.yaml"
        when: "I run `dag run workflow.yaml`"
        then: "system reports all specs completed and takes no action"

  - id: "US-002"
    title: "Force fresh start with --fresh flag"
    priority: "P1"
    as_a: "developer who wants to restart from scratch"
    i_want: "to use `dag run workflow.yaml --fresh` to discard previous state"
    so_that: "I can start over without manually deleting state files"
    why_this_priority: "Essential escape hatch when resume behavior is not desired"
    independent_test: "Create state, run with --fresh, verify state is reset"
    acceptance_scenarios:
      - given: "existing state for workflow.yaml"
        when: "I run `dag run workflow.yaml --fresh`"
        then: "existing state is deleted, worktrees are cleaned up, and fresh execution begins"
      - given: "no existing state for workflow.yaml"
        when: "I run `dag run workflow.yaml --fresh`"
        then: "fresh execution starts (same as without --fresh)"

  - id: "US-003"
    title: "Run specific specs with --only flag"
    priority: "P2"
    as_a: "developer debugging a specific feature spec"
    i_want: "to run only specific spec(s) using `--only spec1,spec2`"
    so_that: "I can focus on particular specs without running the entire workflow"
    why_this_priority: "Important for debugging and iterative development but not core flow"
    independent_test: "Run workflow with --only flag specifying one spec, verify only that spec runs"
    acceptance_scenarios:
      - given: "existing state with spec0 completed and spec1 pending"
        when: "I run `dag run workflow.yaml --only spec1`"
        then: "only spec1 runs (dependencies already satisfied)"
      - given: "existing state with spec0 pending and spec1 depends on spec0"
        when: "I run `dag run workflow.yaml --only spec1`"
        then: "error is shown indicating spec0 dependency must be completed first"
      - given: "no existing state for workflow.yaml"
        when: "I run `dag run workflow.yaml --only spec1`"
        then: "error is shown indicating state must exist (use --fresh for new runs)"

  - id: "US-004"
    title: "Clean restart specific specs with --clean"
    priority: "P2"
    as_a: "developer who needs to completely redo a spec"
    i_want: "to use `--only spec1 --clean` to remove artifacts and restart that spec"
    so_that: "I can cleanly restart a spec without affecting others"
    why_this_priority: "Important for error recovery but --only provides partial solution"
    independent_test: "Mark spec as completed with artifacts, run with --only --clean, verify artifacts removed and spec re-runs"
    acceptance_scenarios:
      - given: "spec1 has completed state and artifacts exist in specs/spec1/"
        when: "I run `dag run workflow.yaml --only spec1 --clean`"
        then: "spec1 artifacts are removed, worktree deleted, state reset to pending, and spec runs fresh"
      - given: "spec1 has failed state"
        when: "I run `dag run workflow.yaml --only spec1 --clean`"
        then: "spec1 is cleaned and runs fresh (same as completed case)"

  - id: "US-005"
    title: "Updated commands use workflow file path"
    priority: "P1"
    as_a: "developer using dag orchestration commands"
    i_want: "all dag commands to use workflow file path instead of run-id"
    so_that: "I have a consistent, human-readable way to reference my workflow"
    why_this_priority: "Consistent UX across all commands is essential"
    independent_test: "Run each dag command with workflow file path and verify it works"
    acceptance_scenarios:
      - given: "a workflow with existing state"
        when: "I run `dag status workflow.yaml`"
        then: "status is shown for that workflow"
      - given: "a workflow with existing state"
        when: "I run `dag logs workflow.yaml spec1`"
        then: "logs are shown for spec1 in that workflow"
      - given: "a workflow with existing state"
        when: "I run `dag merge workflow.yaml`"
        then: "completed specs are merged"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST make dag run idempotent - automatically resume if state exists"
      testable: true
      acceptance_criteria: "Running `dag run workflow.yaml` twice resumes from saved state"
    - id: "FR-002"
      description: "MUST key state files by workflow filename, not opaque run-id"
      testable: true
      acceptance_criteria: "State stored in `.autospec/state/dag-runs/<workflow-filename>.state`"
    - id: "FR-003"
      description: "MUST implement --fresh flag to force fresh start"
      testable: true
      acceptance_criteria: "`--fresh` deletes state file and worktrees before starting"
    - id: "FR-004"
      description: "MUST implement --only flag to run specific spec(s)"
      testable: true
      acceptance_criteria: "`--only spec1,spec2` runs only specified specs"
    - id: "FR-005"
      description: "MUST implement --clean flag (used with --only) for clean restart"
      testable: true
      acceptance_criteria: "`--only spec1 --clean` removes artifacts, worktree, resets state"
    - id: "FR-006"
      description: "MUST remove dag resume command"
      testable: true
      acceptance_criteria: "`dag resume` command no longer exists"
    - id: "FR-007"
      description: "MUST remove dag retry command"
      testable: true
      acceptance_criteria: "`dag retry` command no longer exists"
    - id: "FR-008"
      description: "MUST update dag status, dag merge, dag cleanup, dag logs to use workflow file path"
      testable: true
      acceptance_criteria: "Each command accepts workflow file path as argument"
    - id: "FR-009"
      description: "MUST normalize workflow paths for state filename (replace / with -)"
      testable: true
      acceptance_criteria: "`features/v1.yaml` stores state as `features-v1.yaml.state`"
    - id: "FR-010"
      description: "MUST use only basename for absolute paths in state filename"
      testable: true
      acceptance_criteria: "`/abs/path/workflow.yaml` stores state as `workflow.yaml.state`"
    - id: "FR-011"
      description: "MUST validate dependencies when using --only flag"
      testable: true
      acceptance_criteria: "Error if specified spec depends on uncompleted specs"
    - id: "FR-012"
      description: "SHOULD migrate existing run-id based state files on first run"
      testable: true
      acceptance_criteria: "Legacy state files converted to new format transparently"
    - id: "FR-013"
      description: "MUST ensure make test && make fmt && make lint && make build all pass"
      testable: true
      acceptance_criteria: "All four commands exit with code 0"
  non_functional:
    - id: "NFR-001"
      category: "code_quality"
      description: "Functions must be under 40 lines"
      measurable_target: "No function exceeds 40 lines"
    - id: "NFR-002"
      category: "code_quality"
      description: "Errors must be wrapped with context (fmt.Errorf with %w)"
      measurable_target: "All error returns include context"
    - id: "NFR-003"
      category: "code_quality"
      description: "Tests must use map-based table tests"
      measurable_target: "Test tables use map[string]struct pattern"
    - id: "NFR-004"
      category: "usability"
      description: "CLI feedback must clearly indicate resume vs fresh start"
      measurable_target: "Output messages distinguish between new and resumed runs"
    - id: "NFR-005"
      category: "reliability"
      description: "State files must be atomic (write-rename pattern)"
      measurable_target: "No partial state files on crash"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can run same workflow command repeatedly without managing run-ids"
      metric: "Number of commands needed to resume interrupted workflow"
      target: "1 command (dag run workflow.yaml)"
    - id: "SC-002"
      description: "All dag commands use consistent workflow file path argument"
      metric: "Number of commands requiring run-id"
      target: "0 commands"
    - id: "SC-003"
      description: "Users can force fresh start without manual cleanup"
      metric: "Steps to restart workflow from scratch"
      target: "1 command with --fresh flag"
    - id: "SC-004"
      description: "Users can retry specific specs without running entire workflow"
      metric: "Steps to retry single spec"
      target: "1 command with --only flag"

key_entities:
  - name: "Workflow State File"
    description: "Persistent state for a workflow run, keyed by workflow filename"
    attributes:
      - "workflow_path: original path to workflow file"
      - "specs: map of spec states (pending, running, completed, failed)"
      - "created_at: timestamp of initial run"
      - "updated_at: timestamp of last state change"
  - name: "Workflow Path Normalizer"
    description: "Converts workflow file paths to state filenames"
    attributes:
      - "Replaces path separators with dashes"
      - "Uses basename only for absolute paths"
      - "Appends .state extension"
  - name: "Spec State"
    description: "Execution state for individual spec within workflow"
    attributes:
      - "status: pending | running | completed | failed"
      - "worktree_path: path to git worktree"
      - "artifacts: list of generated artifact paths"
      - "error: error message if failed"

edge_cases:
  - scenario: "Workflow file moved or renamed after partial execution"
    expected_behavior: "New state file created; old state orphaned (shown in dag list)"
  - scenario: "Multiple terminals try to run same workflow simultaneously"
    expected_behavior: "Second invocation detects lock and waits or errors"
  - scenario: "--clean used without --only flag"
    expected_behavior: "Error: --clean requires --only to specify which specs to clean"
  - scenario: "Spec specified in --only does not exist in workflow"
    expected_behavior: "Error with list of valid spec ids"
  - scenario: "Circular dependency detected when validating --only specs"
    expected_behavior: "Error with dependency chain shown"
  - scenario: "State file becomes corrupted"
    expected_behavior: "Error with suggestion to use --fresh"

assumptions:
  - "Workflow files have stable, unique paths within a project"
  - "Users prefer human-readable state identification over UUIDs"
  - "Resume is the most common recovery action (vs. fresh start)"
  - "Spec IDs in workflow files are stable across runs"
  - "Worktrees can be safely deleted when using --clean"

constraints:
  - "Single active run per workflow file (no parallel runs of same workflow)"
  - "State files stored in .autospec/state/dag-runs/ directory"
  - "Must maintain backward compatibility with existing workflows"
  - "Cannot change worktree creation/management logic (owned by other specs)"

out_of_scope:
  - "Multiple parallel runs of the same workflow file"
  - "Run-id as primary identifier (kept only for dag list history)"
  - "Automatic cleanup of orphaned state files"
  - "Web UI or dashboard for monitoring runs"
  - "Cross-machine state synchronization"
  - "Partial spec execution (run from specific step within a spec)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.8.2"
  created: "2026-01-11T19:20:30Z"
  artifact_type: "spec"
