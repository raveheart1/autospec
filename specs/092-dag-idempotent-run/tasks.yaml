tasks:
    branch: "092-dag-idempotent-run"
    created: "2026-01-11"
    spec_path: "specs/092-dag-idempotent-run/spec.yaml"
    plan_path: "specs/092-dag-idempotent-run/plan.yaml"
summary:
    total_tasks: 24
    total_phases: 8
    parallel_opportunities: 8
    estimated_complexity: "medium"
phases:
    - number: 1
      title: "Setup"
      purpose: "Create new files and prepare infrastructure for state management refactor"
      tasks:
        - id: "T001"
          title: "Create pathutils.go with WorkflowPathNormalizer functions"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/dag/pathutils.go"
          dependencies: []
          acceptance_criteria:
            - "NormalizeWorkflowPath(path) returns filesystem-safe filename"
            - "Replaces path separators with dashes"
            - "Uses basename only for absolute paths"
            - "Appends .state extension"
            - "Function under 40 lines"
        - id: "T002"
          title: "Create pathutils_test.go with table-driven tests"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/pathutils_test.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "Tests relative paths (features/v1.yaml → features-v1.yaml.state)"
            - "Tests absolute paths (/abs/path/workflow.yaml → workflow.yaml.state)"
            - "Tests nested paths with multiple separators"
            - "Uses map[string]struct table-driven pattern"
    - number: 2
      title: "Foundational - State Management Refactor"
      purpose: "Refactor DAGRun to use workflow-path keys and atomic operations"
      tasks:
        - id: "T003"
          title: "Add WorkflowPath field to DAGRun struct in runstate.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/runstate.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "WorkflowPath field added to DAGRun struct"
            - "Field is required for new runs, optional for legacy"
            - "JSON/YAML tags properly configured"
        - id: "T004"
          title: "Update state file naming to use normalized workflow path"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/runstate.go"
          dependencies: ["T001", "T003"]
          acceptance_criteria:
            - "State files named using NormalizeWorkflowPath()"
            - "LoadStateByWorkflow(workflowPath) function added"
            - "SaveState() uses workflow-path based filename"
        - id: "T005"
          title: "Implement atomic state file writes (write-rename pattern)"
          status: "InProgress"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/runstate.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "State written to temp file first"
            - "Atomic rename to final filename"
            - "No partial state files on crash"
            - "Function under 40 lines"
        - id: "T006"
          title: "Add tests for workflow-path state operations"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/runstate_test.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "Tests LoadStateByWorkflow for various paths"
            - "Tests atomic save operations"
            - "Tests state file naming"
            - "Uses map[string]struct table-driven pattern"
    - number: 3
      title: "US-001: Run DAG workflow idempotently"
      purpose: "Make dag run automatically resume if state exists"
      story_reference: "US-001"
      independent_test: "Run a workflow, interrupt it, run the same command again and verify it resumes"
      tasks:
        - id: "T007"
          title: "Implement idempotent run logic in run.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "Check for existing state before starting"
            - "If state exists, skip completed specs"
            - "If all specs completed, report and exit"
            - "Clear CLI output distinguishing new vs resumed runs"
            - "Errors wrapped with context"
        - id: "T008"
          title: "Update run.go to use LoadStateByWorkflow instead of run-id"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Workflow path used to locate state"
            - "RunID kept only for history/logging"
            - "State keyed by normalized workflow filename"
        - id: "T009"
          title: "Add tests for idempotent run behavior"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cli/dag/run_test.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "Test fresh run creates new state"
            - "Test resume skips completed specs"
            - "Test all-complete scenario exits cleanly"
            - "Uses map[string]struct table-driven pattern"
    - number: 4
      title: "US-002: Force fresh start with --fresh flag"
      purpose: "Allow users to restart workflows from scratch"
      story_reference: "US-002"
      independent_test: "Create state, run with --fresh, verify state is reset"
      tasks:
        - id: "T010"
          title: "Implement --fresh flag in run.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "--fresh flag added to run command"
            - "Deletes existing state file when set"
            - "Cleans up associated worktrees"
            - "Fresh execution begins after cleanup"
        - id: "T011"
          title: "Add tests for --fresh flag behavior"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/dag/run_test.go"
          dependencies: ["T010"]
          acceptance_criteria:
            - "Test --fresh with existing state resets state"
            - "Test --fresh with no state starts fresh"
            - "Test worktree cleanup on --fresh"
    - number: 5
      title: "US-003 & US-004: Selective execution with --only and --clean"
      purpose: "Enable running and cleaning specific specs"
      story_reference: "US-003"
      independent_test: "Run workflow with --only flag specifying one spec, verify only that spec runs"
      tasks:
        - id: "T012"
          title: "Implement --only flag for spec selection"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T010"]
          acceptance_criteria:
            - "--only flag accepts comma-separated spec IDs"
            - "Only specified specs are executed"
            - "Error if no existing state (suggest --fresh)"
            - "Validates spec IDs exist in workflow"
        - id: "T013"
          title: "Implement dependency validation for --only flag"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T012"]
          acceptance_criteria:
            - "Check dependencies of selected specs"
            - "Error if dependencies not completed"
            - "Clear error message listing missing dependencies"
            - "Function under 40 lines"
        - id: "T014"
          title: "Implement --clean flag (requires --only)"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "--clean flag added, requires --only"
            - "Error if --clean used without --only"
            - "Removes artifacts for specified specs"
            - "Deletes worktrees for specified specs"
            - "Resets spec state to pending"
        - id: "T015"
          title: "Add tests for --only and --clean flags"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-003"
          file_path: "internal/cli/dag/run_test.go"
          dependencies: ["T014"]
          acceptance_criteria:
            - "Test --only runs only specified specs"
            - "Test dependency validation errors"
            - "Test --clean without --only errors"
            - "Test --clean removes artifacts and resets state"
    - number: 6
      title: "US-005: Update commands to use workflow file path"
      purpose: "Consistent UX across all dag subcommands"
      story_reference: "US-005"
      independent_test: "Run each dag command with workflow file path and verify it works"
      tasks:
        - id: "T016"
          title: "Update dag status to accept workflow file path"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-005"
          file_path: "internal/cli/dag/status.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "Accepts workflow file path as argument"
            - "Uses LoadStateByWorkflow to find state"
            - "Displays status for that workflow"
        - id: "T017"
          title: "Update dag logs to accept workflow file path"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-005"
          file_path: "internal/cli/dag/logs.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "Accepts workflow file path as first argument"
            - "Spec ID as second argument"
            - "Displays logs for specified spec"
        - id: "T018"
          title: "Update dag merge to accept workflow file path"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-005"
          file_path: "internal/cli/dag/merge.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "Accepts workflow file path as argument"
            - "Merges completed specs from that workflow"
        - id: "T019"
          title: "Update dag cleanup to accept workflow file path"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-005"
          file_path: "internal/cli/dag/cleanup.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "Accepts workflow file path as argument"
            - "Cleans up worktrees for that workflow"
    - number: 7
      title: "Command Removal"
      purpose: "Remove dag resume and dag retry commands"
      tasks:
        - id: "T020"
          title: "Remove dag resume command"
          status: "Pending"
          type: "refactor"
          parallel: true
          story_id: null
          file_path: "internal/cli/dag/resume.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "resume.go file deleted"
            - "Command registration removed from dag.go"
            - "No references to resume command remain"
        - id: "T021"
          title: "Remove dag retry command (if exists)"
          status: "Pending"
          type: "refactor"
          parallel: true
          story_id: null
          file_path: "internal/cli/dag/retry.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "retry.go file deleted (if exists)"
            - "Command registration removed (if exists)"
    - number: 8
      title: "Polish & Documentation"
      purpose: "Update documentation and run final validation"
      tasks:
        - id: "T022"
          title: "Update docs/public/reference.md with new flags and removed commands"
          status: "Pending"
          type: "documentation"
          parallel: true
          story_id: null
          file_path: "docs/public/reference.md"
          dependencies: ["T020", "T021"]
          acceptance_criteria:
            - "Document --fresh flag"
            - "Document --only flag"
            - "Document --clean flag"
            - "Remove dag resume documentation"
            - "Remove dag retry documentation"
            - "Update dag status/logs/merge/cleanup arguments"
        - id: "T023"
          title: "Update CHANGELOG.md with breaking changes"
          status: "Pending"
          type: "documentation"
          parallel: true
          story_id: null
          file_path: "CHANGELOG.md"
          dependencies: ["T020", "T021"]
          acceptance_criteria:
            - "Document removal of dag resume and dag retry"
            - "Document new --fresh, --only, --clean flags"
            - "Document workflow-path based state keying"
            - "Mark as breaking changes"
        - id: "T024"
          title: "Run make test && make fmt && make lint && make build"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: null
          dependencies: ["T022", "T023"]
          acceptance_criteria:
            - "make fmt exits 0"
            - "make lint exits 0"
            - "make test exits 0"
            - "make build exits 0"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-002", "US-003"]
        - story_id: "US-002"
          depends_on: ["US-001"]
          blocks: ["US-003"]
        - story_id: "US-003"
          depends_on: ["US-002"]
          blocks: ["US-004"]
        - story_id: "US-004"
          depends_on: ["US-003"]
          blocks: []
        - story_id: "US-005"
          depends_on: []
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2]
        - phase: 2
          blocks: [3, 6]
        - phase: 3
          blocks: [4]
        - phase: 4
          blocks: [5]
        - phase: 5
          blocks: [7]
        - phase: 6
          blocks: [8]
        - phase: 7
          blocks: [8]
parallel_execution:
    - phase: 6
      parallel_groups:
        - tasks: ["T016", "T017", "T018", "T019"]
          rationale: "Different command files with no inter-dependencies"
    - phase: 7
      parallel_groups:
        - tasks: ["T020", "T021"]
          rationale: "Independent command removals"
    - phase: 8
      parallel_groups:
        - tasks: ["T022", "T023"]
          rationale: "Different documentation files"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3, 4]
        description: "Setup + Foundational + Idempotent Run + Fresh Flag"
        validation: "Run dag run workflow.yaml twice, verify resume behavior; test --fresh flag"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2]
          deliverable: "State management refactored to use workflow paths"
        - milestone: "Core Idempotent Behavior"
          phases: [1, 2, 3, 4]
          deliverable: "dag run is idempotent with --fresh option"
        - milestone: "Full Feature Set"
          phases: [1, 2, 3, 4, 5, 6, 7]
          deliverable: "All flags implemented, commands updated, legacy commands removed"
        - milestone: "Complete"
          phases: [1, 2, 3, 4, 5, 6, 7, 8]
          deliverable: "Documentation updated, all tests passing"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec v0.8.2"
    created: "2026-01-11T19:25:15Z"
    artifact_type: "tasks"
