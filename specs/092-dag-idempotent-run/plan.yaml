plan:
  branch: "092-dag-idempotent-run"
  created: "2026-01-11"
  spec_path: "specs/092-dag-idempotent-run/spec.yaml"

summary: |
  This plan transforms the DAG orchestration system from a run-id based model to an
  idempotent workflow-path based model. The core change is making `dag run workflow.yaml`
  automatically resume if prior state exists, eliminating the need for separate resume/retry
  commands and opaque run-ids. State files will be keyed by normalized workflow filename
  (e.g., `features/v1.yaml` â†’ `features-v1.yaml.state`), enabling intuitive repeat invocations.

  Implementation focuses on three areas: (1) refactoring state management to use workflow-path
  keys with atomic operations, (2) enhancing `dag run` with --fresh, --only, and --clean flags
  for fine-grained control, and (3) updating all dag subcommands to accept workflow file paths
  instead of run-ids. The dag resume and dag retry commands will be removed, with their
  functionality absorbed into the new idempotent `dag run`.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI framework for command structure and flags"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for state files and DAG configs"
    - name: "golang.org/x/sync/errgroup"
      version: "v0.10.0"
      purpose: "Concurrent spec execution with error propagation"
  storage: "YAML files in .autospec/state/dag-runs/"
  testing:
    framework: "Go testing package with testify assertions"
    approach: "Unit tests for state management, integration tests for command flow"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "State operations <10ms, CLI startup <50ms"
  constraints:
    - "Maintain backward compatibility with existing DAG workflow files"
    - "Cannot change worktree creation/management logic (owned by other specs)"
    - "Single active run per workflow file (no parallel runs of same workflow)"
    - "Atomic state file writes required (write-rename pattern)"
  scale_scope: "Single-machine DAG orchestration with up to ~50 concurrent specs"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "PRIN-001: Test-First Development"
      status: "PASS"
      notes: "All state management and command changes will have tests written first"
    - name: "PRIN-002: Validation-First Workflow"
      status: "PASS"
      notes: "State file validation before operations; dependency validation for --only flag"
    - name: "PRIN-003: Performance Standards"
      status: "PASS"
      notes: "State operations remain <10ms; no performance regressions expected"
    - name: "PRIN-004: Idempotency and Retry Logic"
      status: "PASS"
      notes: "Core feature - making dag run fully idempotent with atomic state persistence"
    - name: "PRIN-005: Standardized Exit Codes"
      status: "PASS"
      notes: "Existing exit code conventions preserved across all commands"
    - name: "PRIN-006: YAML-First Artifacts"
      status: "PASS"
      notes: "State files remain YAML format, keyed by workflow filename"
    - name: "PRIN-011: Go Coding Standards"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, map-based table tests"

research_findings:
  decisions:
    - topic: "State file naming scheme"
      decision: "Use workflow filename with path separators replaced by dashes"
      rationale: "Human-readable, filesystem-safe, avoids collisions for nested paths"
      alternatives_considered:
        - "Hash of full path (not human-readable)"
        - "Full path with escaped separators (complex)"
        - "Basename only (collision risk for same-named files in different dirs)"
    - topic: "Handling --only flag without existing state"
      decision: "Error when no state exists, suggest using --fresh for new runs"
      rationale: "--only implies resuming/targeting existing run; fresh starts should be explicit"
      alternatives_considered:
        - "Auto-create state with specified specs only (confusing behavior)"
        - "Allow --only with fresh starts (violates principle of least surprise)"
    - topic: "Legacy run-id state migration"
      decision: "Migrate on first dag run invocation for matching workflow file"
      rationale: "Transparent migration preserves user progress without manual intervention"
      alternatives_considered:
        - "Require explicit migration command (extra user friction)"
        - "Ignore legacy state (loses user progress)"
    - topic: "--clean flag behavior"
      decision: "Require --only flag; cannot clean entire workflow without --fresh"
      rationale: "Prevents accidental destruction of all progress; --fresh is explicit restart"
      alternatives_considered:
        - "Allow --clean without --only (too destructive by default)"

data_model:
  entities:
    - name: "DAGRun (enhanced)"
      description: "Persistent state for a DAG workflow execution, now keyed by workflow path"
      fields:
        - name: "WorkflowPath"
          type: "string"
          description: "Original path to the workflow file (new primary identifier)"
          constraints: "Non-empty, valid file path"
        - name: "RunID"
          type: "string"
          description: "Legacy run-id, kept for backward compatibility and history"
          constraints: "Timestamp_UUID format for legacy, empty for new runs"
        - name: "Status"
          type: "enum"
          description: "Overall run status"
          constraints: "One of: pending, running, completed, failed, interrupted"
        - name: "Specs"
          type: "map[string]*SpecState"
          description: "Per-spec execution state"
          constraints: "Keyed by spec ID from workflow"
        - name: "StartedAt"
          type: "time.Time"
          description: "Timestamp of initial execution start"
          constraints: "Required"
        - name: "UpdatedAt"
          type: "time.Time"
          description: "Timestamp of last state change"
          constraints: "Updated on every state modification"
      relationships:
        - target: "SpecState"
          type: "one-to-many"
          description: "DAGRun contains multiple SpecStates"
    - name: "WorkflowPathNormalizer"
      description: "Utility for converting workflow paths to state filenames"
      fields:
        - name: "inputPath"
          type: "string"
          description: "Original workflow file path"
          constraints: "May be relative or absolute"
        - name: "normalizedName"
          type: "string"
          description: "Filesystem-safe state filename"
          constraints: "Path separators replaced with dashes, .state extension"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/reference.md"
      description: "CLI reference updates for new flags and removed commands"
    - path: "CHANGELOG.md"
      description: "Document breaking changes (dag resume/retry removal)"
  source_code:
    - path: "internal/dag/runstate.go"
      description: "Enhanced state management with workflow-path keying"
    - path: "internal/dag/pathutils.go"
      description: "New file for workflow path normalization utilities"
    - path: "internal/dag/migrate.go"
      description: "New file for legacy run-id state migration"
    - path: "internal/cli/dag/run.go"
      description: "Enhanced with --fresh, --only, --clean flags and idempotent behavior"
    - path: "internal/cli/dag/status.go"
      description: "Updated to accept workflow file path instead of run-id"
    - path: "internal/cli/dag/logs.go"
      description: "Updated to accept workflow file path"
    - path: "internal/cli/dag/merge.go"
      description: "Updated to accept workflow file path"
    - path: "internal/cli/dag/cleanup.go"
      description: "Updated to accept workflow file path"
  tests:
    - path: "internal/dag/runstate_test.go"
      description: "Tests for workflow-path keying and state operations"
    - path: "internal/dag/pathutils_test.go"
      description: "Tests for path normalization"
    - path: "internal/dag/migrate_test.go"
      description: "Tests for legacy state migration"
    - path: "internal/cli/dag/run_test.go"
      description: "Tests for new flags and idempotent behavior"

implementation_phases:
  - phase: 1
    name: "State Management Refactor"
    goal: "Refactor state storage to use workflow-path keys instead of run-ids"
    deliverables:
      - "WorkflowPathNormalizer utility functions in internal/dag/pathutils.go"
      - "Updated DAGRun struct with WorkflowPath field"
      - "State file naming using normalized workflow path"
      - "Atomic state file operations (write-rename pattern)"
      - "Unit tests for path normalization and state operations"
  - phase: 2
    name: "Legacy State Migration"
    goal: "Enable transparent migration from run-id based state to workflow-path based"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Migration logic in internal/dag/migrate.go"
      - "Auto-migration on dag run invocation"
      - "Legacy state file cleanup after successful migration"
      - "Unit tests for migration scenarios"
  - phase: 3
    name: "Idempotent dag run Command"
    goal: "Make dag run automatically resume from existing state"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Idempotent execution logic in run.go"
      - "--fresh flag implementation"
      - "Clear CLI output distinguishing new vs resumed runs"
      - "Integration tests for resume behavior"
  - phase: 4
    name: "Selective Execution Flags"
    goal: "Implement --only and --clean flags for targeted spec execution"
    dependencies:
      - "Phase 3"
    deliverables:
      - "--only flag with comma-separated spec list"
      - "Dependency validation for --only flag"
      - "--clean flag (requires --only) for artifact cleanup"
      - "Error handling for invalid spec IDs"
      - "Tests for dependency validation and clean behavior"
  - phase: 5
    name: "Command Updates"
    goal: "Update all dag subcommands to accept workflow file path instead of run-id"
    dependencies:
      - "Phase 1"
    deliverables:
      - "dag status workflow.yaml"
      - "dag logs workflow.yaml spec-id"
      - "dag merge workflow.yaml"
      - "dag cleanup workflow.yaml"
      - "Backward-compatible argument parsing"
  - phase: 6
    name: "Command Removal and Cleanup"
    goal: "Remove dag resume and dag retry commands"
    dependencies:
      - "Phase 3"
      - "Phase 4"
    deliverables:
      - "Remove internal/cli/dag/resume.go"
      - "Remove internal/cli/dag/retry.go (if exists)"
      - "Update command registration"
      - "Update documentation and help text"
  - phase: 7
    name: "Documentation and Validation"
    goal: "Update all documentation and run final validation"
    dependencies:
      - "Phase 5"
      - "Phase 6"
    deliverables:
      - "Updated docs/public/reference.md"
      - "CHANGELOG.md entry for breaking changes"
      - "make test && make fmt && make lint && make build passes"

open_questions:
  - question: "Should dag list still show historical runs by run-id for debugging?"
    context: "Run-ids are being removed from user-facing commands but may be useful for debugging"
    proposed_resolution: "Keep dag list showing run history with timestamps, but primarily identify by workflow path"
  - question: "How to handle concurrent dag run invocations on same workflow from different terminals?"
    context: "Current lock mechanism uses run-id; needs update for workflow-path based locking"
    proposed_resolution: "Lock file keyed by normalized workflow path; second invocation detects lock and either waits or errors"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.8.2"
  created: "2026-01-11T19:21:58Z"
  artifact_type: "plan"
