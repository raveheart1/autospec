plan:
  branch: "093-dag-name-branches"
  created: "2026-01-11"
  spec_path: "specs/093-dag-name-branches/spec.yaml"

summary: |
  This implementation adds human-readable branch names to DAG orchestration by generating slugs
  from `dag.name` instead of opaque timestamp-based run IDs. The branch format changes from
  `dag/20260111_112034_ba7166b1/200-repo-reader` to `dag/gitstats-cli-v1/200-repo-reader`.

  The design uses runtime slug generation from `dag.name` as the primary mechanism, with an optional
  `dag.id` field as a power-user override. The resolved ID is locked in the state file at first run,
  preventing accidental orphaning of branches when the DAG name changes. Backward compatibility is
  maintained by using stored branch/worktree paths from state files for resumed runs.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for DAG configs and state files"
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework"
    - name: "github.com/google/uuid"
      version: "v1.6.0"
      purpose: "UUID generation for collision fallback"
  storage: "YAML state files in .autospec/state/dag-runs/"
  testing:
    framework: "go test"
    approach: "Map-based table tests with t.Parallel() for unit tests; existing integration patterns"
  target_platform: "Linux, macOS, Windows (cross-platform)"
  project_type: "cli"
  performance_goals: "Slug generation <1ms; no impact on existing performance contracts"
  constraints:
    - "Git branch names must be valid refs (no spaces, certain special chars)"
    - "Slug length limited to 50 characters for readability"
    - "Backward compatibility with existing timestamp-based runs"
    - "ID immutability once state file exists"
  scale_scope: "Single repository with multiple DAG workflows; tens of specs per DAG"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Tests will be written before implementation for Slugify, ResolveDAGID, and validation functions"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "ID mismatch detection validates state before proceeding with DAG execution"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Slug generation is O(n) string manipulation, well under 10ms threshold"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "State files lock the resolved ID; resume reuses stored branch/worktree paths"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "State files use YAML with new dag_id and dag_name fields"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions under 40 lines; errors wrapped with context; map-based table tests"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "No slash command templates are modified by this feature"

research_findings:
  decisions:
    - topic: "Slug generation algorithm"
      decision: "Reuse and extend existing CleanBranchName from internal/spec/branch.go"
      rationale: "Existing function already handles lowercase, hyphen replacement, and cleanup; extend with truncation"
      alternatives_considered:
        - "New standalone slugify package"
        - "External library (gosimple/slug)"
    - topic: "ID resolution priority"
      decision: "dag.id > slugified dag.name > workflow filename"
      rationale: "Explicit override first, then human name, then fallback for unnamed DAGs"
      alternatives_considered:
        - "Require dag.id always"
        - "No fallback (error on missing name)"
    - topic: "Where to implement slug function"
      decision: "New file internal/dag/slug.go"
      rationale: "DAG-specific logic separate from spec branch naming; reuses helper from spec package"
      alternatives_considered:
        - "Add to internal/spec/branch.go"
        - "Add to internal/dag/types.go"
    - topic: "Branch collision handling"
      decision: "Append 4-character hash suffix on collision"
      rationale: "Short suffix maintains readability while ensuring uniqueness"
      alternatives_considered:
        - "Numeric suffix (-1, -2)"
        - "Full UUID suffix"
        - "Error and require explicit ID"

data_model:
  entities:
    - name: "DAGMetadata"
      description: "Extended DAG metadata with optional ID field"
      fields:
        - name: "Name"
          type: "string"
          description: "Human-readable name for display"
          constraints: "Required if ID not set"
        - name: "ID"
          type: "string"
          description: "Optional explicit identifier override"
          constraints: "If set, used directly without slugification"
      relationships:
        - target: "DAGRun"
          type: "one-to-many"
          description: "A DAG definition can have multiple runs"

    - name: "DAGRun"
      description: "Extended run state with locked DAG identity"
      fields:
        - name: "DAGId"
          type: "string"
          description: "Resolved ID locked at first run"
          constraints: "Immutable once set; used in branch/worktree names"
        - name: "DAGName"
          type: "string"
          description: "Snapshot of dag.name at first run"
          constraints: "Informational; may differ from current YAML"
        - name: "RunID"
          type: "string"
          description: "Legacy timestamp_uuid for backward compatibility"
          constraints: "Optional for new runs"
      relationships:
        - target: "SpecState"
          type: "one-to-many"
          description: "A run contains multiple spec states"

    - name: "SpecState"
      description: "Per-spec state with branch and worktree paths"
      fields:
        - name: "Branch"
          type: "string"
          description: "Git branch name for this spec"
          constraints: "Format: dag/<dag-id>/<spec-id>"
        - name: "WorktreePath"
          type: "string"
          description: "Absolute path to worktree directory"
          constraints: "Already exists in current schema"
      relationships:
        - target: "DAGRun"
          type: "many-to-one"
          description: "Each spec belongs to one run"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/public/dag-orchestration.md"
      description: "Update with new branch naming format and ID resolution"
  source_code:
    - path: "internal/dag/slug.go"
      description: "New file with Slugify and ResolveDAGID functions"
    - path: "internal/dag/types.go"
      description: "Add ID field to DAGMetadata struct"
    - path: "internal/dag/runstate.go"
      description: "Add DAGId and DAGName fields to DAGRun struct"
    - path: "internal/dag/executor.go"
      description: "Update branch and worktree name generation"
    - path: "internal/dag/validate.go"
      description: "Add uniqueness validation for DAG IDs"
    - path: "internal/cli/dag/run.go"
      description: "Add ID mismatch detection before execution"
  tests:
    - path: "internal/dag/slug_test.go"
      description: "Unit tests for Slugify and ResolveDAGID"
    - path: "internal/dag/executor_test.go"
      description: "Integration tests for branch/worktree naming"
    - path: "internal/dag/validate_test.go"
      description: "Tests for DAG ID uniqueness validation"

implementation_phases:
  - phase: 1
    name: "Core Slug Functions"
    goal: "Implement Slugify and ResolveDAGID with comprehensive tests"
    deliverables:
      - "internal/dag/slug.go with Slugify() function"
      - "ResolveDAGID(dag, workflowPath) function"
      - "internal/dag/slug_test.go with table-driven tests"

  - phase: 2
    name: "Type Extensions"
    goal: "Extend DAGMetadata and DAGRun structs for ID tracking"
    deliverables:
      - "Add ID field to DAGMetadata in types.go"
      - "Add DAGId and DAGName fields to DAGRun in runstate.go"
      - "Add Branch field to SpecState for explicit storage"
      - "Update NewDAGRun to accept DAG config for ID resolution"

  - phase: 3
    name: "Branch and Worktree Naming"
    goal: "Update executor to use new naming format"
    dependencies:
      - "Phase 1"
      - "Phase 2"
    deliverables:
      - "Update createWorktree() to use dag/<dag-id>/<spec-id> format"
      - "Update worktreeName() to use dag-<dag-id>-<spec-id> format"
      - "Store branch name in SpecState for resume idempotency"
      - "Tests for new naming in executor_test.go"

  - phase: 4
    name: "ID Mismatch Detection"
    goal: "Prevent accidental ID changes that orphan branches"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "Validation in dag run command before execution"
      - "Clear error message with remediation options"
      - "Tests for mismatch detection scenarios"

  - phase: 5
    name: "Collision Handling"
    goal: "Handle branch name collisions gracefully"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Check for existing branch with different DAG before creation"
      - "Append short hash suffix on collision"
      - "Tests for collision scenarios"

  - phase: 6
    name: "DAG Validate Uniqueness"
    goal: "Add uniqueness validation to dag validate command"
    dependencies:
      - "Phase 1"
    deliverables:
      - "ValidateDAGUniqueness function scanning DAG files"
      - "Error on duplicate resolved IDs"
      - "Warning on duplicate names"
      - "Tests for validation scenarios"

  - phase: 7
    name: "Quality Gates and Documentation"
    goal: "Ensure all quality gates pass and documentation is updated"
    dependencies:
      - "Phase 1"
      - "Phase 2"
      - "Phase 3"
      - "Phase 4"
      - "Phase 5"
      - "Phase 6"
    deliverables:
      - "make test passes"
      - "make fmt passes"
      - "make lint passes"
      - "make build passes"
      - "Updated dag-orchestration.md documentation"

open_questions:
  - question: "Should dag.id also be slugified or used exactly as provided?"
    context: "User might provide invalid git ref characters in dag.id"
    proposed_resolution: "Slugify dag.id as well, or error if result is empty; document this behavior"

  - question: "What happens if workflow file is renamed but state exists?"
    context: "State is keyed by workflow path; renaming loses the association"
    proposed_resolution: "Document that renaming workflow file creates a new run; use --fresh if needed"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.8.2"
  created: "2026-01-11T20:22:52Z"
  artifact_type: "plan"
