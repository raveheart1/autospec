plan:
  branch: "019-completion-install"
  created: "2025-12-16"
  spec_path: "specs/019-completion-install/spec.yaml"

summary: |
  Implement 'autospec completion install' subcommand that automates shell completion setup.
  The command auto-detects the user's shell from $SHELL environment variable and installs
  completions using eval/source style (appending sourcing blocks to rc files for bash/zsh/powershell,
  or writing standalone completion files for fish). Configuration files are backed up before
  modification with timestamped filenames. The implementation follows Cobra CLI patterns,
  creates a new 'internal/completion' package for installation logic, and provides both
  automatic and manual installation paths for maximum flexibility.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI framework with built-in completion generation"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for potential configuration"
  storage: "File system (shell rc files, backup files)"
  testing:
    framework: "Go testing package"
    approach: "Table-driven unit tests, integration tests for file operations"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Command completion in under 2 seconds (NFR-001)"
  constraints:
    - "Must use Cobra's built-in completion generation"
    - "Must not require elevated privileges"
    - "Must be reversible via backup restoration"
    - "Must follow existing autospec CLI patterns"
  scale_scope: "Single-user local installation"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests will be written before implementation following table-driven patterns"
    - name: "Validation-First Workflow"
      status: "N/A"
      notes: "This command operates independently, not part of spec workflow phases"
    - name: "Performance Standards"
      status: "PASS"
      notes: "Command is designed to complete in under 2 seconds per NFR-001"
    - name: "Idempotency and Retry Logic"
      status: "PASS"
      notes: "Marker comments enable idempotent behavior; repeated runs detect existing installation"
    - name: "Standardized Exit Codes"
      status: "PASS"
      notes: "Will use exit code 0 (success), 1 (validation failed), 3 (invalid arguments)"
    - name: "YAML-First Artifacts"
      status: "N/A"
      notes: "This command does not produce workflow artifacts"
    - name: "Code Formatting"
      status: "PASS"
      notes: "Will run go fmt before merge"
    - name: "Cross-Platform Compatibility"
      status: "PASS"
      notes: "Supports bash/zsh/fish on Linux/macOS, PowerShell on Windows"
    - name: "Explicit Dependencies"
      status: "PASS"
      notes: "No new external dependencies required; uses existing Cobra functionality"
    - name: "Documentation Standards"
      status: "PASS"
      notes: "SHELL-COMPLETION.md will be updated with new install command"

research_findings:
  decisions:
    - topic: "Completion installation style"
      decision: "Eval/source style for bash/zsh/powershell, standalone file for fish"
      rationale: |
        Eval/source ensures completions auto-update when autospec binary is upgraded.
        Fish uses a file-based completion system where files in completions/ are automatically loaded.
      alternatives_considered:
        - "File-based for all shells (requires manual regeneration on update)"
        - "System-wide installation (requires elevated privileges)"

    - topic: "Shell detection method"
      decision: "Parse $SHELL environment variable with fallback to explicit argument"
      rationale: |
        $SHELL is the standard way to detect the user's default shell on Unix systems.
        Explicit argument support enables cross-shell installation.
      alternatives_considered:
        - "Detect running shell from /proc (Linux-only, less portable)"
        - "Require explicit shell argument (less user-friendly)"

    - topic: "Backup strategy"
      decision: "Timestamped backup files retained permanently"
      rationale: |
        Per spec FR-005, backups enable recovery at any point. Permanent retention
        prevents data loss if user needs to restore weeks later.
      alternatives_considered:
        - "Single backup overwritten each time (risk of losing original)"
        - "Automatic cleanup after N days (complexity, potential data loss)"

    - topic: "Idempotency mechanism"
      decision: "Marker comments wrapping completion blocks"
      rationale: |
        Per spec FR-007, markers enable detection of existing installation and allow
        replacement or skip behavior. Also enables easy manual removal.
      alternatives_considered:
        - "Check for exact string match (brittle, fails if user edits)"
        - "Separate tracking file (additional complexity)"

    - topic: "Package organization"
      decision: "New internal/completion package for installation logic"
      rationale: |
        Separates concerns from CLI layer, enables comprehensive unit testing,
        follows existing pattern (internal/clean, internal/uninstall).
      alternatives_considered:
        - "All logic in CLI layer (harder to test)"
        - "Add to existing package (doesn't fit existing packages)"

data_model:
  entities:
    - name: "Shell"
      description: "Supported shell type enumeration"
      fields:
        - name: "type"
          type: "string"
          description: "Shell identifier"
          constraints: "One of: bash, zsh, fish, powershell"
      relationships: []

    - name: "ShellConfig"
      description: "Configuration for a specific shell's completion setup"
      fields:
        - name: "shell"
          type: "Shell"
          description: "Shell type"
          constraints: "Required"
        - name: "rcPath"
          type: "string"
          description: "Path to rc file (empty for fish)"
          constraints: "Resolved from user home directory"
        - name: "completionDir"
          type: "string"
          description: "Path to completion directory (fish only)"
          constraints: "Empty for bash/zsh/powershell"
        - name: "requiresRCModification"
          type: "bool"
          description: "Whether shell needs rc file modification"
          constraints: "true for bash/zsh/powershell, false for fish"
      relationships:
        - target: "Shell"
          type: "one-to-one"
          description: "Each config belongs to one shell"

    - name: "CompletionBlock"
      description: "Shell-specific completion sourcing block"
      fields:
        - name: "shell"
          type: "Shell"
          description: "Target shell"
          constraints: "Required"
        - name: "startMarker"
          type: "string"
          description: "Block start marker"
          constraints: "Literal: # >>> autospec completion >>>"
        - name: "endMarker"
          type: "string"
          description: "Block end marker"
          constraints: "Literal: # <<< autospec completion <<<"
        - name: "content"
          type: "string"
          description: "Shell-specific sourcing commands"
          constraints: "Varies by shell"
      relationships:
        - target: "ShellConfig"
          type: "one-to-one"
          description: "Block written to config's rcPath"

    - name: "InstallResult"
      description: "Outcome of installation operation"
      fields:
        - name: "success"
          type: "bool"
          description: "Whether installation succeeded"
          constraints: "Required"
        - name: "backupPath"
          type: "string"
          description: "Path to backup file if created"
          constraints: "Empty for fish or if no backup needed"
        - name: "configPath"
          type: "string"
          description: "Path to modified config file"
          constraints: "Required"
        - name: "action"
          type: "string"
          description: "What action was taken"
          constraints: "installed, updated, skipped"
        - name: "message"
          type: "string"
          description: "Human-readable status message"
          constraints: "Required"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/SHELL-COMPLETION.md"
      description: "Update with install command usage and examples"
  source_code:
    - path: "internal/completion/"
      description: "New package for shell completion installation logic"
    - path: "internal/completion/install.go"
      description: "Core installation logic: shell detection, backup, file modification"
    - path: "internal/completion/shells.go"
      description: "Shell configurations and completion block templates"
    - path: "internal/cli/completion_install.go"
      description: "Cobra command for 'completion install' subcommand"
  tests:
    - path: "internal/completion/install_test.go"
      description: "Unit tests for installation logic with table-driven approach"
    - path: "internal/completion/shells_test.go"
      description: "Unit tests for shell detection and configuration"
    - path: "internal/cli/completion_install_test.go"
      description: "CLI integration tests for completion install command"

implementation_phases:
  - phase: 1
    name: "Core Installation Logic"
    goal: "Implement shell detection, backup creation, and file modification in internal/completion package"
    deliverables:
      - "internal/completion/shells.go: Shell type constants, ShellConfig struct, GetShellConfig()"
      - "internal/completion/shells.go: DetectShell() from $SHELL environment variable"
      - "internal/completion/shells.go: GetCompletionBlock() for each shell type"
      - "internal/completion/install.go: CreateBackup() with timestamped filenames"
      - "internal/completion/install.go: HasExistingInstallation() marker detection"
      - "internal/completion/install.go: Install() main installation orchestration"
      - "internal/completion/shells_test.go: Table-driven tests for shell detection"
      - "internal/completion/install_test.go: Table-driven tests for backup and installation"

  - phase: 2
    name: "CLI Integration"
    goal: "Create Cobra command that wires up the completion logic to 'autospec completion install'"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/cli/completion_install.go: 'completion install' subcommand"
      - "internal/cli/completion_install.go: Shell argument parsing (optional positional arg)"
      - "internal/cli/completion_install.go: --manual flag for instructions-only mode"
      - "internal/cli/completion_install.go: Success/error messaging"
      - "internal/cli/completion_install_test.go: CLI integration tests"

  - phase: 3
    name: "Documentation and Polish"
    goal: "Update documentation and ensure consistent user experience"
    dependencies:
      - "Phase 2"
    deliverables:
      - "docs/SHELL-COMPLETION.md: Add 'autospec completion install' section"
      - "README.md: Update completion section with install command"
      - "CLAUDE.md: Add completion install to CLI command reference"
      - "Manual instructions output for all four shells"
      - "Final code formatting with make fmt"

risks:
  - risk: "Fish completion directory may not exist on fresh systems"
    likelihood: "medium"
    impact: "low"
    mitigation: "Create ~/.config/fish/completions/ directory before writing file"

  - risk: "PowerShell profile paths vary by platform and version"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Use $PROFILE environment variable in PowerShell; provide manual instructions as fallback"

  - risk: "User may have non-standard rc file locations"
    likelihood: "low"
    impact: "medium"
    mitigation: "Provide --manual flag for manual setup instructions"

  - risk: "Marker-based detection may fail if user manually edits the block"
    likelihood: "low"
    impact: "low"
    mitigation: "Check for start marker only; if found but malformed, offer to replace entire block"

  - risk: "Permission denied when writing to config files"
    likelihood: "low"
    impact: "high"
    mitigation: "Catch permission errors gracefully, display manual instructions instead"

open_questions:
  - question: "Should we support custom rc file paths via flag?"
    context: "Some users may have sourced their rc from non-standard locations"
    proposed_resolution: "Not in v1; manual instructions cover this case. Can add --rc-file flag later if needed."

  - question: "Should 'completion install' be added to init command?"
    context: "Could enhance init to also offer completion installation"
    proposed_resolution: "Keep separate for now; init is for autospec workflow setup, completion is for shell UX. Mention in init output as next step."

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T06:11:05Z"
  artifact_type: "plan"
