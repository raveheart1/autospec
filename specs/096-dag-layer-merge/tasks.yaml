tasks:
    branch: "096-dag-layer-merge"
    created: "2026-01-12"
    spec_path: "specs/096-dag-layer-merge/spec.yaml"
    plan_path: "specs/096-dag-layer-merge/plan.yaml"
summary:
    total_tasks: 24
    total_phases: 8
    parallel_opportunities: 8
    estimated_complexity: "high"
phases:
    - number: 1
      title: "Setup"
      purpose: "Project initialization and new package structure"
      tasks:
        - id: "T001"
          title: "Create staging.go file in internal/dag/"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/dag/staging.go"
          dependencies: []
          acceptance_criteria:
            - "File exists with package declaration"
            - "Basic imports in place"
    - number: 2
      title: "Foundational"
      purpose: "Core infrastructure that MUST be complete before user stories"
      tasks:
        - id: "T002"
          title: "Add StagingBranchInfo struct to internal/dag/types.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/types.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "StagingBranchInfo struct with Branch, CreatedAt, SpecsMerged fields"
            - "StagingBranches map[string]*StagingBranchInfo field added to DAGRun"
            - "MergedToStaging bool field added to SpecState"
        - id: "T003"
          title: "Add Automerge field to DAGExecutionConfig in internal/dag/config.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/config.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "Automerge *bool field added to DAGExecutionConfig"
            - "IsAutomergeEnabled() method returns true by default, respects explicit setting"
            - "Validate() method ensures automerge requires autocommit"
        - id: "T004"
          title: "Add MergeConflictError type to internal/dag/staging.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/staging.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "MergeConflictError struct with StageBranch, SpecBranch, SpecID, Conflicts fields"
            - "Error() method returns formatted conflict message"
            - "DetectConflictedFiles helper function implemented"
        - id: "T005"
          title: "Add StartPoint to CreateOptions in internal/worktree/manager.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/worktree/manager.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "StartPoint string field added to CreateOptions"
            - "CreateWithOptions passes StartPoint to git command"
        - id: "T006"
          title: "Extend GitWorktreeAdd in internal/worktree/git.go for start point"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/worktree/git.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "GitWorktreeAdd accepts startPoint parameter"
            - "Start point appended to git worktree add command when provided"
    - number: 3
      title: "User Story 1 - Layer-aware worktree creation"
      purpose: "Enable worktrees for Layer N to branch from staging branch containing Layer N-1 code"
      story_reference: "US-001"
      independent_test: "Create a worktree for Layer 1 spec and verify it contains Layer 0 changes"
      tasks:
        - id: "T007"
          title: "Implement stageBranchName() in internal/dag/staging.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/dag/staging.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "Returns dag/<dag-id>/stage-<layer-id> format"
            - "Handles empty dagID and layerID gracefully"
        - id: "T008"
          title: "Implement getBaseBranchForLayer() in internal/dag/executor.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/dag/executor.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Layer 0 returns base branch (main)"
            - "Layer N (N>0) returns previous layer staging branch"
            - "Function under 40 lines"
        - id: "T009"
          title: "Modify createWorktree() to use layer base branch in internal/dag/executor.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/dag/executor.go"
          dependencies: ["T006", "T008"]
          acceptance_criteria:
            - "Uses getBaseBranchForLayer() to determine start point"
            - "Passes start point to worktree manager"
            - "Outputs which base branch is used"
    - number: 4
      title: "User Story 2 - Automatic staging branch merge after spec completion"
      purpose: "Completed specs automatically merge into the layer staging branch"
      story_reference: "US-002"
      independent_test: "Complete a spec with autocommit+automerge enabled and verify staging branch contains the changes"
      tasks:
        - id: "T010"
          title: "Implement createStagingBranch() in internal/dag/staging.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-002"
          file_path: "internal/dag/staging.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Creates branch from source using git branch command"
            - "Returns wrapped error on failure"
            - "Handles existing branch gracefully (reuse)"
        - id: "T011"
          title: "Implement mergeIntoStaging() in internal/dag/staging.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-002"
          file_path: "internal/dag/staging.go"
          dependencies: ["T004", "T007"]
          acceptance_criteria:
            - "Uses git merge --no-ff to preserve history"
            - "Creates merge commit with descriptive message"
            - "Returns MergeConflictError when conflicts detected"
            - "Function under 40 lines"
        - id: "T012"
          title: "Implement postSpecCompletion() automerge flow in internal/dag/executor.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/dag/executor.go"
          dependencies: ["T003", "T010", "T011"]
          acceptance_criteria:
            - "Checks IsAutomergeEnabled() before merging"
            - "Calls mergeIntoStaging() when automerge enabled"
            - "Sets MergedToStaging = true on success"
            - "Persists state after merge"
            - "Outputs progress messages"
    - number: 5
      title: "User Story 3 - Batch merge at layer completion"
      purpose: "All completed specs merge into staging when the layer completes (automerge disabled)"
      story_reference: "US-003"
      independent_test: "Run a layer with automerge disabled and verify all specs merge at layer end"
      tasks:
        - id: "T013"
          title: "Implement getUnmergedSpecsInLayer() in internal/dag/executor.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-003"
          file_path: "internal/dag/executor.go"
          dependencies: ["T002"]
          acceptance_criteria:
            - "Returns list of spec IDs with MergedToStaging=false"
            - "Only includes specs with CommitStatus=Committed"
            - "Handles empty layers correctly"
        - id: "T014"
          title: "Implement completeLayer() for batch merge in internal/dag/executor.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/dag/executor.go"
          dependencies: ["T011", "T013"]
          acceptance_criteria:
            - "Skips if automerge enabled (already merged individually)"
            - "Merges all unmerged specs sequentially"
            - "Updates MergedToStaging for each merged spec"
            - "Persists state after all merges"
            - "Outputs layer completion summary"
    - number: 6
      title: "User Story 4 - Configuration for automerge behavior"
      purpose: "Enable or disable automerge in config and via CLI flags"
      story_reference: "US-004"
      independent_test: "Set automerge in config and verify it affects merge behavior"
      tasks:
        - id: "T015"
          title: "Add AUTOSPEC_DAG_AUTOMERGE environment variable support"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-004"
          file_path: "internal/dag/config.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "Environment variable overrides config file"
            - "Accepts true/false values"
            - "Documents in code comments"
        - id: "T016"
          title: "Add --automerge and --no-automerge flags to internal/cli/dag/run.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-004"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "Both flags registered with cobra"
            - "Flags override config and env settings"
            - "Mutually exclusive (error if both set)"
        - id: "T017"
          title: "Add --no-layer-staging flag to internal/cli/dag/run.go"
          status: "InProgress"
          type: "implementation"
          parallel: true
          story_id: "US-004"
          file_path: "internal/cli/dag/run.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "Flag disables layer staging entirely"
            - "All worktrees branch from main (legacy behavior)"
            - "Outputs warning about potential conflicts"
    - number: 7
      title: "User Story 5 - Simplified final merge to main"
      purpose: "Merge the final staging branch into main with a single command"
      story_reference: "US-005"
      independent_test: "Run dag merge and verify final staging branch merges to main"
      tasks:
        - id: "T018"
          title: "Implement verifyFinalStaging() in internal/dag/merge.go"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-005"
          file_path: "internal/dag/merge.go"
          dependencies: ["T002", "T007"]
          acceptance_criteria:
            - "Verifies final staging branch exists"
            - "Checks all expected specs are merged"
            - "Returns clear error if verification fails"
        - id: "T019"
          title: "Update Merge() to use final staging branch in internal/dag/merge.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/dag/merge.go"
          dependencies: ["T018"]
          acceptance_criteria:
            - "Detects if layer staging was used"
            - "Merges final staging branch when layer staging enabled"
            - "Falls back to individual branch merges when disabled"
            - "Single merge commit appears on main"
    - number: 8
      title: "User Story 6 - Merge conflict handling"
      purpose: "Clear error messages and resolution instructions when staging merge fails"
      story_reference: "US-006"
      independent_test: "Force a merge conflict and verify error output contains resolution steps"
      tasks:
        - id: "T020"
          title: "Implement handleStagingConflict() in internal/dag/executor.go"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-006"
          file_path: "internal/dag/executor.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "Outputs conflict summary with file list"
            - "Provides step-by-step resolution instructions"
            - "Includes resume command in output"
            - "Returns error for DAG run to stop"
        - id: "T021"
          title: "Add resume logic for post-conflict continuation in internal/dag/executor.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-006"
          file_path: "internal/dag/executor.go"
          dependencies: ["T012", "T020"]
          acceptance_criteria:
            - "Detects if staging merge was interrupted"
            - "Skips already-merged specs on resume"
            - "Validates conflict resolution before continuing"
    - number: 9
      title: "Polish & Cross-Cutting Concerns"
      purpose: "Quality gates and finishing touches"
      tasks:
        - id: "T022"
          title: "Add config schema entry for dag.automerge in internal/config/schema.go"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/config/schema.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "dag.automerge added to KnownKeys map"
            - "Type is bool, default is true"
        - id: "T023"
          title: "Add progress output for staging operations"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/executor.go"
          dependencies: ["T012", "T014"]
          acceptance_criteria:
            - "Clear output showing staging branch creation"
            - "Output shows which spec is merging into staging"
            - "Layer completion summary with merged spec count"
        - id: "T024"
          title: "Verify all quality gates pass"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: ""
          dependencies: ["T001", "T002", "T003", "T004", "T005", "T006", "T007", "T008", "T009", "T010", "T011", "T012", "T013", "T014", "T015", "T016", "T017", "T018", "T019", "T020", "T021", "T022", "T023"]
          acceptance_criteria:
            - "make test exits 0"
            - "make fmt exits 0"
            - "make lint exits 0"
            - "make build exits 0"
            - "All functions under 40 lines"
            - "All errors wrapped with context"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-002", "US-003", "US-005"]
        - story_id: "US-002"
          depends_on: ["US-001"]
          blocks: ["US-003"]
        - story_id: "US-003"
          depends_on: ["US-002"]
          blocks: []
        - story_id: "US-004"
          depends_on: []
          blocks: []
        - story_id: "US-005"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-006"
          depends_on: ["US-002"]
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2]
        - phase: 2
          blocks: [3, 4, 5, 6, 7, 8]
        - phase: 3
          blocks: [4]
        - phase: 4
          blocks: [5, 8]
        - phase: 5
          blocks: []
        - phase: 6
          blocks: []
        - phase: 7
          blocks: []
        - phase: 8
          blocks: [9]
parallel_execution:
    - phase: 2
      parallel_groups:
        - tasks: ["T002", "T003", "T004", "T005"]
          rationale: "Different files with no interdependencies"
    - phase: 3
      parallel_groups:
        - tasks: ["T007", "T008"]
          rationale: "Independent functions in different files"
    - phase: 4
      parallel_groups:
        - tasks: ["T010", "T011"]
          rationale: "Both in staging.go but independent functions"
    - phase: 5
      parallel_groups:
        - tasks: ["T013"]
          rationale: "Single task in phase"
    - phase: 6
      parallel_groups:
        - tasks: ["T015", "T016", "T017"]
          rationale: "Config and CLI flags are independent"
    - phase: 7
      parallel_groups:
        - tasks: ["T018"]
          rationale: "Single implementation before merge update"
    - phase: 8
      parallel_groups:
        - tasks: ["T020"]
          rationale: "Independent conflict handler"
    - phase: 9
      parallel_groups:
        - tasks: ["T022", "T023"]
          rationale: "Config schema and output are independent"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3, 4]
        description: "Setup + Foundational + Layer-aware worktrees + Automerge flow"
        validation: "Create worktrees for Layer 1 and verify they contain Layer 0 code; complete a spec and verify it merges into staging"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2]
          deliverable: "Data structures and worktree manager extended for start point"
        - milestone: "Layer-Aware Worktrees"
          phases: [1, 2, 3]
          deliverable: "Worktrees for Layer N branch from Layer N-1 staging"
        - milestone: "Automerge Working"
          phases: [1, 2, 3, 4]
          deliverable: "Specs automatically merge into staging after commit"
        - milestone: "Full Feature"
          phases: [1, 2, 3, 4, 5, 6, 7, 8, 9]
          deliverable: "Complete layer staging with CLI flags, batch merge, conflict handling, and final merge"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec v0.8.2"
    created: "2026-01-12T08:15:43Z"
    artifact_type: "tasks"
