feature:
    branch: "096-dag-layer-merge"
    created: "2026-01-12"
    status: "Completed"
    completed_at: 2026-01-12T09:13:43Z
    input: |
        DAG Layer Merge Propagation - When running multiple specs in a DAG (directed acyclic graph)
        orchestration, all worktrees currently branch from main, causing merge conflicts and missing
        dependencies. Layer 1 specs depend on Layer 0, but they branch from main without Layer 0's
        code. Solution: After each layer completes, merge completed specs into a staging branch.
        Next layer branches from that staging branch, ensuring each layer has all prior layer code.
user_stories:
    - id: "US-001"
      title: "Layer-aware worktree creation"
      priority: "P1"
      as_a: "developer running multi-spec DAGs"
      i_want: "worktrees for Layer N to branch from a staging branch containing all Layer N-1 code"
      so_that: "specs in later layers have access to dependencies implemented in earlier layers"
      why_this_priority: "Core problem this feature solves - without this, layer dependencies are broken"
      independent_test: "Create a worktree for Layer 1 spec and verify it contains Layer 0 changes"
      acceptance_scenarios:
        - given: "Layer 0 specs have completed and merged into staging branch stage-L0"
          when: "a Layer 1 worktree is created"
          then: "the worktree branches from stage-L0 and contains all Layer 0 code"
        - given: "Layer 0 is in progress"
          when: "Layer 0 worktrees are created"
          then: "they branch from main (the base branch)"
    - id: "US-002"
      title: "Automatic staging branch merge after spec completion"
      priority: "P1"
      as_a: "developer with automerge enabled"
      i_want: "completed specs to automatically merge into the layer staging branch"
      so_that: "other specs in the same layer and subsequent layers have access to the changes immediately"
      why_this_priority: "Enables continuous integration of code within DAG execution"
      independent_test: "Complete a spec with autocommit+automerge enabled and verify staging branch contains the changes"
      acceptance_scenarios:
        - given: "automerge is enabled and a spec completes with a verified commit"
          when: "post-spec-completion flow runs"
          then: "the spec branch is merged into the layer staging branch"
        - given: "automerge is disabled"
          when: "a spec completes"
          then: "no merge occurs until layer completion"
    - id: "US-003"
      title: "Batch merge at layer completion"
      priority: "P2"
      as_a: "developer with automerge disabled"
      i_want: "all completed specs in a layer to merge into staging when the layer completes"
      so_that: "I can control when merges happen while still getting layer staging benefits"
      why_this_priority: "Provides flexibility for users who prefer batch operations over immediate merges"
      independent_test: "Run a layer with automerge disabled and verify all specs merge at layer end"
      acceptance_scenarios:
        - given: "automerge is false and multiple specs in a layer have completed with commits"
          when: "the layer completes"
          then: "all unmerged specs are merged into the staging branch sequentially"
    - id: "US-004"
      title: "Configuration for automerge behavior"
      priority: "P1"
      as_a: "developer configuring DAG execution"
      i_want: "to enable or disable automerge in config and via CLI flags"
      so_that: "I can choose the merge strategy that fits my workflow"
      why_this_priority: "Configuration is required for the feature to be usable"
      independent_test: "Set automerge in config and verify it affects merge behavior"
      acceptance_scenarios:
        - given: "automerge is set to true in config"
          when: "a spec completes with a verified commit"
          then: "it merges immediately into staging"
        - given: "--no-automerge flag is provided on command line"
          when: "DAG run executes"
          then: "automerge is disabled regardless of config setting"
    - id: "US-005"
      title: "Simplified final merge to main"
      priority: "P1"
      as_a: "developer completing a DAG run"
      i_want: "to merge the final staging branch into main with a single command"
      so_that: "all DAG work lands on main with clean history"
      why_this_priority: "Final merge is the goal of the entire DAG workflow"
      independent_test: "Run dag merge and verify final staging branch merges to main"
      acceptance_scenarios:
        - given: "all layers have completed and specs merged into staging branches"
          when: "dag merge is executed"
          then: "the final layer staging branch is merged into main"
    - id: "US-006"
      title: "Merge conflict handling at layer boundaries"
      priority: "P2"
      as_a: "developer encountering merge conflicts"
      i_want: "clear error messages and resolution instructions when staging merge fails"
      so_that: "I can resolve conflicts and resume the DAG run"
      why_this_priority: "Conflicts will happen; users need guidance on resolution"
      independent_test: "Force a merge conflict and verify error output contains resolution steps"
      acceptance_scenarios:
        - given: "two specs in the same layer modify the same file in conflicting ways"
          when: "the second spec tries to merge into staging"
          then: "a conflict error is shown with files listed and resolution steps"
requirements:
    functional:
        - id: "FR-001"
          description: "The system MUST create a staging branch for each layer following the naming convention dag/<dag-id>/stage-<layer-id>"
          testable: true
          acceptance_criteria: "Staging branch exists with correct name after layer starts"
        - id: "FR-002"
          description: "The system MUST create Layer 0 staging branch from the base branch (typically main)"
          testable: true
          acceptance_criteria: "stage-L0 branches from main, verified with git log --oneline stage-L0"
        - id: "FR-003"
          description: "The system MUST create Layer N (N>0) staging branch from the previous layer staging branch"
          testable: true
          acceptance_criteria: "stage-L1 branches from stage-L0, containing all L0 changes"
        - id: "FR-004"
          description: "The system MUST create worktrees for Layer 0 specs from the base branch"
          testable: true
          acceptance_criteria: "Layer 0 worktrees have main as their base, verified with git log"
        - id: "FR-005"
          description: "The system MUST create worktrees for Layer N (N>0) specs from the previous layer staging branch"
          testable: true
          acceptance_criteria: "Layer 1 worktrees contain Layer 0 code, verified with file existence checks"
        - id: "FR-006"
          description: "The system MUST validate that automerge requires autocommit to be enabled"
          testable: true
          acceptance_criteria: "Config validation fails with clear error when automerge=true and autocommit=false"
        - id: "FR-007"
          description: "The system MUST merge completed specs into the staging branch using --no-ff to preserve merge history"
          testable: true
          acceptance_criteria: "git log shows merge commits with proper messages"
        - id: "FR-008"
          description: "The system MUST track staging branch status in DAG run state including branch name, creation time, and merged specs"
          testable: true
          acceptance_criteria: "State file contains staging_branches section with correct data"
        - id: "FR-009"
          description: "The system MUST support --automerge and --no-automerge CLI flags to override config"
          testable: true
          acceptance_criteria: "Flags override config setting, verified with behavior test"
        - id: "FR-010"
          description: "The system MUST detect merge conflicts and report conflicting files with resolution instructions"
          testable: true
          acceptance_criteria: "Conflict error includes file list and step-by-step resolution guide"
        - id: "FR-011"
          description: "The system MUST allow parallel execution of specs within the same layer since they share the same base"
          testable: true
          acceptance_criteria: "Multiple specs in same layer can run concurrently without conflicts"
        - id: "FR-012"
          description: "The dag merge command MUST merge only the final staging branch into main when layer staging is enabled"
          testable: true
          acceptance_criteria: "Single merge commit appears on main with all changes"
        - id: "FR-013"
          description: "The system MUST track per-spec merged_to_staging status in state"
          testable: true
          acceptance_criteria: "State shows merged_to_staging: true for merged specs"
        - id: "FR-014"
          description: "All code changes MUST pass make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All four commands exit with code 0"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "Functions MUST be under 40 lines"
          measurable_target: "No function exceeds 40 lines"
        - id: "NFR-002"
          category: "code_quality"
          description: "Errors MUST be wrapped with context using fmt.Errorf"
          measurable_target: "All error returns include context string"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests MUST use map-based table test pattern"
          measurable_target: "All new tests use map[string]struct pattern"
        - id: "NFR-004"
          category: "reliability"
          description: "Staging branches MUST persist across DAG run interruptions for resume capability"
          measurable_target: "Interrupted run can resume without recreating staging branches"
        - id: "NFR-005"
          category: "performance"
          description: "Merge operations SHOULD complete within 5 seconds per spec"
          measurable_target: "Single merge completes in under 5 seconds"
        - id: "NFR-006"
          category: "usability"
          description: "Progress output MUST clearly indicate staging branch operations"
          measurable_target: "User can see which staging branch is being used for each operation"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Layer 1 worktrees contain all Layer 0 code changes"
          metric: "File existence verification after worktree creation"
          target: "100% of Layer 0 files present in Layer 1 worktrees"
        - id: "SC-002"
          description: "No merge conflicts occur from missing base code between layers"
          metric: "Conflict rate during staging merges"
          target: "Zero conflicts caused by missing dependency code"
        - id: "SC-003"
          description: "Final merge to main is a single operation"
          metric: "Number of merge commits required"
          target: "One merge commit from final staging to main"
        - id: "SC-004"
          description: "Parallel spec execution within layers still works"
          metric: "Concurrent spec execution success rate"
          target: "100% success for parallel specs in same layer"
        - id: "SC-005"
          description: "DAG runs can resume after interruption with staging branches intact"
          metric: "Resume success rate after interruption"
          target: "100% successful resume without staging branch recreation"
        - id: "SC-006"
          description: "Automerge integrates correctly with autocommit flow"
          metric: "Merge success rate when autocommit is enabled"
          target: "100% successful merges after verified commits"
        - id: "SC-007"
          description: "Config validation catches invalid automerge+autocommit combinations"
          metric: "Validation error detection rate"
          target: "100% detection of automerge=true with autocommit=false"
key_entities:
    - name: "StagingBranch"
      description: "A git branch that accumulates completed specs from a layer before the next layer starts"
      attributes:
        - "branch name (dag/<dag-id>/stage-<layer-id>)"
        - "layer ID"
        - "creation timestamp"
        - "list of merged specs"
    - name: "DAGExecutionConfig"
      description: "Configuration controlling DAG execution behavior including automerge settings"
      attributes:
        - "automerge enabled flag"
        - "autocommit enabled flag"
        - "conflict handling strategy"
    - name: "SpecState"
      description: "State tracking for individual spec execution within a DAG"
      attributes:
        - "merged_to_staging flag"
        - "commit SHA"
        - "commit status"
        - "branch name"
    - name: "MergeConflictError"
      description: "Error type containing details about merge conflicts for resolution"
      attributes:
        - "staging branch name"
        - "spec branch name"
        - "spec ID"
        - "list of conflicting files"
edge_cases:
    - scenario: "All specs in a layer fail to commit"
      expected_behavior: "No staging merge occurs; next layer cannot start; clear error message shown"
    - scenario: "Automerge enabled but autocommit disabled"
      expected_behavior: "Validation error at config load time with clear message about the dependency"
    - scenario: "Staging branch already exists (from previous interrupted run)"
      expected_behavior: "Reuse existing staging branch; do not recreate"
    - scenario: "Merge conflict during staging merge"
      expected_behavior: "Abort merge, report conflicting files, provide resolution steps, allow resume after fix"
    - scenario: "Empty layer (no specs)"
      expected_behavior: "Create staging branch from previous layer staging; proceed to next layer"
    - scenario: "Single spec in layer"
      expected_behavior: "Normal flow; staging branch created and spec merged"
    - scenario: "DAG run with --no-layer-staging flag"
      expected_behavior: "All worktrees branch from main (legacy behavior); warning about potential conflicts"
    - scenario: "Resume after partial layer completion"
      expected_behavior: "Only unmerged completed specs are merged; already-merged specs skipped"
assumptions:
    - "autospec autocommit feature is already implemented and working"
    - "Git worktree manager supports specifying a start point for new worktrees"
    - "DAG state persistence is already implemented"
    - "Layer ordering is correct in DAG config (L0 before L1, etc.)"
    - "Specs within a layer do not have dependencies on each other (only cross-layer deps)"
    - "Git is available and configured in the execution environment"
constraints:
    - "Cannot use rebase workflow; merge-based approach only for simplicity"
    - "Cannot cherry-pick individual commits; entire spec branches are merged"
    - "No squash merges into staging; full history preserved"
    - "Cross-layer dependencies within same run must use layer ordering, not runtime checks"
out_of_scope:
    - "Agent-based automatic conflict resolution (mentioned but not implemented in this spec)"
    - "Rebase worktrees onto correct staging branches (--rebase-worktrees flag)"
    - "Squash merge option for staging branches"
    - "Cherry-picking specific commits instead of full branch merges"
    - "Cross-layer dependency validation at runtime"
    - "UI/dashboard for visualizing staging branch state"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec v0.8.2"
    created: "2026-01-12T08:10:51Z"
    artifact_type: "spec"
