plan:
  branch: "096-dag-layer-merge"
  created: "2026-01-12"
  spec_path: "specs/096-dag-layer-merge/spec.yaml"

summary: |
  This plan implements DAG Layer Merge Propagation to solve the critical issue where multi-spec
  DAG orchestration fails because all worktrees branch from main, causing Layer N specs to lack
  Layer N-1's code. The solution introduces staging branches per layer that accumulate completed
  specs before spawning the next layer.

  Key technical decisions: (1) Use git branches for staging (`dag/<dag-id>/stage-<layer-id>`) to
  leverage git's merge infrastructure, (2) Support immediate automerge after each spec commits
  (default) or batch merge at layer completion, (3) Extend existing worktree manager with
  StartPoint option rather than creating new APIs, (4) Store staging branch state in DAGRun
  for resume capability, (5) Simplify final merge to single staging-to-main operation.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for state files and config"
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command structure"
    - name: "os/exec"
      version: "stdlib"
      purpose: "Git command execution"
  storage: "YAML state files in .autospec/state/dag-runs/"
  testing:
    framework: "Go testing package"
    approach: "Map-based table tests with mock interfaces for git operations"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Merge operations complete within 5 seconds per spec"
  constraints:
    - "Merge-based workflow only (no rebase)"
    - "Full history preserved (no squash merges)"
    - "Entire branches merged (no cherry-pick)"
    - "Functions under 40 lines"
    - "Errors wrapped with context"
  scale_scope: "DAGs with 10-50 specs across 3-5 layers"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All new code will have tests written before implementation using map-based table tests"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "Config validation will ensure automerge requires autocommit; staging branch existence validated before use"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Merge operations target <5s per spec; no validation functions added"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Staging branches reused on resume; merged_to_staging flag prevents double-merge"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "MergeConflictError returns distinct exit code for automation"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "Staging state stored in existing YAML state files"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All code passes go fmt and go vet"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, map-based tests"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "No slash command templates modified"

research_findings:
  decisions:
    - topic: "Staging branch naming convention"
      decision: "Use dag/<dag-id>/stage-<layer-id> format"
      rationale: "Consistent with existing spec branch format dag/<dag-id>/<spec-id>; clear hierarchy"
      alternatives_considered:
        - "dag/<dag-id>/staging (single branch) - rejected: loses layer granularity"
        - "staging/<dag-id>/L<n> - rejected: inconsistent with spec branches"

    - topic: "Worktree creation API"
      decision: "Extend CreateWithOptions with StartPoint field rather than new CreateFrom method"
      rationale: "Minimizes API surface; CreateOptions already exists; backwards compatible"
      alternatives_considered:
        - "New CreateFrom method - rejected: duplicates CreateWithOptions logic"
        - "Modify Create signature - rejected: breaks existing callers"

    - topic: "Automerge timing"
      decision: "Support both immediate (after each commit) and batch (at layer end) modes"
      rationale: "Immediate provides faster feedback; batch gives user control over integration points"
      alternatives_considered:
        - "Always batch - rejected: delays conflict detection"
        - "Always immediate - rejected: removes user choice"

    - topic: "State storage for staging branches"
      decision: "Add StagingBranches map to DAGRun struct"
      rationale: "Keeps staging state with run state; enables resume; single source of truth"
      alternatives_considered:
        - "Separate state file - rejected: complicates resume logic"
        - "Query git directly - rejected: loses creation timestamps and merged specs list"

    - topic: "Merge strategy"
      decision: "Use --no-ff merges to preserve history"
      rationale: "Clear audit trail of which specs merged when; easier to bisect issues"
      alternatives_considered:
        - "Fast-forward when possible - rejected: loses merge points"
        - "Squash merges - rejected: loses individual commit history"

data_model:
  entities:
    - name: "StagingBranchInfo"
      description: "Tracks staging branch state for a layer"
      fields:
        - name: "Branch"
          type: "string"
          description: "Full branch name (dag/<dag-id>/stage-<layer-id>)"
          constraints: "Required, valid git branch name"
        - name: "CreatedAt"
          type: "time.Time"
          description: "When the staging branch was created"
          constraints: "Set on creation"
        - name: "SpecsMerged"
          type: "[]string"
          description: "List of spec IDs that have been merged into this staging branch"
          constraints: "Updated as specs merge"
      relationships:
        - target: "DAGRun"
          type: "many-to-one"
          description: "Each staging branch belongs to one DAG run"

    - name: "DAGExecutionConfig (extended)"
      description: "Extended with automerge settings"
      fields:
        - name: "Automerge"
          type: "*bool"
          description: "Enable immediate merge into staging after commit"
          constraints: "Default true; requires Autocommit=true"
      relationships:
        - target: "DAGRun"
          type: "one-to-one"
          description: "Config applies to entire DAG run"

    - name: "SpecState (extended)"
      description: "Extended with staging merge tracking"
      fields:
        - name: "MergedToStaging"
          type: "bool"
          description: "Whether spec has been merged into layer staging branch"
          constraints: "Set true after successful staging merge"
      relationships:
        - target: "StagingBranchInfo"
          type: "many-to-one"
          description: "Spec merges into its layer's staging branch"

    - name: "MergeConflictError"
      description: "Error type containing conflict details for resolution guidance"
      fields:
        - name: "StageBranch"
          type: "string"
          description: "The staging branch being merged into"
          constraints: "Required"
        - name: "SpecBranch"
          type: "string"
          description: "The spec branch being merged"
          constraints: "Required"
        - name: "SpecID"
          type: "string"
          description: "ID of the spec with conflicts"
          constraints: "Required"
        - name: "Conflicts"
          type: "[]string"
          description: "List of files with merge conflicts"
          constraints: "At least one file"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/internal/dag-layer-staging.md"
      description: "Internal documentation for layer staging feature (if needed)"
  source_code:
    - path: "internal/dag/types.go"
      description: "Add StagingBranchInfo struct and extend DAGRun/SpecState"
    - path: "internal/dag/config.go"
      description: "Add Automerge field and IsAutomergeEnabled/Validate methods"
    - path: "internal/dag/staging.go"
      description: "New file for staging branch management (create, merge, conflict handling)"
    - path: "internal/dag/executor.go"
      description: "Modify to use staging branches for worktree creation and post-spec merge"
    - path: "internal/dag/merge.go"
      description: "Simplify final merge to use final staging branch"
    - path: "internal/worktree/manager.go"
      description: "Extend CreateOptions with StartPoint field"
    - path: "internal/worktree/git.go"
      description: "Add GitWorktreeAddFrom or modify existing to support start point"
    - path: "internal/cli/dag/run.go"
      description: "Add --automerge/--no-automerge/--no-layer-staging flags"
  tests:
    - path: "internal/dag/staging_test.go"
      description: "Tests for staging branch creation, merge, conflict detection"
    - path: "internal/dag/config_test.go"
      description: "Tests for automerge config validation"
    - path: "internal/dag/executor_test.go"
      description: "Tests for layer-aware worktree creation"
    - path: "internal/worktree/git_test.go"
      description: "Tests for worktree creation with start point"

implementation_phases:
  - phase: 1
    name: "Data Model & Configuration"
    goal: "Establish the data structures and configuration needed for layer staging"
    deliverables:
      - "StagingBranchInfo struct in types.go"
      - "StagingBranches map[string]*StagingBranchInfo field in DAGRun"
      - "MergedToStaging field in SpecState"
      - "Automerge field in DAGExecutionConfig"
      - "IsAutomergeEnabled() and Validate() methods in config.go"
      - "Environment variable support for AUTOSPEC_DAG_AUTOMERGE"
      - "Config schema update in internal/config/schema.go"
      - "Unit tests for config validation (automerge requires autocommit)"

  - phase: 2
    name: "Worktree Manager Extension"
    goal: "Enable worktree creation from a specific start point (staging branch)"
    dependencies:
      - "Phase 1"
    deliverables:
      - "StartPoint field in CreateOptions struct"
      - "Updated CreateWithOptions to pass start point to git"
      - "GitWorktreeAddFrom function or modified GitWorktreeAdd"
      - "Unit tests for worktree creation with start point"

  - phase: 3
    name: "Staging Branch Management"
    goal: "Implement core staging branch operations"
    dependencies:
      - "Phase 1"
    deliverables:
      - "New staging.go file with StagingManager or Executor methods"
      - "stageBranchName() for naming convention"
      - "createStagingBranch() to create from source branch"
      - "mergeIntoStaging() to merge spec branch with --no-ff"
      - "MergeConflictError type with conflict detection"
      - "DetectConflictedFiles helper function"
      - "Unit tests with mocked git operations"

  - phase: 4
    name: "Executor Integration"
    goal: "Integrate staging branches into DAG execution flow"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "getBaseBranchForLayer() to determine source branch (main vs staging)"
      - "Modified createWorktree() to use layer base branch"
      - "postSpecCompletion() for automerge flow"
      - "completeLayer() for batch merge when automerge disabled"
      - "State persistence for staging branches"
      - "Integration tests for end-to-end layer staging"

  - phase: 5
    name: "CLI Flags & Merge Simplification"
    goal: "Add CLI flags and simplify final merge command"
    dependencies:
      - "Phase 4"
    deliverables:
      - "--automerge and --no-automerge flags for dag run"
      - "--no-layer-staging flag to disable feature (legacy mode)"
      - "Updated dag merge to use final staging branch"
      - "Clear output showing staging operations"
      - "End-to-end tests for CLI flags"

  - phase: 6
    name: "Conflict Handling & Polish"
    goal: "Robust conflict handling and user experience improvements"
    dependencies:
      - "Phase 5"
    deliverables:
      - "handleStagingConflict() with clear error messages"
      - "Resolution instructions in error output"
      - "Resume after manual conflict resolution"
      - "Progress output for staging operations"
      - "Documentation updates if needed"
      - "All quality gates pass (make test, fmt, lint, build)"

open_questions:
  - question: "Should --rebase-worktrees be implemented in this spec or deferred?"
    context: "The spec marks it as out-of-scope but mentions it in CLI Changes section"
    proposed_resolution: "Defer to separate spec; focus on core staging functionality first"

  - question: "How to handle empty layers (no features)?"
    context: "Edge case where a layer has no features but exists for organizational purposes"
    proposed_resolution: "Create staging branch anyway from previous layer; allows clean layer progression"

  - question: "Should dag status show staging branch details?"
    context: "Would help users understand current state but adds complexity"
    proposed_resolution: "Add basic staging info to dag status; detailed --staging flag deferred"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.8.2"
  created: "2026-01-12T08:12:16Z"
  artifact_type: "plan"
