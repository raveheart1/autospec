plan:
  branch: "060-targeted-test-coverage"
  created: "2025-12-19"
  spec_path: "specs/060-targeted-test-coverage/spec.yaml"

summary: |
  This plan addresses test coverage gaps across CLI subpackages and supporting packages without
  modifying production code. The implementation follows a bottom-up approach: starting with
  small utility packages (shared, retry, health), then moving to larger packages (completion, notify),
  and finally tackling the CLI subpackages (admin, config, stages, util) and main CLI package.

  All tests will use map-based table-driven patterns with t.Parallel(), Cobra test utilities for
  CLI commands, and t.TempDir() for file operations. The constraint of no production code changes
  means tests will focus on exercising existing public APIs and command behaviors through their
  established interfaces.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.1"
      purpose: "CLI framework - provides SetArgs, SetOut, SetErr for testing"
    - name: "github.com/stretchr/testify"
      version: "v1.9.0"
      purpose: "Test assertions and requirements"
  storage: "None"
  testing:
    framework: "go test"
    approach: |
      Unit tests with map-based table-driven patterns. CLI commands tested via
      Cobra's SetArgs/SetOut/SetErr/Execute pattern. File operations use t.TempDir().
      No mocks added to production code; tests exercise public interfaces only.
  target_platform: "linux/darwin/windows (amd64/arm64)"
  project_type: "cli"
  performance_goals: "Test suite increase <30 seconds"
  constraints:
    - "No production code modifications"
    - "No new interfaces for testing purposes"
    - "Must use existing arch-1/2 interfaces for mocking"
    - "Functions must stay under 40 lines"
    - "Must pass make test, make fmt, make lint, make build"
  scale_scope: "Add ~20-30 test files across 10 packages"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "This feature is entirely about writing tests; inherently test-first"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "No workflow phase transitions involved; only test file additions"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "NFR-007 limits test suite increase to <30 seconds"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "N/A"
      notes: "Tests are idempotent by nature"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "All tests will use map-based table-driven pattern with t.Parallel(), <40 line functions"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "No command templates modified"

research_findings:
  decisions:
    - topic: "CLI command testing approach"
      decision: "Use Cobra's SetArgs, SetOut, SetErr, Execute pattern"
      rationale: "Standard Cobra testing approach; already used in existing tests like specify_test.go"
      alternatives_considered:
        - "Direct function calls (less realistic)"
        - "Integration tests with subprocess (too slow)"
    - topic: "Test file organization"
      decision: "Add *_test.go files in each subpackage directory"
      rationale: "Go convention; tests in same package access unexported symbols if needed"
      alternatives_considered:
        - "Separate _test package (would require exporting internals)"
    - topic: "Mocking external commands"
      decision: "Test behavior boundaries, not internal execution"
      rationale: "FR-011/FR-012 prohibit new interfaces; test what commands output given inputs"
      alternatives_considered:
        - "Add mock interfaces to production code (violates constraints)"
    - topic: "Coverage target approach"
      decision: "Focus on uncovered functions identified by coverage profiling"
      rationale: "Coverage profiling shows exactly which functions need tests"
      alternatives_considered:
        - "Blanket all-functions approach (inefficient)"

data_model:
  entities: []

api_contracts:
  endpoints: []

project_structure:
  documentation: []
  source_code:
    - path: "internal/cli/admin/"
      description: "Administrative CLI commands (commands, completion_install, uninstall)"
    - path: "internal/cli/config/"
      description: "Configuration CLI commands (init, config, migrate, doctor)"
    - path: "internal/cli/shared/"
      description: "Shared constants and types for CLI subpackages"
    - path: "internal/cli/stages/"
      description: "Workflow stage commands (specify, plan, tasks, implement)"
    - path: "internal/cli/util/"
      description: "Utility CLI commands (status, history, version, clean)"
    - path: "internal/notify/"
      description: "Notification system with platform-specific senders"
    - path: "internal/completion/"
      description: "Shell completion generation and installation"
    - path: "internal/retry/"
      description: "Retry state persistence"
    - path: "internal/health/"
      description: "Dependency health checks"
  tests:
    - path: "internal/cli/shared/*_test.go"
      description: "Tests for shared constants and exit error handling"
    - path: "internal/cli/admin/*_test.go"
      description: "Tests for admin subcommands (commands, completion, uninstall)"
    - path: "internal/cli/config/*_test.go"
      description: "Tests for config subcommands (init, config, migrate, doctor)"
    - path: "internal/cli/stages/*_test.go"
      description: "Tests for stage subcommands (specify, plan, tasks, implement)"
    - path: "internal/cli/util/*_test.go"
      description: "Tests for utility subcommands (status, history, version, clean)"
    - path: "internal/notify/*_test.go"
      description: "Additional tests for handler hooks and sender logic"
    - path: "internal/completion/*_test.go"
      description: "Additional tests for Install and installFish functions"
    - path: "internal/retry/*_test.go"
      description: "Additional tests for save state edge cases"
    - path: "internal/health/*_test.go"
      description: "Additional tests for check error paths"

implementation_phases:
  - phase: 1
    name: "Minor Package Coverage Fixes"
    goal: "Bring retry (83.4%) and health (83.3%) packages to 85% threshold with minimal additions"
    deliverables:
      - "internal/retry/retry_test.go additions for SaveRetryState edge cases"
      - "internal/health/health_test.go additions for check error paths"
  - phase: 2
    name: "Shared Package Foundation"
    goal: "Add tests for internal/cli/shared package (0% → 85%)"
    deliverables:
      - "internal/cli/shared/constants_test.go covering exit codes, group constants, and ExitError"
    dependencies:
      - "Phase 1"
  - phase: 3
    name: "Completion and Notify Package Improvements"
    goal: "Improve completion (65.2% → 85%) and notify (56.9% → 85%) coverage"
    deliverables:
      - "internal/completion/install_test.go additions for Install, installFish, generateCompletionScript"
      - "internal/notify/handler_test.go additions for OnCommandComplete, OnStageComplete, OnError full paths"
      - "internal/notify/sender_test.go additions for platform-specific sender logic"
    dependencies:
      - "Phase 2"
  - phase: 4
    name: "CLI Admin Subpackage Tests"
    goal: "Add tests for internal/cli/admin package (0% → 85%)"
    deliverables:
      - "internal/cli/admin/register_test.go for Register function"
      - "internal/cli/admin/commands_test.go for commands parent command"
      - "internal/cli/admin/commands_check_test.go for runCommandsCheck"
      - "internal/cli/admin/commands_info_test.go for runCommandsInfo, listAllCommands, showCommandDetail"
      - "internal/cli/admin/commands_install_test.go for runCommandsInstall"
      - "internal/cli/admin/completion_install_test.go for runCompletionInstall"
      - "internal/cli/admin/uninstall_test.go for RunUninstall and helpers"
    dependencies:
      - "Phase 3"
  - phase: 5
    name: "CLI Config Subpackage Tests"
    goal: "Add tests for internal/cli/config package (0% → 85%)"
    deliverables:
      - "internal/cli/config/register_test.go for Register function"
      - "internal/cli/config/init_test.go for runInit and helpers"
      - "internal/cli/config/config_test.go for runConfigShow, runConfigMigrate"
      - "internal/cli/config/migrate_test.go for migrate command"
      - "internal/cli/config/doctor_test.go for doctor command"
    dependencies:
      - "Phase 4"
  - phase: 6
    name: "CLI Stages Subpackage Tests"
    goal: "Add tests for internal/cli/stages package (0% → 85%)"
    deliverables:
      - "internal/cli/stages/register_test.go for Register function"
      - "internal/cli/stages/specify_test.go for specifyCmd"
      - "internal/cli/stages/plan_test.go for planCmd"
      - "internal/cli/stages/tasks_test.go for tasksCmd"
      - "internal/cli/stages/implement_test.go for implementCmd"
    dependencies:
      - "Phase 5"
  - phase: 7
    name: "CLI Util Subpackage Tests"
    goal: "Add tests for internal/cli/util package (0% → 85%)"
    deliverables:
      - "internal/cli/util/register_test.go for Register function"
      - "internal/cli/util/status_test.go for statusCmd"
      - "internal/cli/util/history_test.go for historyCmd"
      - "internal/cli/util/version_test.go for versionCmd"
      - "internal/cli/util/clean_test.go for cleanCmd"
    dependencies:
      - "Phase 6"
  - phase: 8
    name: "CLI Main Package Coverage Improvement"
    goal: "Improve internal/cli main package coverage (35.8% → 85%)"
    deliverables:
      - "Additional tests in internal/cli/ for root command, subcommand registration, global flags"
      - "Tests for uncovered functions in artifact.go, new_feature.go, and other main package files"
    dependencies:
      - "Phase 7"
  - phase: 9
    name: "Quality Gate Validation"
    goal: "Verify all coverage targets met and quality gates pass"
    deliverables:
      - "Coverage verification for all 10 target packages"
      - "make test passes"
      - "make fmt produces no changes"
      - "make lint passes"
      - "make build succeeds"
    dependencies:
      - "Phase 8"

risks:
  - risk: "85% coverage not achievable without production changes"
    likelihood: "medium"
    impact: "high"
    mitigation: "Coverage profiling identifies exactly what's untested; focus on achievable paths first"
  - risk: "CLI commands require external dependencies (Claude CLI, git)"
    likelihood: "high"
    impact: "medium"
    mitigation: "Test command setup, flag parsing, output formatting—not actual execution"
  - risk: "Platform-specific code hard to test on single platform"
    likelihood: "medium"
    impact: "low"
    mitigation: "Test the dispatch logic; platform-specific senders already have conditional coverage"
  - risk: "Test suite time exceeds 30 second increase"
    likelihood: "low"
    impact: "low"
    mitigation: "Use t.Parallel() throughout; keep tests focused and fast"

open_questions:
  - question: "How to test commands that prompt for user input (uninstall, init)?"
    context: "FR-011/FR-012 prohibit adding mock interfaces to production code"
    proposed_resolution: "Test non-interactive paths; verify prompt messages without actual input"
  - question: "Should we test internal/cli main package or subpackage commands first?"
    context: "Main package at 35.8% has different challenges than 0% subpackages"
    proposed_resolution: "Subpackages first (clearer scope), then main package (builds on patterns)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-19T00:44:34Z"
  artifact_type: "plan"
