plan:
  branch: "083-enhanced-integration-tests"
  created: "2026-01-06"
  spec_path: "specs/083-enhanced-integration-tests/spec.yaml"

summary: |
  This plan enhances autospec's integration test infrastructure to provide robust CLI argument
  validation without making API calls. The approach combines three complementary strategies:
  (1) extending the existing MockExecutor with environment variable capture for complete
  invocation context, (2) implementing the TestHelperProcess pattern for exec.Command
  interception at the Go test level, and (3) supporting real binary validation through
  invalid API key injection that causes Claude/OpenCode to fail-fast before network calls.

  The existing mock-claude.sh and MockExecutorBuilder provide a solid foundation. This plan
  extends them with argument capture, schema validation, and comprehensive test fixtures
  for all workflow stages. The key insight is that real CLIs fail-fast with invalid API keys,
  providing a validation opportunity without network dependency.

technical_context:
  language: "Go"
  framework: "None"
  primary_dependencies:
    - name: "testing"
      version: "stdlib"
      purpose: "Go test framework with table-driven patterns"
    - name: "os/exec"
      version: "stdlib"
      purpose: "Command execution and TestHelperProcess pattern"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for call log files"
  storage: "None"
  testing:
    framework: "Go testing"
    approach: "Table-driven unit tests with mock executor and TestHelperProcess pattern"
  target_platform: "Linux, macOS"
  project_type: "cli"
  performance_goals: "Mock-based tests complete in under 5 seconds total"
  constraints:
    - "Cannot modify Claude or OpenCode CLI source code"
    - "Must maintain backward compatibility with existing MockExecutor API"
    - "Must work on macOS and Linux CI environments"
  scale_scope: "Integration test enhancement for existing autospec test suite"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Test infrastructure is the primary deliverable; tests will validate the new mock capabilities"
    - name: "Validation-First Workflow"
      status: "PASS"
      notes: "ArgumentValidator provides validation before workflow execution"
    - name: "Performance Standards"
      status: "PASS"
      notes: "NFR-005 specifies <5s for mock-based tests; no network calls ensures speed"
    - name: "Idempotency and Retry Logic"
      status: "N/A"
      notes: "Testing infrastructure doesn't require retry logic"
    - name: "Go Coding Standards"
      status: "PASS"
      notes: "All new code follows <40 line functions, error wrapping, map-based table tests"

research_findings:
  decisions:
    - topic: "CLI argument validation without API calls"
      decision: "Use empty/invalid ANTHROPIC_API_KEY to trigger CLI fail-fast"
      rationale: "Both Claude and OpenCode CLI validate API keys before making network calls. An empty or invalid key causes immediate exit with authentication error, confirming argument parsing succeeded"
      alternatives_considered:
        - "Network-level blocking (iptables) - not portable across CI environments"
        - "Proxy interception - complex setup, maintenance burden"
        - "CLI dry-run flags - not consistently available across agents"
    - topic: "Mock subprocess interception pattern"
      decision: "Implement TestHelperProcess pattern for exec.Command"
      rationale: "Standard Go pattern where test binary re-invokes itself with GO_WANT_HELPER_PROCESS=1, enabling complete control over subprocess behavior without external dependencies"
      alternatives_considered:
        - "Shell script mocks only - already have mock-claude.sh, but Go pattern provides tighter integration"
        - "Interface mocking with testify - doesn't catch exec.Command construction bugs"
    - topic: "Call log format"
      decision: "YAML format for call logs to match existing artifact patterns"
      rationale: "Consistent with autospec's YAML-first artifact approach (constitution PRIN-006), enables reuse of existing YAML parsing infrastructure"
      alternatives_considered:
        - "JSON logs - valid but YAML provides better multiline string handling"
        - "Structured Go values only - limits debugging visibility"

data_model:
  entities:
    - name: "CallRecord"
      description: "Extended invocation record with full execution context"
      fields:
        - name: "Method"
          type: "string"
          description: "Method name (Execute, ExecuteInteractive, StreamCommand, FormatCommand)"
          constraints: "One of defined method names"
        - name: "Prompt"
          type: "string"
          description: "Full prompt/command passed to agent"
          constraints: "Non-empty for execution methods"
        - name: "Args"
          type: "[]string"
          description: "Raw argument array passed to exec.Command"
          constraints: "None"
        - name: "Env"
          type: "map[string]string"
          description: "Environment variables snapshot at execution time"
          constraints: "Includes ANTHROPIC_API_KEY, OPENCODE_* vars"
        - name: "Timestamp"
          type: "time.Time"
          description: "When the call was made"
          constraints: "Non-zero"
        - name: "Response"
          type: "string"
          description: "Mock response returned"
          constraints: "None"
        - name: "Error"
          type: "error"
          description: "Error returned by the mock"
          constraints: "nil on success"
        - name: "ExitCode"
          type: "int"
          description: "Exit code from mock execution"
          constraints: "0-255"
    - name: "ArgumentSchema"
      description: "Schema for validating CLI arguments by agent type"
      fields:
        - name: "AgentName"
          type: "string"
          description: "Agent identifier (claude, opencode)"
          constraints: "One of registered agent names"
        - name: "RequiredFlags"
          type: "[]string"
          description: "Flags that must be present"
          constraints: "None"
        - name: "ValidFlags"
          type: "map[string]FlagSpec"
          description: "Known valid flags with value constraints"
          constraints: "None"
        - name: "PromptDeliveryMethods"
          type: "[]string"
          description: "How prompt can be delivered (-p, --print, stdin)"
          constraints: "At least one method"
      relationships:
        - target: "CallRecord"
          type: "validates"
          description: "ArgumentSchema validates CallRecord.Args"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "internal/testutil/README.md"
      description: "Documentation for test utilities including mock patterns (existing, may update)"
  source_code:
    - path: "internal/testutil/mock_executor.go"
      description: "Extended MockExecutor with Env capture and Args recording"
    - path: "internal/testutil/test_helper_process.go"
      description: "New file implementing TestHelperProcess pattern"
    - path: "internal/testutil/argument_validator.go"
      description: "New file implementing ArgumentValidator for CLI argument schema validation"
    - path: "internal/testutil/call_log.go"
      description: "New file for YAML call log reading/writing"
  tests:
    - path: "internal/testutil/mock_executor_test.go"
      description: "Tests for extended MockExecutor functionality"
    - path: "internal/testutil/test_helper_process_test.go"
      description: "Tests for TestHelperProcess pattern"
    - path: "internal/testutil/argument_validator_test.go"
      description: "Tests for argument validation against agent schemas"
    - path: "internal/workflow/integration_test.go"
      description: "Extended integration tests using new mock capabilities"

implementation_phases:
  - phase: 1
    name: "Extend MockExecutor with Environment Capture"
    goal: "Add Env map to CallRecord and capture environment variables during mock execution"
    deliverables:
      - "Extended CallRecord struct with Args and Env fields"
      - "Modified recordAndRespond to capture os.Environ()"
      - "New GetCallsByEnv() helper method for filtering by env vars"
      - "Unit tests verifying environment capture"
  - phase: 2
    name: "Implement TestHelperProcess Pattern"
    goal: "Create reusable TestHelperProcess implementation for exec.Command interception"
    dependencies:
      - "Phase 1"
    deliverables:
      - "TestHelperProcess function with GO_WANT_HELPER_PROCESS check"
      - "Helper to configure exec.Command to use test binary"
      - "Argument parsing and configurable exit codes"
      - "Integration with MockExecutorBuilder"
      - "Tests demonstrating pattern usage"
  - phase: 3
    name: "Implement ArgumentValidator"
    goal: "Create validation framework for CLI argument construction"
    dependencies:
      - "Phase 1"
    deliverables:
      - "ArgumentSchema struct with flag specifications"
      - "ValidateArgs(agentName string, args []string) error function"
      - "Pre-built schemas for Claude and OpenCode agents"
      - "Table-driven tests for valid and invalid argument combinations"
  - phase: 4
    name: "Add Real Binary Validation Support"
    goal: "Enable validation tests using real CLI binaries with invalid API keys"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Helper function to detect if real CLI is available"
      - "Test wrapper that sets empty ANTHROPIC_API_KEY"
      - "Skip logic with clear message when CLI not installed"
      - "Integration tests that validate against real parser"
  - phase: 5
    name: "Create Test Fixtures and Integration Tests"
    goal: "Comprehensive test coverage for all workflow stages"
    dependencies:
      - "Phase 1"
      - "Phase 2"
      - "Phase 3"
      - "Phase 4"
    deliverables:
      - "Test fixtures for specify, plan, tasks, implement stages"
      - "Table-driven tests covering edge cases from spec"
      - "Updated integration_test.go with new mock capabilities"
      - "Documentation updates for test utility usage"

risks:
  - risk: "Real CLI validation may not be deterministic across CLI versions"
    impact: "medium"
    likelihood: "low"
    mitigation: "Version-specific skip logic if behavior changes; focus on mock-based tests for determinism"
  - risk: "TestHelperProcess pattern complexity may confuse contributors"
    impact: "low"
    likelihood: "medium"
    mitigation: "Clear documentation with examples; follow established Go testing patterns"

open_questions:
  - question: "Should ArgumentValidator also validate prompt content structure?"
    context: "Currently scoped to CLI flags only, but could extend to prompt format validation"
    proposed_resolution: "Defer to separate feature; keep initial scope focused on CLI arguments"
  - question: "How to handle agent-specific flag variations (Claude vs OpenCode vs Gemini)?"
    context: "Different agents have different flag names for similar concepts"
    proposed_resolution: "Create per-agent ArgumentSchema instances; avoid over-abstraction initially"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec 0.8.2"
  created: "2026-01-06T05:02:08Z"
  artifact_type: "plan"
