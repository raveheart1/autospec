feature:
    branch: "083-enhanced-integration-tests"
    created: "2026-01-06"
    status: "Completed"
    completed_at: 2026-01-06T05:25:52Z
    input: "improve on integration tests while still mocking any opencode or claude code binary so that we never trigger any api calls while still validating args to claude or opencode. how is this possible with mock binary? how to validate with the real program if our current args/tests work without making any api calls? sandbox or intercept them? quit binary quickly (seems hacky prefer not to) do a bit of research and figure it out"
user_stories:
    - id: "US-001"
      title: "Validate CLI Arguments Without API Calls"
      priority: "P1"
      as_a: "developer running integration tests"
      i_want: "to validate that autospec passes correct arguments to Claude/OpenCode CLI"
      so_that: "I can catch argument construction bugs without incurring API costs or network dependencies"
      why_this_priority: "Core requirement - argument validation is the primary concern expressed in the feature request"
      independent_test: "Run test suite with mock binaries that capture and validate arguments"
      acceptance_scenarios:
        - given: "a mock binary configured to capture arguments"
          when: "autospec executes a specify command"
          then: "the mock captures arguments and validates prompt delivery method, flags, and values"
        - given: "a test using the TestHelperProcess pattern"
          when: "autospec executes any workflow stage"
          then: "the test binary intercepts the exec.Command call without spawning real processes"
    - id: "US-002"
      title: "Test Against Real Binary Argument Parsing"
      priority: "P1"
      as_a: "developer ensuring compatibility"
      i_want: "to verify my argument construction works with the real Claude/OpenCode CLI parser"
      so_that: "I can catch argument format issues that only real binaries would detect (invalid flags, quoting problems)"
      why_this_priority: "Critical for detecting real-world compatibility issues that mocks cannot catch"
      independent_test: "Run validation tests using real binary with dry-run or argument validation mode"
      acceptance_scenarios:
        - given: "Claude or OpenCode CLI is installed"
          when: "a validation test runs with constructed arguments"
          then: "the CLI validates arguments and exits before making any API calls"
        - given: "invalid arguments are passed to the real CLI"
          when: "the validation test runs"
          then: "the test detects the argument parsing error without triggering API calls"
    - id: "US-003"
      title: "Intercept API Calls at Network Level"
      priority: "P2"
      as_a: "developer writing integration tests"
      i_want: "network-level safeguards preventing any accidental API calls"
      so_that: "even if argument validation passes, no real API requests are made during tests"
      why_this_priority: "Defense-in-depth - provides safety net for edge cases where other validation might miss an execution path"
      independent_test: "Run tests with network sandbox or mock server that rejects/intercepts API traffic"
      acceptance_scenarios:
        - given: "tests running with network interception enabled"
          when: "any code path attempts an API call"
          then: "the call is blocked or redirected to a mock endpoint"
        - given: "the environment variable ANTHROPIC_API_KEY is unset or invalid"
          when: "Claude CLI attempts initialization"
          then: "the CLI fails fast before network calls"
    - id: "US-004"
      title: "Capture and Assert on CLI Invocations"
      priority: "P1"
      as_a: "developer debugging test failures"
      i_want: "detailed logging of all CLI invocations including full argument lists and environment"
      so_that: "I can diagnose why a particular command construction failed"
      why_this_priority: "Essential for test debugging and CI visibility"
      independent_test: "Verify call logs contain timestamp, full args array, environment snapshot, and exit codes"
      acceptance_scenarios:
        - given: "a mock executor is configured"
          when: "multiple workflow stages execute"
          then: "each invocation is logged with timestamp, args, env vars, and response"
        - given: "a test fails due to incorrect arguments"
          when: "I examine the test output"
          then: "I can see exactly what arguments were passed vs expected"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST implement TestHelperProcess pattern for exec.Command interception in Go tests"
          testable: true
          acceptance_criteria: "Tests can intercept exec.Command calls without spawning real subprocess, validate args, and return mock responses"
        - id: "FR-002"
          description: "MUST provide mock binary (shell script or Go binary) that captures invocation details to a log file"
          testable: true
          acceptance_criteria: "Mock binary writes YAML call log with args, timestamp, env vars; integration tests can read and assert on log contents"
        - id: "FR-003"
          description: "MUST support validation mode where real CLI binary validates arguments without making API calls"
          testable: true
          acceptance_criteria: "Test helper can invoke real claude/opencode binary in a mode that parses args and fails on invalid input but never reaches API layer"
        - id: "FR-004"
          description: "MUST configure test environment to prevent API calls via empty/invalid API keys"
          testable: true
          acceptance_criteria: "Tests set ANTHROPIC_API_KEY to empty string; CLI initialization fails gracefully before any network activity"
        - id: "FR-005"
          description: "SHOULD support argument schema validation against known CLI flag specifications"
          testable: true
          acceptance_criteria: "Validation function checks arguments match expected patterns for each agent type (Claude vs OpenCode)"
        - id: "FR-006"
          description: "MUST extend MockExecutorBuilder to record full command construction including environment variables"
          testable: true
          acceptance_criteria: "CallRecord struct includes Env map; GetCalls returns complete invocation context"
        - id: "FR-007"
          description: "SHOULD provide test fixtures for common argument patterns across all supported workflow stages"
          testable: true
          acceptance_criteria: "Table-driven tests cover specify, plan, tasks, implement stages with valid and invalid argument combinations"
        - id: "FR-008"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-002"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern"
          measurable_target: "All new test functions use map[string]struct pattern"
        - id: "NFR-004"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
        - id: "NFR-005"
          category: "performance"
          description: "Integration tests using mocks must complete quickly"
          measurable_target: "Mock-based integration tests complete in under 5 seconds total"
        - id: "NFR-006"
          category: "reliability"
          description: "Tests must be deterministic and not flaky"
          measurable_target: "Zero intermittent failures over 100 consecutive test runs"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Developers can run full integration test suite without any external API calls"
          metric: "Number of network requests to anthropic.com or openai.com during test run"
          target: "Zero external API calls"
        - id: "SC-002"
          description: "Integration tests validate argument construction for all workflow stages"
          metric: "Coverage of argument patterns tested"
          target: "100% of workflow stages (specify, plan, tasks, implement) have argument validation tests"
        - id: "SC-003"
          description: "Real binary validation catches argument format errors"
          metric: "Detection rate for malformed arguments"
          target: "100% detection of invalid flags, missing required args, and malformed values"
        - id: "SC-004"
          description: "Test debugging provides clear invocation logs"
          metric: "Information completeness in failure messages"
          target: "Every test failure includes full args array, expected vs actual comparison"
key_entities:
    - name: "MockExecutor"
      description: "Test double that intercepts command execution and records invocations"
      attributes:
        - "CallRecord (struct with Method, Prompt, Args, Env, Timestamp, Response, Error)"
        - "Response queue for sequential mock responses"
        - "Artifact generation callbacks"
    - name: "TestHelperProcess"
      description: "Go test pattern where test binary calls itself to intercept subprocess execution"
      attributes:
        - "GO_WANT_HELPER_PROCESS environment variable check"
        - "Argument parsing and validation"
        - "Configurable exit codes and output"
    - name: "ArgumentValidator"
      description: "Component that validates CLI argument construction against agent specifications"
      attributes:
        - "Agent-specific flag schemas (Claude vs OpenCode)"
        - "Prompt delivery method validation"
        - "Required vs optional argument checks"
    - name: "CallLog"
      description: "Structured log of CLI invocations for test assertions"
      attributes:
        - "YAML format for machine readability"
        - "Timestamp, args array, environment snapshot"
        - "Exit code and output"
edge_cases:
    - scenario: "Arguments contain special characters (quotes, newlines, unicode)"
      expected_behavior: "Mock captures exact argument values; validation handles escaping correctly"
    - scenario: "Environment variables override command-line arguments"
      expected_behavior: "Tests validate both CLI args and env var combinations"
    - scenario: "Real CLI binary not installed in test environment"
      expected_behavior: "Real binary validation tests skip gracefully with clear message"
    - scenario: "Mock response queue exhausted before all expected calls"
      expected_behavior: "MockExecutor returns success with empty response; test can assert on call count"
    - scenario: "Concurrent test execution accessing shared mock state"
      expected_behavior: "MockExecutor is goroutine-safe with mutex protection"
    - scenario: "CLI binary exits immediately with usage error"
      expected_behavior: "Tests can distinguish between argument validation failure and runtime error"
assumptions:
    - "Claude Code and OpenCode CLI have consistent argument parsing behavior across versions"
    - "Empty ANTHROPIC_API_KEY causes Claude to fail before any network calls"
    - "The TestHelperProcess pattern works reliably across all Go test runners"
    - "Mock shell scripts (mock-claude.sh) execute consistently across macOS and Linux"
    - "CI environments have bash available for shell-based mocks"
constraints:
    - "Cannot modify Claude or OpenCode CLI source code; must work with binaries as black boxes"
    - "Some CLI argument validation can only be confirmed by invoking real binary"
    - "Network-level blocking may not be available in all CI environments"
    - "Must maintain backward compatibility with existing mock_executor.go API"
out_of_scope:
    - "Mocking the actual LLM responses or behavior"
    - "Testing Claude/OpenCode CLI internal logic"
    - "Performance benchmarking of real CLI invocations"
    - "Testing with actual API credentials or network calls"
    - "Modifying the Claude or OpenCode CLI binaries"
    - "Supporting Windows-specific testing scenarios (focus on Unix-like systems)"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.8.2"
    created: "2026-01-06T04:59:39Z"
    artifact_type: "spec"
