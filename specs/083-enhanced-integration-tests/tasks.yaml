tasks:
    branch: "083-enhanced-integration-tests"
    created: "2026-01-06"
    spec_path: "specs/083-enhanced-integration-tests/spec.yaml"
    plan_path: "specs/083-enhanced-integration-tests/plan.yaml"
summary:
    total_tasks: 16
    total_phases: 6
    parallel_opportunities: 6
    estimated_complexity: "medium"
phases:
    - number: 1
      title: "Setup"
      purpose: "Project initialization and test infrastructure preparation"
      tasks:
        - id: "T001"
          title: "Review existing mock_executor.go and test infrastructure"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/testutil/mock_executor.go"
          dependencies: []
          acceptance_criteria:
            - "Understand current CallRecord structure and MockExecutorBuilder API"
            - "Document existing mock patterns for backward compatibility"
    - number: 2
      title: "User Story 1 - Validate CLI Arguments Without API Calls"
      purpose: "Implement argument capture and validation in MockExecutor"
      story_reference: "US-001"
      independent_test: "Run test suite with mock binaries that capture and validate arguments"
      tasks:
        - id: "T002"
          title: "Extend CallRecord with Args and Env fields in mock_executor.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/testutil/mock_executor.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "CallRecord struct includes Args []string field"
            - "CallRecord struct includes Env map[string]string field"
            - "Backward compatible with existing tests"
        - id: "T003"
          title: "Add environment capture in recordAndRespond method"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/testutil/mock_executor.go"
          dependencies: ["T002"]
          acceptance_criteria:
            - "recordAndRespond captures os.Environ() at call time"
            - "Environment snapshot stored in CallRecord.Env"
            - "Key environment variables (ANTHROPIC_API_KEY, OPENCODE_*) are captured"
        - id: "T004"
          title: "Add GetCallsByEnv helper method to MockExecutor"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/testutil/mock_executor.go"
          dependencies: ["T003"]
          acceptance_criteria:
            - "GetCallsByEnv(key, value string) filters calls by env var"
            - "Returns slice of matching CallRecords"
        - id: "T005"
          title: "Write tests for extended MockExecutor functionality"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/testutil/mock_executor_test.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "Tests verify Args capture for all method types"
            - "Tests verify Env capture includes key environment variables"
            - "Tests use map-based table-driven pattern"
    - number: 3
      title: "User Story 1 - TestHelperProcess Pattern"
      purpose: "Implement TestHelperProcess for exec.Command interception"
      story_reference: "US-001"
      independent_test: "Tests can intercept exec.Command calls and validate arguments"
      tasks:
        - id: "T006"
          title: "Create test_helper_process.go with TestHelperProcess function"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/testutil/test_helper_process.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "TestHelperProcess checks GO_WANT_HELPER_PROCESS env var"
            - "Parses arguments and returns configurable exit codes"
            - "Supports configurable mock responses"
        - id: "T007"
          title: "Add helper to configure exec.Command to use test binary"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/testutil/test_helper_process.go"
          dependencies: ["T006"]
          acceptance_criteria:
            - "ConfigureTestCommand returns exec.Cmd pointing to test binary"
            - "Sets GO_WANT_HELPER_PROCESS and GO_HELPER_PROCESS_ARGS env vars"
            - "Works with go test -run pattern"
        - id: "T008"
          title: "Write tests for TestHelperProcess pattern"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/testutil/test_helper_process_test.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "Demonstrates pattern usage with example test"
            - "Tests configurable exit codes and outputs"
            - "Tests use map-based table-driven pattern"
    - number: 4
      title: "User Story 2 - Real Binary Argument Validation"
      purpose: "Enable validation against real CLI binaries without API calls"
      story_reference: "US-002"
      independent_test: "Run validation tests using real binary with invalid API key"
      tasks:
        - id: "T009"
          title: "Create argument_validator.go with ArgumentSchema struct"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-002"
          file_path: "internal/testutil/argument_validator.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "ArgumentSchema struct with AgentName, RequiredFlags, ValidFlags"
            - "FlagSpec struct for value constraints"
            - "PromptDeliveryMethods field for -p, --print, stdin validation"
        - id: "T010"
          title: "Implement ValidateArgs function for CLI argument validation"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/testutil/argument_validator.go"
          dependencies: ["T009"]
          acceptance_criteria:
            - "ValidateArgs(agentName, args) returns error on invalid args"
            - "Checks required flags are present"
            - "Validates flag values match expected patterns"
        - id: "T011"
          title: "Add pre-built schemas for Claude and OpenCode agents"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/testutil/argument_validator.go"
          dependencies: ["T010"]
          acceptance_criteria:
            - "ClaudeSchema defines valid Claude CLI flags"
            - "OpenCodeSchema defines valid OpenCode CLI flags"
            - "Schemas registered in global registry for lookup by agent name"
        - id: "T012"
          title: "Add helper to detect real CLI availability"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/testutil/argument_validator.go"
          dependencies: ["T011"]
          acceptance_criteria:
            - "IsRealCLIAvailable(agentName) checks if binary exists in PATH"
            - "Returns false with clear message when CLI not installed"
            - "Used by tests to skip real binary validation gracefully"
        - id: "T013"
          title: "Write tests for ArgumentValidator"
          status: "InProgress"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/testutil/argument_validator_test.go"
          dependencies: ["T012"]
          acceptance_criteria:
            - "Tests valid and invalid argument combinations"
            - "Tests agent-specific schema differences"
            - "Tests use map-based table-driven pattern"
            - "Tests cover edge cases: special characters, missing required flags"
    - number: 5
      title: "User Story 4 - CLI Invocation Logging"
      purpose: "Create YAML call log for detailed invocation tracking"
      story_reference: "US-004"
      independent_test: "Call logs contain timestamp, full args array, environment snapshot"
      tasks:
        - id: "T014"
          title: "Create call_log.go for YAML call log reading/writing"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-004"
          file_path: "internal/testutil/call_log.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "CallLog struct wraps []CallRecord for YAML serialization"
            - "WriteCallLog writes YAML to file with timestamp, args, env"
            - "ReadCallLog parses YAML call log file"
            - "Supports multiline prompts and special characters"
        - id: "T015"
          title: "Write tests for call_log.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-004"
          file_path: "internal/testutil/call_log_test.go"
          dependencies: ["T014"]
          acceptance_criteria:
            - "Tests roundtrip write/read of call logs"
            - "Tests special character handling"
            - "Tests use map-based table-driven pattern"
    - number: 6
      title: "Integration and Quality Gates"
      purpose: "Create comprehensive integration tests and ensure quality gates pass"
      tasks:
        - id: "T016"
          title: "Create integration tests using new mock capabilities"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/workflow/integration_test.go"
          dependencies: ["T005", "T008", "T013", "T015"]
          acceptance_criteria:
            - "Tests cover specify, plan, tasks, implement workflow stages"
            - "Tests validate argument construction for each stage"
            - "Tests verify no API calls are made"
            - "make test, make fmt, make lint, make build all pass"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-002", "US-004"]
        - story_id: "US-002"
          depends_on: ["US-001"]
          blocks: []
        - story_id: "US-003"
          depends_on: []
          blocks: []
          notes: "Network interception is P2 and deferred; defense-in-depth via invalid API key"
        - story_id: "US-004"
          depends_on: ["US-001"]
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2, 3, 4, 5]
        - phase: 2
          blocks: [5, 6]
        - phase: 3
          blocks: [6]
        - phase: 4
          blocks: [6]
        - phase: 5
          blocks: [6]
parallel_execution:
    - phase: 3
      parallel_groups:
        - tasks: ["T006"]
          rationale: "TestHelperProcess can be developed in parallel with MockExecutor tests"
    - phase: 4
      parallel_groups:
        - tasks: ["T009"]
          rationale: "ArgumentValidator is independent of TestHelperProcess implementation"
    - phase: 5
      parallel_groups:
        - tasks: ["T014"]
          rationale: "Call log can be developed once MockExecutor tests pass"
implementation_strategy:
    mvp_scope:
        phases: [1, 2]
        description: "Setup + Extended MockExecutor with Args/Env capture"
        validation: "Run existing tests to verify backward compatibility; add new tests for env capture"
    incremental_delivery:
        - milestone: "MockExecutor Extended"
          phases: [1, 2]
          deliverable: "MockExecutor captures full invocation context (args, env, timestamp)"
        - milestone: "Argument Validation Ready"
          phases: [1, 2, 3, 4]
          deliverable: "Full argument validation against agent schemas, both mock and real CLI"
        - milestone: "Full Integration Tests"
          phases: [1, 2, 3, 4, 5, 6]
          deliverable: "Complete test suite with coverage for all workflow stages"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.8.2"
    created: "2026-01-06T05:04:07Z"
    artifact_type: "tasks"
