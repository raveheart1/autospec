plan:
  branch: "062-agent-abstraction"
  created: "2025-12-19"
  spec_path: "specs/062-agent-abstraction/spec.yaml"

summary: |
  This plan implements a multi-agent abstraction layer for autospec, enabling users to switch
  between different CLI AI coding agents (Claude Code, Cline, Gemini CLI, Codex CLI, OpenCode,
  Goose) through a unified interface. The implementation creates a new internal/cliagent/
  package with an Agent interface, BaseAgent shared implementation, thread-safe Registry for
  agent discovery, and concrete implementations for all Tier 1 agents.

  Key architectural decisions: (1) New package internal/cliagent/ avoids confusion with existing
  internal/agent/ which handles AGENTS.md file management, (2) Configuration priority follows
  custom_agent_cmd > agent_preset > legacy fields > default(claude), (3) Backward compatibility
  maintained via deprecation warnings on stderr for legacy claude_cmd/custom_claude_cmd fields,
  (4) All workflow commands get --agent flag for runtime agent override.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/google/shlex"
      version: "latest"
      purpose: "Parse shell command strings for CustomAgent template expansion"
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI framework for command structure"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for configuration"
  storage: "None"
  testing:
    framework: "Go testing package"
    approach: "Map-based table-driven tests with t.Parallel() for unit tests, interface conformance tests for Agent implementations"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Agent validation <100ms, no impact on CLI startup time (<50ms)"
  constraints:
    - "Must maintain backward compatibility with existing claude_cmd, claude_args, custom_claude_cmd config fields"
    - "Cannot modify external agent CLIs - must adapt to their interfaces"
    - "Registry must be initialized before workflow commands execute"
    - "Command templates in internal/commands/*.md must remain project-agnostic"
  scale_scope: "6 Tier 1 agents with extensible registry for future additions"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Each phase includes test creation before implementation; interface conformance tests will validate all agents"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "Agent.Validate() checks CLI presence and required env vars before execution"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "NFR-005 requires Validate() <100ms; will add benchmark tests"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Agent operations are stateless; existing retry infrastructure handles execution retries"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Agent validation failures use exit code 4 (missing dependencies)"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "N/A"
      notes: "This feature doesn't create new artifact types"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All code will pass make fmt, make lint before commit"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, table-driven tests, interface-in/concrete-out"
    - name: "Command Template Independence (PRIN-012)"
      status: "PASS"
      notes: "No changes to internal/commands/*.md templates required"
    - name: "Cross-Platform Compatibility (PRIN-008)"
      status: "PASS"
      notes: "Using os/exec for CLI invocation; shlex for cross-platform command parsing"

research_findings:
  decisions:
    - topic: "Package naming to avoid conflict with internal/agent/"
      decision: "Use internal/cliagent/ for CLI agent abstraction"
      rationale: "internal/agent/ already handles AGENTS.md file management - using cliagent/ is explicit about purpose and prevents confusion"
      alternatives_considered:
        - "internal/agent/cli/ - nested package adds complexity"
        - "internal/executor/ - too generic, doesn't convey agent concept"
        - "internal/agents/ - minor naming difference, could still confuse"
    - topic: "Agent prompt delivery method"
      decision: "Use PromptDelivery struct with Method enum (arg, positional, subcommand, subcommand-arg, template)"
      rationale: "Different agents use different patterns - Claude uses -p flag, Cline uses positional, Codex uses exec subcommand, Goose uses run -t"
      alternatives_considered:
        - "Single PromptFlag field - doesn't handle subcommand patterns"
        - "Full template for all agents - over-complicates standard patterns"
    - topic: "Configuration priority order"
      decision: "custom_agent_cmd > agent_preset > legacy fields (claude_cmd/custom_claude_cmd) > default (claude)"
      rationale: "Custom templates are most specific, presets next, legacy for backward compatibility, claude as sensible default"
      alternatives_considered:
        - "CLI flag highest priority - already handled separately at command level"
        - "Environment vars highest - doesn't match existing config precedence"
    - topic: "Deprecation warning output"
      decision: "Write deprecation warnings to stderr only"
      rationale: "Follows Unix convention - visible to users interactively but doesn't break pipelines or stdout parsing"
      alternatives_considered:
        - "Log file only - users might miss warnings"
        - "stdout - would break command output parsing"
    - topic: "Agent registration timing"
      decision: "Use package init() in internal/cliagent/init.go to register all built-in agents"
      rationale: "Ensures registry is populated before any CLI commands run; import side-effect pattern"
      alternatives_considered:
        - "Lazy registration on first access - adds complexity, potential race conditions"
        - "Explicit registration in main() - requires code changes in multiple places"

data_model:
  entities:
    - name: "Agent"
      description: "Interface representing a CLI AI coding agent with execution and discovery capabilities"
      fields:
        - name: "Name"
          type: "func() string"
          description: "Unique identifier for the agent (e.g., 'claude', 'gemini')"
          constraints: "Must be lowercase, alphanumeric"
        - name: "Version"
          type: "func() (string, error)"
          description: "Returns installed CLI version or error"
          constraints: "May return 'unknown' if version unavailable"
        - name: "Validate"
          type: "func() error"
          description: "Checks CLI installed in PATH and required env vars set"
          constraints: "Must complete in <100ms"
        - name: "BuildCommand"
          type: "func(prompt string, opts ExecOptions) (*exec.Cmd, error)"
          description: "Constructs exec.Cmd for given prompt and options"
          constraints: "Does not execute the command"
        - name: "Execute"
          type: "func(ctx context.Context, prompt string, opts ExecOptions) (*Result, error)"
          description: "Builds and runs command, capturing output"
          constraints: "Respects context cancellation and timeout"
        - name: "Capabilities"
          type: "func() Caps"
          description: "Returns self-describing feature flags"
          constraints: "Non-nil, all fields initialized"
      relationships:
        - target: "Caps"
          type: "composition"
          description: "Each Agent has exactly one Caps describing its features"
        - target: "Registry"
          type: "aggregation"
          description: "Agents are registered in and retrieved from Registry"

    - name: "Caps"
      description: "Self-describing feature flags for agent discovery and automation compatibility"
      fields:
        - name: "Automatable"
          type: "bool"
          description: "Whether agent can run fully headless without user input"
          constraints: "Required for autospec automation"
        - name: "PromptDelivery"
          type: "PromptDelivery"
          description: "How to pass prompts to the agent CLI"
          constraints: "Must match agent's actual CLI interface"
        - name: "AutonomousFlag"
          type: "string"
          description: "CLI flag to skip confirmations (e.g., --dangerously-skip-permissions)"
          constraints: "Empty string if not needed"
        - name: "AutonomousEnv"
          type: "map[string]string"
          description: "Environment variables for autonomous mode"
          constraints: "May be nil"
        - name: "RequiredEnv"
          type: "[]string"
          description: "Environment variable names required for agent (API keys)"
          constraints: "Validation fails if any missing"
        - name: "OptionalEnv"
          type: "[]string"
          description: "Optional environment variables"
          constraints: "Informational only"
      relationships:
        - target: "PromptDelivery"
          type: "composition"
          description: "Embedded struct defining prompt passing method"

    - name: "PromptDelivery"
      description: "Describes how to pass prompts to the agent CLI"
      fields:
        - name: "Method"
          type: "string"
          description: "One of: arg, positional, subcommand, subcommand-arg, template"
          constraints: "Must match agent's CLI pattern"
        - name: "Flag"
          type: "string"
          description: "Primary flag or subcommand (-p, exec, run)"
          constraints: "Required for arg/subcommand methods"
        - name: "PromptFlag"
          type: "string"
          description: "Secondary flag for prompt after subcommand (-t for goose run -t)"
          constraints: "Only used with subcommand-arg method"
      relationships: []

    - name: "ExecOptions"
      description: "Configuration for a single agent execution"
      fields:
        - name: "Autonomous"
          type: "bool"
          description: "Whether to use headless/YOLO mode"
          constraints: "Adds autonomous flags to command"
        - name: "Timeout"
          type: "time.Duration"
          description: "Maximum execution duration"
          constraints: "0 means no timeout"
        - name: "WorkDir"
          type: "string"
          description: "Working directory for command execution"
          constraints: "Defaults to current directory"
        - name: "ExtraArgs"
          type: "[]string"
          description: "Additional CLI arguments"
          constraints: "Appended after standard args"
        - name: "Env"
          type: "map[string]string"
          description: "Additional environment variables"
          constraints: "Merged with process environment"
        - name: "Stdout"
          type: "io.Writer"
          description: "Where to write stdout"
          constraints: "If nil, output captured in Result"
        - name: "Stderr"
          type: "io.Writer"
          description: "Where to write stderr"
          constraints: "If nil, output captured in Result"
      relationships: []

    - name: "Result"
      description: "Outcome of an agent execution"
      fields:
        - name: "ExitCode"
          type: "int"
          description: "Process exit status"
          constraints: "0 indicates success"
        - name: "Stdout"
          type: "string"
          description: "Captured stdout (if no writer provided)"
          constraints: "May be empty if Stdout writer used"
        - name: "Stderr"
          type: "string"
          description: "Captured stderr (if no writer provided)"
          constraints: "May be empty if Stderr writer used"
        - name: "Duration"
          type: "time.Duration"
          description: "Execution time"
          constraints: "Measured from command start to completion"
      relationships: []

    - name: "Registry"
      description: "Thread-safe container for registered agents with discovery methods"
      fields:
        - name: "agents"
          type: "map[string]Agent"
          description: "Registered agents by name"
          constraints: "Protected by RWMutex"
        - name: "mu"
          type: "sync.RWMutex"
          description: "Mutex for concurrent access"
          constraints: "RLock for reads, Lock for writes"
      relationships:
        - target: "Agent"
          type: "aggregation"
          description: "Registry contains zero or more registered Agents"

    - name: "CustomAgent"
      description: "Agent implementation supporting {{PROMPT}} template expansion for arbitrary CLI tools"
      fields:
        - name: "name"
          type: "string"
          description: "Agent name (typically 'custom')"
          constraints: "Identifies as custom in registry"
        - name: "template"
          type: "string"
          description: "Command template with {{PROMPT}} placeholder"
          constraints: "Must contain exactly one {{PROMPT}}"
      relationships:
        - target: "Agent"
          type: "implementation"
          description: "Implements Agent interface"

    - name: "BaseAgent"
      description: "Shared implementation for common agent operations"
      fields:
        - name: "name"
          type: "string"
          description: "Agent identifier"
          constraints: "Lowercase, alphanumeric"
        - name: "cmd"
          type: "string"
          description: "CLI command name"
          constraints: "Must be in PATH for Validate to pass"
        - name: "versionFlag"
          type: "string"
          description: "Flag to get version (--version, -v)"
          constraints: "Empty if agent doesn't support version"
        - name: "caps"
          type: "Caps"
          description: "Agent capabilities"
          constraints: "Immutable after creation"
      relationships:
        - target: "Agent"
          type: "implementation"
          description: "Provides base implementation of Agent interface"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/agents.md"
      description: "User-facing documentation for agent configuration and usage"
  source_code:
    - path: "internal/cliagent/"
      description: "New package for CLI agent abstraction layer"
    - path: "internal/cliagent/agent.go"
      description: "Agent interface and core type definitions"
    - path: "internal/cliagent/base.go"
      description: "BaseAgent struct with shared implementation"
    - path: "internal/cliagent/registry.go"
      description: "Thread-safe Registry for agent registration and discovery"
    - path: "internal/cliagent/capabilities.go"
      description: "Caps struct and PromptDelivery enum"
    - path: "internal/cliagent/options.go"
      description: "ExecOptions and Result types"
    - path: "internal/cliagent/custom.go"
      description: "CustomAgent implementation with {{PROMPT}} template expansion"
    - path: "internal/cliagent/claude.go"
      description: "Claude Code agent implementation"
    - path: "internal/cliagent/cline.go"
      description: "Cline agent implementation"
    - path: "internal/cliagent/gemini.go"
      description: "Gemini CLI agent implementation"
    - path: "internal/cliagent/codex.go"
      description: "Codex CLI agent implementation"
    - path: "internal/cliagent/opencode.go"
      description: "OpenCode agent implementation"
    - path: "internal/cliagent/goose.go"
      description: "Goose agent implementation"
    - path: "internal/cliagent/init.go"
      description: "Package init() to register all built-in agents"
    - path: "internal/config/config.go"
      description: "Extended with agent_preset, custom_agent_cmd fields and GetAgent() method"
    - path: "internal/workflow/claude.go"
      description: "Refactored to use Agent interface instead of hardcoded Claude"
    - path: "internal/health/health.go"
      description: "Extended with agent status reporting via Registry.Doctor()"
  tests:
    - path: "internal/cliagent/*_test.go"
      description: "Unit tests for all agent package components"
    - path: "internal/cliagent/conformance_test.go"
      description: "Interface conformance tests ensuring all agents implement Agent correctly"
    - path: "internal/config/agent_test.go"
      description: "Tests for agent configuration loading and GetAgent()"

implementation_phases:
  - phase: 1
    name: "Core Interfaces and Types"
    goal: "Establish the foundational Agent interface, Caps, ExecOptions, Result types and Registry"
    deliverables:
      - "internal/cliagent/agent.go - Agent interface definition"
      - "internal/cliagent/capabilities.go - Caps struct and PromptDelivery"
      - "internal/cliagent/options.go - ExecOptions and Result types"
      - "internal/cliagent/registry.go - Thread-safe Registry with Default global instance"
      - "Unit tests with t.Parallel() for all types"

  - phase: 2
    name: "Base Implementation and CustomAgent"
    goal: "Implement shared BaseAgent functionality and template-based CustomAgent"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/cliagent/base.go - BaseAgent with common operations"
      - "internal/cliagent/custom.go - CustomAgent with {{PROMPT}} expansion"
      - "Tests for BaseAgent.Validate(), BuildCommand(), Execute()"
      - "Tests for CustomAgent template parsing and shell quoting"

  - phase: 3
    name: "Tier 1 Agent Implementations"
    goal: "Implement concrete agents for Claude, Cline, Gemini, Codex, OpenCode, Goose"
    dependencies:
      - "Phase 2"
    deliverables:
      - "internal/cliagent/claude.go"
      - "internal/cliagent/cline.go"
      - "internal/cliagent/gemini.go"
      - "internal/cliagent/codex.go"
      - "internal/cliagent/opencode.go"
      - "internal/cliagent/goose.go"
      - "internal/cliagent/init.go - Agent registration"
      - "Interface conformance tests for all six agents"
      - "BuildCommand tests verifying correct CLI patterns per agent"

  - phase: 4
    name: "Configuration Integration"
    goal: "Extend config package with agent fields and GetAgent() method"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Add agent_preset, custom_agent_cmd fields to Configuration struct"
      - "Implement GetAgent() with priority: custom_agent_cmd > agent_preset > legacy > default"
      - "Deprecation warnings to stderr for claude_cmd, claude_args, custom_claude_cmd"
      - "Tests for config priority order and backward compatibility"

  - phase: 5
    name: "Workflow Executor Refactoring"
    goal: "Refactor ClaudeExecutor to use Agent interface"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Refactor internal/workflow/claude.go to accept Agent interface"
      - "Update Execute() to delegate to agent.Execute()"
      - "Maintain existing streaming and timeout behavior"
      - "Update all callers in internal/cli/stages/"

  - phase: 6
    name: "CLI Flag and Doctor Integration"
    goal: "Add --agent flag to workflow commands and extend doctor with agent status"
    dependencies:
      - "Phase 5"
    deliverables:
      - "Add --agent flag to: run, implement, prep, specify, plan, tasks"
      - "Flag overrides agent_preset for single execution"
      - "Extend internal/health/health.go with Registry.Doctor() integration"
      - "Update doctor command output to show all agents"
      - "Integration tests for --agent flag"

  - phase: 7
    name: "Documentation and Quality Gates"
    goal: "Create user documentation and ensure all quality gates pass"
    dependencies:
      - "Phase 6"
    deliverables:
      - "docs/agents.md - User guide for agent configuration"
      - "Update docs/reference.md with --agent flag"
      - "Update CLAUDE.md if architectural notes needed"
      - "make test passes (no failures)"
      - "make fmt passes (no changes)"
      - "make lint passes (no errors)"
      - "make build passes"

risks:
  - risk: "Agent CLI interfaces may change in future versions"
    likelihood: "low"
    impact: "medium"
    mitigation: "Document specific CLI versions tested; agent implementations are isolated and easily updated"

  - risk: "Some agents may not be installed on developer machines for testing"
    likelihood: "high"
    impact: "low"
    mitigation: "Validation tests skip unavailable agents; mock-based unit tests for core logic; BuildCommand can be tested without executing"

  - risk: "Shell quoting edge cases with CustomAgent {{PROMPT}} expansion"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Use google/shlex library for robust parsing; comprehensive test cases with special characters, quotes, newlines"

  - risk: "Thread-safety issues in Registry under concurrent access"
    likelihood: "low"
    impact: "high"
    mitigation: "Use sync.RWMutex with proper locking; run tests with go test -race flag"

  - risk: "Backward compatibility regression with legacy config fields"
    likelihood: "medium"
    impact: "high"
    mitigation: "Comprehensive backward compatibility tests; deprecation warnings visible to users; maintain legacy paths indefinitely"

  - risk: "Agent validation may be slow for some agents (Version command)"
    likelihood: "medium"
    impact: "low"
    mitigation: "NFR-005 enforces <100ms target; cache version results if needed; version errors don't block validation"

open_questions:
  - question: "Should we cache agent validation results to avoid repeated PATH lookups?"
    context: "Validate() is called during config load and potentially during doctor; repeated exec.LookPath calls add latency"
    proposed_resolution: "Initially no caching - LookPath is fast. Add caching in Phase 2 if profiling shows it's needed"

  - question: "Should CustomAgent support multiple {{PROMPT}} placeholders?"
    context: "Current design only allows one placeholder; some complex scenarios might need multiple"
    proposed_resolution: "Keep single placeholder for simplicity; users can use shell functions for complex cases"

  - question: "How to handle agents that require TTY but autospec runs non-interactively?"
    context: "Some agents might behave differently without TTY; currently out of scope per spec"
    proposed_resolution: "Document TTY-requiring agents as unsupported; Tier 1 agents all support headless mode"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-19T20:36:15Z"
  artifact_type: "plan"
