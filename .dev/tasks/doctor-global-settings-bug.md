# Bug: doctor command doesn't check global Claude settings

## Issue

`autospec doctor` reports missing `Bash(autospec:*)` permission even when it's configured in the user-level global settings.

## Root Cause

- `autospec init` was changed to update **user-level** settings at `~/.claude/settings.json`
- `autospec doctor` still only checks **project-level** settings at `.claude/settings.local.json`
- This mismatch causes false negatives

## Reproduction

```bash
# Permissions ARE set in global settings
grep -E "autospec|specs" ~/.claude/settings.json
#       "Bash(autospec:*)",
#       "Write(.autospec/**)",
#       "Edit(.autospec/**)",
#       "Write(./specs/**)",
#       "Edit(./specs/**)"

# But doctor still fails
autospec doctor
# Output: ✗ Claude settings: missing Bash(autospec:*) permission (run 'autospec init' to fix)
```

---

## Solution: Add `.autospec/init.yml` to Track Init Settings

### Overview

Create a new `.autospec/init.yml` file that remembers all options chosen during `autospec init`. This file:

1. Enables `doctor` to know where to look for permissions (project vs global)
2. Provides visibility into how autospec was configured in this project
3. Allows `doctor` to warn about projects on older autospec versions

### `.autospec/init.yml` Schema

```yaml
# .autospec/init.yml - Tracks autospec init configuration for this project
# Generated by: autospec init
# Regenerate by: autospec init --force

version: 1                      # Schema version for future compatibility
created_at: 2025-01-15T10:30:00Z
updated_at: 2025-01-15T10:30:00Z
autospec_version: "0.8.2"       # Version of autospec that ran init

# Where settings were written
settings_scope: global          # "global" (~/.claude/settings.json) or "project" (.claude/settings.local.json)

# Agents configured during init
agents:
  - name: claude
    configured: true
    permissions_location: global  # Where permissions were added
    sandbox_enabled: true
    sandbox_paths:
      - ".autospec/**"
      - "./specs/**"
  - name: opencode
    configured: false

# Auth and execution settings
auth:
  use_subscription: true        # OAuth subscription vs API credits
  skip_permissions: true        # Autonomous mode enabled

# Project setup status
project:
  constitution_created: true
  gitignore_updated: true
  specs_dir: "specs"
```

### Implementation

#### 1. Create init settings package

New file: `internal/initsettings/initsettings.go`

```go
package initsettings

const (
    FileName = "init.yml"
    FilePath = ".autospec/init.yml"
)

type InitSettings struct {
    Version         int       `yaml:"version"`
    CreatedAt       time.Time `yaml:"created_at"`
    UpdatedAt       time.Time `yaml:"updated_at"`
    AutospecVersion string    `yaml:"autospec_version"`
    SettingsScope   string    `yaml:"settings_scope"` // "global" or "project"
    Agents          []AgentConfig `yaml:"agents"`
    Auth            AuthConfig    `yaml:"auth"`
    Project         ProjectConfig `yaml:"project"`
}

type AgentConfig struct {
    Name                string   `yaml:"name"`
    Configured          bool     `yaml:"configured"`
    PermissionsLocation string   `yaml:"permissions_location,omitempty"`
    SandboxEnabled      bool     `yaml:"sandbox_enabled,omitempty"`
    SandboxPaths        []string `yaml:"sandbox_paths,omitempty"`
}

type AuthConfig struct {
    UseSubscription bool `yaml:"use_subscription"`
    SkipPermissions bool `yaml:"skip_permissions"`
}

type ProjectConfig struct {
    ConstitutionCreated bool   `yaml:"constitution_created"`
    GitignoreUpdated    bool   `yaml:"gitignore_updated"`
    SpecsDir            string `yaml:"specs_dir"`
}

func Load() (*InitSettings, error) { ... }
func (s *InitSettings) Save() error { ... }
func Exists() bool { ... }
```

#### 2. Update `autospec init` to write init.yml

In `internal/cli/config/init_cmd.go`:

```go
func runInit(cmd *cobra.Command, args []string) error {
    // ... existing init logic ...

    // At the end, after all configuration is done:
    initSettings := &initsettings.InitSettings{
        Version:         1,
        CreatedAt:       time.Now().UTC(),
        UpdatedAt:       time.Now().UTC(),
        AutospecVersion: build.Version(),
        SettingsScope:   scope, // "global" or "project" based on --project flag
        Agents:          configuredAgents,
        Auth: initsettings.AuthConfig{
            UseSubscription: cfg.UseSubscription,
            SkipPermissions: cfg.SkipPermissions,
        },
        Project: initsettings.ProjectConfig{
            ConstitutionCreated: result.constitutionExists,
            GitignoreUpdated:    pending.addGitignore,
            SpecsDir:            specsDir,
        },
    }

    if err := initSettings.Save(); err != nil {
        fmt.Fprintf(out, "%s Failed to save init settings: %v\n", cYellow("⚠"), err)
    } else {
        fmt.Fprintf(out, "%s %s: saved at %s\n", cGreen("✓"), cBold("Init settings"), cDim(".autospec/init.yml"))
    }

    return nil
}
```

#### 3. Update doctor to use init.yml

In `internal/health/health.go`:

```go
func CheckClaudeSettingsInDir(projectDir string) CheckResult {
    // Step 1: Load init.yml to determine where to look
    initSettings, err := initsettings.Load()

    // Step 2: If init.yml doesn't exist, warn about older autospec version
    if err != nil || initSettings == nil {
        // Fallback: Check both locations for backwards compatibility
        return checkClaudeSettingsLegacy(projectDir)
    }

    // Step 3: Check the location specified in init.yml
    switch initSettings.SettingsScope {
    case "project":
        return checkProjectSettings(projectDir)
    case "global":
        return checkGlobalSettings()
    default:
        // Unknown scope, check both
        return checkBothSettings(projectDir)
    }
}

func checkClaudeSettingsLegacy(projectDir string) CheckResult {
    // Check project-level first
    projectResult := checkProjectSettings(projectDir)
    if projectResult.Passed {
        return projectResult
    }

    // Fall back to global
    globalResult := checkGlobalSettings()
    if globalResult.Passed {
        return globalResult
    }

    // Neither has the permission - return message suggesting re-run init
    return CheckResult{
        Name:    "Claude settings",
        Passed:  false,
        Message: "missing Bash(autospec:*) permission. Run 'autospec init' to configure.",
    }
}
```

#### 4. Add init.yml existence check to doctor

```go
func CheckInitSettings() CheckResult {
    if !initsettings.Exists() {
        return CheckResult{
            Name:    "Init settings",
            Passed:  false,  // or true with warning?
            Message: ".autospec/init.yml not found. This project may be using an older autospec version. Run 'autospec init' to configure.",
        }
    }

    settings, err := initsettings.Load()
    if err != nil {
        return CheckResult{
            Name:    "Init settings",
            Passed:  false,
            Message: fmt.Sprintf("failed to load .autospec/init.yml: %v", err),
        }
    }

    return CheckResult{
        Name:    "Init settings",
        Passed:  true,
        Message: fmt.Sprintf("configured (scope: %s, autospec v%s)", settings.SettingsScope, settings.AutospecVersion),
    }
}
```

---

## Files to Modify

| File | Changes |
|------|---------|
| `internal/initsettings/initsettings.go` | **NEW** - Init settings struct, Load/Save/Exists functions |
| `internal/initsettings/initsettings_test.go` | **NEW** - Tests for init settings |
| `internal/cli/config/init_cmd.go` | Write init.yml at end of init process |
| `internal/health/health.go` | Use init.yml to determine where to check permissions; add `CheckInitSettings()` |
| `internal/health/health_test.go` | Add test cases for init.yml-aware permission checking |
| `internal/claude/settings.go` | Add `CheckGlobalSettings()` convenience function |

---

## Doctor Output Examples

### Project with init.yml (global scope)

```
$ autospec doctor
✓ Claude CLI: found
✓ Git: found
✓ Init settings: configured (scope: global, autospec v0.8.2)
✓ Claude settings: Bash(autospec:*) permission configured (global)

CLI Agents:
  ✓ claude: installed (v1.0.26)
```

### Project without init.yml (legacy/older version)

```
$ autospec doctor
✓ Claude CLI: found
✓ Git: found
⚠ Init settings: .autospec/init.yml not found
  → This project may be using an older autospec version.
  → Run 'autospec init' to properly configure autospec.
✓ Claude settings: Bash(autospec:*) permission configured (global fallback)

CLI Agents:
  ✓ claude: installed (v1.0.26)
```

### Project with neither project nor global permissions

```
$ autospec doctor
✓ Claude CLI: found
✓ Git: found
⚠ Init settings: .autospec/init.yml not found
✗ Claude settings: missing Bash(autospec:*) permission
  → Run 'autospec init' to configure permissions

CLI Agents:
  ✓ claude: installed (v1.0.26)
```

---

## Benefits

1. **Accurate permission detection**: Doctor knows exactly where to look
2. **Version awareness**: Can warn about outdated autospec configurations
3. **Debugging aid**: `cat .autospec/init.yml` shows exactly how autospec was configured
4. **Idempotent re-init**: `autospec init --force` regenerates with current settings
5. **Agent-specific checks**: Can skip Claude checks if only opencode was configured
6. **Future extensibility**: Version field allows schema evolution

---

## Notes

- The `claude` package already has `LoadGlobal()` which loads from `~/.claude/settings.json`
- init.yml should be added to `.gitignore` by default (it's project-specific config)
- Consider whether to skip Claude settings check entirely if agents list doesn't include Claude
- User workaround (until fix): `autospec init --project` writes to project-level settings
